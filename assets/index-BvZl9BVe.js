var bt=Object.defineProperty;var Pt=(tt,w,t)=>w in tt?bt(tt,w,{enumerable:!0,configurable:!0,writable:!0,value:t}):tt[w]=t;var C=(tt,w,t)=>Pt(tt,typeof w!="symbol"?w+"":w,t);import{P as U}from"./phaser-0RJB29YE.js";(function(){const w=document.createElement("link").relList;if(w&&w.supports&&w.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const i of e)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(e){const i={};return e.integrity&&(i.integrity=e.integrity),e.referrerPolicy&&(i.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?i.credentials="include":e.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(e){if(e.ep)return;e.ep=!0;const i=t(e);fetch(e.href,i)}})();class Lt extends U.Scene{constructor(){super("BootScene")}preload(){this.load.image("effect_circle","effects/circle.png"),this.load.image("effect_circle_line","effects/circle_line.png"),this.load.image("effect_line","effects/line.png");const w=[30,40,50,60,70,80,90,100,110,120,130,140,150,160,360];for(const s of w)this.load.image(`effect_sector_${s}`,`effects/sector_${s}.png`);this.load.image("effect_soulwave","effects/soulwave.png"),this.load.image("effect_shield","effects/shield.png");const t="0123456789ABCDEF";for(const s of t)this.load.image(`hex_${s}`,`effects/hex/${s}.png`)}create(){this.scene.start("MainScene")}}const ot=[{id:"advanced_burning_celluloid",name:"燃燒的賽璐珞",subtitle:"傳統手繪動畫師、逐幀動畫師",description:`【靈魂渲染＋鈦金肝】
消耗10HP，旋轉一圈30°扇形攻擊`,color:16737792,flashColor:16750899,cooldown:2e3,maxLevel:-1,iconPrefix:"X01",requiredSkills:["active_soul_render","passive_titanium_liver"],levelUpQuotes:["你選擇成為傳統手繪動畫師、逐幀動畫師"]},{id:"advanced_tech_artist",name:"技術美術大神",subtitle:"一人成軍的遊戲開發者",description:`【咒言幻象＋視網膜】
周圍5單位射下光線，3單位爆炸，敵人暈眩1秒`,color:10053375,flashColor:12294655,cooldown:1e3,maxLevel:-1,iconPrefix:"X02",requiredSkills:["active_coder","passive_retina_module"],levelUpQuotes:["左手寫 Code，右手畫圖，一人成軍的遊戲開發者"]},{id:"advanced_absolute_defense",name:"絕對邏輯防禦",subtitle:"無懈可擊的系統架構",description:`【靈魂統領＋同步率】
有護盾時輪鋸繞身，滿盾6個，撞敵耗盾並擊退`,color:16768256,flashColor:16772710,cooldown:100,maxLevel:-1,iconPrefix:"X03",requiredSkills:["active_architect","passive_sync_rate"],levelUpQuotes:["系統架構固若金湯，邏輯防線無懈可擊"]},{id:"advanced_perfect_pixel",name:"完美像素審判",subtitle:"構圖之神的鐵律",description:`【疾光狙擊＋視網膜】
每3秒產生井字線，四焦點輪流爆炸
命中敵人暈眩1秒`,color:6750156,flashColor:8978414,cooldown:3e3,maxLevel:-1,iconPrefix:"X04",requiredSkills:["active_vfx","passive_retina_module"],levelUpQuotes:["構圖的黃金法則，像素的完美審判"]},{id:"advanced_vfx_burst",name:"爆發的影視特效",subtitle:"好萊塢級的視覺轟炸",description:`【疾光狙擊＋AI強化】
每3.5秒發射20枚追蹤導彈`,color:16729088,flashColor:16737843,cooldown:3500,maxLevel:-1,iconPrefix:"X05",requiredSkills:["active_vfx","passive_ai_enhancement"],levelUpQuotes:["好萊塢級的視覺轟炸，每一幀都是藝術"]},{id:"advanced_phantom_iteration",name:"幻影迭代模式",subtitle:"無限分身的創作者",description:`【咒言幻象＋AI強化】
召喚影分身施放燃燒賽璐珞(3格)、技美大神(2發)、完美像素(±2格)，每5秒嘲諷怪物2秒`,color:10053375,flashColor:12290303,cooldown:15e3,maxLevel:-1,iconPrefix:"X06",requiredSkills:["active_coder","passive_ai_enhancement"],levelUpQuotes:["影分身現身，無限迭代的創作者"]},{id:"advanced_zero_trust",name:"零信任防禦協定",subtitle:"絕對安全的系統架構",description:`【靈魂統領＋AI強化】
展開8角矩陣，持續光束掃描範圍內敵人
範圍內敵人移動速度減半`,color:16763904,flashColor:16772710,cooldown:0,maxLevel:-1,iconPrefix:"X07",requiredSkills:["active_architect","passive_ai_enhancement"],levelUpQuotes:["零信任，驗證一切，絕不妥協"]},{id:"advanced_soul_slash",name:"次元向量疾劃",subtitle:"貫穿次元的向量之刃",description:`【靈魂渲染＋AI強化】
朝最近敵人揮出貫穿全螢幕的直線斬擊
每級 1% 機率從擊中敵人觸發連鎖斬擊`,color:16724838,flashColor:16737945,cooldown:500,maxLevel:-1,iconPrefix:"X08",requiredSkills:["active_soul_render","passive_ai_enhancement"],levelUpQuotes:["向量運算，次元切割"]}],ut=[{id:"active_soul_render",name:"靈魂渲染",subtitle:"動畫大師",description:"朝最近敵人發射 3 單位扇形攻擊，每級擴大 10°",type:"active",color:6724095,flashColor:6737151,cooldown:1e3,maxLevel:5,iconPrefix:"A",levelUpMessages:["60° 扇形、2 傷害","70° 扇形、3 傷害","80° 扇形、4 傷害","90° 扇形、5 傷害","100° 扇形、6 傷害","110° 扇形、7 傷害，已達最大等級！"],levelUpQuotes:["你練習了繪畫技法，動畫美術的能力提升了","你習得了分鏡設計，並獲得了動態腳本製作技術","你增進了手繪動畫和停格動畫的製作技術","你苦練了3D角色模型和3D場景的設計","你完全理解了動畫法則，提升了角色動畫的製作精度","你成為了動畫大師，解鎖了進階技能組合"],maxExtraAbility:{name:"穿透",description:"攻擊後 {value} 機率發射扇形波（每 0.3 秒傷害一次）",baseValue:0,perLevel:.007,unit:"%",isPercentage:!0}},{id:"active_coder",name:"咒言幻象",subtitle:"遊戲先知",description:"對周圍 2 單位敵人造成傷害，每級增加 0.5 單位範圍",type:"active",color:11167487,flashColor:13404415,cooldown:2e3,maxLevel:5,iconPrefix:"C",levelUpMessages:["2 單位範圍、2 傷害","2.5 單位範圍、4 傷害","3 單位範圍、6 傷害","3.5 單位範圍、8 傷害","4 單位範圍、10 傷害","4.5 單位範圍、12 傷害，已達最大等級！"],levelUpQuotes:["你參透了互動設計的原理，同時了解遊戲企劃架構","你習得動作捕捉的技術，將應用到虛擬實境製作","你增進了程式設計能力和遊戲引擎的創作能力","你整合了虛擬網紅製作技術，讓自媒體營銷具爆發力","你導入了人工智慧協作能力，產能提升了數倍","你成為了遊戲先知，解鎖了進階技能組合"],maxExtraAbility:{name:"爆發",description:"擊殺時 {value} 機率再發動（可連鎖）",baseValue:0,perLevel:.01,unit:"%",isPercentage:!0}},{id:"active_vfx",name:"疾光狙擊",subtitle:"超級導演",description:"朝隨機敵人發射 10 單位貫穿光束，每級增加 1 道",type:"active",color:6750054,flashColor:8978312,cooldown:2500,maxLevel:5,iconPrefix:"B",levelUpMessages:["1 道光束、1 傷害","2 道光束、2 傷害","3 道光束、3 傷害","4 道光束、4 傷害","5 道光束、5 傷害","3 道精準鎖定超粗射線、6 傷害、15 單位射程，已達最大等級！"],levelUpQuotes:["你研究了影像美學，劇本編導的能力提升了","你習得了動靜態攝影的能力，獲得了畫面控制的技術","你增進了影片剪輯和動態影像的設計能力","你苦練了數位成音技術影像獲得更多回饋","你學會應用特效合成後製提升了影像各種可能性","你成為了超級導演，解鎖了進階技能組合"],maxExtraAbility:{name:"精準",description:"改為 3 條精準鎖定超粗射線，射程 15 單位",baseValue:0,perLevel:0,unit:"",isPercentage:!1}},{id:"active_architect",name:"靈魂統領",subtitle:"架構師",description:"產生 30% HP 護盾（霸體），反傷並擊退攻擊者 1 單位",type:"active",color:16763904,flashColor:16768324,cooldown:1e4,maxLevel:5,levelUpMessages:["30% HP 護盾、1 反傷＋擊退","30% HP 護盾、2.5 反傷＋擊退","30% HP 護盾、4 反傷＋擊退","30% HP 護盾、5.5 反傷＋擊退","30% HP 護盾、7 反傷＋擊退","30% HP 護盾、8.5 反傷＋擊退，已達最大等級！"],maxExtraAbility:{name:"堅守",description:"護盾覆蓋時 100% 炸開並擊退敵人",baseValue:0,perLevel:.01,unit:"%",isPercentage:!0}},{id:"passive_titanium_liver",name:"鈦金屬賽博肝臟",subtitle:"超級肝",description:"提升 10% HP 總量並每 15 秒回復 1% 最大 HP，每級再 +10% HP、回復間隔 -1 秒",type:"passive",color:11189196,maxLevel:5,iconPrefix:"P01",levelUpMessages:["+10% HP、每 15 秒回血","+20% HP、每 14 秒回血","+30% HP、每 13 秒回血","+40% HP、每 12 秒回血","+50% HP、每 11 秒回血","+60% HP、每 10 秒回血，已達最大等級！"],levelUpQuotes:["驚人無懈可擊的耐力，你的工作時長不斷提升","驚人無懈可擊的耐力，你的工作時長不斷提升","驚人無懈可擊的耐力，你的工作時長不斷提升","驚人無懈可擊的耐力，你的工作時長不斷提升","驚人無懈可擊的耐力，你的工作時長不斷提升","千錘百鍊的鈦金肝再也不怕熬夜"],maxExtraAbility:{name:"不死",description:"抵銷一次死亡，觸發暗影爆炸",triggerQuote:"不知何處湧上的力量將你推回現實...",baseValue:1,perLevel:0,unit:"次",isPercentage:!1}},{id:"passive_sync_rate",name:"精神同步率強化",subtitle:"零的領域",description:"提升 10% 移速、減少 8% 冷卻，每級再疊加",type:"passive",color:14518340,maxLevel:5,iconPrefix:"P02",levelUpMessages:["+10% 移速、-8% 冷卻","+20% 移速、-16% 冷卻","+30% 移速、-24% 冷卻","+40% 移速、-32% 冷卻","+50% 移速、-40% 冷卻","+60% 移速、-48% 冷卻，已達最大等級！"],levelUpQuotes:["進入到心流狀態，專注力提升且變的敏捷","進入到心流狀態，專注力提升且變的敏捷","進入到心流狀態，專注力提升且變的敏捷","進入到心流狀態，專注力提升且變的敏捷","進入到心流狀態，專注力提升且變的敏捷","你已進入無限心流狀態，感覺身手異常敏捷迅速"],maxExtraAbility:{name:"迅捷",description:"閃避機率 +{value}",baseValue:0,perLevel:.002,unit:"%",isPercentage:!0}},{id:"passive_retina_module",name:"視網膜增強模組",subtitle:"血輪眼",description:"提升 30% 經驗取得，每級再 +30%",type:"passive",color:10035763,maxLevel:5,iconPrefix:"P03",levelUpMessages:["+30% 經驗","+60% 經驗","+90% 經驗","+120% 經驗","+150% 經驗","+180% 經驗，已達最大等級！"],levelUpQuotes:["敏銳的觀察力，提高獲取經驗的速度","敏銳的觀察力，提高獲取經驗的速度","敏銳的觀察力，提高獲取經驗的速度","敏銳的觀察力，提高獲取經驗的速度","敏銳的觀察力，提高獲取經驗的速度","千錘百鍊的敏銳觀察，再沒什麼看不穿、看不清"],maxExtraAbility:{name:"洞察",description:"暴擊率 +{value}",baseValue:0,perLevel:.005,unit:"%",isPercentage:!0}},{id:"passive_ai_enhancement",name:"AI賦能強化",subtitle:"智能輔助",description:"提升 25% 攻擊、15% 防禦，每級再疊加",type:"passive",color:6719658,maxLevel:5,iconPrefix:"P04",levelUpMessages:["+25% 攻擊、+15% 防禦","+50% 攻擊、+30% 防禦","+75% 攻擊、+45% 防禦","+100% 攻擊、+60% 防禦","+125% 攻擊、+75% 防禦","+150% 攻擊、+90% 防禦，已達最大等級！"],levelUpQuotes:["攻守兼備，各方面能力全面提升","攻守兼備，各方面能力全面提升","攻守兼備，各方面能力全面提升","攻守兼備，各方面能力全面提升","攻守兼備，各方面能力全面提升","熟練的AI操作，讓你無論做任何事情效率提高數十倍"],maxExtraAbility:{name:"超載",description:"暴擊傷害 +{value}",baseValue:0,perLevel:.005,unit:"%",isPercentage:!0}}],lt=class lt{constructor(){C(this,"playerSkills",new Map);C(this,"advancedSkillLevels",new Map);C(this,"equippedAdvancedSkillId",null)}getActiveSkillDefinitions(){return ut.filter(w=>w.type==="active")}getPassiveSkillDefinitions(){return ut.filter(w=>w.type==="passive")}getPlayerSkill(w){return this.playerSkills.get(w)}getPlayerActiveSkills(){const w=[];this.playerSkills.forEach(s=>{s.definition.type==="active"&&w.push(s)});const t=[];for(let s=0;s<4;s++)t.push(w[s]||null);return t}getPlayerPassiveSkills(){const w=[];this.playerSkills.forEach(s=>{s.definition.type==="passive"&&w.push(s)});const t=[];for(let s=0;s<lt.MAX_PASSIVE_SLOTS;s++)t.push(w[s]||null);return t}getOwnedPassiveCount(){let w=0;return this.playerSkills.forEach(t=>{t.definition.type==="passive"&&w++}),w}isPassiveSlotsFull(){return this.getOwnedPassiveCount()>=lt.MAX_PASSIVE_SLOTS}getSkillLevel(w){const t=this.playerSkills.get(w);return t?t.level:-1}isSkillMaxLevel(w){const t=this.playerSkills.get(w);return t?t.level>=t.definition.maxLevel:!1}learnOrUpgradeSkill(w){const t=ut.find(e=>e.id===w);if(!t)return!1;const s=this.playerSkills.get(w);if(s){if(s.level>=t.maxLevel)return!1;s.level++}else this.playerSkills.set(w,{definition:t,level:0});return!0}getUpgradeableActiveSkills(){return this.getActiveSkillDefinitions().filter(w=>{const t=this.playerSkills.get(w.id);return!t||t.level<w.maxLevel})}getUpgradeablePassiveSkills(){const w=this.isPassiveSlotsFull();return this.getPassiveSkillDefinitions().filter(t=>{const s=this.playerSkills.get(t.id);return w?s&&s.level<t.maxLevel:!s||s.level<t.maxLevel})}hasAnyActiveSkill(){return this.getActiveSkillDefinitions().some(t=>this.playerSkills.has(t.id))}getRandomSkillOptions(){const w=this.getUpgradeableActiveSkills(),t=this.getUpgradeablePassiveSkills(),s=[];if(!this.hasAnyActiveSkill()){for(let a=0;a<Math.min(3,w.length);a++)s.push(w[a]);return s}const e=this.shuffleArray([...w]);for(let a=0;a<Math.min(2,e.length);a++)s.push(e[a]);const i=this.shuffleArray([...t]);return i.length>0&&s.push(i[0]),s}getMixedSkillOptions(){const w=this.getUpgradeableActiveSkills(),t=this.getUpgradeablePassiveSkills(),s=this.getUpgradeableAdvancedSkills(),e=[];if(!this.hasAnyActiveSkill()){for(let o=0;o<Math.min(3,w.length);o++)e.push(w[o]);return{normal:e,advanced:[]}}const i=this.shuffleArray([...w]);for(let o=0;o<Math.min(2,i.length);o++)e.push(i[o]);const a=this.shuffleArray([...t]);a.length>0&&e.push(a[0]);let n=[];if(this.equippedAdvancedSkillId){const o=s.find(r=>r.id===this.equippedAdvancedSkillId);if(o){const r=s.filter(h=>h.id!==this.equippedAdvancedSkillId),c=this.shuffleArray([...r]);n=[o,...c]}else n=this.shuffleArray([...s])}else n=this.shuffleArray([...s]);return{normal:e,advanced:n}}hasUpgradeableSkills(){return this.getUpgradeableActiveSkills().length>0||this.getUpgradeablePassiveSkills().length>0}shuffleArray(w){for(let t=w.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[w[t],w[s]]=[w[s],w[t]]}return w}static formatLevel(w,t=5){return w<=0?"Lv.0":w>=t?"MAX":`Lv.${w}`}getTitaniumLiverHpBonus(){const w=this.playerSkills.get("passive_titanium_liver");return w?(w.level+1)*.1:0}getTitaniumLiverRegenInterval(){const w=this.playerSkills.get("passive_titanium_liver");return w?(15-w.level)*1e3:0}hasTitaniumLiver(){return this.playerSkills.has("passive_titanium_liver")}getSyncRateSpeedBonus(){const w=this.playerSkills.get("passive_sync_rate");return w?(w.level+1)*.1:0}getSyncRateCooldownReduction(){const w=this.playerSkills.get("passive_sync_rate");return w?(w.level+1)*.08:0}getRetinaModuleExpBonus(){const w=this.playerSkills.get("passive_retina_module");return w?(w.level+1)*.3:0}getAiEnhancementDamageBonus(){const w=this.playerSkills.get("passive_ai_enhancement");return w?(w.level+1)*.25:0}getAiEnhancementDefenseBonus(){const w=this.playerSkills.get("passive_ai_enhancement");return w?(w.level+1)*.15:0}calculateFinalMaxHp(w){const t=this.getTitaniumLiverHpBonus();return Math.floor(w*(1+t))}calculateFinalMoveSpeed(w){const t=this.getSyncRateSpeedBonus();return w*(1+t)}calculateFinalCooldown(w){const t=this.getSyncRateCooldownReduction();return w*(1-t)}calculateFinalExp(w){const t=this.getRetinaModuleExpBonus();return Math.floor(w*(1+t))}calculateFinalDamage(w){const t=this.getAiEnhancementDamageBonus();return Math.floor(w*(1+t))}calculateFinalDamageWithCrit(w,t){const s=this.getAiEnhancementDamageBonus();let e=Math.floor(w*(1+s));const i=this.getRetinaModuleCritChance(t);let a=!1;if(i>0&&Math.random()<i){a=!0;const n=1.5,o=this.getAiEnhancementCritDamage(t),r=n+o;e=Math.floor(e*r)}return{damage:e,isCrit:a}}calculateFinalDamageTaken(w){const t=this.getAiEnhancementDefenseBonus();return Math.floor(w*(1-t))}getMaxExtraAbilityValue(w,t){const s=this.playerSkills.get(w);if(!s||s.level<s.definition.maxLevel)return 0;const e=s.definition.maxExtraAbility;return e?e.baseValue+e.perLevel*t:0}getMaxExtraAbilityText(w,t){const s=this.playerSkills.get(w);if(!s||s.level<s.definition.maxLevel)return null;const e=s.definition.maxExtraAbility;if(!e)return null;const i=this.getMaxExtraAbilityValue(w,t),a=e.isPercentage?(i*100).toFixed(1):i.toFixed(1);return`【${e.name}】${e.description.replace("{value}",a+e.unit)}`}getAllMaxExtraAbilities(w){const t=[];return this.playerSkills.forEach((s,e)=>{const i=this.getMaxExtraAbilityText(e,w);i&&t.push({skillId:e,text:i})}),t}getSoulRenderWaveChance(w){return this.getMaxExtraAbilityValue("active_soul_render",w)}getCoderBurstChance(w){return this.getMaxExtraAbilityValue("active_coder",w)}getVfxChainChance(w){return this.getMaxExtraAbilityValue("active_vfx",w)}getArchitectExplosionChance(w){return this.getMaxExtraAbilityValue("active_architect",w)}hasTitaniumLiverRevive(){const w=this.playerSkills.get("passive_titanium_liver");return w?w.level>=w.definition.maxLevel:!1}getSyncRateDodgeChance(w){return this.getMaxExtraAbilityValue("passive_sync_rate",w)}getRetinaModuleCritChance(w){return this.getMaxExtraAbilityValue("passive_retina_module",w)}getAiEnhancementCritDamage(w){return this.getMaxExtraAbilityValue("passive_ai_enhancement",w)}areAllBasicSkillsMaxed(){const t=this.getActiveSkillDefinitions().every(a=>{const n=this.playerSkills.get(a.id);return n&&n.level>=a.maxLevel});if(this.getOwnedPassiveCount()<lt.MAX_PASSIVE_SLOTS)return!1;const e=this.getPassiveSkillDefinitions();let i=0;return e.forEach(a=>{const n=this.playerSkills.get(a.id);n&&n.level>=a.maxLevel&&i++}),t&&i>=lt.MAX_PASSIVE_SLOTS}getAvailableAdvancedSkills(){return ot.filter(w=>w.requiredSkills.every(s=>{const e=this.playerSkills.get(s);return e?e.level>=e.definition.maxLevel:!1}))}getUpgradeableAdvancedSkills(){return this.getAvailableAdvancedSkills().filter(w=>w.maxLevel<0?!0:(this.advancedSkillLevels.get(w.id)??0)<w.maxLevel)}getRandomAdvancedSkillOptions(){const w=this.getUpgradeableAdvancedSkills();if(this.equippedAdvancedSkillId){const s=w.find(e=>e.id===this.equippedAdvancedSkillId);if(s){const e=w.filter(a=>a.id!==this.equippedAdvancedSkillId),i=this.shuffleArray([...e]);return[s,...i.slice(0,2)]}}return this.shuffleArray([...w]).slice(0,3)}getEquippedAdvancedSkill(){if(!this.equippedAdvancedSkillId)return null;const w=ot.find(s=>s.id===this.equippedAdvancedSkillId);if(!w)return null;const t=this.advancedSkillLevels.get(this.equippedAdvancedSkillId)??0;return{definition:w,level:t}}getEquippedAdvancedSkillId(){return this.equippedAdvancedSkillId}setEquippedAdvancedSkill(w){const t=ot.find(e=>e.id===w);return!t||!t.requiredSkills.every(e=>{const i=this.playerSkills.get(e);return i?i.level>=i.definition.maxLevel:!1})?!1:(this.equippedAdvancedSkillId=w,!0)}getAdvancedSkillLevel(w){return this.advancedSkillLevels.get(w)??-1}upgradeAdvancedSkill(w){const t=ot.find(e=>e.id===w);if(!t)return!1;const s=this.advancedSkillLevels.get(w)??0;return t.maxLevel>=0&&s>=t.maxLevel?!1:(this.advancedSkillLevels.set(w,s+1),!0)}isAdvancedSkillMaxLevel(w){const t=ot.find(e=>e.id===w);return!t||t.maxLevel<0?!1:(this.advancedSkillLevels.get(w)??0)>=t.maxLevel}hasAnyAdvancedSkill(){return this.equippedAdvancedSkillId!==null}getAdvancedSkillDefinition(w){return ot.find(t=>t.id===w)}calculateAdvancedSkillCooldown(w){return this.calculateFinalCooldown(w)}getLearnedAdvancedSkills(){const w=[];for(const[t,s]of this.advancedSkillLevels.entries())if(s>0){const e=ot.find(i=>i.id===t);e&&w.push(e)}return w}stopAllSkills(){}};C(lt,"MAX_PASSIVE_SLOTS",3);let rt=lt;const ft=[{id:"slime",name:"史萊姆",color:6750054,speed:1,damage:1,size:.05,hp:30,exp:20},{id:"boss_slime",name:"BOSS 史萊姆",color:4856427,speed:.6,damage:3,size:.15,hp:30,exp:200},{id:"bat",name:"蝙蝠",color:8930474,speed:8,damage:.5,size:.025,hp:10,exp:5}],it=class it{constructor(w,t,s,e){C(this,"scene");C(this,"monsters",[]);C(this,"nextMonsterId",0);C(this,"clipMask",null);C(this,"spawnInterval",2e3);C(this,"lastSpawnTime",0);C(this,"isSpawning",!1);C(this,"batSwarmInterval",3e4);C(this,"lastBatSwarmTime",0);C(this,"batSwarmCount",8);C(this,"bossSpawnedAtLevels",new Set);C(this,"tauntTarget",{x:0,y:0,active:!1});C(this,"gameBounds");C(this,"mapWidth");C(this,"mapHeight");C(this,"playerLevel",0);C(this,"gridCellSize",4);C(this,"gridScaleMultiplier",3);C(this,"monsterGridContainer");C(this,"monsterGridCells",[]);C(this,"screenGridCols",0);C(this,"screenGridRows",0);C(this,"slowZone",{active:!1,centerX:0,centerY:0,radius:0,multiplier:1});this.scene=w,this.gameBounds=t,this.mapWidth=s,this.mapHeight=e,this.updateGridCellSize(),this.createMonsterGrid()}setPlayerLevel(w){return this.playerLevel=w,w>=10&&w%10===0&&!this.bossSpawnedAtLevels.has(w)?(this.bossSpawnedAtLevels.add(w),!0):!1}spawnBoss(w,t){const s=this.playerLevel,e=ft.find(m=>m.id==="boss_slime");if(!e)return;const i=["top","left","right"],a=i[Math.floor(Math.random()*i.length)];let n,o;const r=150,c=w,h=w+this.gameBounds.width,l=t;switch(a){case"top":n=c+Math.random()*this.gameBounds.width,o=l-r;break;case"left":n=c-r,o=l+Math.random()*this.gameBounds.height;break;case"right":n=h+r,o=l+Math.random()*this.gameBounds.height;break}const g=this.calculateMonsterHp(e.hp)*s,f={id:this.nextMonsterId++,definition:e,x:n,y:o,hp:g,lastDamageTime:0,bouncePhase:Math.random()*Math.PI*2,bounceSpeed:1.5+Math.random()*.5,squashStretch:1,flashStartTime:0,isBoss:!0,bossHpMultiplier:s};this.monsters.push(f)}setGridScaleMultiplier(w){this.gridScaleMultiplier=w,this.updateGridCellSize(),this.recreateMonsterGrid()}updateGridCellSize(){const w=this.scene.cameras.main.width,t=1920,s=20/this.gridScaleMultiplier,e=6/this.gridScaleMultiplier,i=Math.min(1,w/t);this.gridCellSize=Math.max(e,Math.floor(s*i))}setClipMask(w){this.clipMask=w,this.monsterGridContainer&&this.monsterGridContainer.setMask(w)}createMonsterGrid(){this.monsterGridContainer=this.scene.add.container(this.gameBounds.x,this.gameBounds.y),this.monsterGridContainer.setDepth(5),this.clipMask&&this.monsterGridContainer.setMask(this.clipMask),this.screenGridCols=Math.ceil(this.gameBounds.width/this.gridCellSize)+1,this.screenGridRows=Math.ceil(this.gameBounds.height/this.gridCellSize)+1;for(let w=0;w<this.screenGridRows;w++)for(let t=0;t<this.screenGridCols;t++){const s=t*this.gridCellSize,e=w*this.gridCellSize,i=this.scene.add.rectangle(s,e,this.gridCellSize,this.gridCellSize,0,0);i.setOrigin(0,0),i.setVisible(!1),this.monsterGridContainer.add(i),this.monsterGridCells.push({rect:i,screenCol:t,screenRow:w})}}recreateMonsterGrid(){this.monsterGridCells.forEach(w=>w.rect.destroy()),this.monsterGridCells=[],this.monsterGridContainer&&this.monsterGridContainer.destroy(),this.createMonsterGrid()}getHighLevelMultiplier(){return this.playerLevel<=70?1:1+.1*Math.floor((this.playerLevel-70)/5)}calculateMonsterHp(w){const t=w*Math.pow(it.HP_GROWTH_RATE,this.playerLevel);return Math.floor(t*this.getHighLevelMultiplier())}calculateMonsterDamage(w){const t=Math.max(1,this.playerLevel);return it.DAMAGE_UNIT*t*w.definition.damage*this.getHighLevelMultiplier()}calculateMonsterExp(w){const t=Math.floor(this.playerLevel/5);return w*Math.pow(2,t)}startSpawning(){this.isSpawning=!0,this.lastSpawnTime=this.scene.time.now,this.lastBatSwarmTime=this.scene.time.now}stopSpawning(){this.isSpawning=!1}hideAllMonsters(){this.monsterGridContainer&&this.monsterGridContainer.setVisible(!1)}update(w,t,s,e,i){const a=this.scene.time.now;let n=0;const o=[];if(this.isSpawning&&a-this.lastSpawnTime>=this.spawnInterval){const h=Math.min(this.playerLevel,70),l=1+Math.floor(h/5);for(let d=0;d<l;d++)this.spawnMonster(t,s,e,i);this.lastSpawnTime=a}this.isSpawning&&a-this.lastBatSwarmTime>=this.batSwarmInterval&&(this.spawnBatSwarm(e,i),this.lastBatSwarmTime=a);const r=this.gameBounds.height*.1,c=[];return this.monsters.forEach(h=>{const l=this.isMonsterStunned(h);if(h.isBat&&h.directionX!==void 0&&h.directionY!==void 0){if(!l){const p=this.getSlowMultiplier(h.x,h.y),x=h.definition.speed*this.gameBounds.height*.1*p*w/1e3;h.x+=h.directionX*x,h.y+=h.directionY*x}const d=this.gameBounds.height*.3,g=e-d,f=e+this.gameBounds.width+d,m=i-d,M=i+this.gameBounds.height+d;if((h.x<g||h.x>f||h.y<m||h.y>M)&&c.push(h.id),!l){const p=t-h.x,S=s-h.y;Math.sqrt(p*p+S*S)<=r&&a-h.lastDamageTime>=3e3&&(n+=this.calculateMonsterDamage(h),h.lastDamageTime=a,o.push(h))}}else if(!l){let d=t,g=s;this.tauntTarget.active&&(d=this.tauntTarget.x,g=this.tauntTarget.y);const f=d-h.x,m=g-h.y,M=Math.sqrt(f*f+m*m);if(M>r){const p=this.getSlowMultiplier(h.x,h.y),k=h.definition.speed*this.gameBounds.height*.1*p*w/1e3/M;h.x+=f*k,h.y+=m*k}else!this.tauntTarget.active&&a-h.lastDamageTime>=3e3&&(n+=this.calculateMonsterDamage(h),h.lastDamageTime=a,o.push(h))}if(l)h.squashStretch=1;else{h.bouncePhase+=h.bounceSpeed*w/1e3,h.bouncePhase>Math.PI*2&&(h.bouncePhase-=Math.PI*2);const d=.08;h.squashStretch=1+Math.sin(h.bouncePhase)*d}}),c.forEach(h=>{this.monsters=this.monsters.filter(l=>l.id!==h)}),this.renderMonstersToGrid(e,i),{damage:n,hitMonsters:o}}spawnMonster(w,t,s,e){const i=["top","left","right"],a=i[Math.floor(Math.random()*i.length)];let n,o;const r=100,c=s,h=s+this.gameBounds.width,l=e;switch(a){case"top":n=c+Math.random()*this.gameBounds.width,o=l-r;break;case"left":n=c-r,o=l+Math.random()*this.gameBounds.height;break;case"right":n=h+r,o=l+Math.random()*this.gameBounds.height;break}n=Phaser.Math.Clamp(n,0,this.mapWidth),o=Phaser.Math.Clamp(o,0,this.mapHeight);const d=ft[0],g=this.calculateMonsterHp(d.hp),f={id:this.nextMonsterId++,definition:d,x:n,y:o,hp:g,lastDamageTime:0,bouncePhase:Math.random()*Math.PI*2,bounceSpeed:3+Math.random()*2,squashStretch:1,flashStartTime:0};this.monsters.push(f)}spawnBatSwarm(w,t){const s=["topLeft","topRight","bottomLeft","bottomRight"],e=s[Math.floor(Math.random()*s.length)],i=w,a=w+this.gameBounds.width,n=t,o=t+this.gameBounds.height,r=this.gameBounds.height*.15;let c,h,l,d;switch(e){case"topLeft":c=i-r,h=n-r,l=a+r*2,d=o+r*2;break;case"topRight":c=a+r,h=n-r,l=i-r*2,d=o+r*2;break;case"bottomLeft":c=i-r,h=o+r,l=a+r*2,d=n-r*2;break;case"bottomRight":default:c=a+r,h=o+r,l=i-r*2,d=n-r*2;break}const g=ft.find(M=>M.id==="bat")||ft[0],f=[],m=this.gameBounds.height*.04;for(let M=0;M<this.batSwarmCount;M++){let p,S,x=0;const k=50;do{const b=Math.random()*Math.PI*2,P=Math.random()*r;if(p=c+Math.cos(b)*P,S=h+Math.sin(b)*P,x++,!f.some(R=>{const D=R.x-p,L=R.y-S;return Math.sqrt(D*D+L*L)<m})||x>=k)break}while(!0);f.push({x:p,y:S});const y=l-p,E=d-S,T=Math.sqrt(y*y+E*E),A=y/T,v=E/T,I={id:this.nextMonsterId++,definition:g,x:p,y:S,hp:it.BAT_FIXED_HP,lastDamageTime:0,bouncePhase:Math.random()*Math.PI*2,bounceSpeed:5+Math.random()*3,squashStretch:1,flashStartTime:0,isBat:!0,directionX:A,directionY:v};this.monsters.push(I)}}renderMonstersToGrid(w,t){const s=this.gridCellSize,e=this.scene.time.now,i=new Map;this.monsters.forEach(a=>{const n=this.gameBounds.height*a.definition.size,o=a.squashStretch,r=1/a.squashStretch,c=a.x-w,h=a.y-t,l=Math.floor(c/s),d=Math.floor(h/s),g=Math.ceil(n/s/2),f=Math.ceil(g*r),m=Math.ceil(g*o),M=a.definition.color;let p=M>>16&255,S=M>>8&255,x=M&255,k=!1;const y=300;if(a.flashStartTime>0){const P=e-a.flashStartTime;if(P<y){k=!0;const B=Math.floor(P/60)%2,R=P<y/2?1:1-(P-y/2)/(y/2);B===0?(p=Math.min(255,Math.floor(p+(255-p)*R)),S=Math.min(255,Math.floor(S+(255-S)*R)),x=Math.min(255,Math.floor(x+(255-x)*R))):(p=Math.min(255,Math.floor(p+(255-p)*R)),S=Math.floor(S*(1-R*.8)),x=Math.floor(x*(1-R*.8)))}else a.flashStartTime=0}if(this.isMonsterStunned(a)&&!k){const P=Math.floor((p+S+x)/3);p=Math.floor(P*.7+p*.3),S=Math.floor(P*.7+S*.3),x=Math.floor(P*.7+x*.3),p=Math.min(255,p+60),S=Math.min(255,S+60),x=Math.min(255,x+60)}if(a.isBat){const B=(Math.sin(a.bouncePhase*3)*.5+.5)*.8-.2,R=Math.max(2,Math.ceil(f*.6)),D=Math.max(2,Math.ceil(m*.8)),L=Math.max(3,Math.ceil(f*3)),G=Math.max(2,Math.ceil(m*1.5)),F=(O,N,Y,W)=>{if(O>=0&&O<this.screenGridCols&&N>=0&&N<this.screenGridRows){const K=`${O},${N}`,Q=i.get(K);(!Q||W>Q.alpha)&&i.set(K,{color:Y,alpha:W})}},_=p<<16|S<<8|x,X=Math.floor(p*.7)<<16|Math.floor(S*.7)<<8|Math.floor(x*.7),H=Math.floor(p*.5)<<16|Math.floor(S*.5)<<8|Math.floor(x*.5);for(let O=-D;O<=D;O++)for(let N=-R;N<=R;N++){const Y=N/R,W=O/D;Y*Y+W*W<=1&&F(l+N,d+O,_,.95)}const z=Math.max(1,Math.floor(R*.6)),V=Math.max(1,Math.floor(D*.6));for(let O=0;O<=V;O++){const N=Math.max(1,V-O);for(let Y=0;Y<N;Y++)F(l-z+Y,d-D-O-1,_,.9)}for(let O=0;O<=V;O++){const N=Math.max(1,V-O);for(let Y=0;Y<N;Y++)F(l+z-Y,d-D-O-1,_,.9)}for(let O=1;O<=L;O++){const N=O/L,Y=Math.floor(G*N*(1-N*.3)),W=Math.floor(B*N*G),K=-Y+W,Q=Math.floor(Y*.3)+W;for(let q=K;q<=Q;q++){const j=Math.floor(Math.sin(N*Math.PI*2+a.bouncePhase)*.5),st=.85-N*.3,et=q<(K+Q)/2?X:H;F(l-R-O,d+q+j,et,st)}if(O%2===0&&O<L-1){const q=Math.floor((K+Q)/2+W);F(l-R-O,d+q,_,.9)}}for(let O=1;O<=L;O++){const N=O/L,Y=Math.floor(G*N*(1-N*.3)),W=Math.floor(B*N*G),K=-Y+W,Q=Math.floor(Y*.3)+W;for(let q=K;q<=Q;q++){const j=Math.floor(Math.sin(N*Math.PI*2+a.bouncePhase)*.5),st=.85-N*.3,et=q<(K+Q)/2?X:H;F(l+R+O,d+q+j,et,st)}if(O%2===0&&O<L-1){const q=Math.floor((K+Q)/2+W);F(l+R+O,d+q,_,.9)}}const Z=d-Math.floor(D*.3),$=Math.max(1,Math.floor(R*.4));F(l-$,Z,16711680,1),F(l+$,Z,16711680,1);return}else{for(let P=-m;P<=0;P++)for(let B=-f;B<=f;B++){const R=B/f,D=P/m,L=R*R+D*D;if(L<=1.1){const F=(.5+(1-Math.pow(Math.min(1,L),.5))*.5)*(L<=1?1:(1.1-L)/.1),_=k?1:1+(1-D)*.4,X=Math.min(255,Math.floor(p*_)),H=Math.min(255,Math.floor(S*_)),z=Math.min(255,Math.floor(x*_)),V=X<<16|H<<8|z,Z=l+B,$=d+P;if(Z>=0&&Z<this.screenGridCols&&$>=0&&$<this.screenGridRows){const O=`${Z},${$}`,N=i.get(O);(!N||F>N.alpha)&&i.set(O,{color:V,alpha:F})}}}for(let P=-f;P<=f;P++){const B=P/f;if(Math.abs(B)<=1){const R=k?1:.7,D=Math.floor(p*R),L=Math.floor(S*R),G=Math.floor(x*R),F=D<<16|L<<8|G,_=l+P,X=d;if(_>=0&&_<this.screenGridCols&&X>=0&&X<this.screenGridRows){const H=`${_},${X}`;i.set(H,{color:F,alpha:.9})}}}}const T=Math.max(1,Math.floor(f*.35)),A=Math.floor(m*.5),v=l-T,I=l+T,b=d-A;if(v>=0&&v<this.screenGridCols&&b>=0&&b<this.screenGridRows&&i.set(`${v},${b}`,{color:0,alpha:1}),I>=0&&I<this.screenGridCols&&b>=0&&b<this.screenGridRows&&i.set(`${I},${b}`,{color:0,alpha:1}),!k){const P=Math.floor(f*.4),B=Math.floor(m*.7),R=l-P,D=d-B;R>=0&&R<this.screenGridCols&&D>=0&&D<this.screenGridRows&&i.set(`${R},${D}`,{color:16777215,alpha:.8})}});for(const a of this.monsterGridCells){const n=`${a.screenCol},${a.screenRow}`,o=i.get(n);o?(a.rect.setFillStyle(o.color,o.alpha),a.rect.setVisible(!0)):a.rect.setVisible(!1)}}removeMonster(w){const t=this.monsters.findIndex(s=>s.id===w);t!==-1&&this.monsters.splice(t,1)}getMonsters(){return this.monsters}clearAllMonsters(){this.monsters=[]}setSpawnInterval(w){this.spawnInterval=w}damageMonster(w,t){const s=this.monsters.find(e=>e.id===w);if(!s)return{killed:!1,exp:0};if(s.hp-=t,this.flashMonster(s),s.hp<=0){const e=s.isBat?it.BAT_FIXED_EXP:this.calculateMonsterExp(s.definition.exp);return this.playDeathSmoke(s.x,s.y),this.removeMonster(w),{killed:!0,exp:e}}return{killed:!1,exp:0}}flashMonster(w){w.flashStartTime=this.scene.time.now}playDeathSmoke(w,t){const s=this.scene;s.flashDeathEffect&&s.flashDeathEffect(w,t)}damageMonsters(w,t){let s=0,e=0;const i=[];for(const a of w){const n=this.monsters.find(c=>c.id===a),o=n?{x:n.x,y:n.y}:null,r=this.damageMonster(a,t);r.killed&&o&&(s+=r.exp,e++,i.push(o))}return{totalExp:s,killCount:e,killedPositions:i}}stunMonsters(w,t){const e=this.scene.time.now+t;for(const i of w){const a=this.monsters.find(n=>n.id===i);a&&(a.stunEndTime=Math.max(a.stunEndTime||0,e))}}knockbackMonsters(w,t,s,e){for(const i of w){const a=this.monsters.find(n=>n.id===i);if(a){const n=a.x-t,o=a.y-s,r=Math.sqrt(n*n+o*o);if(r>0){const c=n/r,h=o/r;a.x+=c*e,a.y+=h*e;const l=this.mapWidth/2,d=this.mapHeight/2;a.x=Math.max(-l,Math.min(l,a.x)),a.y=Math.max(-d,Math.min(d,a.y))}}}}isMonsterStunned(w){return w.stunEndTime?this.scene.time.now<w.stunEndTime:!1}setTauntTarget(w,t,s){this.tauntTarget={x:w,y:t,active:s}}clearTauntTarget(){this.tauntTarget.active=!1}setSlowZone(w,t,s,e){this.slowZone={active:!0,centerX:w,centerY:t,radius:s,multiplier:e}}clearSlowZone(){this.slowZone.active=!1}getSlowMultiplier(w,t){if(!this.slowZone.active)return 1;const s=w-this.slowZone.centerX,e=t-this.slowZone.centerY,i=Math.sqrt(s*s+e*e),a=this.slowZone.radius*this.gameBounds.height*.1;return i<=a?this.slowZone.multiplier:1}getTauntTarget(){return this.tauntTarget}};C(it,"BAT_FIXED_HP",10),C(it,"BAT_FIXED_EXP",5),C(it,"HP_GROWTH_RATE",1.1),C(it,"DAMAGE_UNIT",10);let kt=it;const u=class u extends U.Scene{constructor(){super("MainScene");C(this,"character");C(this,"characterState","idle");C(this,"facingRight",!0);C(this,"skillIcons",[]);C(this,"skillIconGridGraphics",[]);C(this,"skillIconGridData",[]);C(this,"gameBounds");C(this,"boundsBorder");C(this,"background");C(this,"gameAreaContainer");C(this,"revealMask");C(this,"mapWidth");C(this,"mapHeight");C(this,"characterX");C(this,"characterY");C(this,"characterSize");C(this,"isPointerDown",!1);C(this,"moveDirX",0);C(this,"moveDirY",0);C(this,"baseMoveSpeed",0);C(this,"moveSpeed",0);C(this,"floorGrid");C(this,"floorHexContainer");C(this,"floorHexChars",[]);C(this,"floorHexUsedPositions",new Set);C(this,"floorHexPool",[]);C(this,"scanLineX",-1);C(this,"scanLineActive",!1);C(this,"lastScanTime",-25e3);C(this,"circularScanRadius",0);C(this,"circularScanActive",!1);C(this,"lastCircularScanTime",-5e3);C(this,"damageScanRings",[]);C(this,"shieldBreathScan",{phase:"idle",radius:0,targetRadius:0});C(this,"levelUpBreathScan",{phase:"idle",radius:0,targetRadius:0});C(this,"radiusWaves",[]);C(this,"lastRadiusWaveTime",0);C(this,"gameOverActive",!1);C(this,"gameOverSprites",[]);C(this,"gameOverBreathScan",{phase:"idle",radius:0,targetRadius:0});C(this,"worldContainer");C(this,"characterContainer");C(this,"uiContainer");C(this,"cameraOffsetX",0);C(this,"cameraOffsetY",0);C(this,"cursors");C(this,"isKeyboardMoving",!1);C(this,"skillPanelContainer");C(this,"isPaused",!1);C(this,"popupPaused",!1);C(this,"isSkillSelecting",!1);C(this,"skillOptions",[]);C(this,"keyOne");C(this,"keyTwo");C(this,"keyThree");C(this,"skillCardBgs",[]);C(this,"gameTimer",0);C(this,"totalDamageReceived",0);C(this,"timerText");C(this,"selectedSkillIndex",0);C(this,"currentSkillChoices",[]);C(this,"skillCutInContainer");C(this,"skillManager",new rt);C(this,"skillIconContainers",[]);C(this,"skillLevelTexts",[]);C(this,"skillIconSprites",[]);C(this,"advancedSkillContainer");C(this,"advancedSkillSlotVisible",!1);C(this,"advancedSkillIconSprite",null);C(this,"advancedSkillLevelText");C(this,"advancedSkillGridGraphics");C(this,"advancedSkillGridData");C(this,"advancedSkillHue",0);C(this,"advancedSkillCooldownTime",0);C(this,"isSelectingAdvancedSkill",!1);C(this,"currentAdvancedSkillChoices",[]);C(this,"mixedSkillTypes",[]);C(this,"mixedNormalIndices",[]);C(this,"mixedAdvancedIndices",[]);C(this,"sawBladeAngle",0);C(this,"sawBladeSpinAngle",0);C(this,"sawBladeSprites",[]);C(this,"sawBladeLastHitTime",new Map);C(this,"currentSawBladePositions",[]);C(this,"sawBladeRadius",0);C(this,"perfectPixelLineSprites",[]);C(this,"perfectPixelFocusIndex",0);C(this,"perfectPixelLineAlpha",0);C(this,"zeroTrustActive",!1);C(this,"zeroTrustSprite");C(this,"zeroTrustTrackedMonsters",new Set);C(this,"zeroTrustPoints",[]);C(this,"phantoms",[]);C(this,"nextPhantomId",0);C(this,"phantomSawBladeActive",new Set);C(this,"globalChainRayTimer");C(this,"skillInfoPanel");C(this,"skillInfoBg");C(this,"skillInfoText");C(this,"skillInfoHideTimer");C(this,"currentExp",0);C(this,"maxExp",100);C(this,"currentLevel",0);C(this,"expBarContainer");C(this,"expBarFlowOffset",0);C(this,"levelText");C(this,"currentHp",200);C(this,"maxHp",200);C(this,"hpBarContainer");C(this,"hpBarFlowOffset",0);C(this,"hpText");C(this,"currentShield",0);C(this,"maxShield",0);C(this,"shieldBarFlowOffset",0);C(this,"shieldReflectDamage",0);C(this,"shieldText");C(this,"shieldAuraGraphics");C(this,"shieldSparkleTimer",0);C(this,"shieldGroundSprite",null);C(this,"hpRegenTimer",0);C(this,"reviveUsed",!1);C(this,"displayedHp",200);C(this,"hpDamageDelay",0);C(this,"isMobile",!1);C(this,"keyPlus");C(this,"keyMinus");C(this,"keyShift");C(this,"keyCtrl");C(this,"keyZero");C(this,"keyBackspace");C(this,"keyF5");C(this,"keyF6");C(this,"keyF7");C(this,"keyF8");C(this,"keyF9");C(this,"keyF10");C(this,"keyF11");C(this,"keyF12");C(this,"showGridSkillEffects",!1);C(this,"monsterManager");C(this,"isHurt",!1);C(this,"hurtEndTime",0);C(this,"lowHpBreathTimer",0);C(this,"isLowHp",!1);C(this,"vignetteEdgeCells",new Set);C(this,"skillCooldowns",new Map);C(this,"isAttacking",!1);C(this,"attackEndTime",0);C(this,"gameBgm");C(this,"currentBgmKey","");C(this,"skillGridContainer");C(this,"skillGridCells",[]);C(this,"skillGridCols",0);C(this,"skillGridRows",0);C(this,"skillGridCellSize",10);C(this,"gridScaleMultiplier",3);C(this,"activeSkillGridCells",new Set);C(this,"skillEffectPool",[]);C(this,"activeSkillEffects",[]);C(this,"lineEffectPool",[]);C(this,"activeLineEffects",[]);C(this,"circleLineEffectPool",[]);C(this,"activeCircleLineEffects",[])}create(){this.cameras.main.setBackgroundColor("#111111"),this.isMobile=this.sys.game.device.input.touch&&window.innerWidth<1024,this.gridScaleMultiplier=3;const t=this.cameras.main.width,s=this.cameras.main.height;if(this.gameBounds=this.registry.get("gameBounds"),!this.gameBounds){const o=t*.9,r=s*(1-.05*2),c=16/9,h=o/r;let l,d;h>c?(d=r,l=r*c):(l=o,d=o/c),this.gameBounds={x:(t-l)/2,y:(s-d)/2,width:l,height:d}}this.mapWidth=this.gameBounds.width*u.MAP_SCALE,this.mapHeight=this.gameBounds.height*u.MAP_SCALE,this.characterSize=this.gameBounds.height*.15,this.baseMoveSpeed=this.gameBounds.height*.3,this.moveSpeed=this.baseMoveSpeed,this.characterX=this.mapWidth/2,this.characterY=this.mapHeight/2,this.createFullscreenBackground(t,s),this.gameAreaContainer=this.add.container(0,0),this.gameAreaContainer.setDepth(0),this.drawGameBorder(),this.worldContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.floorGrid=this.add.graphics(),this.drawFloorGrid(),this.worldContainer.add(this.floorGrid),this.floorHexContainer=this.add.container(0,0),this.worldContainer.add(this.floorHexContainer),this.createCharacterAnimations(),this.characterContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.shieldAuraGraphics=this.add.graphics(),this.characterContainer.add(this.shieldAuraGraphics),this.character=this.add.sprite(this.characterX,this.characterY,"char_idle_1"),this.character.setScale(this.characterSize/this.character.height),this.character.setOrigin(.5,1),this.character.play("char_idle"),this.characterContainer.add(this.character),this.gameAreaContainer.add([this.boundsBorder,this.worldContainer]);const e=this.make.graphics({x:0,y:0});e.fillStyle(16777215),e.fillRect(this.gameBounds.x,this.gameBounds.y,this.gameBounds.width,this.gameBounds.height);const i=e.createGeometryMask();this.worldContainer.setMask(i),this.uiContainer=this.add.container(0,0),this.uiContainer.setDepth(100),this.monsterManager=new kt(this,this.gameBounds,this.mapWidth,this.mapHeight),this.monsterManager.setGridScaleMultiplier(this.gridScaleMultiplier),this.monsterManager.setClipMask(i),this.createSkillGrid(),this.initSkillEffectPool(),this.initLineEffectPool(),this.initCircleLineEffectPool(),window.addEventListener("gridscalechange",n=>{this.gridScaleMultiplier=n.detail.scale,this.recreateSkillGrid(),this.monsterManager.setGridScaleMultiplier(n.detail.scale)}),window.addEventListener("popupStateChange",n=>{this.popupPaused=n.detail.open}),this.characterContainer.setDepth(60),this.characterContainer.setMask(i),this.uiContainer.add(this.characterContainer),this.createSkillBar(),this.revealMask=this.make.graphics({x:0,y:0});const a=this.revealMask.createGeometryMask();this.gameAreaContainer.setMask(a),this.uiContainer.setMask(a),this.registry.events.on("reveal-update",this.updateRevealMask,this),this.registry.events.on("reveal-complete",this.onRevealComplete,this),this.input.on("pointerdown",this.onPointerDown,this),this.input.on("pointermove",this.onPointerMove,this),this.input.on("pointerup",this.onPointerUp,this),this.input.keyboard&&(this.cursors={W:this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.W),A:this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.A),S:this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.S),D:this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.D)},this.keyOne=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.ONE),this.keyTwo=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.TWO),this.keyThree=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.THREE),this.keyPlus=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.PLUS),this.keyMinus=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.MINUS),this.keyShift=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.SHIFT),this.keyCtrl=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.CTRL),this.keyZero=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.ZERO),this.keyBackspace=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.BACKSPACE),this.keyF5=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.F5),this.keyF6=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.F6),this.keyF7=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.F7),this.keyF8=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.F8),this.keyF9=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.F9),this.keyF10=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.F10),this.keyF11=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.F11),this.keyF12=this.input.keyboard.addKey(U.Input.Keyboard.KeyCodes.F12)),this.updateCamera(!0),this.createHpBar(),this.createShieldBar(),this.createExpBar(),this.createSkillPanel(),this.createSkillCutIn(),this.createLowHpVignette()}update(t,s){if(this.isPaused||this.popupPaused){this.updateHpBarFlow(s),this.updateShieldBarFlow(s),this.updateExpBarFlow(s),this.updateShieldAura(s),this.updateLowHpVignetteBreathing(s),this.updateSkillCooldownDisplay(),this.handleSkillPanelInput();return}this.updateHpBarFlow(s),this.updateShieldBarFlow(s),this.updateExpBarFlow(s),this.updateShieldAura(s),this.updateHpRegen(s),this.updateLowHpVignetteBreathing(s),this.updateSkillCooldownDisplay(),this.updateAdvancedSkillCooldown(s),this.updatePhantomVisual(s),this.updateZeroTrustVisual(s),this.updateFloorHexChars(),this.gameTimer+=s,this.updateTimerDisplay(),this.handleExpTestInput();const e=this.time.now;this.isHurt&&e>=this.hurtEndTime&&(this.isHurt=!1,this.setCharacterState("idle"),this.updateCharacterSprite()),this.isAttacking&&e>=this.attackEndTime&&(this.isAttacking=!1,this.character.clearTint(),this.isPointerDown||this.isKeyboardMoving?this.setCharacterState("run",!0):this.setCharacterState("idle",!0)),this.isHurt||(this.handleKeyboardInput(s),this.isPointerDown&&!this.isKeyboardMoving&&this.moveCharacter(s));const i=this.monsterManager.update(s,this.characterX,this.characterY,this.cameraOffsetX,this.cameraOffsetY);i.damage>0&&this.takeDamage(i.damage,i.hitMonsters),this.tryActivateSkills(e)}tryActivateSkills(t){if(this.isHurt||this.gameOverActive||this.popupPaused)return;const s=this.skillManager.getPlayerActiveSkills();for(const e of s){if(!e)continue;const i=e.definition;let a=i.cooldown||1e3;i.id==="active_architect"&&(a=a-e.level*500);const n=this.skillManager.calculateFinalCooldown(a),o=this.skillCooldowns.get(i.id)||0;t-o>=n&&(this.activateSkill(e,t),this.skillCooldowns.set(i.id,t))}}activateSkill(t,s){const e=t.definition;switch(this.isAttacking=!0,this.attackEndTime=s+u.ATTACK_DURATION,this.setCharacterState("attack",!0),e.flashColor&&this.character.setTint(e.flashColor),e.id){case"active_soul_render":this.activateSoulRender(t);break;case"active_coder":this.activateCoder(t);break;case"active_vfx":this.activateVfx(t);break;case"active_architect":this.activateArchitect(t);break}}activateSoulRender(t){const s=this.monsterManager.getMonsters();if(s.length===0)return;let e=s[0],i=1/0;for(const M of s){const p=M.x-this.characterX,S=M.y-this.characterY,x=Math.sqrt(p*p+S*S);x<i&&(i=x,e=M)}const a=Math.atan2(e.y-this.characterY,e.x-this.characterX);this.facingRight=Math.cos(a)>=0,this.updateCharacterSprite();const n=this.gameBounds.height*.3,r=(60+t.level*10)/2*(Math.PI/180),c=2+t.level,h=u.DAMAGE_UNIT*c,{damage:l,isCrit:d}=this.skillManager.calculateFinalDamageWithCrit(h,this.currentLevel),g=[];for(const M of s){const p=this.gameBounds.height*M.definition.size*.5,S=M.x-this.characterX,x=M.y-this.characterY,k=Math.sqrt(S*S+x*x);if(k-p>n)continue;let E=Math.atan2(x,S)-a;for(;E>Math.PI;)E-=Math.PI*2;for(;E<-Math.PI;)E+=Math.PI*2;const T=k>0?Math.atan2(p,k):Math.PI;Math.abs(E)<=r+T&&g.push(M.id)}this.drawSectorEdge(a,n,r,t.definition.color);const f=t.definition.flashColor||t.definition.color;if(this.showGridSkillEffects)this.flashSkillAreaSector(this.characterX,this.characterY,n,a,r,f);else{const M=r*(180/Math.PI);this.flashSkillEffectSector(this.characterX,this.characterY,n,a,M,f)}if(g.length>0){const M=s.filter(S=>g.includes(S.id)),p=this.monsterManager.damageMonsters(g,l);p.totalExp>0&&this.addExp(p.totalExp),this.shakeScreen(g.length);for(const S of M){const x=Math.atan2(S.y-this.characterY,S.x-this.characterX);this.showHitSparkEffect(S.x,S.y,6724095,x,4)}}const m=this.skillManager.getSoulRenderWaveChance(this.currentLevel);m>0&&Math.random()<m&&this.triggerSoulRenderWave(a,n,r,l,t)}drawSectorEdge(t,s,e,i){const a=t-e,n=t+e,o=this.characterX,r=this.characterY,c=500,h=300,l=s,d=24,g=p=>{const S=this.worldToScreen(o,r),x=S.x+Math.cos(p)*(l/2),k=S.y+Math.sin(p)*(l/2),y=this.add.sprite(x,k,u.TEXTURE_LINE);return this.skillGridContainer.add(y),y.setDepth(55),y.setTint(16777215),y.setRotation(p),y.setScale(l/u.EFFECT_TEXTURE_SIZE,d/u.EFFECT_LINE_HEIGHT),y.setAlpha(.9),y},f=g(a),m=g(n);this.tweens.add({targets:[f,m],alpha:0,delay:h,duration:c-h,ease:"Power2",onUpdate:()=>{const p=this.worldToScreen(o,r),S=p.x+Math.cos(a)*(l/2),x=p.y+Math.sin(a)*(l/2),k=p.x+Math.cos(n)*(l/2),y=p.y+Math.sin(n)*(l/2);f.setPosition(S,x),m.setPosition(k,y)},onComplete:()=>{f.destroy(),m.destroy()}});const M=this.time.addEvent({delay:16,callback:()=>{if(!f.active||!m.active)return;const p=this.worldToScreen(o,r),S=p.x+Math.cos(a)*(l/2),x=p.y+Math.sin(a)*(l/2),k=p.x+Math.cos(n)*(l/2),y=p.y+Math.sin(n)*(l/2);f.setPosition(S,x),m.setPosition(k,y)},callbackScope:this,repeat:Math.ceil(h/16)});this.time.delayedCall(c+50,()=>{M.remove(),f.active&&f.destroy(),m.active&&m.destroy()})}drawCircleEdge(t,s,e,i){const a=e??this.characterX,n=i??this.characterY,o=500,r=300,c=this.getCircleLineEffectSprite(),h=t*2/u.EFFECT_TEXTURE_SIZE;c.setScale(h),c.setTint(16777215),c.setAlpha(1),c.setRotation(0);const l=this.time.now,d=Math.PI*2,g=()=>{const m=this.time.now-l,M=Math.min(m/o,1),p=this.worldToScreen(a,n);c.setPosition(p.x,p.y);let S=1;m>r&&(S=1-(m-r)/(o-r)),c.setAlpha(S);let x;if(M<.8)x=M*o/1e3*d;else{const k=.8*o/1e3*d,E=(M-.8)/.2*.2*o/1e3*d*3;x=k+E}c.setRotation(x),M>=1&&this.releaseCircleLineEffectSprite(c)};g();const f=this.time.addEvent({delay:16,callback:g,callbackScope:this,repeat:Math.ceil(o/16)});this.time.delayedCall(o+50,()=>{f.remove(),c.active&&c.visible&&this.releaseCircleLineEffectSprite(c)})}drawBeamEdge(t,s,e,i,a,n){const o=this.add.graphics();this.worldContainer.add(o);const r=a??this.characterX,c=n??this.characterY,h=Math.cos(t),l=Math.sin(t),d=800,g=380,f=this.time.now,m=20,M=()=>{const S=this.time.now-f,x=Math.min(S/d,1);o.clear();let k=0;S>g&&(k=(S-g)/(d-g));const y=.6*(1-k*.5);if(y>.01)for(let E=0;E<m;E++){const T=E/m,A=(E+1)/m,v=(T+A)/2,I=Math.min(1,v/.15),b=Math.min(1,(1-v)/.15),P=Math.min(I,b),B=y*P*P;if(B>.01){const R=r+h*s*T,D=c+l*s*T,L=r+h*s*A,G=c+l*s*A;o.lineStyle(2,16777215,B),o.beginPath(),o.moveTo(R,D),o.lineTo(L,G),o.strokePath()}}x>=1&&o.destroy()};M();const p=this.time.addEvent({delay:16,callback:M,callbackScope:this,repeat:Math.ceil(d/16)});this.time.delayedCall(d+50,()=>{o.active&&o.destroy(),p.remove()})}activateCoder(t){const s=this.monsterManager.getMonsters();if(s.length===0)return;const e=this.gameBounds.height*.1,i=2+t.level*.5,a=e*i,n=(1+t.level)*2,o=u.DAMAGE_UNIT*n,{damage:r,isCrit:c}=this.skillManager.calculateFinalDamageWithCrit(o,this.currentLevel),h=[];for(const d of s){const g=this.gameBounds.height*d.definition.size*.5,f=d.x-this.characterX,m=d.y-this.characterY;Math.sqrt(f*f+m*m)-g<=a&&h.push(d.id)}this.drawCircleEdge(a,t.definition.color);const l=t.definition.flashColor||t.definition.color;if(this.showGridSkillEffects?this.flashSkillAreaCircle(this.characterX,this.characterY,a,l):this.flashSkillEffectCircle(this.characterX,this.characterY,a,l),h.length>0){const d=s.filter(m=>h.includes(m.id)),g=this.monsterManager.damageMonsters(h,r);g.totalExp>0&&this.addExp(g.totalExp),this.shakeScreen(h.length);for(const m of d){const M=this.worldToScreen(m.x,m.y);this.showExplosionSparkEffect(M.x,M.y,11167487,.8)}const f=this.skillManager.getCoderBurstChance(this.currentLevel);f>0&&g.killedPositions.length>0&&this.triggerCoderBurst(g.killedPositions,a,r,t,f)}}triggerSoulRenderWave(t,s,e,i,a){const n=this.gameBounds.height*.1,o=n*5,r=s*e*2,c=a.definition.flashColor||a.definition.color,h=this.characterX,l=this.characterY;this.showGridSkillEffects?this.flashSkillAreaSectorMoving(h,l,s,t,e,c,o):this.flashSkillEffectSectorMoving(h,l,s,t,e,c,o);const d=1e3,g=300,f=n*1,m=M=>{const p=s+o*M,S=r/(2*p),x=this.monsterManager.getMonsters(),k=[];for(const y of x){const E=this.gameBounds.height*y.definition.size*.5,T=y.x-h,A=y.y-l,v=Math.sqrt(T*T+A*A);if(Math.abs(v-p)>f+E)continue;let b=Math.atan2(A,T)-t;for(;b>Math.PI;)b-=Math.PI*2;for(;b<-Math.PI;)b+=Math.PI*2;const P=v>0?Math.atan2(E,v):Math.PI;Math.abs(b)<=S+P&&k.push(y.id)}if(k.length>0){const y=x.filter(T=>k.includes(T.id)),E=this.monsterManager.damageMonsters(k,i);E.totalExp>0&&this.addExp(E.totalExp),this.shakeScreen(k.length);for(const T of y){const A=Math.atan2(T.y-l,T.x-h);this.showHitSparkEffect(T.x,T.y,6724095,A,3)}}};for(let M=g;M<=d;M+=g){const p=M/d;this.time.delayedCall(M,()=>{m(p)})}}flashSkillAreaSectorMoving(t,s,e,i,a,n,o){const r=this.worldToScreen(t,s),c=r.x,h=r.y,l=u.SKILL_GRID_GAP,d=this.skillGridCellSize+l,g=1e3,f=this.time.now,m=Math.cos(i),M=Math.sin(i),p=e+o+e,S=[],x=Math.max(0,Math.floor((c-p)/d)),k=Math.min(this.skillGridCols-1,Math.ceil((c+p)/d)),y=Math.max(0,Math.floor((h-p)/d)),E=Math.min(this.skillGridRows-1,Math.ceil((h+p)/d));for(let v=y;v<=E;v++)for(let I=x;I<=k;I++){const b=I*d+this.skillGridCellSize/2,P=v*d+this.skillGridCellSize/2;S.push({col:I,row:v,screenX:b,screenY:P})}if(S.length===0)return;const T=[];for(const{col:v,row:I}of S){const b=v*d+this.skillGridCellSize/2,P=I*d+this.skillGridCellSize/2,B=this.add.rectangle(b,P,this.skillGridCellSize,this.skillGridCellSize,n,0);B.setVisible(!1),this.skillGridContainer.add(B),T.push(B)}const A=()=>{const v=this.time.now-f,I=Math.min(v/g,1),b=o*I,P=c+m*b,B=h+M*b,R=.5,D=I>R?(I-R)/(1-R):0;let L=0;for(const{screenX:G,screenY:F}of S){const _=T[L++];if(!_)continue;const X=G-P,H=F-B,z=Math.sqrt(X*X+H*H),V=e*.5;if(z>=V&&z<=e){let $=Math.atan2(H,X)-i;for(;$>Math.PI;)$-=Math.PI*2;for(;$<-Math.PI;)$+=Math.PI*2;if(Math.abs($)<=a){const O=(z-V)/(e-V),N=Math.abs($)/a,Y=Math.max(O,N),W=Math.max(0,Math.min(1,(Y-.3)/.7)),K=W*W*(3-2*W),q=(.15+K*.6)*(1-D);if(q>.01){const j=.5+K*.5,st=n>>16&255,et=n>>8&255,pt=n&255,ht=Math.floor(st*j),ct=Math.floor(et*j),dt=Math.floor(pt*j),at=ht<<16|ct<<8|dt;_.setFillStyle(at,q),_.setVisible(!0)}else _.setVisible(!1)}else _.setVisible(!1)}else _.setVisible(!1)}if(I>=1)for(const G of T)G.destroy();else this.time.delayedCall(16,A)};A()}triggerCoderBurst(t,s,e,i,a){const n=this.monsterManager.getMonsters();if(n.length===0)return;const o=s*.5;for(const r of t){if(Math.random()>=a)continue;const c=[];for(const l of n){const d=this.gameBounds.height*l.definition.size*.5,g=l.x-r.x,f=l.y-r.y;Math.sqrt(g*g+f*f)-d<=o&&c.push(l.id)}this.drawCircleEdge(o,i.definition.color,r.x,r.y);const h=i.definition.flashColor||i.definition.color;if(this.showGridSkillEffects?this.flashSkillAreaCircle(r.x,r.y,o,h):this.flashSkillEffectCircle(r.x,r.y,o,h),c.length>0){n.filter(d=>c.includes(d.id)).map(d=>({x:d.x,y:d.y}));const l=this.monsterManager.damageMonsters(c,e);l.totalExp>0&&this.addExp(l.totalExp)}}}activateVfx(t){const s=this.monsterManager.getMonsters();if(s.length===0)return;const e=t.level>=t.definition.maxLevel,i=e?3:t.level+1,a=e?this.gameBounds.height*1.5:this.gameBounds.height*1,n=e?this.gameBounds.height*.5:this.gameBounds.height*.05,o=1+t.level,r=u.DAMAGE_UNIT*o,{damage:c,isCrit:h}=this.skillManager.calculateFinalDamageWithCrit(r,this.currentLevel),l=new Set,d=[];if(e){const f=s.map(M=>{const p=M.x-this.characterX,S=M.y-this.characterY;return{monster:M,dist:Math.sqrt(p*p+S*S)}});f.sort((M,p)=>M.dist-p.dist);const m=Math.min(i,f.length);for(let M=0;M<m;M++){const p=f[M].monster,S=Math.atan2(p.y-this.characterY,p.x-this.characterX);d.push(S)}}else{const f=s.map((m,M)=>M);for(let m=0;m<i;m++){let M;if(f.length>0){const p=Math.floor(Math.random()*f.length),S=f[p];f.splice(p,1);const x=s[S];M=Math.atan2(x.y-this.characterY,x.x-this.characterX)}else M=Math.random()*Math.PI*2;d.push(M)}}for(const f of d){for(const S of s){const x=this.gameBounds.height*S.definition.size*.5,k=S.x-this.characterX,y=S.y-this.characterY;if(Math.sqrt(k*k+y*y)-x>a)continue;const T=Math.cos(f),A=Math.sin(f);if(k*T+y*A<-x)continue;Math.abs(k*A-y*T)<=n/2+x&&l.add(S.id)}this.drawBeamEdge(f,a,n,t.definition.color);const m=this.characterX+Math.cos(f)*a,M=this.characterY+Math.sin(f)*a,p=t.definition.flashColor||t.definition.color;this.showGridSkillEffects?this.flashSkillAreaLine(this.characterX,this.characterY,m,M,n,p):this.flashSkillEffectLine(this.characterX,this.characterY,m,M,n,p)}d.length>0&&(this.facingRight=Math.cos(d[0])>=0,this.updateCharacterSprite());const g=Array.from(l);if(g.length>0){const f=s.filter(S=>g.includes(S.id)),m=f.map(S=>({x:S.x,y:S.y})),M=this.monsterManager.damageMonsters(g,c);M.totalExp>0&&this.addExp(M.totalExp),this.shakeScreen(g.length);for(const S of f){const x=Math.atan2(S.y-this.characterY,S.x-this.characterX);this.showHitSparkEffect(S.x,S.y,6750054,x,5)}const p=this.skillManager.getVfxChainChance(this.currentLevel);p>0&&m.length>0&&this.triggerVfxChain(m,c,p,t)}}triggerVfxChain(t,s,e,i){if(Math.random()>=e)return;const a=this.monsterManager.getMonsters();if(a.length===0)return;const n=this.gameBounds.height*1.5,o=this.gameBounds.height*.5,r=i.definition.flashColor||i.definition.color,c=a.map(g=>{const f=g.x-this.characterX,m=g.y-this.characterY;return{monster:g,dist:Math.sqrt(f*f+m*m)}});c.sort((g,f)=>g.dist-f.dist);const h=Math.min(3,c.length),l=new Set;for(let g=0;g<h;g++){const f=c[g].monster,m=Math.atan2(f.y-this.characterY,f.x-this.characterX);for(const S of a){const x=this.gameBounds.height*S.definition.size*.5,k=S.x-this.characterX,y=S.y-this.characterY;if(Math.sqrt(k*k+y*y)-x>n)continue;const T=Math.cos(m),A=Math.sin(m);if(k*T+y*A<-x)continue;Math.abs(k*A-y*T)<=o/2+x&&l.add(S.id)}this.drawBeamEdge(m,n,o,i.definition.color);const M=this.characterX+Math.cos(m)*n,p=this.characterY+Math.sin(m)*n;this.showGridSkillEffects?this.flashSkillAreaLine(this.characterX,this.characterY,M,p,o,r):this.flashSkillEffectLine(this.characterX,this.characterY,M,p,o,r)}const d=Array.from(l);if(d.length>0){const g=a.filter(m=>l.has(m.id)),f=this.monsterManager.damageMonsters(d,s);f.totalExp>0&&this.addExp(f.totalExp),this.shakeScreen(d.length);for(const m of g){const M=Math.atan2(m.y-this.characterY,m.x-this.characterX);this.showHitSparkEffect(m.x,m.y,6750054,M,5)}}}_drawBeamEffect(t,s,e,i){const a=this.add.graphics();this.worldContainer.add(a);const n=this.characterX,o=this.characterY,r=n+Math.cos(t)*s,c=o+Math.sin(t)*s,h=e*1.5,l=Math.sin(t)*h/2,d=-Math.cos(t)*h/2,g=Math.sin(t)*h*.4/2,f=-Math.cos(t)*h*.4/2,m=15,M=1e3,p=this.time.now,S=()=>{const k=this.time.now-p,y=Math.min(k/M,1);a.clear();const E=.3,T=y<E?0:(y-E)/(1-E);for(let I=0;I<m;I++){const b=I/m,P=(I+1)/m,B=n+(r-n)*b,R=o+(c-o)*b,D=n+(r-n)*P,L=o+(c-o)*P,F=.85*(1-b*.6)*(1-T);F>.01&&(a.fillStyle(i,F),a.beginPath(),a.moveTo(B-l,R-d),a.lineTo(D-l,L-d),a.lineTo(D+l,L+d),a.lineTo(B+l,R+d),a.closePath(),a.fillPath())}for(let I=0;I<m;I++){const b=I/m,P=(I+1)/m,B=n+(r-n)*b,R=o+(c-o)*b,D=n+(r-n)*P,L=o+(c-o)*P,G=.98*(1-b*.5)*(1-T);G>.01&&(a.fillStyle(16777215,G),a.beginPath(),a.moveTo(B-g,R-f),a.lineTo(D-g,L-f),a.lineTo(D+g,L+f),a.lineTo(B+g,R+f),a.closePath(),a.fillPath())}const A=1*(1-T);A>.01&&(a.lineStyle(6,16777215,A),a.beginPath(),a.moveTo(n,o),a.lineTo(r,c),a.strokePath());const v=1*(1-T);v>.01&&(a.lineStyle(4,i,v),a.beginPath(),a.moveTo(n-l,o-d),a.lineTo(r-l,c-d),a.lineTo(r+l,c+d),a.lineTo(n+l,o+d),a.closePath(),a.strokePath(),a.lineStyle(2,16777215,v*.6),a.beginPath(),a.moveTo(n-l*1.1,o-d*1.1),a.lineTo(r-l*1.1,c-d*1.1),a.lineTo(r+l*1.1,c+d*1.1),a.lineTo(n+l*1.1,o+d*1.1),a.closePath(),a.strokePath()),y>=1&&a.destroy()},x=this.time.addEvent({delay:16,callback:S,callbackScope:this,repeat:Math.ceil(M/16)});this.time.delayedCall(M+50,()=>{a.active&&a.destroy(),x.remove()})}_drawCrossStarBurst(t,s){const i=this.gameBounds.height*.1*1,a=600;for(const n of t){const o=this.add.graphics();this.worldContainer.add(o);const r=this.time.now,c=()=>{const l=this.time.now-r,d=Math.min(l/a,1);o.clear();const g=d<.2?d/.2:1,f=d<.4?0:(d-.4)/.6,m=i*g,M=1-f;if(M>.01&&m>0){const p=m*.2,S=m,x=m*.4;o.fillStyle(16777215,M),o.fillCircle(n.x,n.y,x);for(let E=0;E<4;E++){const T=E*Math.PI/2,A=Math.cos(T),v=Math.sin(T),I=-v,b=A,P=6;for(let B=0;B<P;B++){const R=B/P,D=(B+1)/P,L=p*(1-R*.8),G=p*(1-D*.8),F=n.x+A*S*R,_=n.y+v*S*R,X=n.x+A*S*D,H=n.y+v*S*D,z=M*(1-R*.7);o.fillStyle(s,z*.8),o.beginPath(),o.moveTo(F+I*L,_+b*L),o.lineTo(X+I*G,H+b*G),o.lineTo(X-I*G,H-b*G),o.lineTo(F-I*L,_-b*L),o.closePath(),o.fillPath();const V=L*.5,Z=G*.5;o.fillStyle(16777215,z*.9),o.beginPath(),o.moveTo(F+I*V,_+b*V),o.lineTo(X+I*Z,H+b*Z),o.lineTo(X-I*Z,H-b*Z),o.lineTo(F-I*V,_-b*V),o.closePath(),o.fillPath()}}const k=S*.5,y=p*.6;for(let E=0;E<4;E++){const T=E*Math.PI/2+Math.PI/4,A=Math.cos(T),v=Math.sin(T),I=-v,b=A,P=4;for(let B=0;B<P;B++){const R=B/P,D=(B+1)/P,L=y*(1-R*.9),G=y*(1-D*.9),F=n.x+A*k*R,_=n.y+v*k*R,X=n.x+A*k*D,H=n.y+v*k*D,z=M*(1-R*.8)*.7;o.fillStyle(s,z),o.beginPath(),o.moveTo(F+I*L,_+b*L),o.lineTo(X+I*G,H+b*G),o.lineTo(X-I*G,H-b*G),o.lineTo(F-I*L,_-b*L),o.closePath(),o.fillPath()}}}d>=1&&o.destroy()};c();const h=this.time.addEvent({delay:16,callback:c,callbackScope:this,repeat:Math.ceil(a/16)});this.time.delayedCall(a+50,()=>{o.active&&o.destroy(),h.remove()})}}activateArchitect(t){this.skillManager.getArchitectExplosionChance(this.currentLevel)>0&&this.currentShield>0&&this.triggerShieldExplosion(t),this.currentSawBladePositions.length>0&&this.launchSawBladesOutward();const e=Math.floor(this.maxHp*.3);this.currentShield=e,this.maxShield=e;const i=1+t.level*1.5;this.shieldReflectDamage=u.DAMAGE_UNIT*i,this.drawShieldBarFill();const a=this.gameBounds.height*.18,n=t.definition.flashColor||t.definition.color;this.flashShieldEffect(this.characterX,this.characterY,a,n),this.triggerShieldBreathScan()}triggerShieldExplosion(t){const e=this.gameBounds.height*.1*3,i=t.definition.color,a=t.definition.flashColor||i,n=this.shieldReflectDamage;this.drawCircleEdge(e,i),this.flashShieldEffect(this.characterX,this.characterY,e,a);const o=this.monsterManager.getMonsters(),r=[];for(const c of o){const h=this.gameBounds.height*c.definition.size*.5,l=c.x-this.characterX,d=c.y-this.characterY;Math.sqrt(l*l+d*d)-h<=e&&r.push(c.id)}if(r.length>0){const c=o.filter(d=>r.includes(d.id)),h=this.monsterManager.damageMonsters(r,n);h.totalExp>0&&this.addExp(h.totalExp);const l=this.gameBounds.height*.1;this.monsterManager.knockbackMonsters(r,this.characterX,this.characterY,l),this.shakeScreen(r.length);for(const d of c)this.showHitSparkEffect(d.x,d.y,16763904)}}handleExpTestInput(){if(!(!this.keyPlus||!this.keyMinus||!this.keyShift)){if(this.keyShift.isDown&&U.Input.Keyboard.JustDown(this.keyBackspace)){this.showGridSkillEffects=!this.showGridSkillEffects;return}if(this.keyShift.isDown&&U.Input.Keyboard.JustDown(this.keyZero)){this.maxOutAllSkills();return}if(this.keyCtrl.isDown&&this.keyShift.isDown){const t=[{key:this.keyF5,skillId:"active_soul_render"},{key:this.keyF6,skillId:"active_coder"},{key:this.keyF7,skillId:"active_vfx"},{key:this.keyF8,skillId:"active_architect"},{key:this.keyF9,skillId:"passive_titanium_liver"},{key:this.keyF10,skillId:"passive_sync_rate"},{key:this.keyF11,skillId:"passive_retina_module"},{key:this.keyF12,skillId:"passive_ai_enhancement"}];for(const{key:s,skillId:e}of t)if(s&&U.Input.Keyboard.JustDown(s)){this.maxOutSingleSkill(e);return}}if(this.keyShift.isDown&&U.Input.Keyboard.JustDown(this.keyPlus)){this.levelUp();return}this.keyPlus.isDown&&!this.keyShift.isDown&&this.addExp(10),this.keyMinus.isDown&&this.addExp(-10)}}maxOutSingleSkill(t){const s=ut.find(o=>o.id===t);if(!s)return;const e=this.skillManager.getSkillLevel(t),i=s.type==="passive";if(e>=s.maxLevel||i&&e<0&&this.skillManager.isPassiveSlotsFull())return;const a=e<0?-1:e,n=s.maxLevel-a;this.currentLevel+=n,this.monsterManager.setPlayerLevel(this.currentLevel);for(let o=0;o<n;o++)this.skillManager.learnOrUpgradeSkill(t);this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(u.BASE_EXP*Math.pow(u.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay()}maxOutAllSkills(){this.currentLevel=24;const s=this.skillManager.getActiveSkillDefinitions();for(const e of s)for(let i=0;i<=e.maxLevel;i++)this.skillManager.learnOrUpgradeSkill(e.id);this.monsterManager.setPlayerLevel(this.currentLevel),this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(u.BASE_EXP*Math.pow(u.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay()}addExp(t){t>0&&(t=this.skillManager.calculateFinalExp(t)),this.currentExp+=t,this.currentExp<0&&(this.currentExp=0),this.currentExp>=this.maxExp&&this.levelUp(),this.drawExpBarFill()}levelUp(){this.currentLevel++,this.currentExp=0,this.maxExp=Math.floor(u.BASE_EXP*Math.pow(u.EXP_GROWTH_RATE,this.currentLevel)),this.recalculateMaxHp(),this.displayedHp=this.currentHp,this.monsterManager.setPlayerLevel(this.currentLevel)&&this.monsterManager.spawnBoss(this.cameraOffsetX,this.cameraOffsetY),this.levelText.setText(`Lv.${this.currentLevel}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showSkillPanel(),this.drawExpBarFill(),this.triggerLevelUpBreathScan()}recalculateMaxHp(){const t=u.BASE_HP+u.HP_PER_LEVEL*this.currentLevel,s=this.maxHp;if(this.maxHp=this.skillManager.calculateFinalMaxHp(t),this.maxHp>s&&s>0){const e=this.maxHp-s;this.currentHp+=e}this.currentHp=Math.min(this.currentHp,this.maxHp)}recalculateMoveSpeed(){this.moveSpeed=this.skillManager.calculateFinalMoveSpeed(this.baseMoveSpeed)}handleSkillPanelInput(){if(!this.keyOne||this.popupPaused)return;let t;this.mixedSkillTypes.length>0?t=this.mixedSkillTypes.length:this.isSelectingAdvancedSkill?t=this.currentAdvancedSkillChoices.length:t=this.currentSkillChoices.length,t===1?U.Input.Keyboard.JustDown(this.keyTwo)&&(this.selectedSkillIndex===0?this.confirmSkillSelection():this.setSelectedSkill(0)):t===2?(U.Input.Keyboard.JustDown(this.keyOne)&&(this.selectedSkillIndex===0?this.confirmSkillSelection():this.setSelectedSkill(0)),U.Input.Keyboard.JustDown(this.keyThree)&&(this.selectedSkillIndex===1?this.confirmSkillSelection():this.setSelectedSkill(1))):(U.Input.Keyboard.JustDown(this.keyOne)&&(this.selectedSkillIndex===0?this.confirmSkillSelection():this.setSelectedSkill(0)),U.Input.Keyboard.JustDown(this.keyTwo)&&(this.selectedSkillIndex===1?this.confirmSkillSelection():this.setSelectedSkill(1)),U.Input.Keyboard.JustDown(this.keyThree)&&(this.selectedSkillIndex===2?this.confirmSkillSelection():this.setSelectedSkill(2)))}setSelectedSkill(t){this.popupPaused||(this.updateSkillCardStyle(this.selectedSkillIndex,!1),this.selectedSkillIndex=t,this.updateSkillCardStyle(this.selectedSkillIndex,!0))}updateSkillCardStyle(t,s){const e=this.skillCardBgs[t],i=this.skillOptions[t];!e||!i||(s?(e.setFillStyle(3355443),e.setStrokeStyle(3,16777215),this.tweens.add({targets:i,scaleX:1.05,scaleY:1.05,duration:100})):(e.setFillStyle(2236962),e.setStrokeStyle(2,6710886),this.tweens.add({targets:i,scaleX:1,scaleY:1,duration:100})))}confirmSkillSelection(){if(this.popupPaused)return;if(this.mixedSkillTypes.length>0){this.confirmMixedSkillSelection();return}if(this.isSkillSelecting)return;if(this.isSkillSelecting=!0,this.isSelectingAdvancedSkill){if(this.currentAdvancedSkillChoices.length===0||this.selectedSkillIndex>=this.currentAdvancedSkillChoices.length)return;const s=this.currentAdvancedSkillChoices[this.selectedSkillIndex];this.selectAdvancedSkill(this.selectedSkillIndex,s.id);return}if(this.currentSkillChoices.length===0||this.selectedSkillIndex>=this.currentSkillChoices.length)return;const t=this.currentSkillChoices[this.selectedSkillIndex];this.selectSkill(this.selectedSkillIndex,t.id)}handleKeyboardInput(t){if(!this.cursors||this.gameOverActive||this.popupPaused)return;let s=0,e=0;if(this.cursors.W.isDown&&(e=-1),this.cursors.S.isDown&&(e=1),this.cursors.A.isDown&&(s=-1),this.cursors.D.isDown&&(s=1),s!==0||e!==0){if(this.isKeyboardMoving=!0,this.isPointerDown=!1,s!==0&&(this.facingRight=s>0),s!==0&&e!==0){const a=1/Math.sqrt(2);s*=a,e*=a}const i=this.moveSpeed*t/1e3;this.characterX+=s*i,this.characterY+=e*i,this.characterX=U.Math.Clamp(this.characterX,this.characterSize,this.mapWidth-this.characterSize),this.characterY=U.Math.Clamp(this.characterY,this.characterSize,this.mapHeight-this.characterSize),this.setCharacterState("run"),this.updateCharacterSprite(),this.updateCamera()}else this.isKeyboardMoving=!1,this.isPointerDown||(this.setCharacterState("idle"),this.updateCharacterSprite())}onPointerDown(t){this.isPaused||this.gameOverActive||this.popupPaused||this.isPointerInGameArea(t)&&(this.isPointerDown=!0,this.updateMoveDirectionFromPointer(t))}onPointerMove(t){!this.isPointerDown||this.isPaused||this.popupPaused||this.isPointerInGameArea(t)&&this.updateMoveDirectionFromPointer(t)}onPointerUp(){this.isPointerDown=!1,this.isKeyboardMoving||(this.setCharacterState("idle"),this.updateCharacterSprite())}isPointerInGameArea(t){return t.x>=this.gameBounds.x&&t.x<=this.gameBounds.x+this.gameBounds.width&&t.y>=this.gameBounds.y&&t.y<=this.gameBounds.y+this.gameBounds.height}updateMoveDirectionFromPointer(t){const s=t.x-this.gameBounds.x,e=t.y-this.gameBounds.y,i=s+this.cameraOffsetX,a=e+this.cameraOffsetY,n=i-this.characterX,o=a-this.characterY,r=Math.sqrt(n*n+o*o);r>0?(this.moveDirX=n/r,this.moveDirY=o/r):(this.moveDirX=0,this.moveDirY=0)}moveCharacter(t){const s=this.moveSpeed*t/1e3,e=this.characterX+this.moveDirX*s,i=this.characterY+this.moveDirY*s;this.characterX=U.Math.Clamp(e,this.characterSize,this.mapWidth-this.characterSize),this.characterY=U.Math.Clamp(i,this.characterSize,this.mapHeight-this.characterSize),this.moveDirX!==0&&this.updateCharacterFacing(this.characterX+this.moveDirX),this.setCharacterState("run"),this.updateCharacterSprite(),this.updateCamera()}updateCamera(t=!1){const s=this.cameraOffsetX+this.gameBounds.width/2,e=this.cameraOffsetY+this.gameBounds.height/2,i=this.characterX-s,a=this.characterY-e,n=this.gameBounds.width*u.CAMERA_DEAD_ZONE,o=this.gameBounds.height*u.CAMERA_DEAD_ZONE;t?(this.cameraOffsetX=this.characterX-this.gameBounds.width/2,this.cameraOffsetY=this.characterY-this.gameBounds.height/2):(Math.abs(i)>n/2&&(i>0?this.cameraOffsetX+=i-n/2:this.cameraOffsetX+=i+n/2),Math.abs(a)>o/2&&(a>0?this.cameraOffsetY+=a-o/2:this.cameraOffsetY+=a+o/2)),this.cameraOffsetX=U.Math.Clamp(this.cameraOffsetX,0,this.mapWidth-this.gameBounds.width),this.cameraOffsetY=U.Math.Clamp(this.cameraOffsetY,0,this.mapHeight-this.gameBounds.height),this.worldContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY),this.characterContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY)}updateRevealMask(t){this.revealMask&&(this.revealMask.clear(),this.revealMask.fillStyle(16777215),this.revealMask.fillCircle(t.x,t.y,t.radius))}onRevealComplete(){this.gameAreaContainer.clearMask(!0),this.uiContainer.clearMask(!0),this.revealMask.destroy(),this.registry.events.off("reveal-update",this.updateRevealMask,this),this.registry.events.off("reveal-complete",this.onRevealComplete,this);const t=document.getElementById("controls");t&&t.classList.add("visible");const s=document.getElementById("left-controls");s&&s.classList.add("visible"),this.showSkillPanel(),this.monsterManager.startSpawning(),this.playRandomGameBgm()}playRandomGameBgm(){const t=["bgm_game_01","bgm_game_02"];let s;if(this.currentBgmKey&&t.length>1){const e=t.filter(i=>i!==this.currentBgmKey);s=e[Math.floor(Math.random()*e.length)]}else s=t[Math.floor(Math.random()*t.length)];this.currentBgmKey=s,this.gameBgm&&(this.gameBgm.stop(),this.gameBgm.destroy()),this.cache.audio.exists(s)&&(this.gameBgm=this.sound.add(s,{volume:.5,loop:!1}),this.gameBgm.on("complete",()=>{this.playRandomGameBgm()}),this.gameBgm.play())}createFullscreenBackground(t,s){this.background=this.add.image(t/2,s/2,"background");const e=t/this.background.width,i=s/this.background.height,a=Math.max(e,i);this.background.setScale(a)}drawGameBorder(){this.boundsBorder=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0),this.boundsBorder.setStrokeStyle(2,4473924)}createHpBar(){this.hpBarContainer=this.add.container(0,0),this.hpBarContainer.setDepth(1001);const t=this.skillGridCellSize,s=this.gameBounds.y+t*2,e=Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(this.gameBounds.height*.03));this.hpText=this.add.text(this.gameBounds.x+this.gameBounds.width/2,s+t/2,`${this.currentHp} / ${this.maxHp}`,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${e}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:4}),this.hpText.setResolution(2),this.hpText.setOrigin(.5,.5),this.hpText.setDepth(1002),this.hpBarContainer.add(this.hpText),this.drawHpBarFill(),this.uiContainer.add(this.hpBarContainer)}drawHpBarFill(){const t=[1,2,3],s=[1,2],e=this.skillGridCols-2,i=this.currentHp/this.maxHp,a=Math.floor(e*i),n=this.displayedHp/this.maxHp,o=Math.floor(e*n);for(const r of t)for(let c=0;c<e;c++){const h=c+1,l=r*this.skillGridCols+h,d=this.skillGridCells[l];d&&(d.setFillStyle(0,.9),d.setVisible(!0),d.setDepth(1e3))}if(o>a)for(const r of t)for(let c=a;c<o;c++){const h=c+1,l=r*this.skillGridCols+h,d=this.skillGridCells[l];if(!d)continue;const g=t.indexOf(r),f=g===0?.85:g===1?.75:.65;d.setFillStyle(16777215,f)}if(a>0)for(const r of t)for(let c=0;c<a;c++){const h=c+1,l=r*this.skillGridCols+h,d=this.skillGridCells[l];if(!d)continue;const g=c/e,f=this.hpBarFlowOffset,m=(g+f)%1,M=(Math.sin(m*Math.PI*2-Math.PI/2)+1)/2,p=Math.floor(136-34*M),S=0,x=Math.floor(34+102*M),k=p<<16|S<<8|x,y=t.indexOf(r),E=y===0?.95:y===1?.85:.75;d.setFillStyle(k,E)}if(this.currentShield>0&&this.maxShield>0){const r=this.currentShield/this.maxShield,c=Math.floor(e*r);for(const h of s)for(let l=0;l<e;l++){const d=l+1,g=h*this.skillGridCols+d,f=this.skillGridCells[g];if(f&&l<c){const m=l/e,M=this.shieldBarFlowOffset,p=(m+M)%1,S=(Math.sin(p*Math.PI*2-Math.PI/2)+1)/2,x=255,k=Math.floor(204+51*S),y=Math.floor(0+204*S),E=x<<16|k<<8|y,T=h===s[0]?.95:.8;f.setFillStyle(E,T)}}}}updateHpBarFlow(t){this.hpBarFlowOffset+=.2*t/1e3,this.hpBarFlowOffset>=1&&(this.hpBarFlowOffset-=1),this.updateDamageDisplay(t),this.drawHpBarFill()}updateDamageDisplay(t){if(this.displayedHp>this.currentHp)if(this.hpDamageDelay>0)this.hpDamageDelay-=t;else{const e=(this.displayedHp-this.currentHp)*u.HP_DAMAGE_LERP_SPEED*(t/1e3);this.displayedHp-=Math.max(1,e),this.displayedHp<this.currentHp&&(this.displayedHp=this.currentHp)}else this.displayedHp<this.currentHp&&(this.displayedHp=this.currentHp)}updateHpText(){this.hpText&&(this.currentShield>0?this.hpText.setText(`${this.currentHp}+${this.currentShield}/${this.maxHp}`):this.hpText.setText(`${this.currentHp}/${this.maxHp}`))}createShieldBar(){const t=this.skillGridCellSize,s=this.gameBounds.y+t*2,e=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.025));this.shieldText=this.add.text(this.gameBounds.x+this.gameBounds.width-10,s+t/2,"",{fontFamily:"monospace",fontSize:`${e}px`,color:"#ffdd44",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.shieldText.setOrigin(1,.5),this.shieldText.setDepth(1002),this.shieldText.setVisible(!1),this.uiContainer.add(this.shieldText)}drawShieldBarFill(){this.shieldText.setVisible(!1),this.updateHpText()}updateShieldBarFlow(t){if(this.currentShield<=0)return;const s=.6;this.shieldBarFlowOffset+=s*t/1e3,this.shieldBarFlowOffset>=1&&(this.shieldBarFlowOffset-=1),this.drawShieldBarFill()}updateShieldAura(t){if(this.shieldAuraGraphics.clear(),this.currentShield<=0){this.shieldGroundSprite&&this.shieldGroundSprite.visible&&this.shieldGroundSprite.setVisible(!1);return}const s=this.characterX,e=this.characterY,i=this.characterSize*.8,a=this.characterSize*.35,n=e-this.characterSize*.15;this.shieldGroundSprite||(this.shieldGroundSprite=this.add.sprite(0,0,u.TEXTURE_SECTOR_360),this.skillGridContainer.add(this.shieldGroundSprite),this.shieldGroundSprite.setDepth(55));const o=this.worldToScreen(s,n);this.shieldGroundSprite.setPosition(o.x,o.y);const r=i*1/u.EFFECT_TEXTURE_SIZE,c=r*.35;this.shieldGroundSprite.setScale(r,c),this.shieldGroundSprite.setTint(16768324),this.shieldGroundSprite.setAlpha(.5),this.shieldGroundSprite.setVisible(!0),this.shieldSparkleTimer+=t;const h=80;this.shieldSparkleTimer>=h&&(this.shieldSparkleTimer-=h,this.createShieldSparkle(s,n,i,a))}createShieldSparkle(t,s,e,i){const a=Math.random()*Math.PI*2,n=t+Math.cos(a)*(e/2),o=s+Math.sin(a)*(i/2),r=this.worldToScreen(n,o),c=this.getLineEffectSprite(),h=this.gameBounds.height/10,l=h*.2,d=h*.6,g=24+Math.random()*16,f=h*1.2,m=700+Math.random()*300;c.setPosition(r.x,r.y),c.setRotation(-Math.PI/2+(Math.random()-.5)*.4),c.setScale(l/u.EFFECT_TEXTURE_SIZE,g/u.EFFECT_LINE_HEIGHT),c.setTint(16768324),c.setAlpha(.85),c.setDepth(150),this.tweens.add({targets:c,y:r.y-f,scaleX:d/u.EFFECT_TEXTURE_SIZE,scaleY:g*.5/u.EFFECT_LINE_HEIGHT,alpha:0,duration:m,ease:"Quad.easeOut",onComplete:()=>{this.releaseLineEffectSprite(c)}})}updateHpRegen(t){const s=this.skillManager.getTitaniumLiverRegenInterval();if(!(s<=0)){if(this.currentHp>=this.maxHp){this.hpRegenTimer=0;return}if(this.hpRegenTimer+=t,this.hpRegenTimer>=s){this.hpRegenTimer-=s;const e=Math.max(1,Math.floor(this.maxHp*.01));this.currentHp=Math.min(this.currentHp+e,this.maxHp),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showHpHealEffect(e)}}}showHpHealEffect(t){const s=this.characterX,e=this.characterY-this.characterSize*.3,i=Math.min(8,Math.max(3,Math.floor(t/10)+3));for(let a=0;a<i;a++)this.time.delayedCall(a*40,()=>{this.createHpHealParticle(s,e)})}createHpHealParticle(t,s){const e=Math.random()*Math.PI*2,i=this.characterSize*.4,a=this.characterSize*.25,n=t+Math.cos(e)*i*(.3+Math.random()*.7),o=s+Math.sin(e)*a*(.3+Math.random()*.7),r=this.add.graphics();this.characterContainer.add(r);const c=this.gameBounds.height/10,h=c*(.1+Math.random()*.08),l=c*(.5+Math.random()*.3),d=700+Math.random()*300,g=this.time.now,f=[6702335,8939263,7820782,10057727],m=f[Math.floor(Math.random()*f.length)],M=()=>{const S=this.time.now-g,x=Math.min(S/d,1);r.clear();const k=o-l*x;let y,E;if(x<.2?(y=.6+x*2,E=1-x*5):(y=1-(x-.2)/.8,E=0),y>.01){const T=m>>16&255,A=m>>8&255,v=m&255,I=Math.round(T+(255-T)*E),b=Math.round(A+(255-A)*E),P=Math.round(v+(255-v)*E),B=I<<16|b<<8|P;r.fillStyle(B,y*.9),r.fillRect(n-h/2,k-h/2,h,h),r.lineStyle(1,16777215,y*.7),r.strokeRect(n-h/2,k-h/2,h,h)}x>=1&&r.destroy()};M();const p=this.time.addEvent({delay:16,callback:M,callbackScope:this,repeat:Math.ceil(d/16)});this.time.delayedCall(d+50,()=>{r.active&&r.destroy(),p.remove()})}takeDamage(t,s=[]){var o;const e=this.skillManager.getSyncRateDodgeChance(this.currentLevel);if(e>0&&Math.random()<e){this.flashDodgeEffect();return}let a=this.skillManager.calculateFinalDamageTaken(t),n=0;if(this.currentShield>0&&(this.currentShield>0,this.currentShield>=a?(n=a,this.currentShield-=a,a=0):(n=this.currentShield,a-=this.currentShield,this.currentShield=0),this.drawShieldBarFill(),n>0&&this.showGridSkillEffects&&this.flashShieldHitEffect(),this.shieldReflectDamage>0&&s.length>0)){const r=s.map(l=>l.id),c=this.monsterManager.damageMonsters(r,this.shieldReflectDamage);c.totalExp>0&&this.addExp(c.totalExp);const h=this.gameBounds.height*.1;this.monsterManager.knockbackMonsters(r,this.characterX,this.characterY,h)}if(a>0&&(this.currentHp-=a,this.totalDamageReceived+=a,this.currentHp<0&&(this.currentHp=0),this.hpDamageDelay=u.HP_DAMAGE_DELAY,this.drawHpBarFill(),this.updateHpText(),this.isHurt=!0,this.hurtEndTime=this.time.now+u.HURT_DURATION,this.isPointerDown=!1,this.isKeyboardMoving=!1,this.setCharacterState("hurt"),this.updateCharacterSprite(),this.flashCharacter(),this.triggerDamageScan(),this.updateLowHpVignette()),this.currentHp<=0)if(!this.reviveUsed&&this.skillManager.hasTitaniumLiverRevive()){this.reviveUsed=!0,this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.triggerShadowExplosion(),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.flashReviveEffect();const r=this.skillManager.getPlayerSkill("passive_titanium_liver");(o=r==null?void 0:r.definition.maxExtraAbility)!=null&&o.triggerQuote&&this.showTriggerCutIn(r.definition,"【不死】觸發",r.definition.maxExtraAbility.triggerQuote)}else this.triggerGameOver()}triggerGameOver(){if(this.gameOverActive)return;this.monsterManager.stopSpawning(),this.character.setVisible(!1),this.monsterManager.hideAllMonsters(),this.uiContainer.setVisible(!1),this.skillCooldowns.clear(),this.showGameOver(),this.startGameOverBreathScan();const t=Math.floor(this.gameTimer/6e4),s=Math.floor(this.gameTimer%6e4/1e3),e=`${String(t).padStart(2,"0")}:${String(s).padStart(2,"0")}`,i=Math.floor(this.currentExp/this.maxExp*100),a=this.currentLevel+i/100;this.time.delayedCall(2e3,()=>{window.dispatchEvent(new CustomEvent("playerDeath",{detail:{survivalTime:e,level:a,totalDamage:Math.floor(this.totalDamageReceived)}}))})}startGameOverBreathScan(){this.triggerGameOverBreathScan(),this.time.addEvent({delay:5e3,callback:()=>this.triggerGameOverBreathScan(),loop:!0})}triggerGameOverBreathScan(){this.gameOverActive&&(this.gameOverBreathScan={phase:"expand",radius:0,targetRadius:this.gameBounds.height*.5})}flashShieldHitEffect(){const t=this.worldToScreen(this.characterX,this.characterY),s=t.x,e=t.y,i=u.SKILL_GRID_GAP,a=this.skillGridCellSize+i,n=16763904,o=this.gameBounds.height*.2,r=400,c=200,h=this.time.now,l=[],d=Math.max(0,Math.floor((s-o)/a)),g=Math.min(this.skillGridCols-1,Math.ceil((s+o)/a)),f=Math.max(0,Math.floor((e-o)/a)),m=Math.min(this.skillGridRows-1,Math.ceil((e+o)/a));for(let x=f;x<=m;x++)for(let k=d;k<=g;k++){const y=k*a+this.skillGridCellSize/2,E=x*a+this.skillGridCellSize/2,T=y-s,A=E-e,v=Math.sqrt(T*T+A*A);v<=o&&l.push({col:k,row:x,dist:v})}if(l.length===0)return;const M=[];for(const{col:x,row:k}of l){const y=x*a+this.skillGridCellSize/2,E=k*a+this.skillGridCellSize/2,T=this.add.rectangle(y,E,this.skillGridCellSize,this.skillGridCellSize,n,0);T.setVisible(!1),this.skillGridContainer.add(T),M.push(T)}const p=()=>{const x=this.time.now-h,k=Math.min(x/r,1),y=Math.min(x/c,1),E=o*y,T=o*.3,A=Math.max(0,E-T);let v=0;x>c&&(v=(x-c)/(r-c));let I=0;for(const{dist:b}of l){const P=M[I++];if(P)if(b>=A&&b<=E){const B=(A+E)/2,R=Math.abs(b-B),D=T/2,L=R/D,F=.9*(1-L*.5)*(1-v);if(F>.01){if(x<c&&L<.3){const _=n>>16&255,X=n>>8&255,H=n&255,z=Math.min(255,_+Math.floor((255-_)*.5)),V=Math.min(255,X+Math.floor((255-X)*.5)),Z=Math.min(255,H+Math.floor((255-H)*.5)),$=z<<16|V<<8|Z;P.setFillStyle($,F)}else P.setFillStyle(n,F);P.setVisible(!0)}else P.setVisible(!1)}else P.setVisible(!1)}if(k>=1)for(const b of M)b.destroy()};p();const S=this.time.addEvent({delay:16,callback:p,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{S.remove();for(const x of M)x.active&&x.destroy()})}flashCharacter(){this.character.setTint(16777215),this.time.delayedCall(50,()=>{this.character.setTint(16724787)}),this.time.delayedCall(100,()=>{this.character.setTint(16777215)}),this.time.delayedCall(150,()=>{this.character.clearTint()})}flashDodgeEffect(){this.character.setTint(6737151),this.time.delayedCall(50,()=>{this.character.setTint(16777215)}),this.time.delayedCall(100,()=>{this.character.setTint(6737151)}),this.time.delayedCall(150,()=>{this.character.clearTint()})}flashReviveEffect(){const t=[6684774,2228258,8913032,4456516,11141290];let s=0;const e=()=>{s<t.length?(this.character.setTint(t[s]),s++,this.time.delayedCall(80,e)):this.character.clearTint()};e()}triggerShadowExplosion(){const s=this.gameBounds.height*.1*5,e=this.monsterManager.getMonsters(),i=[];for(const a of e){const n=a.x-this.characterX,o=a.y-this.characterY,r=Math.sqrt(n*n+o*o),c=this.gameBounds.height*a.definition.size*.5;r-c<=s&&i.push(a.id)}if(i.length>0){const a=e.filter(o=>i.includes(o.id)).map(o=>({x:o.x,y:o.y}));this.monsterManager.damageMonsters(i,999999),this.flashShadowCrossAtPositions(a)}this.drawCircleEdge(s,6684774),this.showGridSkillEffects?this.flashSkillAreaCircle(this.characterX,this.characterY,s,8913032):this.flashSkillEffectCircle(this.characterX,this.characterY,s,8913032),this.cameras.main.shake(200,.01)}_drawShadowExplosionEffect(t){const s=this.add.graphics();this.worldContainer.add(s);const e=this.characterX,i=this.characterY,a=4456516,n=800,o=this.time.now,r=()=>{const h=this.time.now-o,l=Math.min(h/n,1);s.clear();const d=t*l,g=.6*(1-l);g>.01&&(s.fillStyle(a,g),s.fillCircle(e,i,d),s.lineStyle(4,8913032,g*.8),s.strokeCircle(e,i,d)),l>=1&&s.destroy()};r();const c=this.time.addEvent({delay:16,callback:r,callbackScope:this,repeat:Math.ceil(n/16)});this.time.delayedCall(n+50,()=>{c.remove(),s.active&&s.destroy()})}flashShadowCrossAtPositions(t){t.forEach(s=>{this.flashShadowCrossAt(s.x,s.y)})}flashShadowCrossAt(t,s){const e=this.worldToScreen(t,s),i=u.SKILL_GRID_GAP,a=this.skillGridCellSize+i,n=Math.floor(e.x/a),o=Math.floor(e.y/a),r=n*a+this.skillGridCellSize/2,c=o*a+this.skillGridCellSize/2,h=5,l=500,d=this.time.now,g=Math.random()<.5?1:-1,f=(Math.PI/4+Math.random()*Math.PI/4)*g,m=[];m.push({offsetX:0,offsetY:0,dist:0});const M=[{dc:1,dr:0},{dc:-1,dr:0},{dc:0,dr:1},{dc:0,dr:-1}];for(const{dc:y,dr:E}of M)for(let T=1;T<=h;T++)m.push({offsetX:y*T*a,offsetY:E*T*a,dist:T});if(m.length===0)return;const p=8913032,S=[];for(let y=0;y<m.length;y++){const E=this.add.rectangle(r,c,this.skillGridCellSize,this.skillGridCellSize,p,0);E.setVisible(!1),this.skillGridContainer.add(E),S.push(E)}const x=()=>{const y=this.time.now-d,E=Math.min(y/l,1),T=f*E,A=Math.cos(T),v=Math.sin(T),I=h*E;for(let b=0;b<m.length;b++){const{offsetX:P,offsetY:B,dist:R}=m[b],D=S[b];if(!D)continue;const L=r+P*A-B*v,G=c+P*v+B*A;if(D.setPosition(L,G),R>=I){const _=1-R/h*.2;let X=1;I>0&&R<I+1&&(X=R-I);const H=_*Math.max(0,X);H>.01?(D.setFillStyle(p,H),D.setVisible(!0)):D.setVisible(!1)}else D.setVisible(!1)}if(E>=1)for(const b of S)b.destroy()};x();const k=this.time.addEvent({delay:16,callback:x,callbackScope:this,repeat:Math.ceil(l/16)});this.time.delayedCall(l+50,()=>{k.remove();for(const y of S)y.active&&y.destroy()})}shakeScreen(t){t<10||this.cameras.main.shake(100,.005)}createLowHpVignette(){}updateLowHpVignette(){const t=this.currentHp/this.maxHp;this.isLowHp=t<=.3,!this.isLowHp&&this.currentShield<=0&&this.clearVignetteCells()}clearVignetteCells(){for(const t of this.vignetteEdgeCells){const s=Math.floor(t/this.skillGridCols),e=t%this.skillGridCols;if(s===0||s===this.skillGridRows-1||e===0||e===this.skillGridCols-1||s>=1&&s<=3)continue;const i=this.skillGridCells[t];i&&(i.setFillStyle(16777215,0),i.setVisible(!1))}this.vignetteEdgeCells.clear()}updateLowHpVignetteBreathing(t){if(!this.isLowHp&&this.currentShield<=0)return;this.lowHpBreathTimer+=t;const s=1500;this.lowHpBreathTimer>=s&&(this.lowHpBreathTimer-=s);const e=this.lowHpBreathTimer/s,i=Math.sin(e*Math.PI*2)*.5+.5;this.drawGridVignette(i)}drawGridVignette(t){const s=.2+t*.2;let e;this.currentShield>0?e=16768324:e=16720418;const i=this.skillGridCols/2,a=this.skillGridRows/2,n=this.skillGridCols/2*2,o=this.skillGridRows/2*2,r=4,c=this.skillGridRows-3;for(let h=r;h<c;h++)for(let l=1;l<this.skillGridCols-1;l++){const d=h*this.skillGridCols+l,g=this.skillGridCells[d];if(!g)continue;const f=(l-i)/n,m=(h-a)/o,M=Math.sqrt(f*f+m*m);if(M>.5){const p=Math.min(1,(M-.5)/.25),S=s*p;S>.01&&(g.setFillStyle(e,S),g.setVisible(!0),this.vignetteEdgeCells.add(d))}}}createExpBar(){this.expBarContainer=this.add.container(0,0),this.expBarContainer.setDepth(1002);const t=Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(this.gameBounds.height*.03)),s=this.skillGridCellSize,e=this.gameBounds.y+this.gameBounds.height-s*2;this.levelText=this.add.text(this.gameBounds.x+10,e-5,`Lv.${this.currentLevel}`,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${t}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.levelText.setResolution(2),this.levelText.setOrigin(0,1),this.expBarContainer.add(this.levelText),this.timerText=this.add.text(this.gameBounds.x+this.gameBounds.width-10,e-5,"00:00",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${t}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.timerText.setResolution(2),this.timerText.setOrigin(1,1),this.expBarContainer.add(this.timerText),this.uiContainer.add(this.expBarContainer)}drawExpBarFill(){const t=[this.skillGridRows-3,this.skillGridRows-2],s=this.skillGridCols-2;for(const a of t)for(let n=0;n<s;n++){const o=n+1,r=a*this.skillGridCols+o,c=this.skillGridCells[r];c&&(c.setFillStyle(0,.9),c.setVisible(!0),c.setDepth(1e3))}const e=this.currentExp/this.maxExp,i=Math.floor(s*e);if(!(i<=0))for(const a of t)for(let n=0;n<i;n++){const o=n+1,r=a*this.skillGridCols+o,c=this.skillGridCells[r];if(!c)continue;const h=n/s,l=this.expBarFlowOffset,d=(h+l)%1,g=(Math.sin(d*Math.PI*2-Math.PI/2)+1)/2,f=Math.floor(68+68*g),m=Math.floor(136-68*g),p=f<<16|m<<8|255,S=a===this.skillGridRows-2?.95:.8;c.setFillStyle(p,S)}}updateExpBarFlow(t){this.expBarFlowOffset+=.2*t/1e3,this.expBarFlowOffset>=1&&(this.expBarFlowOffset-=1),this.drawExpBarFill()}drawBorderFrame(){for(let e=0;e<this.skillGridCols;e++){const i=0*this.skillGridCols+e,a=this.skillGridCells[i];a&&(a.setFillStyle(3355443,.95),a.setVisible(!0),a.setDepth(1001))}for(let e=0;e<this.skillGridCols;e++){const i=(this.skillGridRows-1)*this.skillGridCols+e,a=this.skillGridCells[i];a&&(a.setFillStyle(3355443,.95),a.setVisible(!0),a.setDepth(1001))}for(let e=1;e<this.skillGridRows-1;e++){const i=e*this.skillGridCols+0,a=this.skillGridCells[i];a&&(a.setFillStyle(3355443,.95),a.setVisible(!0),a.setDepth(1001))}for(let e=1;e<this.skillGridRows-1;e++){const i=e*this.skillGridCols+(this.skillGridCols-1),a=this.skillGridCells[i];a&&(a.setFillStyle(3355443,.95),a.setVisible(!0),a.setDepth(1001))}}drawFloorGrid(){this.floorGrid.clear(),this.floorGrid.fillStyle(1118481,1),this.floorGrid.fillRect(0,0,this.mapWidth,this.mapHeight),this.floorGrid.lineStyle(4,16729156,1),this.floorGrid.strokeRect(0,0,this.mapWidth,this.mapHeight)}getFloorHexSprite(t){const s=`hex_${t}`;let e=this.floorHexPool.pop();return e?(e.setTexture(s),e.setVisible(!0),e.setActive(!0)):e=this.add.sprite(0,0,s),e.setTint(u.HEX_TINT_NORMAL),e}releaseFloorHexSprite(t){t.setVisible(!1),t.setActive(!1),t.setTint(u.HEX_TINT_NORMAL),this.floorHexPool.push(t)}getRandomHexChar(){const t=Math.random()<u.HEX_CHANCE?u.HEX_CHARS:u.BINARY_CHARS;return t[Math.floor(Math.random()*t.length)]}lerpTint(t){const s=u.HEX_TINT_NORMAL>>16&255,e=u.HEX_TINT_NORMAL>>8&255,i=u.HEX_TINT_NORMAL&255,a=u.HEX_TINT_HIGHLIGHT>>16&255,n=u.HEX_TINT_HIGHLIGHT>>8&255,o=u.HEX_TINT_HIGHLIGHT&255,r=Math.round(s+(a-s)*t),c=Math.round(e+(n-e)*t),h=Math.round(i+(o-i)*t);return r<<16|c<<8|h}lerpTintColor(t,s,e){const i=t>>16&255,a=t>>8&255,n=t&255,o=s>>16&255,r=s>>8&255,c=s&255,h=Math.round(i+(o-i)*e),l=Math.round(a+(r-a)*e),d=Math.round(n+(c-n)*e);return h<<16|l<<8|d}triggerDamageScan(){this.damageScanRings=[{radius:0,active:!0},{radius:-this.gameBounds.height*.1,active:!0}]}updateDamageScan(){const t=this.gameBounds.height,s=this.game.loop.delta/1e3,e=t*u.DAMAGE_SCAN_WIDTH,i=t*u.DAMAGE_SCAN_MAX;for(const a of this.damageScanRings)if(a.active){if(a.radius+=t*u.DAMAGE_SCAN_SPEED*s,a.radius>0){const n=Math.max(0,a.radius-e/2),o=a.radius+e/2;for(const r of this.floorHexChars){const c=r.sprite.x-this.characterX,h=r.sprite.y-this.characterY,l=Math.sqrt(c*c+h*h);if(l>=n&&l<=o){const f=1-Math.abs(l-a.radius)/(e/2),m=this.lerpTintColor(u.DAMAGE_SCAN_COLOR,16777215,f);r.sprite.setTint(m)}}}a.radius>i&&(a.active=!1)}this.damageScanRings=this.damageScanRings.filter(a=>a.active)}triggerShieldBreathScan(){this.shieldBreathScan={phase:"expand",radius:0,targetRadius:this.gameBounds.height*u.SHIELD_SCAN_EXPAND_MAX}}updateShieldBreathScan(){if(this.shieldBreathScan.phase==="idle")return;const t=this.gameBounds.height,s=this.game.loop.delta/1e3,e=t*u.SHIELD_SCAN_WIDTH;let i=0,a=u.SHIELD_SCAN_COLOR,n=16777215;switch(this.shieldBreathScan.phase){case"expand":i=u.SHIELD_SCAN_EXPAND_SPEED,this.shieldBreathScan.radius+=t*i*s,a=u.SHIELD_SCAN_COLOR,n=16777215,this.shieldBreathScan.radius>=this.shieldBreathScan.targetRadius&&(this.shieldBreathScan.phase="contract");break;case"contract":i=u.SHIELD_SCAN_CONTRACT_SPEED,this.shieldBreathScan.radius-=t*i*s,a=16777215,n=16777215,this.shieldBreathScan.radius<=0&&(this.shieldBreathScan.radius=0,this.shieldBreathScan.phase="burst",this.shieldBreathScan.targetRadius=t*u.SHIELD_SCAN_BURST_MAX);break;case"burst":i=u.SHIELD_SCAN_BURST_SPEED,this.shieldBreathScan.radius+=t*i*s,a=16777215,n=u.SHIELD_SCAN_COLOR,this.shieldBreathScan.radius>=this.shieldBreathScan.targetRadius&&(this.shieldBreathScan.phase="idle");break}if(this.shieldBreathScan.radius>0){const o=Math.max(0,this.shieldBreathScan.radius-e/2),r=this.shieldBreathScan.radius+e/2;for(const c of this.floorHexChars){const h=c.sprite.x-this.characterX,l=c.sprite.y-this.characterY,d=Math.sqrt(h*h+l*l);if(d>=o&&d<=r){const m=1-Math.abs(d-this.shieldBreathScan.radius)/(e/2),M=this.lerpTintColor(a,n,m);c.sprite.setTint(M)}}}}triggerLevelUpBreathScan(){this.levelUpBreathScan={phase:"expand",radius:0,targetRadius:this.gameBounds.height*u.LEVELUP_SCAN_EXPAND_MAX}}updateLevelUpBreathScan(){if(this.levelUpBreathScan.phase==="idle")return;const t=this.gameBounds.height,s=this.game.loop.delta/1e3,e=t*u.LEVELUP_SCAN_WIDTH;let i=0,a=u.LEVELUP_SCAN_COLOR,n=16777215;switch(this.levelUpBreathScan.phase){case"expand":i=u.LEVELUP_SCAN_EXPAND_SPEED,this.levelUpBreathScan.radius+=t*i*s,a=u.LEVELUP_SCAN_COLOR,n=16777215,this.levelUpBreathScan.radius>=this.levelUpBreathScan.targetRadius&&(this.levelUpBreathScan.phase="contract");break;case"contract":i=u.LEVELUP_SCAN_CONTRACT_SPEED,this.levelUpBreathScan.radius-=t*i*s,a=16777215,n=16777215,this.levelUpBreathScan.radius<=0&&(this.levelUpBreathScan.radius=0,this.levelUpBreathScan.phase="burst",this.levelUpBreathScan.targetRadius=t*u.LEVELUP_SCAN_BURST_MAX);break;case"burst":i=u.LEVELUP_SCAN_BURST_SPEED,this.levelUpBreathScan.radius+=t*i*s,a=16777215,n=u.LEVELUP_SCAN_COLOR,this.levelUpBreathScan.radius>=this.levelUpBreathScan.targetRadius&&(this.levelUpBreathScan.phase="idle");break}if(this.levelUpBreathScan.radius>0){const o=Math.max(0,this.levelUpBreathScan.radius-e/2),r=this.levelUpBreathScan.radius+e/2;for(const c of this.floorHexChars){const h=c.sprite.x-this.characterX,l=c.sprite.y-this.characterY,d=Math.sqrt(h*h+l*l);if(d>=o&&d<=r){const m=1-Math.abs(d-this.levelUpBreathScan.radius)/(e/2),M=this.lerpTintColor(a,n,m);c.sprite.setTint(M)}}}}updateGameOverBreathScan(){if(this.gameOverBreathScan.phase==="idle")return;const t=this.gameBounds.height,s=this.game.loop.delta/1e3,e=t*u.GAMEOVER_SCAN_WIDTH;let i=0,a=u.GAMEOVER_SCAN_COLOR,n=16777215;switch(this.gameOverBreathScan.phase){case"expand":i=u.GAMEOVER_SCAN_EXPAND_SPEED,this.gameOverBreathScan.radius+=t*i*s,a=u.GAMEOVER_SCAN_COLOR,n=16755370,this.gameOverBreathScan.radius>=this.gameOverBreathScan.targetRadius&&(this.gameOverBreathScan.phase="contract");break;case"contract":i=u.GAMEOVER_SCAN_CONTRACT_SPEED,this.gameOverBreathScan.radius-=t*i*s,a=16777215,n=16777215,this.gameOverBreathScan.radius<=0&&(this.gameOverBreathScan.radius=0,this.gameOverBreathScan.phase="burst",this.gameOverBreathScan.targetRadius=t*u.GAMEOVER_SCAN_BURST_MAX);break;case"burst":i=u.GAMEOVER_SCAN_BURST_SPEED,this.gameOverBreathScan.radius+=t*i*s,a=16777215,n=10044671,this.gameOverBreathScan.radius>=this.gameOverBreathScan.targetRadius&&(this.gameOverBreathScan.phase="idle");break}if(this.gameOverBreathScan.radius>0){const o=Math.max(0,this.gameOverBreathScan.radius-e/2),r=this.gameOverBreathScan.radius+e/2;for(const c of this.floorHexChars){const h=c.sprite.x-this.characterX,l=c.sprite.y-this.characterY,d=Math.sqrt(h*h+l*l);if(d>=o&&d<=r){const m=1-Math.abs(d-this.gameOverBreathScan.radius)/(e/2),M=this.lerpTintColor(a,n,m);c.sprite.setTint(M)}}}}spawnFloorHexChar(){if(this.floorHexChars.length>=u.FLOOR_HEX_MAX)return;const t=this.gameBounds.height*u.FLOOR_HEX_GRID_SIZE,s=this.gameBounds.width*2,e=this.gameBounds.height*2,i=Math.max(0,this.characterX-s/2),a=Math.max(0,this.characterY-e/2),n=Math.min(this.mapWidth,this.characterX+s/2),o=Math.min(this.mapHeight,this.characterY+e/2);let r=0;for(;r<20;){const c=i+Math.random()*(n-i),h=a+Math.random()*(o-a),l=Math.floor(c/t),d=Math.floor(h/t),g=`${l},${d}`;if(!this.floorHexUsedPositions.has(g)){const f=this.getRandomHexChar(),m=t*.25,M=l*t+t/2+d*m,p=d*t+t/2,S=this.getFloorHexSprite(f);S.setPosition(M,p);const x=t;S.setScale(x/80),S.setAlpha(0),this.floorHexContainer.add(S),this.floorHexChars.push({sprite:S,gridKey:g,spawnTime:this.time.now,fadeInDuration:1e3+Math.random()*1e3,lifetime:1e3+Math.random()*2e3,fullyVisible:!1,visibleStartTime:0}),this.floorHexUsedPositions.add(g);return}r++}}updateFloorHexChars(){const t=this.time.now,s=this.gameBounds.width*1.5;for(let a=this.floorHexChars.length-1;a>=0;a--){const n=this.floorHexChars[a],o=t-n.spawnTime,r=n.sprite.x,c=n.sprite.y;if(Math.sqrt(Math.pow(r-this.characterX,2)+Math.pow(c-this.characterY,2))>s){this.releaseFloorHexSprite(n.sprite),this.floorHexUsedPositions.delete(n.gridKey),this.floorHexChars.splice(a,1);continue}if(n.fullyVisible){const l=t-n.visibleStartTime,d=n.lifetime*.2;if(l>=n.lifetime)this.releaseFloorHexSprite(n.sprite),this.floorHexUsedPositions.delete(n.gridKey),this.floorHexChars.splice(a,1);else if(l>n.lifetime-d){const g=(n.lifetime-l)/d;n.sprite.setAlpha(.7*g)}else n.sprite.setAlpha(.7)}else if(o<n.fadeInDuration){const l=o/n.fadeInDuration;n.sprite.setAlpha(.7*l)}else n.fullyVisible=!0,n.visibleStartTime=t,n.sprite.setAlpha(.7)}const e=u.FLOOR_HEX_MAX,i=Math.min(20,e-this.floorHexChars.length);for(let a=0;a<i;a++)this.spawnFloorHexChar();this.updateRadiusWaves(),this.updateScanLine(),this.updateGameOverFlicker()}showGameOver(){if(this.gameOverActive)return;this.gameOverActive=!0;for(const x of this.floorHexChars)this.releaseFloorHexSprite(x.sprite);this.floorHexChars=[],this.floorHexUsedPositions.clear();const t=this.gameBounds.height*u.FLOOR_HEX_GRID_SIZE,s=7,e=9,i=2,a=2,n=s+i,o="GAME",r="OVER",c=o.length*(s+i)-i,h=r.length*(s+i)-i,l=e*2+a,d=-t*.25,g=this.characterX,f=this.characterY,m=g-c*t/2-n*t/2,M=f-l*t/2;this.spawnDotMatrixLine(o,m,M,t,d,0);const p=g-h*t/2+n*t/2,S=f-l*t/2+(e+a)*t;this.spawnDotMatrixLine(r,p,S,t,d,e+a)}spawnDotMatrixLine(t,s,e,i,a,n){let h=s;for(const l of t){const d=u.DOT_MATRIX_FONT[l];if(d){for(let g=0;g<9;g++)for(let f=0;f<d[g].length;f++)if(d[g][f]===1){const m=n+g,M=h+f*i+i/2+m*a,p=e+g*i+i/2,S=Math.floor(M/i),x=Math.floor(p/i),k=`go_${S},${x}`;if(!this.floorHexUsedPositions.has(k)){this.floorHexUsedPositions.add(k);const y=u.HEX_CHARS[Math.floor(Math.random()*16)],E=this.getFloorHexSprite(y);E.setPosition(M,p),E.setScale(i/80),E.setAlpha(0),E.setTint(16729156),this.floorHexContainer.add(E),this.gameOverSprites.push(E),this.floorHexChars.push({sprite:E,gridKey:k,spawnTime:this.time.now,fadeInDuration:300,lifetime:999999,fullyVisible:!1,visibleStartTime:0});const T=Math.random()*500;this.tweens.add({targets:E,alpha:.9,duration:300,delay:T,ease:"Power2",onComplete:()=>{const A=this.floorHexChars.find(v=>v.sprite===E);A&&(A.fullyVisible=!0,A.visibleStartTime=this.time.now)}})}}h+=9*i}}}updateGameOverFlicker(){if(!(!this.gameOverActive||this.gameOverSprites.length===0)){for(const t of this.gameOverSprites)if(t.active){if(Math.random()<.02){const s=u.HEX_CHARS[Math.floor(Math.random()*16)];t.setTexture(`hex_${s}`)}if(Math.random()<.05){const s=.7+Math.random()*.3;t.setAlpha(s)}Math.random()<.01&&(t.setTint(16777215),this.time.delayedCall(50+Math.random()*100,()=>{t.active&&t.setTint(16729156)}))}}}updateScanLine(){const t=this.time.now,s=this.gameBounds.width,e=s*u.SCAN_WIDTH;if(!this.scanLineActive&&t-this.lastScanTime>=u.SCAN_INTERVAL&&(this.scanLineActive=!0,this.scanLineX=this.characterX-s/2-e,this.lastScanTime=t),this.scanLineActive){const i=this.game.loop.delta/1e3;this.scanLineX+=s*u.SCAN_SPEED*i;const a=this.scanLineX,n=this.scanLineX+e,o=this.scanLineX+e/2;for(const r of this.floorHexChars){const c=r.sprite.x;if(c>=a&&c<=n){const d=1-Math.abs(c-o)/(e/2);r.sprite.setTint(this.lerpTint(d))}else r.sprite.setTint(u.HEX_TINT_NORMAL)}this.scanLineX>this.characterX+s/2+e&&(this.scanLineActive=!1)}this.updateCircularScan(),this.updateDamageScan(),this.updateShieldBreathScan(),this.updateLevelUpBreathScan(),this.updateGameOverBreathScan()}updateCircularScan(){const t=this.time.now,s=this.gameBounds.height,e=s*u.CIRCULAR_SCAN_WIDTH,i=s*u.CIRCULAR_SCAN_MAX;if(!this.circularScanActive&&t-this.lastCircularScanTime>=u.CIRCULAR_SCAN_INTERVAL&&(this.circularScanActive=!0,this.circularScanRadius=0,this.lastCircularScanTime=t),this.circularScanActive){const a=this.game.loop.delta/1e3;this.circularScanRadius+=s*u.CIRCULAR_SCAN_SPEED*a;const n=Math.max(0,this.circularScanRadius-e/2),o=this.circularScanRadius+e/2;for(const r of this.floorHexChars){const c=r.sprite.x-this.characterX,h=r.sprite.y-this.characterY,l=Math.sqrt(c*c+h*h);if(l>=n&&l<=o){const f=1-Math.abs(l-this.circularScanRadius)/(e/2);r.sprite.setTint(this.lerpTint(f))}}this.circularScanRadius>i&&(this.circularScanActive=!1)}}startRadiusWave(){const t=this.gameBounds.height*u.FLOOR_HEX_GRID_SIZE,s=t*.25,i=this.gameBounds.height*.1/t,a=this.characterX-this.gameBounds.width/2,n=this.characterX+this.gameBounds.width/2,o=this.characterY-this.gameBounds.height/2,r=this.characterY+this.gameBounds.height/2,c=Math.floor(o/t),h=Math.ceil(r/t);for(let l=0;l<u.RADIUS_WAVE_POINTS;l++){let d=0;for(;d<50;){const g=c+Math.floor(Math.random()*(h-c)),f=g*s,m=Math.floor((a-f)/t),M=Math.ceil((n-f)/t),p=m+Math.floor(Math.random()*(M-m)),S=4+Math.random()*6,x=Math.floor(S*i),k=40+Math.random()*60,y=[];for(let E=0;E<=x;E++)y[E]=[];for(let E=-x;E<=x;E++)for(let T=-x;T<=x;T++){const A=Math.sqrt(T*T+E*E),v=Math.floor(A);if(v<=x){const I=p+T,b=g+E;y[v].push(`${I},${b}`)}}this.radiusWaves.push({centerCol:p,centerRow:g,rings:y,currentRing:0,lastExpandTime:this.time.now,expandSpeed:k});break}}}updateRadiusWaves(){const t=this.time.now,s=this.gameBounds.height*u.FLOOR_HEX_GRID_SIZE,e=s*.25;t-this.lastRadiusWaveTime>=u.RADIUS_WAVE_INTERVAL&&(this.startRadiusWave(),this.lastRadiusWaveTime=t);const i=this.characterX-this.gameBounds.width/2,a=this.characterX+this.gameBounds.width/2,n=this.characterY-this.gameBounds.height/2,o=this.characterY+this.gameBounds.height/2,r=this.gameBounds.height*.2;for(let c=this.radiusWaves.length-1;c>=0;c--){const h=this.radiusWaves[c];if(!(t-h.lastExpandTime<h.expandSpeed)){if(h.lastExpandTime=t,h.currentRing<h.rings.length){const l=h.rings[h.currentRing];for(const d of l){if(this.floorHexUsedPositions.has(d))continue;const[g,f]=d.split(",").map(Number),m=g*s+s/2+f*e,M=f*s+s/2;if(m<i-r||m>a+r||M<n-r||M>o+r)continue;const p=this.getRandomHexChar(),S=this.getFloorHexSprite(p);S.setPosition(m,M);const x=s;S.setScale(x/80),S.setAlpha(0),this.floorHexContainer.add(S),this.floorHexChars.push({sprite:S,gridKey:d,spawnTime:t,fadeInDuration:300+Math.random()*400,lifetime:500+Math.random()*1e3,fullyVisible:!1,visibleStartTime:0}),this.floorHexUsedPositions.add(d)}h.currentRing++}h.currentRing>=h.rings.length&&this.radiusWaves.splice(c,1)}}}createSkillBar(){const t=this.skillGridCellSize,s=u.SKILL_GRID_GAP,e=8,i=e*(t+s)-s,a=1,n=2,o=u.ACTIVE_SKILLS,r=u.PASSIVE_SKILLS,c=e+n,h=o*e+(o-1)*a,l=r*e+(r-1)*a,g=(h+n+l)*(t+s)-s,f=this.gameBounds.x+(this.gameBounds.width-g)/2,m=2*(t+s),M=t+s,p=this.gameBounds.y+this.gameBounds.height-m-i-M;this.createAdvancedSkillSlot(f,p,e,i,c,t,s);let S=f;for(let x=0;x<o;x++){const k=S+i/2,y=p+i/2,E=this.add.container(k,y),T=this.add.rectangle(0,0,i,i);T.setStrokeStyle(0,16777215,0),T.setFillStyle(0,0),E.add(T);const A=this.add.rectangle(0,0,i-4,i-4,3355443,0);E.add(A),this.skillIconSprites.push(null);const v=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.2)),I=this.add.text(0,i*.3,"",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${v}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});I.setResolution(2),I.setOrigin(.5,.5),E.add(I),this.skillIcons.push(T),this.skillIconContainers.push(E),this.skillLevelTexts.push(I),E.setDepth(1002),this.uiContainer.add(E),this.drawSkillIconGrid(S,p,e,x),S+=i+a*(t+s)}S+=(n-a)*(t+s);for(let x=0;x<r;x++){const k=S+i/2,y=p+i/2,E=this.add.container(k,y),T=this.add.rectangle(0,0,i,i);T.setStrokeStyle(0,16777215,0),T.setFillStyle(0,0),E.add(T);const A=this.add.rectangle(0,0,i-4,i-4,3355443,0);E.add(A),this.skillIconSprites.push(null);const v=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.2)),I=this.add.text(0,i*.3,"",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${v}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});I.setResolution(2),I.setOrigin(.5,.5),E.add(I),this.skillIcons.push(T),this.skillIconContainers.push(E),this.skillLevelTexts.push(I),E.setDepth(1002),this.uiContainer.add(E),this.drawSkillIconGrid(S,p,e,o+x),S+=i+a*(t+s)}this.createSkillInfoPanel(),this.setupSkillIconInteractions()}createAdvancedSkillSlot(t,s,e,i,a,n,o){const r=t-a*(n+o),c=r+i/2,h=s+i/2;this.advancedSkillContainer=this.add.container(c,h),this.advancedSkillContainer.setDepth(1002),this.advancedSkillContainer.setVisible(!1),this.advancedSkillContainer.setAlpha(0),this.uiContainer.add(this.advancedSkillContainer);const l=this.add.rectangle(0,0,i,i);l.setStrokeStyle(0,16777215,0),l.setFillStyle(0,0),this.advancedSkillContainer.add(l);const d=this.add.rectangle(0,0,i-4,i-4,3355443,0);this.advancedSkillContainer.add(d);const g=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.2));this.advancedSkillLevelText=this.add.text(0,i*.3,"",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${g}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.advancedSkillLevelText.setResolution(2),this.advancedSkillLevelText.setOrigin(.5,.5),this.advancedSkillContainer.add(this.advancedSkillLevelText),this.advancedSkillGridGraphics=this.add.graphics(),this.advancedSkillGridGraphics.setDepth(1001),this.advancedSkillGridGraphics.setVisible(!1),this.uiContainer.add(this.advancedSkillGridGraphics),this.advancedSkillGridData={startX:r,startY:s,gridSize:e},l.setInteractive({useHandCursor:!0}),l.on("pointerdown",()=>{const f=this.skillManager.getEquippedAdvancedSkill();f&&this.showAdvancedSkillInfo(f)})}showAdvancedSkillSlot(){if(this.advancedSkillSlotVisible)return;this.advancedSkillSlotVisible=!0,this.advancedSkillContainer.setVisible(!0),this.advancedSkillGridGraphics.setVisible(!0);const t=this.advancedSkillContainer.x;this.advancedSkillContainer.x=t-50,this.tweens.add({targets:this.advancedSkillContainer,x:t,alpha:1,duration:300,ease:"Power2"})}updateAdvancedSkillDisplay(){const t=this.skillManager.getEquippedAdvancedSkill();if(!t)return;const s=t.definition;s.maxLevel>=0&&t.level>=s.maxLevel?(this.advancedSkillLevelText.setText("MAX"),this.advancedSkillLevelText.setColor("#FFD700")):(this.advancedSkillLevelText.setText(`Lv.${t.level}`),this.advancedSkillLevelText.setColor("#ffffff"));const e=`skill_${s.iconPrefix}0${t.level}`;if(this.textures.exists(e))if(this.advancedSkillIconSprite)this.advancedSkillIconSprite.setTexture(e);else{const i=this.skillGridCellSize,a=u.SKILL_GRID_GAP,o=8*(i+a)-a-4;this.advancedSkillIconSprite=this.add.sprite(0,0,e),this.advancedSkillIconSprite.setDisplaySize(o,o),this.advancedSkillContainer.add(this.advancedSkillIconSprite),this.advancedSkillContainer.sendToBack(this.advancedSkillIconSprite)}}redrawAdvancedSkillRainbowBorder(t,s){if(!this.advancedSkillSlotVisible||!this.advancedSkillGridGraphics)return;this.advancedSkillHue=(this.advancedSkillHue+s*.1)%360;const e=this.advancedSkillGridGraphics,i=this.advancedSkillGridData;if(!i)return;e.clear();const a=this.skillGridCellSize,n=u.SKILL_GRID_GAP,{startX:o,startY:r,gridSize:c}=i,h=[],l=Math.floor(c/2);for(let f=l;f<c;f++)h.push({row:0,col:f});for(let f=1;f<c;f++)h.push({row:f,col:c-1});for(let f=c-2;f>=0;f--)h.push({row:c-1,col:f});for(let f=c-2;f>=1;f--)h.push({row:f,col:0});h.push({row:0,col:0});for(let f=1;f<l;f++)h.push({row:0,col:f});const d=h.length,g=Math.floor(d*t);for(let f=0;f<d;f++){const{row:m,col:M}=h[f],p=o+M*(a+n),S=r+m*(a+n);if(f<g){const x=(this.advancedSkillHue+f*12)%360,k=U.Display.Color.HSLToColor(x/360,1,.5).color;e.fillStyle(k,.8)}else e.fillStyle(0,.5);e.fillRect(p,S,a,a)}}drawSkillIconGrid(t,s,e,i){const a=this.add.graphics();a.setDepth(1001),this.uiContainer.add(a),this.skillIconGridData[i]={startX:t,startY:s,gridSize:e},this.redrawSkillIconGrid(i,0),this.skillIconGridGraphics[i]=a}redrawSkillIconGrid(t,s){const e=this.skillIconGridGraphics[t],i=this.skillIconGridData[t];if(!e||!i)return;e.clear();const a=this.skillGridCellSize,n=u.SKILL_GRID_GAP,{startX:o,startY:r,gridSize:c}=i,h=u.ACTIVE_SKILLS,l=t<h,d=l?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills(),g=l?t:t-h;if(!d[g]){e.fillStyle(0,.5);for(let x=0;x<c;x++)for(let k=0;k<c;k++){const y=o+k*(a+n),E=r+x*(a+n);e.fillRect(y,E,a,a)}return}const m=[],M=Math.floor(c/2);for(let x=M;x<c;x++)m.push({row:0,col:x});for(let x=1;x<c;x++)m.push({row:x,col:c-1});for(let x=c-2;x>=0;x--)m.push({row:c-1,col:x});for(let x=c-2;x>=1;x--)m.push({row:x,col:0});m.push({row:0,col:0});for(let x=1;x<M;x++)m.push({row:0,col:x});const p=m.length,S=Math.floor(p*s);for(let x=0;x<p;x++){const{row:k,col:y}=m[x],E=o+y*(a+n),T=r+k*(a+n);if(x<S){const A=this.getSkillColorForIndex(t);e.fillStyle(A,.4)}else e.fillStyle(0,.5);e.fillRect(E,T,a,a)}}getSkillColorForIndex(t){const s=u.ACTIVE_SKILLS,e=t<s,i=e?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills(),a=e?t:t-s,n=i[a];return n?n.definition.color:6710886}updateSkillCooldownDisplay(){const t=this.time.now,s=this.skillManager.getPlayerActiveSkills();for(let a=0;a<s.length;a++){const n=s[a];if(!n){this.redrawSkillIconGrid(a,0);continue}const o=n.definition;let r=o.cooldown||1e3;o.id==="active_architect"&&(r=r-n.level*500);const c=this.skillManager.calculateFinalCooldown(r),h=this.skillCooldowns.get(o.id)||0,l=t-h;if(l>=c)this.redrawSkillIconGrid(a,1);else{const d=l/c;this.redrawSkillIconGrid(a,d)}}const e=this.skillManager.getPlayerPassiveSkills(),i=u.ACTIVE_SKILLS;for(let a=0;a<e.length;a++){const n=e[a];if(!n){this.redrawSkillIconGrid(i+a,0);continue}const o=n.definition;let r=1;switch(o.id){case"passive_titanium_liver":{const c=this.skillManager.getTitaniumLiverRegenInterval();c>0&&this.currentHp<this.maxHp&&(r=this.hpRegenTimer/c);break}}this.redrawSkillIconGrid(i+a,r)}}updateAdvancedSkillCooldown(t){if(!this.advancedSkillSlotVisible)return;const s=this.skillManager.getEquippedAdvancedSkill();if(!s)return;const e=this.time.now,i=this.skillManager.calculateFinalCooldown(s.definition.cooldown),a=e-this.advancedSkillCooldownTime,n=Math.min(1,a/i);this.redrawAdvancedSkillRainbowBorder(n,t),s.definition.id==="advanced_absolute_defense"&&this.updateSawBladeSpinVisual(t),n>=1&&!this.isPaused&&!this.popupPaused&&!this.isHurt&&!this.gameOverActive&&(this.activateAdvancedSkill(s),this.advancedSkillCooldownTime=e)}activateAdvancedSkill(t){switch(t.definition.id){case"advanced_burning_celluloid":this.executeBurningCelluloid(t.level);break;case"advanced_tech_artist":this.executeTechArtist(t.level);break;case"advanced_absolute_defense":this.executeAbsoluteDefense(t.level);break;case"advanced_perfect_pixel":this.executePerfectPixel(t.level);break;case"advanced_vfx_burst":this.executeVfxBurst(t.level);break;case"advanced_phantom_iteration":this.executePhantomIteration(t.level);break;case"advanced_zero_trust":this.activateZeroTrust(t.level);break;case"advanced_soul_slash":this.executeSoulSlash(t.level);break}}executeBurningCelluloid(t){if(this.currentHp>10)this.currentHp-=10,this.drawHpBarFill(),this.updateHpText(),this.character.setTint(16737792),this.time.delayedCall(100,()=>{this.character.clearTint()});else return;const e=this.currentLevel+t,i=u.DAMAGE_UNIT*e,a=this.gameBounds.height*.7,n=30,o=n/2*(Math.PI/180),r=12,c=600,h=c/r,l=new Set;for(let d=0;d<r;d++)this.time.delayedCall(d*h,()=>{const g=d/r*Math.PI*2,{damage:f,isCrit:m}=this.skillManager.calculateFinalDamageWithCrit(i,this.currentLevel),M=this.monsterManager.getMonsters(),p=[],S=[];for(const k of M){if(l.has(k.id))continue;const y=k.x-this.characterX,E=k.y-this.characterY,T=Math.sqrt(y*y+E*E),A=this.gameBounds.height*k.definition.size*.5;if(T-A>a)continue;let I=Math.atan2(E,y)-g;for(;I>Math.PI;)I-=Math.PI*2;for(;I<-Math.PI;)I+=Math.PI*2;const b=T>0?Math.atan2(A,T):Math.PI;Math.abs(I)<=o+b&&(p.push(k.id),S.push({x:k.x,y:k.y}),l.add(k.id))}if(p.length>0){const k=this.monsterManager.damageMonsters(p,f);k.totalExp>0&&this.addExp(k.totalExp);for(const y of S)this.showHitSparkEffect(y.x,y.y,4491519,g)}const x=n/2;this.flashSkillEffectSector(this.characterX,this.characterY,a,g,x,16737792)});this.time.delayedCall(c,()=>{this.shakeScreen(l.size)})}_showRotatingSectorEffect_deprecated(t,s,e,i){const a=this.add.graphics();this.skillGridContainer.add(a),a.setDepth(55);const n=150,o=this.time.now,r=this.characterX,c=this.characterY,h=()=>{const l=this.time.now-o,d=Math.min(l/n,1),g=.8*(1-d),f=this.worldToScreen(r,c);a.clear(),a.fillStyle(i,g*.5),a.beginPath(),a.moveTo(f.x,f.y),a.arc(f.x,f.y,s,t-e,t+e,!1),a.lineTo(f.x,f.y),a.closePath(),a.fillPath(),a.lineStyle(2,16777215,g),a.beginPath(),a.moveTo(f.x,f.y),a.lineTo(f.x+Math.cos(t-e)*s,f.y+Math.sin(t-e)*s),a.strokePath(),a.beginPath(),a.moveTo(f.x,f.y),a.lineTo(f.x+Math.cos(t+e)*s,f.y+Math.sin(t+e)*s),a.strokePath(),d>=1&&a.destroy()};this.time.addEvent({callback:h,loop:!0,delay:16})}executeTechArtist(t){const s=this.currentLevel+t,e=u.DAMAGE_UNIT*s,i=this.gameBounds.height/10,a=5,n=3,o=1e3,r=Math.random()*Math.PI*2,c=Math.random()*a*i,h=this.characterX+Math.cos(r)*c,l=this.characterY+Math.sin(r)*c,d=(Math.random()-.5)*2*i,g=this.worldToScreen(h,l),f=-Math.PI/2-Math.atan2(d,g.y+50),m=10053375,M=n*i;this.showLightBeamEffect(h,l,M,m,d),this.time.delayedCall(200,()=>{const{damage:p,isCrit:S}=this.skillManager.calculateFinalDamageWithCrit(e,this.currentLevel),x=this.monsterManager.getMonsters(),k=[],y=[];for(const E of x){const T=E.x-h,A=E.y-l,I=Math.sqrt(T*T+A*A)/i,b=E.definition.size*.5;I-b<=n&&(k.push(E.id),y.push({x:E.x,y:E.y}))}if(k.length>0){this.monsterManager.stunMonsters(k,o);const E=this.monsterManager.damageMonsters(k,p);E.totalExp>0&&this.addExp(E.totalExp);for(const T of y){const A=this.worldToScreen(T.x,T.y);this.showExplosionSparkEffect(A.x,A.y,10053375,1)}this.shakeScreen(k.length)}this.showExplosionEffect(h,l,M,m,f)})}showLightBeamEffect(t,s,e,i,a){const n=this.worldToScreen(t,s),o=this.gameBounds.height/10,r=a!==void 0?a:(Math.random()-.5)*2*o,c=n.x+r,h=-200,l=n.x,d=n.y,g=l-c,f=d-h,m=Math.sqrt(g*g+f*f),M=Math.atan2(f,g),p=this.add.sprite((c+l)/2,(h+d)/2,u.TEXTURE_LINE);this.skillGridContainer.add(p),p.setDepth(55),p.setTint(i),p.setRotation(M);const S=160,x=m/u.EFFECT_TEXTURE_SIZE,k=S/u.EFFECT_LINE_HEIGHT;p.setScale(x,k*.3),p.setAlpha(1),this.tweens.add({targets:p,scaleY:{from:k*.3,to:k},alpha:{from:1,to:.9},duration:50,ease:"Quad.easeOut",onComplete:()=>{this.tweens.add({targets:p,alpha:0,scaleY:k*.2,duration:300,ease:"Quad.easeIn",onComplete:()=>{p.destroy()}})}});const y=this.add.graphics();this.skillGridContainer.add(y),y.setDepth(54);const E=this.time.now,T=400,A=()=>{const I=(this.time.now-E)/T,b=this.worldToScreen(t,s);if(y.clear(),I<1){const P=.5*(1-I);y.lineStyle(2,i,P),y.strokeCircle(b.x,b.y,e*Math.min(I*2,1))}else y.destroy()};this.time.addEvent({callback:A,loop:!0,delay:16})}showExplosionEffect(t,s,e,i,a){const n=this.worldToScreen(t,s),o=300;this.gameBounds.height/10;const r=this.add.sprite(n.x,n.y,u.TEXTURE_CIRCLE);this.skillGridContainer.add(r),r.setDepth(55),r.setTint(i);const c=e*2/u.EFFECT_TEXTURE_SIZE;r.setScale(c),r.setAlpha(.8);const h=this.add.sprite(n.x,n.y,u.TEXTURE_SECTOR_360);this.skillGridContainer.add(h),h.setDepth(56),h.setTint(16777215);const l=e*.4/u.EFFECT_TEXTURE_SIZE;if(h.setScale(l),h.setAlpha(1),a!==void 0){const d=a+Math.PI;this.showHitSparkEffect(t,s,10053375,d)}this.tweens.add({targets:r,rotation:Math.PI*4,alpha:0,scale:c*1.5,duration:o,ease:"Power2",onUpdate:()=>{const d=this.worldToScreen(t,s);r.setPosition(d.x,d.y),h.setPosition(d.x,d.y)},onComplete:()=>{r.destroy()}}),this.tweens.add({targets:h,alpha:0,scale:l*.5,duration:o*.8,ease:"Power2",onComplete:()=>{h.destroy()}})}executeAbsoluteDefense(t){if(this.currentShield<=0){for(const T of this.sawBladeSprites)T.outer.setVisible(!1),T.inner.setVisible(!1);return}const s=this.currentLevel+t,e=u.DAMAGE_UNIT*s,i=this.gameBounds.height/10,a=2,n=.5,o=a*i,r=n*i;this.sawBladeRadius=r;const c=this.currentShield/this.maxShield,l=Math.max(1,Math.ceil(c*6)),f=Math.PI*2/2e3*100;this.sawBladeAngle+=f,this.sawBladeAngle>Math.PI*2&&(this.sawBladeAngle-=Math.PI*2);const{damage:m,isCrit:M}=this.skillManager.calculateFinalDamageWithCrit(e,this.currentLevel),p=this.monsterManager.getMonsters(),S=[],x=[],k=this.time.now,y=500,E=[];for(let T=0;T<l;T++){const A=this.sawBladeAngle+T/l*Math.PI*2,v=this.characterX+Math.cos(A)*o,I=this.characterY+Math.sin(A)*o;E.push({x:v,y:I})}this.currentSawBladePositions=E;for(const T of p)for(const A of E){const v=T.x-A.x,I=T.y-A.y,P=Math.sqrt(v*v+I*I)/i,B=T.definition.size*.5;if(P-B<=n){const R=this.sawBladeLastHitTime.get(T.id)||0;if(k-R>=y){S.push(T.id),x.push({x:T.x,y:T.y}),this.sawBladeLastHitTime.set(T.id,k);break}}}if(S.length>0){const T=this.monsterManager.damageMonsters(S,m);T.totalExp>0&&this.addExp(T.totalExp),this.monsterManager.knockbackMonsters(S,this.characterX,this.characterY,1);const v=Math.ceil(this.maxShield*.02)*S.length;this.currentShield=Math.max(0,this.currentShield-v),this.drawShieldBarFill();for(const I of x)this.showHitSparkEffect(I.x,I.y,16763904)}this.drawSawBlades(E,r)}drawSawBlades(t,s){for(;this.sawBladeSprites.length<t.length;){const e=this.add.sprite(0,0,u.TEXTURE_SHIELD);this.skillGridContainer.add(e),e.setDepth(56),e.setTint(16768256),e.setAlpha(.7);const i=this.add.sprite(0,0,u.TEXTURE_CIRCLE);this.skillGridContainer.add(i),i.setDepth(57),i.setTint(16772710),i.setAlpha(.8),this.sawBladeSprites.push({outer:e,inner:i})}for(let e=t.length;e<this.sawBladeSprites.length;e++)this.sawBladeSprites[e].outer.setVisible(!1),this.sawBladeSprites[e].inner.setVisible(!1);for(let e=0;e<t.length;e++){const i=t[e],{outer:a,inner:n}=this.sawBladeSprites[e],o=this.worldToScreen(i.x,i.y);a.setPosition(o.x,o.y),a.setVisible(!0);const r=s*2/u.EFFECT_TEXTURE_SIZE;a.setScale(r),a.setRotation(this.sawBladeSpinAngle),n.setPosition(o.x,o.y),n.setVisible(!0),n.setScale(r*.5),n.setRotation(-this.sawBladeSpinAngle*1.5)}}launchSawBladesOutward(){const t=this.currentSawBladePositions.length;if(t===0)return;const s=this.sawBladeRadius||this.gameBounds.height*.05,e=this.skillManager.getEquippedAdvancedSkill(),i=e?e.level:1,a=this.currentLevel+i,n=u.DAMAGE_UNIT*a;for(let o=0;o<t;o++){const r=this.sawBladeAngle+o/t*Math.PI*2;this.launchSingleSawBlade(s,n,r)}this.currentSawBladePositions=[]}launchSingleSawBlade(t,s,e){const i=this.add.sprite(0,0,u.TEXTURE_SHIELD);this.skillGridContainer.add(i),i.setDepth(100),i.setTint(16768256),i.setAlpha(.7);const a=this.add.sprite(0,0,u.TEXTURE_CIRCLE);this.skillGridContainer.add(a),a.setDepth(101),a.setTint(16772710),a.setAlpha(.8);const n=this.gameBounds.height*.2,o=this.gameBounds.height*1,r=1600,c=1.5,h={orbitAngle:e,orbitRadius:n,spinAngle:this.sawBladeSpinAngle,progress:0},l=t*2/u.EFFECT_TEXTURE_SIZE,d=()=>{const f=this.characterX+Math.cos(h.orbitAngle)*h.orbitRadius,m=this.characterY+Math.sin(h.orbitAngle)*h.orbitRadius,M=this.worldToScreen(f,m);return i.setPosition(M.x,M.y),i.setScale(l),i.setRotation(h.spinAngle),a.setPosition(M.x,M.y),a.setScale(l*.5),a.setRotation(-h.spinAngle*1.5),{worldX:f,worldY:m}},g=new Set;this.tweens.add({targets:h,progress:1,duration:r,ease:"Quad.easeIn",onUpdate:()=>{h.orbitRadius=n+(o-n)*h.progress,h.orbitAngle=e+c*Math.PI*2*h.progress,h.spinAngle+=.3,h.spinAngle>Math.PI*2&&(h.spinAngle-=Math.PI*2);const{worldX:f,worldY:m}=d(),M=this.monsterManager.getMonsters();for(const p of M){if(g.has(p.id))continue;const S=p.x-f,x=p.y-m,k=Math.sqrt(S*S+x*x),y=this.gameBounds.height*p.definition.size*.5;if(k-y<=t){g.add(p.id);const{damage:E,isCrit:T}=this.skillManager.calculateFinalDamageWithCrit(s,this.currentLevel),A=this.monsterManager.damageMonsters([p.id],E);A.totalExp>0&&this.addExp(A.totalExp),this.monsterManager.knockbackMonsters([p.id],this.characterX,this.characterY,1),this.showHitSparkEffect(p.x,p.y,16763904)}}},onComplete:()=>{i.destroy(),a.destroy()}}),d()}updateSawBladeSpinVisual(t){if(this.currentShield<=0){for(const c of this.sawBladeSprites)c.outer.setVisible(!1),c.inner.setVisible(!1);return}const s=Math.PI*2/150;this.sawBladeSpinAngle+=s*t,this.sawBladeSpinAngle>Math.PI*2&&(this.sawBladeSpinAngle-=Math.PI*2);const e=this.gameBounds.height*.2,i=this.gameBounds.height*.05,a=this.currentShield/this.maxShield,o=Math.max(1,Math.ceil(a*6)),r=[];for(let c=0;c<o;c++){const h=this.sawBladeAngle+c/o*Math.PI*2,l=this.characterX+Math.cos(h)*e,d=this.characterY+Math.sin(h)*e;r.push({x:l,y:d})}this.drawSawBlades(r,i)}clearAdvancedSkillEffects(){for(const t of this.sawBladeSprites)t.outer.setVisible(!1),t.inner.setVisible(!1);this.sawBladeLastHitTime.clear();for(const t of this.perfectPixelLineSprites)t.destroy();this.perfectPixelLineSprites=[],this.perfectPixelFocusIndex=0,this.perfectPixelLineAlpha=0}executePerfectPixel(t){const s=this.currentLevel+t,e=u.DAMAGE_UNIT*s,i=this.gameBounds,a=i.x+i.width/3,n=i.x+i.width*2/3,o=i.y+i.height/3,r=i.y+i.height*2/3,c=[{x:a,y:o},{x:n,y:o},{x:a,y:r},{x:n,y:r}],h=this.gameBounds.height*.3,l=this.gameBounds.height/10,d=3;this.perfectPixelLineAlpha=1,this.drawPerfectPixelLines(a,n,o,r);const g=[0,1,2,3];for(let m=g.length-1;m>0;m--){const M=Math.floor(Math.random()*(m+1));[g[m],g[M]]=[g[M],g[m]]}const f=250;g.forEach((m,M)=>{this.time.delayedCall(M*f,()=>{const p=c[m],S={x:p.x+this.cameraOffsetX,y:p.y+this.cameraOffsetY},{damage:x,isCrit:k}=this.skillManager.calculateFinalDamageWithCrit(e,this.currentLevel),y=this.monsterManager.getMonsters(),E=[];for(const T of y){const A=T.x-S.x,v=T.y-S.y,b=Math.sqrt(A*A+v*v)/l,P=T.definition.size*.5;b-P<=d&&E.push(T.id)}if(E.length>0){this.monsterManager.stunMonsters(E,1e3);const T=this.monsterManager.damageMonsters(E,x);T.totalExp>0&&this.addExp(T.totalExp);const A=this.monsterManager.getMonsters();for(const v of E){const I=A.find(b=>b.id===v);if(I){const b=this.worldToScreen(I.x,I.y);this.showExplosionSparkEffect(b.x,b.y,6750156,1)}}}this.showPerfectPixelExplosion(p.x,p.y,h,k)})}),this.time.delayedCall(4*f,()=>{this.tweens.add({targets:this,perfectPixelLineAlpha:0,duration:2e3,ease:"Power2",onUpdate:()=>{this.drawPerfectPixelLines(a,n,o,r)}})})}drawPerfectPixelLines(t,s,e,i){const a=this.gameBounds,n=16;if(this.perfectPixelLineSprites.length===0){const r=this.add.sprite(t,a.y+a.height/2,u.TEXTURE_LINE);this.uiContainer.add(r),r.setDepth(1005),r.setTint(6750156),r.setRotation(Math.PI/2),r.setScale(a.height/u.EFFECT_TEXTURE_SIZE,n/u.EFFECT_LINE_HEIGHT),this.perfectPixelLineSprites.push(r);const c=this.add.sprite(s,a.y+a.height/2,u.TEXTURE_LINE);this.uiContainer.add(c),c.setDepth(1005),c.setTint(6750156),c.setRotation(Math.PI/2),c.setScale(a.height/u.EFFECT_TEXTURE_SIZE,n/u.EFFECT_LINE_HEIGHT),this.perfectPixelLineSprites.push(c);const h=this.add.sprite(a.x+a.width/2,e,u.TEXTURE_LINE);this.uiContainer.add(h),h.setDepth(1005),h.setTint(6750156),h.setRotation(0),h.setScale(a.width/u.EFFECT_TEXTURE_SIZE,n/u.EFFECT_LINE_HEIGHT),this.perfectPixelLineSprites.push(h);const l=this.add.sprite(a.x+a.width/2,i,u.TEXTURE_LINE);this.uiContainer.add(l),l.setDepth(1005),l.setTint(6750156),l.setRotation(0),l.setScale(a.width/u.EFFECT_TEXTURE_SIZE,n/u.EFFECT_LINE_HEIGHT),this.perfectPixelLineSprites.push(l)}const o=this.perfectPixelLineAlpha*.8;for(const r of this.perfectPixelLineSprites)r.setAlpha(o)}showPerfectPixelExplosion(t,s,e,i){const a=[],o=e*1.2,r=i?16776960:6750156,c=this.add.sprite(t,s,u.TEXTURE_SECTOR_360);this.uiContainer.add(c),c.setDepth(1006),c.setTint(r),c.setScale(e*.6/u.EFFECT_TEXTURE_SIZE),c.setAlpha(1),a.push(c);const h=this.add.sprite(t,s,u.TEXTURE_CIRCLE_LINE);this.uiContainer.add(h),h.setDepth(1005),h.setTint(6750156),h.setScale(e*1/u.EFFECT_TEXTURE_SIZE),h.setAlpha(.8),a.push(h);const l=this.add.sprite(t,s,u.TEXTURE_CIRCLE_LINE);this.uiContainer.add(l),l.setDepth(1004),l.setTint(8978414),l.setScale(e*2/u.EFFECT_TEXTURE_SIZE),l.setAlpha(.4),a.push(l);const d=this.add.sprite(t,s,u.TEXTURE_LINE);this.uiContainer.add(d),d.setDepth(1007),d.setTint(6750156),d.setRotation(0),d.setScale(o*2/u.EFFECT_TEXTURE_SIZE,24/u.EFFECT_LINE_HEIGHT),d.setAlpha(.8),a.push(d);const g=this.add.sprite(t,s,u.TEXTURE_LINE);this.uiContainer.add(g),g.setDepth(1007),g.setTint(6750156),g.setRotation(Math.PI/2),g.setScale(o*2/u.EFFECT_TEXTURE_SIZE,24/u.EFFECT_LINE_HEIGHT),g.setAlpha(.8),a.push(g);for(const p of a)this.tweens.add({targets:p,alpha:0,duration:500,ease:"Power2",onComplete:()=>p.destroy()});const f=this.add.sprite(t,s,u.TEXTURE_SECTOR_360);this.uiContainer.add(f),f.setDepth(1005),f.setTint(6750156);const m=e*.6/u.EFFECT_TEXTURE_SIZE,M=e*2/u.EFFECT_TEXTURE_SIZE;f.setScale(m),f.setAlpha(1),this.tweens.add({targets:f,scale:M,alpha:0,duration:300,ease:"Power2",onComplete:()=>f.destroy()})}executeVfxBurst(t){const s=this.currentLevel+t,e=u.DAMAGE_UNIT*s;if(this.monsterManager.getMonsters().length===0)return;const a=20,n=75;for(let o=0;o<a;o++)this.time.delayedCall(o*n,()=>{const r=this.monsterManager.getMonsters();if(r.length===0)return;const c=r.map(f=>{const m=f.x-this.characterX,M=f.y-this.characterY;return{monster:f,dist:Math.sqrt(m*m+M*M)}});c.sort((f,m)=>f.dist-m.dist);const h=Math.min(5,c.length),l=c.slice(0,h),d=Math.floor(Math.random()*l.length),g=l[d].monster;this.launchMissile(g.id,e)})}launchMissile(t,s){const e=this.gameBounds.height/10,i=this.gameBounds.height*.2,a=this.worldToScreen(this.characterX,this.characterY),n=a.x,o=a.y,r=this.add.sprite(n,o,u.TEXTURE_LINE);this.skillGridContainer.add(r),r.setDepth(100),r.setTint(16737792);const c=32;let h=e*.3;const l=()=>{const p=h/u.EFFECT_TEXTURE_SIZE,S=c/u.EFFECT_LINE_HEIGHT;r.setScale(p,S)};l();const g=this.monsterManager.getMonsters().find(p=>p.id===t);if(!g){r.destroy();return}const f=Math.random()*Math.PI*2;r.setRotation(f);const m=n+Math.cos(f)*i,M=o+Math.sin(f)*i;this.tweens.add({targets:r,x:m,y:M,duration:400,ease:"Quad.easeOut",onComplete:()=>{const p=this.worldToScreen(g.x,g.y),S=p.x-r.x,x=p.y-r.y;r.setRotation(Math.atan2(x,S)),h=e*2.4,l(),this.tweens.add({targets:r,x:p.x,y:p.y,duration:500,ease:"Linear",onComplete:()=>{const k=this.monsterManager.getMonsters(),{damage:y,isCrit:E}=this.skillManager.calculateFinalDamageWithCrit(s,this.currentLevel),T=k.find(I=>I.id===t);if(T){const I=this.monsterManager.damageMonsters([T.id],y);I.totalExp>0&&this.addExp(I.totalExp)}const A=3,v=[];for(const I of k){const b=this.worldToScreen(I.x,I.y),P=b.x-r.x,B=b.y-r.y;Math.sqrt(P*P+B*B)<=A*e&&v.push(I.id)}if(v.length>0){const I=this.monsterManager.damageMonsters(v,y);I.totalExp>0&&this.addExp(I.totalExp);for(const b of v){const P=k.find(B=>B.id===b);if(P){const B=this.worldToScreen(P.x,P.y);this.showExplosionSparkEffect(B.x,B.y,16737792,1)}}}this.showMissileExplosion(r.x,r.y,E),r.destroy()}})}})}showMissileExplosion(t,s,e){const a=this.gameBounds.height/10*3,n=this.add.sprite(t,s,u.TEXTURE_SECTOR_360);this.skillGridContainer.add(n),n.setDepth(101),n.setTint(16737792);const o=a*.6/u.EFFECT_TEXTURE_SIZE;n.setScale(o),n.setAlpha(.9);const r=this.add.sprite(t,s,u.TEXTURE_CIRCLE_LINE);this.skillGridContainer.add(r),r.setDepth(100),r.setTint(16763904);const c=a*2/u.EFFECT_TEXTURE_SIZE;r.setScale(c),r.setAlpha(.7),this.showExplosionSparkEffect(t,s,16737792,3),this.tweens.add({targets:n,alpha:0,scale:o*1.5,duration:250,ease:"Power2",onComplete:()=>{n.destroy()}}),this.tweens.add({targets:r,alpha:0,scale:c*1.3,duration:300,ease:"Power2",onComplete:()=>{r.destroy()}})}activateZeroTrust(t){if(this.zeroTrustActive)return;this.zeroTrustActive=!0;const s=this.gameBounds.height/10,i=5*s;this.zeroTrustSprite||(this.zeroTrustSprite=this.add.sprite(0,0,u.TEXTURE_SHIELD),this.skillGridContainer.add(this.zeroTrustSprite),this.zeroTrustSprite.setDepth(49),this.zeroTrustSprite.setAlpha(.15));for(let a=0;a<8;a++){const n=a/8*Math.PI*2-Math.PI/2,o=this.characterX+Math.cos(n)*i,r=this.characterY+Math.sin(n)*i,c=this.add.sprite(0,0,u.TEXTURE_SECTOR_360);this.skillGridContainer.add(c),c.setDepth(56),c.setTint(16777215),c.setAlpha(.8);const h=s*.3/u.EFFECT_TEXTURE_SIZE,l=h*.35;c.setScale(h,l);const d=this.add.sprite(0,0,u.TEXTURE_LINE);this.skillGridContainer.add(d),d.setDepth(55),d.setTint(16768324),d.setAlpha(.6),d.setRotation(-Math.PI/2),this.zeroTrustPoints.push({targetMonsterId:null,currentX:o,currentY:r,homeAngle:n,lastDamageTime:0,pointSprite:c,beamSprite:d,flickerPhase:Math.random()*Math.PI*2})}this.monsterManager.setSlowZone(this.characterX,this.characterY,5,.5)}updateZeroTrust(t,s){if(!this.zeroTrustActive)return;this.monsterManager.setSlowZone(this.characterX,this.characterY,5,.5);const e=this.gameBounds.height/10,a=5*e,n=500,o=1,r=this.time.now,c=16763904,h=e*8,l=this.worldToScreen(this.characterX,this.characterY);if(this.zeroTrustSprite){this.zeroTrustSprite.setPosition(l.x,l.y);const p=a*2/u.EFFECT_TEXTURE_SIZE;this.zeroTrustSprite.setScale(p),this.zeroTrustSprite.setTint(c),this.zeroTrustSprite.setAlpha(.15),this.zeroTrustSprite.rotation+=.015}const d=this.currentLevel+t,g=u.DAMAGE_UNIT*d,f=this.monsterManager.getMonsters(),m=new Set(f.map(p=>p.id)),M=[];for(const p of f){const S=p.x-this.characterX,x=p.y-this.characterY;Math.sqrt(S*S+x*x)<=a&&M.push(p)}for(const p of this.zeroTrustPoints){if(p.flickerPhase+=s*.02,p.targetMonsterId!==null){const L=m.has(p.targetMonsterId),F=f.find(_=>_.id===p.targetMonsterId)&&M.some(_=>_.id===p.targetMonsterId);(!L||!F)&&(this.zeroTrustTrackedMonsters.delete(p.targetMonsterId),p.targetMonsterId=null)}if(p.targetMonsterId===null&&M.length>0){let L=null,G=1/0;for(const F of M){if(this.zeroTrustTrackedMonsters.has(F.id))continue;const _=F.x-p.currentX,X=F.y-p.currentY,H=Math.sqrt(_*_+X*X);H<G&&(G=H,L=F)}L&&(p.targetMonsterId=L.id,this.zeroTrustTrackedMonsters.add(L.id))}let S,x;if(p.targetMonsterId!==null){const L=f.find(G=>G.id===p.targetMonsterId);L?(S=L.x,x=L.y):(S=this.characterX+Math.cos(p.homeAngle)*a,x=this.characterY+Math.sin(p.homeAngle)*a)}else S=this.characterX+Math.cos(p.homeAngle)*a,x=this.characterY+Math.sin(p.homeAngle)*a;const k=S-p.currentX,y=x-p.currentY,E=Math.sqrt(k*k+y*y);if(E>1){const L=Math.min(h*s/1e3,E);p.currentX+=k/E*L,p.currentY+=y/E*L}if(Math.sqrt(Math.pow(p.currentX-this.characterX,2)+Math.pow(p.currentY-this.characterY,2))>a){const L=Math.atan2(p.currentY-this.characterY,p.currentX-this.characterX);p.currentX=this.characterX+Math.cos(L)*a,p.currentY=this.characterY+Math.sin(L)*a}const A=this.worldToScreen(p.currentX,p.currentY);p.pointSprite.setPosition(A.x,A.y);const v=p.targetMonsterId!==null,I=Math.sin(p.flickerPhase)*.5+.5;if(v){const L=I>.5?16737894:16711680;p.pointSprite.setTint(L)}else{const L=I>.5?16777215:14540253;p.pointSprite.setTint(L)}p.pointSprite.setAlpha(.7+I*.3);const b=this.gameBounds.height*.8,P=A.y-b;p.beamSprite.setPosition(A.x,(P+A.y)/2);const B=b/u.EFFECT_TEXTURE_SIZE,R=12/u.EFFECT_LINE_HEIGHT;p.beamSprite.setScale(B,R);const D=I>.5?16768324:16777215;if(p.beamSprite.setTint(D),p.beamSprite.setAlpha(.3+I*.4),p.targetMonsterId!==null&&r-p.lastDamageTime>=n){p.lastDamageTime=r;const L=[];for(const G of f){const F=G.x-p.currentX,_=G.y-p.currentY;Math.sqrt(F*F+_*_)<=o*e&&L.push(G.id)}if(L.length>0){const{damage:G,isCrit:F}=this.skillManager.calculateFinalDamageWithCrit(g,this.currentLevel),_=this.monsterManager.damageMonsters(L,G);_.totalExp>0&&this.addExp(_.totalExp),this.showZeroTrustHitEffect(p.currentX,p.currentY,F)}}}}showZeroTrustHitEffect(t,s,e){const i=this.worldToScreen(t,s),a=this.gameBounds.height/10,n=e?16737792:16763904,r=a*2*2/u.EFFECT_TEXTURE_SIZE,c=Math.PI*4,h=300,l=Math.random()*Math.PI*2,d=Math.PI/2;this.showHitSparkEffect(t,s,n,d);const g=this.add.sprite(i.x,i.y,u.TEXTURE_SHIELD);this.skillGridContainer.add(g),g.setDepth(59),g.setTint(n),g.setScale(.1),g.setAlpha(.8),g.setRotation(l);const f=this.add.sprite(i.x,i.y,u.TEXTURE_SHIELD);this.skillGridContainer.add(f),f.setDepth(60),f.setTint(16777215),f.setScale(.05),f.setAlpha(.9),f.setRotation(-l),this.tweens.add({targets:g,scale:r,rotation:l+c,alpha:0,duration:h,ease:"Quad.easeOut",onComplete:()=>{g.destroy()}}),this.tweens.add({targets:f,scale:r*.5,rotation:-l-c*1.5,alpha:0,duration:h,ease:"Quad.easeOut",onComplete:()=>{f.destroy()}})}deactivateZeroTrust(){this.zeroTrustActive=!1;for(const t of this.zeroTrustPoints)t.pointSprite.destroy(),t.beamSprite.destroy();this.zeroTrustPoints=[],this.zeroTrustTrackedMonsters.clear(),this.zeroTrustSprite&&(this.zeroTrustSprite.destroy(),this.zeroTrustSprite=void 0),this.monsterManager.clearSlowZone()}executeSoulSlash(t){const s=this.currentLevel+t,e=u.DAMAGE_UNIT*s,i=this.monsterManager.getMonsters();if(i.length===0)return;let a=i[0],n=1/0;for(const h of i){const l=h.x-this.characterX,d=h.y-this.characterY,g=Math.sqrt(l*l+d*d);g<n&&(n=g,a=h)}const o=a.x-this.characterX,r=a.y-this.characterY,c=Math.atan2(r,o);this.performSoulSlash(this.characterX,this.characterY,c,e,t,!1)}performSoulSlash(t,s,e,i,a,n){const o=Math.max(this.gameBounds.width,this.gameBounds.height)*2,r=t-Math.cos(e)*o,c=s-Math.sin(e)*o,h=t+Math.cos(e)*o,l=s+Math.sin(e)*o;n?this.drawChainSlashEffect(r,c,h,l,e,t,s):this.drawSoulSlashEffect(r,c,h,l,e);const d=this.monsterManager.getMonsters(),g=[],f=[],m=this.gameBounds.height*.05;for(const M of d){const p=this.pointToLineDistance(M.x,M.y,r,c,h,l),S=this.gameBounds.height*M.definition.size*.5;p<=m+S&&(g.push(M.id),f.push({x:M.x,y:M.y}))}if(g.length>0){const{damage:M,isCrit:p}=this.skillManager.calculateFinalDamageWithCrit(i,this.currentLevel),S=this.monsterManager.damageMonsters(g,M);S.totalExp>0&&this.addExp(S.totalExp);for(const x of f)this.showHitSparkEffect(x.x,x.y,16729190,e);if(!n){const x=a*.01;for(const k of f)if(Math.random()<x){const E=(30+Math.random()*30)*Math.PI/180,T=e+(Math.random()<.5?E:-E);this.time.delayedCall(50,()=>{this.performSoulSlash(k.x,k.y,T,i,a,!0)})}}}}drawChainSlashEffect(t,s,e,i,a,n,o){const r=this.worldToScreen(t,s),c=this.worldToScreen(e,i),h=c.x-r.x,l=c.y-r.y,d=Math.sqrt(h*h+l*l),g=(r.x+c.x)/2,f=(r.y+c.y)/2,m=65535,M=48,p=this.add.sprite(g,f,u.TEXTURE_LINE);this.skillGridContainer.add(p),p.setDepth(60),p.setTint(m),p.setRotation(a),p.setScale(d/u.EFFECT_TEXTURE_SIZE,M*1.5/u.EFFECT_LINE_HEIGHT),p.setAlpha(.3);const S=this.add.sprite(g,f,u.TEXTURE_LINE);this.skillGridContainer.add(S),S.setDepth(61),S.setTint(m),S.setRotation(a),S.setScale(d/u.EFFECT_TEXTURE_SIZE,M/u.EFFECT_LINE_HEIGHT),S.setAlpha(.6);const x=this.add.sprite(g,f,u.TEXTURE_LINE);this.skillGridContainer.add(x),x.setDepth(62),x.setTint(16777215),x.setRotation(a),x.setScale(d/u.EFFECT_TEXTURE_SIZE,M*.3/u.EFFECT_LINE_HEIGHT),x.setAlpha(.9);const k=[p,S,x];for(const E of k)this.tweens.add({targets:E,alpha:0,duration:150,onComplete:()=>E.destroy()});const y=this.worldToScreen(n,o);this.showChainSlashFlashEffect(y.x,y.y,a)}showChainSlashFlashEffect(t,s,e){const i=this.add.graphics();this.skillGridContainer.add(i),i.setDepth(61);const a=this.gameBounds.height*.08;i.lineStyle(3,65535,.8),i.beginPath(),i.arc(t,s,a,e-.3,e+.3,!1),i.strokePath(),i.lineStyle(1,16777215,1),i.beginPath(),i.arc(t,s,a*.7,e-.2,e+.2,!1),i.strokePath(),this.tweens.add({targets:i,alpha:0,duration:80,onComplete:()=>{i.destroy()}})}pointToLineDistance(t,s,e,i,a,n){const o=t-e,r=s-i,c=a-e,h=n-i,l=o*c+r*h,d=c*c+h*h;let g=-1;d!==0&&(g=l/d);let f,m;g<0?(f=e,m=i):g>1?(f=a,m=n):(f=e+g*c,m=i+g*h);const M=t-f,p=s-m;return Math.sqrt(M*M+p*p)}drawSoulSlashEffect(t,s,e,i,a){const n=this.worldToScreen(t,s),o=this.worldToScreen(e,i),r=o.x-n.x,c=o.y-n.y,h=Math.sqrt(r*r+c*c),l=(n.x+o.x)/2,d=(n.y+o.y)/2,g=16724838,f=48,m=this.add.sprite(l,d,u.TEXTURE_LINE);this.skillGridContainer.add(m),m.setDepth(60),m.setTint(g),m.setRotation(a),m.setScale(h/u.EFFECT_TEXTURE_SIZE,f*1.5/u.EFFECT_LINE_HEIGHT),m.setAlpha(.3);const M=this.add.sprite(l,d,u.TEXTURE_LINE);this.skillGridContainer.add(M),M.setDepth(61),M.setTint(g),M.setRotation(a),M.setScale(h/u.EFFECT_TEXTURE_SIZE,f/u.EFFECT_LINE_HEIGHT),M.setAlpha(.6);const p=this.add.sprite(l,d,u.TEXTURE_LINE);this.skillGridContainer.add(p),p.setDepth(62),p.setTint(16777215),p.setRotation(a),p.setScale(h/u.EFFECT_TEXTURE_SIZE,f*.3/u.EFFECT_LINE_HEIGHT),p.setAlpha(.9);const S=[m,M,p];for(const k of S)this.tweens.add({targets:k,alpha:0,duration:150,onComplete:()=>k.destroy()});const x=this.worldToScreen(this.characterX,this.characterY);this.showSlashFlashEffect(x.x,x.y,a)}showSlashFlashEffect(t,s,e){const i=this.add.graphics();this.skillGridContainer.add(i),i.setDepth(61);const a=this.gameBounds.height*.1;i.lineStyle(4,16724838,.8),i.beginPath(),i.arc(t,s,a,e-.3,e+.3,!1),i.strokePath(),i.lineStyle(2,16777215,1),i.beginPath(),i.arc(t,s,a*.8,e-.2,e+.2,!1),i.strokePath(),this.tweens.add({targets:i,alpha:0,duration:100,onComplete:()=>{i.destroy()}})}executePhantomIteration(t){const s=["advanced_burning_celluloid","advanced_tech_artist","advanced_perfect_pixel"],e=this.gameBounds.height/10,i=Math.random()*Math.PI*2,a=Math.random()*3*e,n=this.characterX+Math.cos(i)*a,o=this.characterY+Math.sin(i)*a,r=this.add.sprite(0,0,"char_idle_1");r.setOrigin(.5,1),r.setScale(this.character.scaleX,this.character.scaleY),r.setAlpha(.5),r.setTint(u.PHANTOM_COLOR),r.play("char_idle"),this.skillGridContainer.add(r),r.setDepth(55);const c=this.nextPhantomId++,h=(Math.floor(t/5)+10)*1e3,l=1e3,d=Math.max(0,Math.floor(h/l)-1),g=this.time.addEvent({delay:l,repeat:d,callback:()=>{if(this.isPaused||this.popupPaused)return;const x=this.phantoms.find(y=>y.id===c);if(!x)return;const k=s[Math.floor(Math.random()*s.length)];this.executePhantomSkillAt(k,t,x.x,x.y,c),this.setPhantomMoveTargetFor(x)}}),f=this.time.delayedCall(h,()=>{this.dismissPhantomById(c)}),m=5e3,M=2e3,p=this.time.addEvent({delay:m,repeat:Math.floor(h/m),callback:()=>{if(this.isPaused||this.popupPaused)return;const x=this.phantoms.find(k=>k.id===c);x&&(this.monsterManager.setTauntTarget(x.x,x.y,!0),this.time.delayedCall(M,()=>{if(this.isPaused||this.popupPaused)return;this.phantoms.find(y=>y.id===c)&&this.monsterManager.clearTauntTarget()}))}}),S={id:c,x:n,y:o,targetX:n,targetY:o,moving:!1,sprite:r,skillTimer:g,dismissTimer:f,tauntTimer:p,lastAfterimageTime:0};this.phantoms.push(S),this.globalChainRayTimer||(this.globalChainRayTimer=this.time.addEvent({delay:500,loop:!0,callback:()=>{if(this.isPaused||this.popupPaused||this.phantoms.length===0)return;const x=this.skillManager.getEquippedAdvancedSkill(),k=x?x.level:t,y=this.currentLevel+k,E=u.DAMAGE_UNIT*y;this.phantomCastChainRay(E,this.characterX,this.characterY)}})),this.showPhantomSpawnEffectAt(n,o)}setPhantomMoveTargetFor(t){const s=this.gameBounds.height/10,e=Math.random()*Math.PI*2,i=(1+Math.random()*4)*s;t.targetX=this.characterX+Math.cos(e)*i,t.targetY=this.characterY+Math.sin(e)*i,t.moving=!0,t.sprite&&t.sprite.anims&&t.sprite.play("char_run",!0)}executePhantomSkillAt(t,s,e,i,a){const n=this.skillManager.getEquippedAdvancedSkill(),o=n?n.level:s,r=this.currentLevel+o,c=u.DAMAGE_UNIT*r;switch(this.showPhantomCastEffectAt(e,i),t){case"advanced_burning_celluloid":this.phantomCastBurningCelluloidAt(c,e,i);break;case"advanced_tech_artist":this.phantomCastTechArtistAt(c,e,i);break;case"advanced_perfect_pixel":this.phantomCastPerfectPixelAt(c,e,i);break;case"advanced_vfx_burst":this.phantomCastVfxBurstAt(c,e,i);break;case"advanced_absolute_logic":this.phantomCastAbsoluteLogicAt(c,a);break;case"phantom_chain_ray":this.phantomCastChainRay(c,e,i);break}}phantomCastBurningCelluloidAt(t,s,e){const i=this.gameBounds.height*.3,a=15,n=a*Math.PI/180,o=u.PHANTOM_COLOR,r=12,c=80;for(let h=0;h<r;h++)this.time.delayedCall(h*c,()=>{const l=h/r*Math.PI*2,d=this.monsterManager.getMonsters(),g=[];for(const f of d){const m=f.x-s,M=f.y-e;if(Math.sqrt(m*m+M*M)<=i){const S=Math.atan2(M,m);let x=Math.abs(S-l);x>Math.PI&&(x=Math.PI*2-x),x<=n&&g.push(f.id)}}if(g.length>0){const{damage:f}=this.skillManager.calculateFinalDamageWithCrit(t,this.currentLevel),m=this.monsterManager.damageMonsters(g,f);m.totalExp>0&&this.addExp(m.totalExp)}this.flashSkillEffectSector(s,e,i,l,a,o)})}phantomCastTechArtistAt(t,s,e){const i=this.gameBounds.height/10,a=i*3,n=i*2,o=2;for(let r=0;r<o;r++)this.time.delayedCall(r*100,()=>{const c=Math.random()*Math.PI*2,h=Math.random()*a,l=s+Math.cos(c)*h,d=e+Math.sin(c)*h,g=(Math.random()-.5)*2*i,f=this.worldToScreen(l,d),m=-Math.PI/2-Math.atan2(g,f.y+50);this.showLightBeamEffect(l,d,n,u.PHANTOM_COLOR,g),this.time.delayedCall(150,()=>{const M=this.monsterManager.getMonsters(),p=[];for(const S of M){const x=S.x-l,k=S.y-d,E=Math.sqrt(x*x+k*k)/i,T=S.definition.size*.5;E-T<=2&&p.push(S.id)}if(p.length>0){this.monsterManager.stunMonsters(p,1e3);const{damage:S}=this.skillManager.calculateFinalDamageWithCrit(t,this.currentLevel),x=this.monsterManager.damageMonsters(p,S);x.totalExp>0&&this.addExp(x.totalExp)}this.showExplosionEffect(l,d,n,u.PHANTOM_COLOR,m)})})}phantomCastPerfectPixelAt(t,s,e){const i=this.gameBounds.height/10,a=i*2,n=i*1.5,o=[{x:s-n,y:e-n},{x:s+n,y:e-n},{x:s-n,y:e+n},{x:s+n,y:e+n}];[0,1,2,3].sort(()=>Math.random()-.5).forEach((c,h)=>{this.time.delayedCall(h*250,()=>{const l=o[c],d=this.monsterManager.getMonsters(),g=[];for(const M of d){const p=M.x-l.x,S=M.y-l.y,k=Math.sqrt(p*p+S*S)/i,y=M.definition.size*.5;k-y<=2&&g.push(M.id)}if(g.length>0){this.monsterManager.stunMonsters(g,1e3);const{damage:M}=this.skillManager.calculateFinalDamageWithCrit(t,this.currentLevel),p=this.monsterManager.damageMonsters(g,M);p.totalExp>0&&this.addExp(p.totalExp)}const f=this.worldToScreen(l.x,l.y);this.showPhantomPerfectPixelExplosion(f.x,f.y,a);const m=this.monsterManager.getMonsters();for(const M of g){const p=m.find(S=>S.id===M);if(p){const S=this.worldToScreen(p.x,p.y);this.showExplosionSparkEffect(S.x,S.y,u.PHANTOM_COLOR_LIGHT,.8)}}})})}showPhantomPerfectPixelExplosion(t,s,e){const i=[],n=e*1,o=this.add.sprite(t,s,u.TEXTURE_SECTOR_360);this.uiContainer.add(o),o.setDepth(1006),o.setTint(u.PHANTOM_COLOR),o.setScale(e*.5/u.EFFECT_TEXTURE_SIZE),o.setAlpha(.9),i.push(o);const r=this.add.sprite(t,s,u.TEXTURE_CIRCLE_LINE);this.uiContainer.add(r),r.setDepth(1005),r.setTint(u.PHANTOM_COLOR_LIGHT),r.setScale(e*.8/u.EFFECT_TEXTURE_SIZE),r.setAlpha(.7),i.push(r);const c=this.add.sprite(t,s,u.TEXTURE_CIRCLE_LINE);this.uiContainer.add(c),c.setDepth(1004),c.setTint(u.PHANTOM_COLOR_LIGHT),c.setScale(e*1.5/u.EFFECT_TEXTURE_SIZE),c.setAlpha(.35),i.push(c);const h=this.add.sprite(t,s,u.TEXTURE_LINE);this.uiContainer.add(h),h.setDepth(1007),h.setTint(u.PHANTOM_COLOR_LIGHT),h.setRotation(0),h.setScale(n*1.8/u.EFFECT_TEXTURE_SIZE,20/u.EFFECT_LINE_HEIGHT),h.setAlpha(.7),i.push(h);const l=this.add.sprite(t,s,u.TEXTURE_LINE);this.uiContainer.add(l),l.setDepth(1007),l.setTint(u.PHANTOM_COLOR_LIGHT),l.setRotation(Math.PI/2),l.setScale(n*1.8/u.EFFECT_TEXTURE_SIZE,20/u.EFFECT_LINE_HEIGHT),l.setAlpha(.7),i.push(l);for(const m of i)this.tweens.add({targets:m,alpha:0,duration:400,ease:"Power2",onComplete:()=>m.destroy()});const d=this.add.sprite(t,s,u.TEXTURE_SECTOR_360);this.uiContainer.add(d),d.setDepth(1005),d.setTint(u.PHANTOM_COLOR);const g=e*.5/u.EFFECT_TEXTURE_SIZE,f=e*1.5/u.EFFECT_TEXTURE_SIZE;d.setScale(g),d.setAlpha(.8),this.tweens.add({targets:d,scale:f,alpha:0,duration:250,ease:"Power2",onComplete:()=>d.destroy()})}phantomCastVfxBurstAt(t,s,e){const i=this.monsterManager.getMonsters();if(i.length===0)return;const a=i.map(n=>{const o=n.x-s,r=n.y-e;return{monster:n,dist:Math.sqrt(o*o+r*r)}}).sort((n,o)=>n.dist-o.dist).slice(0,5);for(let n=0;n<Math.min(5,a.length);n++)this.time.delayedCall(n*100,()=>{const o=a[n%a.length].monster;this.launchPhantomMissileAt(o.id,t,s,e)})}launchPhantomMissileAt(t,s,e,i){const a=this.gameBounds.height/10,n=this.gameBounds.height*.15,o=this.add.graphics();this.skillGridContainer.add(o),o.setDepth(100);const r=this.worldToScreen(e,i),c={screenX:r.x,screenY:r.y,rotation:0},h=a*.05;let l=a*.25;const d=()=>{o.clear(),o.save(),o.translateCanvas(c.screenX,c.screenY),o.rotateCanvas(c.rotation);const S=l/2,x=[3346824,4465305,5579434,6697915,7816396,8934877],k=l/6;for(let y=0;y<6;y++)o.fillStyle(x[y],.8),o.fillRect(-S+y*k,-h/2,k+1,h);o.restore()},f=this.monsterManager.getMonsters().find(S=>S.id===t);if(!f){o.destroy();return}const m=Math.random()*Math.PI*2;c.rotation=m;const M=c.screenX+Math.cos(m)*n,p=c.screenY+Math.sin(m)*n;d(),this.tweens.add({targets:c,screenX:M,screenY:p,duration:300,ease:"Quad.easeOut",onUpdate:d,onComplete:()=>{const S=this.worldToScreen(f.x,f.y),x=S.x-c.screenX,k=S.y-c.screenY;c.rotation=Math.atan2(k,x),l=a*1.5,this.tweens.add({targets:c,screenX:S.x,screenY:S.y,duration:400,ease:"Linear",onUpdate:d,onComplete:()=>{const E=this.monsterManager.getMonsters().find(T=>T.id===t);if(E){const{damage:T}=this.skillManager.calculateFinalDamageWithCrit(s,this.currentLevel),A=this.monsterManager.damageMonsters([E.id],T);A.totalExp>0&&this.addExp(A.totalExp)}this.showMissileExplosion(c.screenX,c.screenY,!1),o.destroy()}})}})}phantomCastAbsoluteLogicAt(t,s){if(s===void 0||this.phantomSawBladeActive.has(s))return;this.phantomSawBladeActive.add(s);const e=this.gameBounds.height/10,a=e*1.5,n=e*.4,o=3,r=Math.PI*2/1e3,c=Math.PI*2/150,h=this.add.graphics();this.skillGridContainer.add(h),h.setDepth(100);const l={angle:0,spinAngle:0},d=new Map,g=()=>{const p=this.phantoms.find(S=>S.id===s);return p?{x:p.x,y:p.y}:null},f=p=>{h.clear();const S=this.worldToScreen(p.x,p.y);for(let x=0;x<o;x++){const k=l.angle+x/o*Math.PI*2,y=S.x+Math.cos(k)*a,E=S.y+Math.sin(k)*a;h.fillStyle(u.PHANTOM_COLOR,.6),h.fillCircle(y,E,n),h.lineStyle(3,u.PHANTOM_COLOR_LIGHT,.8),h.strokeCircle(y,E,n);const T=8;for(let A=0;A<T;A++){const v=l.spinAngle+A/T*Math.PI*2,I=n*.6,b=n*1.2,P=y+Math.cos(v)*I,B=E+Math.sin(v)*I,R=y+Math.cos(v+.15)*b,D=E+Math.sin(v+.15)*b,L=y+Math.cos(v+.3)*I,G=E+Math.sin(v+.3)*I;h.lineStyle(2,u.PHANTOM_COLOR_LIGHT,.8),h.beginPath(),h.moveTo(P,B),h.lineTo(R,D),h.lineTo(L,G),h.strokePath()}}},m=()=>{const p=g();if(!p){h.destroy(),this.phantomSawBladeActive.delete(s);return}const S=16;l.angle+=r*S,l.spinAngle-=c*S,l.angle>Math.PI*2&&(l.angle-=Math.PI*2),l.spinAngle<-Math.PI*2&&(l.spinAngle+=Math.PI*2);const x=this.monsterManager.getMonsters(),k=this.time.now,y=[],E=[];for(let T=0;T<o;T++){const A=l.angle+T/o*Math.PI*2,v=p.x+Math.cos(A)*a,I=p.y+Math.sin(A)*a;for(const b of x){const P=b.x-v,B=b.y-I,D=Math.sqrt(P*P+B*B)/e,L=b.definition.size*.5;if(D<=.4+L){const G=d.get(b.id)||0;k-G>=500&&(y.push(b.id),E.push({x:b.x,y:b.y}),d.set(b.id,k))}}}if(y.length>0){const{damage:T,isCrit:A}=this.skillManager.calculateFinalDamageWithCrit(t,this.currentLevel),v=this.monsterManager.damageMonsters(y,T);v.totalExp>0&&this.addExp(v.totalExp);for(const I of E)this.showHitSparkEffect(I.x,I.y,16763904)}f(p)},M=g();M&&(f(M),this.time.addEvent({callback:m,loop:!0,delay:16}))}phantomCastSoulSlashAt(t,s,e){const i=this.monsterManager.getMonsters();if(i.length===0)return;let a=i[0],n=1/0;for(const S of i){const x=S.x-s,k=S.y-e,y=Math.sqrt(x*x+k*k);y<n&&(n=y,a=S)}const o=a.x-s,r=a.y-e,c=Math.atan2(r,o),h=Math.max(this.gameBounds.width,this.gameBounds.height)*2,l=s-Math.cos(c)*h,d=e-Math.sin(c)*h,g=s+Math.cos(c)*h,f=e+Math.sin(c)*h;this.drawPhantomSoulSlashEffect(l,d,g,f,c,s,e);const m=[],M=[],p=this.gameBounds.height*.05;for(const S of i){const x=this.pointToLineDistance(S.x,S.y,l,d,g,f),k=this.gameBounds.height*S.definition.size*.5;x<=p+k&&(m.push(S.id),M.push({x:S.x,y:S.y}))}if(m.length>0){const{damage:S,isCrit:x}=this.skillManager.calculateFinalDamageWithCrit(t,this.currentLevel),k=this.monsterManager.damageMonsters(m,S);k.totalExp>0&&this.addExp(k.totalExp)}}drawPhantomSoulSlashEffect(t,s,e,i,a,n,o){const r=this.worldToScreen(t,s),c=this.worldToScreen(e,i),h=this.add.graphics();this.skillGridContainer.add(h),h.setDepth(60);const l=u.PHANTOM_COLOR;h.lineStyle(12,l,.3),h.beginPath(),h.moveTo(r.x,r.y),h.lineTo(c.x,c.y),h.strokePath(),h.lineStyle(6,l,.6),h.beginPath(),h.moveTo(r.x,r.y),h.lineTo(c.x,c.y),h.strokePath(),h.lineStyle(2,16777215,.9),h.beginPath(),h.moveTo(r.x,r.y),h.lineTo(c.x,c.y),h.strokePath(),this.tweens.add({targets:h,alpha:0,duration:150,onComplete:()=>{h.destroy()}});const d=this.worldToScreen(n,o);this.showPhantomSlashFlashEffect(d.x,d.y,a)}showPhantomSlashFlashEffect(t,s,e){const i=this.add.graphics();this.skillGridContainer.add(i),i.setDepth(61);const a=this.gameBounds.height*.1;i.lineStyle(4,u.PHANTOM_COLOR,.8),i.beginPath(),i.arc(t,s,a,e-.3,e+.3,!1),i.strokePath(),i.lineStyle(2,16777215,1),i.beginPath(),i.arc(t,s,a*.8,e-.2,e+.2,!1),i.strokePath(),this.tweens.add({targets:i,alpha:0,duration:100,onComplete:()=>{i.destroy()}})}phantomCastChainRay(t,s,e){const i=[];i.push({x:this.characterX,y:this.characterY});for(const f of this.phantoms)i.push({x:f.x,y:f.y});if(i.length<2)return;let a=0,n=1/0;for(let f=0;f<i.length;f++){const m=i[f].x-s,M=i[f].y-e,p=m*m+M*M;p<n&&(n=p,a=f)}const o=[a],r=new Set([a]);for(;o.length<i.length;){const f=o[o.length-1],m=i[f];let M=-1,p=1/0;for(let S=0;S<i.length;S++){if(r.has(S))continue;const x=i[S].x-m.x,k=i[S].y-m.y,y=x*x+k*k;y<p&&(p=y,M=S)}M!==-1&&(o.push(M),r.add(M))}o.push(a);const c=this.monsterManager.getMonsters(),h=new Set,l=this.gameBounds.height*.02,d=24,g=[];for(let f=0;f<o.length-1;f++){const m=i[o[f]],M=i[o[f+1]],p=this.worldToScreen(m.x,m.y),S=this.worldToScreen(M.x,M.y),x=S.x-p.x,k=S.y-p.y,y=Math.sqrt(x*x+k*k),E=Math.atan2(k,x),T=this.add.sprite((p.x+S.x)/2,(p.y+S.y)/2,u.TEXTURE_LINE);this.skillGridContainer.add(T),T.setDepth(58),T.setTint(12281599),T.setRotation(E),T.setScale(y/u.EFFECT_TEXTURE_SIZE,d/u.EFFECT_LINE_HEIGHT),T.setAlpha(.9),g.push(T);const A=this.add.sprite((p.x+S.x)/2,(p.y+S.y)/2,u.TEXTURE_LINE);this.skillGridContainer.add(A),A.setDepth(59),A.setTint(15650047),A.setRotation(E),A.setScale(y/u.EFFECT_TEXTURE_SIZE,d*.5/u.EFFECT_LINE_HEIGHT),A.setAlpha(1),g.push(A);for(const v of c){if(h.has(v.id))continue;const I=this.gameBounds.height*v.definition.size*.5;this.pointToSegmentDistance(v.x,v.y,m.x,m.y,M.x,M.y)<=I+l&&h.add(v.id)}}for(let f=0;f<i.length;f++){const m=this.worldToScreen(i[f].x,i[f].y),M=this.add.sprite(m.x,m.y,u.TEXTURE_CIRCLE);this.skillGridContainer.add(M),M.setDepth(60),M.setTint(15650047),M.setScale(16/u.EFFECT_TEXTURE_SIZE),g.push(M);const p=this.add.sprite(m.x,m.y,u.TEXTURE_CIRCLE);this.skillGridContainer.add(p),p.setDepth(61),p.setTint(16777215),p.setScale(8/u.EFFECT_TEXTURE_SIZE),p.setAlpha(.8),g.push(p)}if(h.size>0){const f=Array.from(h);c.filter(M=>h.has(M.id)).map(M=>({x:M.x,y:M.y}));const m=this.monsterManager.damageMonsters(f,t);m.totalExp>0&&this.addExp(m.totalExp),this.shakeScreen(Math.min(h.size,3))}for(const f of g)this.tweens.add({targets:f,alpha:0,duration:300,onComplete:()=>f.destroy()})}pointToSegmentDistance(t,s,e,i,a,n){const o=a-e,r=n-i,c=o*o+r*r;if(c===0)return Math.sqrt((t-e)*(t-e)+(s-i)*(s-i));let h=((t-e)*o+(s-i)*r)/c;h=Math.max(0,Math.min(1,h));const l=e+h*o,d=i+h*r;return Math.sqrt((t-l)*(t-l)+(s-d)*(s-d))}showPhantomSpawnEffectAt(t,s){const e=this.worldToScreen(t,s),a=this.gameBounds.height/10*.5,n=this.add.sprite(e.x,e.y,u.TEXTURE_LINE);n.setOrigin(.5,1),n.setTint(12290303),this.skillGridContainer.add(n),n.setDepth(60);const o=4,r=o/u.EFFECT_TEXTURE_SIZE,c=o/u.EFFECT_LINE_HEIGHT;n.setScale(r,c),n.setAlpha(1);const h=a/u.EFFECT_TEXTURE_SIZE,l=a/u.EFFECT_LINE_HEIGHT;this.tweens.add({targets:n,scaleX:h,scaleY:l,duration:150,ease:"Power2.easeOut",onComplete:()=>{const d=a*3,g=d/u.EFFECT_LINE_HEIGHT,f=h*.1;this.tweens.add({targets:n,scaleX:f,scaleY:g,alpha:0,y:e.y-d*.5,duration:250,ease:"Power2.easeIn",onComplete:()=>n.destroy()})}})}showPhantomCastEffectAt(t,s){const e=this.worldToScreen(t,s),i=this.add.graphics();this.skillGridContainer.add(i),i.fillStyle(12290303,.6),i.fillCircle(e.x,e.y,20),this.tweens.add({targets:i,alpha:0,duration:200,onComplete:()=>i.destroy()})}dismissPhantomById(t){const s=this.phantoms.findIndex(g=>g.id===t);if(s===-1)return;const e=this.phantoms[s];e.skillTimer.destroy(),e.dismissTimer.destroy(),e.tauntTimer.destroy(),this.monsterManager.clearTauntTarget(),this.phantoms.splice(s,1),this.phantoms.length===0&&this.globalChainRayTimer&&(this.globalChainRayTimer.destroy(),this.globalChainRayTimer=void 0);const i=this.worldToScreen(e.x,e.y),n=this.gameBounds.height/10*.5,o=this.add.sprite(i.x,i.y,u.TEXTURE_LINE);o.setOrigin(.5,1),o.setTint(u.PHANTOM_COLOR),this.skillGridContainer.add(o),o.setDepth(60);const r=4,c=r/u.EFFECT_TEXTURE_SIZE,h=r/u.EFFECT_LINE_HEIGHT;o.setScale(c,h),o.setAlpha(1);const l=n/u.EFFECT_TEXTURE_SIZE,d=n/u.EFFECT_LINE_HEIGHT;this.tweens.add({targets:o,scaleX:l,scaleY:d,duration:150,ease:"Power2.easeOut",onComplete:()=>{const g=n*3,f=g/u.EFFECT_LINE_HEIGHT,m=l*.1;this.tweens.add({targets:o,scaleX:m,scaleY:f,alpha:0,y:i.y-g*.5,duration:250,ease:"Power2.easeIn",onComplete:()=>o.destroy()})}}),e.sprite.destroy(),this.phantomSawBladeActive.delete(t)}createAfterimage(t){const s=this.worldToScreen(t.x,t.y),e=this.add.sprite(s.x,s.y,"char_idle_1");e.setOrigin(.5,1),e.setScale(t.sprite.scaleX,t.sprite.scaleY),e.setFlipX(t.sprite.flipX),e.setAlpha(.3),e.setTint(u.PHANTOM_COLOR),this.skillGridContainer.add(e),e.setDepth(54),this.tweens.add({targets:e,alpha:0,duration:300,onComplete:()=>e.destroy()})}updateZeroTrustVisual(t){if(this.isPaused)return;const s=this.skillManager.getEquippedAdvancedSkill();if(!s||s.definition.id!=="advanced_zero_trust"){this.zeroTrustActive&&this.deactivateZeroTrust();return}this.zeroTrustActive||this.activateZeroTrust(s.level),this.updateZeroTrust(s.level,t)}updatePhantomVisual(t){if(this.isPaused)return;const s=this.time.now;for(const e of this.phantoms){if(e.moving){const a=e.targetX-e.x,n=e.targetY-e.y,o=Math.sqrt(a*a+n*n),c=this.moveSpeed*4*t/1e3;if(o<=c)e.x=e.targetX,e.y=e.targetY,e.moving=!1,e.sprite.anims&&e.sprite.play("char_idle",!0);else{const h=c/o;e.x+=a*h,e.y+=n*h,a<0?e.sprite.setFlipX(!0):a>0&&e.sprite.setFlipX(!1),s-e.lastAfterimageTime>50&&(this.createAfterimage(e),e.lastAfterimageTime=s)}}const i=this.worldToScreen(e.x,e.y);e.sprite.setPosition(i.x,i.y),e.sprite.setScale(this.character.scaleX,this.character.scaleY)}}getPhantomPosition(){if(this.phantoms.length>0){const t=this.phantoms[0];return{x:t.x,y:t.y,active:!0}}return{x:0,y:0,active:!1}}updateTimerDisplay(){const t=Math.floor(this.gameTimer/1e3),s=Math.floor(t/60),e=t%60,i=`${s.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`;this.timerText.setText(i)}createSkillInfoPanel(){const t=this.gameBounds,s=200,e=80,i=t.width*.05,a=t.x+i,n=t.y+t.height-e-i-60;this.skillInfoPanel=this.add.container(a,n),this.skillInfoPanel.setDepth(1003),this.skillInfoBg=this.add.rectangle(0,0,s,e,0,.7),this.skillInfoBg.setOrigin(0,0),this.skillInfoBg.setStrokeStyle(1,6710886),this.skillInfoPanel.add(this.skillInfoBg);const o=10,r=Math.max(u.MIN_FONT_SIZE_SMALL,12);this.skillInfoText=this.add.text(o,o,"",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${r}px`,color:"#ffffff",wordWrap:{width:s-o*2}}),this.skillInfoText.setResolution(2),this.skillInfoPanel.add(this.skillInfoText),this.skillInfoPanel.setVisible(!1),this.uiContainer.add(this.skillInfoPanel)}setupSkillIconInteractions(){const t=u.ACTIVE_SKILLS;for(let s=0;s<this.skillIconContainers.length;s++){const e=this.skillIconContainers[s],i=s<t,a=i?s:s-t;e.setSize(e.getBounds().width,e.getBounds().height),e.setInteractive({useHandCursor:!0}),e.on("pointerdown",()=>{this.showSkillInfo(i,a)})}}showSkillInfo(t,s){const i=(t?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills())[s];if(!i){this.skillInfoPanel.setVisible(!1);return}const a=[];a.push(`【${i.definition.name}】${rt.formatLevel(i.level,i.definition.maxLevel)}`),t?this.appendActiveSkillInfo(a,i):this.appendPassiveSkillInfo(a,i),this.skillInfoText.setText(a.join(`
`));const n=this.skillInfoText.getBounds(),o=10;this.skillInfoBg.setSize(Math.max(180,n.width+o*2),n.height+o*2),this.skillInfoPanel.setVisible(!0),this.skillInfoHideTimer&&this.skillInfoHideTimer.destroy(),this.skillInfoHideTimer=this.time.delayedCall(3e3,()=>{this.skillInfoPanel.setVisible(!1)})}showAdvancedSkillInfo(t){const s=t.definition,e=t.level,i=this.skillManager.getSyncRateCooldownReduction(),a=this.skillManager.getAiEnhancementDamageBonus(),n=[];if(n.push(`【${s.name}】${rt.formatLevel(e,s.maxLevel)}`),s.subtitle&&n.push(s.subtitle),s.id==="advanced_burning_celluloid"){const c=this.currentLevel+e,h=u.DAMAGE_UNIT*c,l=Math.floor(h*(1+a)),g=(s.cooldown*(1-i)/1e3).toFixed(1);n.push("HP 消耗: 10"),n.push(`傷害: ${c} 單位（${l}）`),n.push("範圍: 7 單位 / 30°"),n.push(`冷卻: ${g}s`)}else if(s.id==="advanced_tech_artist"){const c=this.currentLevel+e,h=u.DAMAGE_UNIT*c,l=Math.floor(h*(1+a)),g=(s.cooldown*(1-i)/1e3).toFixed(1);n.push(`傷害: ${c} 單位（${l}）`),n.push("範圍: 5 單位隨機 / 3 單位爆炸"),n.push("癱瘓: 1s"),n.push(`冷卻: ${g}s`)}else if(s.id==="advanced_absolute_defense"){const c=this.currentLevel+e,h=u.DAMAGE_UNIT*c,l=Math.floor(h*(1+a)),d=this.currentShield/this.maxShield,g=Math.max(1,Math.ceil(d*6)),f=Math.ceil(this.maxShield*.02);n.push(`傷害: ${c} 單位（${l}）`),n.push(`輪鋸數量: ${g} / 6`),n.push("旋轉速度: 2 秒/圈"),n.push(`撞敵耗盾: ${f} (2%)`),n.push(`當前護盾: ${this.currentShield}/${this.maxShield}`)}else if(s.id==="advanced_perfect_pixel"){const c=this.currentLevel+e,h=u.DAMAGE_UNIT*c,l=Math.floor(h*(1+a)),g=(s.cooldown*(1-i)/1e3).toFixed(1);n.push(`傷害: ${c} 單位（${l}）`),n.push("爆炸範圍: 3 單位"),n.push("焦點輪轉: 四焦點循環"),n.push("暈眩: 1s"),n.push(`冷卻: ${g}s`)}else if(s.id==="advanced_vfx_burst"){const c=this.currentLevel+e,h=u.DAMAGE_UNIT*c,l=Math.floor(h*(1+a)),g=(s.cooldown*(1-i)/1e3).toFixed(1),f=20;n.push(`導彈數量: ${f} 枚`),n.push(`單發傷害: ${c} 單位（${l}）`),n.push(`總傷害: ${l*f}`),n.push(`冷卻: ${g}s`)}else if(s.id==="advanced_zero_trust"){const c=this.currentLevel+e,h=u.DAMAGE_UNIT*c,l=Math.floor(h*(1+a)),d=l*5,g=4+Math.floor(e/5);n.push(`傷害: ${c} 單位（${l}）`),n.push(`每秒傷害: ${d}（0.2秒/次）`),n.push(`光束數量: ${g} 發（4+Lv/5）`),n.push("傷害範圍: 1 單位"),n.push("矩陣半徑: 5 單位"),n.push("減速效果: 50%")}else if(s.id==="advanced_phantom_iteration"){const c=Math.floor(e/5)+10,l=(s.cooldown*(1-i)/1e3).toFixed(1),d=c>parseFloat(l);if(n.push(`持續時間: ${c} 秒 (Sk${e}/5+10)`),n.push(`冷卻: ${l}s`),n.push("分身行為: 每0.5秒施放隨機技能"),n.push("可用技: 賽璐珞/美術/特效/彈射"),n.push("嘲諷: 每5秒吸引怪物2秒"),d)n.push("狀態: 可多分身重疊！");else{const g=Math.ceil((parseFloat(l)-8+1)*5);n.push(`狀態: Lv${g} 開始可重疊`)}}else if(s.id==="advanced_soul_slash"){const c=this.currentLevel+e,h=u.DAMAGE_UNIT*c,l=Math.floor(h*(1+a)),g=(s.cooldown*(1-i)/1e3).toFixed(1);n.push(`傷害: ${c} 單位（${l}）`),n.push("範圍: 貫穿全螢幕直線"),n.push("寬度: 0.5 單位"),n.push(`冷卻: ${g}s`)}this.skillInfoText.setText(n.join(`
`));const o=this.skillInfoText.getBounds(),r=10;this.skillInfoBg.setSize(Math.max(180,o.width+r*2),o.height+r*2),this.skillInfoPanel.setVisible(!0),this.skillInfoHideTimer&&this.skillInfoHideTimer.destroy(),this.skillInfoHideTimer=this.time.delayedCall(3e3,()=>{this.skillInfoPanel.setVisible(!1)})}appendActiveSkillInfo(t,s){const e=s.level,i=this.skillManager.getAiEnhancementDamageBonus(),a=this.skillManager.getSyncRateCooldownReduction();switch(s.definition.id){case"active_soul_render":{const n=60+e*10,o=2+e,r=u.DAMAGE_UNIT*o,c=Math.floor(r*(1+i)),l=((s.definition.cooldown||1e3)*(1-a)/1e3).toFixed(1);t.push(`扇形角度: ${n}°`),t.push("射程: 3 單位"),t.push(`傷害: ${c}`),t.push(`冷卻: ${l}s`);break}case"active_coder":{const n=2+e*.5,o=(1+e)*2,r=u.DAMAGE_UNIT*o,c=Math.floor(r*(1+i)),l=((s.definition.cooldown||2e3)*(1-a)/1e3).toFixed(1);t.push(`範圍: ${n} 單位`),t.push(`傷害: ${c}`),t.push(`冷卻: ${l}s`);break}case"active_vfx":{const n=e>=s.definition.maxLevel,o=1+e,r=u.DAMAGE_UNIT*o,c=Math.floor(r*(1+i)),l=((s.definition.cooldown||2500)*(1-a)/1e3).toFixed(1);n?(t.push("精準鎖定: 3 道超粗射線"),t.push("射程: 15 單位")):(t.push(`光束數: ${e+1} 道`),t.push("射程: 10 單位")),t.push(`傷害: ${c}`),t.push(`冷卻: ${l}s`);break}case"active_architect":{const o=Math.floor(this.maxHp*.3),r=1+e*1.5,c=u.DAMAGE_UNIT*r,l=((s.definition.cooldown||1e4)*(1-a)/1e3).toFixed(1);t.push(`護盾: ${o} (霸體)`),t.push(`反傷: ${c} + 擊退 1 單位`),t.push(`護盾消失回血: ${o}`),t.push(`冷卻: ${l}s`);break}}this.appendMaxExtraAbility(t,s)}appendMaxExtraAbility(t,s){const e=this.skillManager.getMaxExtraAbilityText(s.definition.id,this.currentLevel);e&&(t.push(""),t.push(e))}appendPassiveSkillInfo(t,s){switch(s.definition.id){case"passive_titanium_liver":{const e=this.skillManager.getTitaniumLiverHpBonus(),i=this.skillManager.getTitaniumLiverRegenInterval()/1e3;if(t.push(`HP 加成: +${Math.round(e*100)}%`),t.push(`最大 HP: ${this.maxHp}`),t.push(`回復: 每 ${i} 秒 +1% HP`),this.skillManager.hasTitaniumLiverRevive()){const a=this.reviveUsed?"(已使用)":"(待命)";t.push(`【不死】抵銷一次死亡 ${a}`)}break}case"passive_sync_rate":{const e=this.skillManager.getSyncRateSpeedBonus(),i=this.skillManager.getSyncRateCooldownReduction();t.push(`移速加成: +${Math.round(e*100)}%`),t.push(`冷卻減少: -${Math.round(i*100)}%`);break}case"passive_retina_module":{const e=this.skillManager.getRetinaModuleExpBonus();t.push(`經驗加成: +${Math.round(e*100)}%`);break}case"passive_ai_enhancement":{const e=this.skillManager.getAiEnhancementDamageBonus(),i=this.skillManager.getAiEnhancementDefenseBonus();t.push(`攻擊加成: +${Math.round(e*100)}%`),t.push(`防禦加成: +${Math.round(i*100)}%`);break}}this.appendMaxExtraAbility(t,s)}updateSkillBarDisplay(){const t=this.skillManager.getPlayerActiveSkills(),s=this.skillManager.getPlayerPassiveSkills(),e=[...t,...s],i=this.skillGridCellSize,a=u.SKILL_GRID_GAP,o=8*(i+a)-a;for(let r=0;r<this.skillIconContainers.length;r++){const c=this.skillIconContainers[r],h=this.skillLevelTexts[r],l=e[r],d=c.list[1],g=this.skillIconSprites[r];if(l)if(d.setFillStyle(l.definition.color,.5),h.setText(rt.formatLevel(l.level,l.definition.maxLevel)),l.definition.iconPrefix){const m=l.definition.iconPrefix.startsWith("P")?`skill_icon_${l.definition.iconPrefix}`:`skill_icon_${l.definition.iconPrefix}${l.level.toString().padStart(2,"0")}`;if(this.textures.exists(m)){if(g)g.setTexture(m),g.setVisible(!0);else{const M=this.add.sprite(0,0,m);M.setOrigin(.5,.5);const S=(o-8)/Math.max(M.width,M.height);M.setScale(S),c.addAt(M,2),this.skillIconSprites[r]=M}d.setAlpha(0)}else g&&g.setVisible(!1),d.setAlpha(1)}else g&&g.setVisible(!1),d.setAlpha(1);else d.setFillStyle(3355443,0),d.setAlpha(1),h.setText(""),g&&g.setVisible(!1)}}createCharacterAnimations(){this.anims.create({key:"char_idle",frames:[{key:"char_idle_1"},{key:"char_idle_2"}],frameRate:2,repeat:-1}),this.anims.create({key:"char_run",frames:[{key:"char_run_1"},{key:"char_run_2"}],frameRate:8,repeat:-1}),this.anims.create({key:"char_attack",frames:[{key:"char_attack_1"},{key:"char_attack_2"}],frameRate:8,repeat:0}),this.anims.create({key:"char_hurt",frames:[{key:"char_hurt"}],frameRate:2,repeat:0})}updateCharacterSprite(){this.character.setPosition(this.characterX,this.characterY),this.character.setScale((this.facingRight?1:-1)*(this.characterSize/this.character.height),this.characterSize/this.character.height)}setCharacterState(t,s=!1){this.characterState!==t&&(this.isHurt&&!s&&t!=="hurt"||this.isAttacking&&!s&&t!=="hurt"||(this.characterState=t,this.character.play(`char_${t}`)))}updateCharacterFacing(t){t>this.characterX?this.facingRight=!0:t<this.characterX&&(this.facingRight=!1)}createSkillPanel(){this.skillPanelContainer=this.add.container(0,0),this.skillPanelContainer.setVisible(!1),this.uiContainer.add(this.skillPanelContainer);const t=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0,.8);t.setInteractive(),this.skillPanelContainer.add(t);const s=this.gameBounds.y+this.gameBounds.height*.12,e=this.add.text(this.gameBounds.x+this.gameBounds.width/2,s,"選擇技能",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(this.gameBounds.height*.07))}px`,color:"#ffffff",fontStyle:"bold"});e.setResolution(2),e.setOrigin(.5,.5),this.skillPanelContainer.add(e);const i=s+this.gameBounds.height*.06,a=this.add.text(this.gameBounds.x+this.gameBounds.width/2,i,"提升你的數位能力",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.025))}px`,color:"#cccccc"});a.setResolution(2),a.setOrigin(.5,.5),this.skillPanelContainer.add(a),this.createSkillOptions();const n=this.gameBounds.y+this.gameBounds.height*.92,o=this.isMobile?"點兩次確認":"重複按同一鍵確認",r=this.add.text(this.gameBounds.x+this.gameBounds.width/2,n,o,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.022))}px`,color:"#888888"});r.setResolution(2),r.setOrigin(.5,.5),this.skillPanelContainer.add(r)}createSkillCutIn(){this.skillCutInContainer=this.add.container(0,0),this.skillCutInContainer.setVisible(!1),this.skillCutInContainer.setDepth(1e3),this.uiContainer.add(this.skillCutInContainer)}showSkillCutIn(t,s){this.skillCutInContainer.removeAll(!0);const e=this.gameBounds.height*.22,i=this.gameBounds.y+this.gameBounds.height*.25,a=this.gameBounds.width*.15,n=this.gameBounds.width-a*2,o=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,i,n,e,0,.75);this.skillCutInContainer.add(o);const r=this.add.graphics(),c=this.gameBounds.x,h=this.gameBounds.x+a,l=20;for(let v=0;v<l;v++){const I=v/l*.75,b=c+a/l*v,P=a/l+1;r.fillStyle(0,I),r.fillRect(b,i-e/2,P,e)}this.skillCutInContainer.add(r);const d=this.add.graphics(),g=this.gameBounds.x+this.gameBounds.width-a;for(let v=0;v<l;v++){const I=(1-v/l)*.75,b=g+a/l*v,P=a/l+1;d.fillStyle(0,I),d.fillRect(b,i-e/2,P,e)}this.skillCutInContainer.add(d);const f=3,m=this.add.graphics(),M=i-e/2-f/2;for(let v=0;v<l;v++){const I=v/l*.8,b=c+a/l*v,P=a/l+1;m.fillStyle(t.color,I),m.fillRect(b,M,P,f)}m.fillStyle(t.color,.8),m.fillRect(h,M,n,f);for(let v=0;v<l;v++){const I=(1-v/l)*.8,b=g+a/l*v,P=a/l+1;m.fillStyle(t.color,I),m.fillRect(b,M,P,f)}this.skillCutInContainer.add(m);const p=this.add.graphics(),S=i+e/2-f/2;for(let v=0;v<l;v++){const I=v/l*.8,b=c+a/l*v,P=a/l+1;p.fillStyle(t.color,I),p.fillRect(b,S,P,f)}p.fillStyle(t.color,.8),p.fillRect(h,S,n,f);for(let v=0;v<l;v++){const I=(1-v/l)*.8,b=g+a/l*v,P=a/l+1;p.fillStyle(t.color,I),p.fillRect(b,S,P,f)}this.skillCutInContainer.add(p);const x=t.maxLevel>0&&s>=t.maxLevel?"MAX":`Lv.${s}`,k=`${t.name} 提升到 ${x}`,y=this.add.text(this.gameBounds.x+this.gameBounds.width/2,i-e*.3,k,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(e*.26))}px`,color:"#ffffff",fontStyle:"bold"});y.setResolution(2),y.setOrigin(.5,.5),this.skillCutInContainer.add(y);let E="";if(t.levelUpQuotes&&t.levelUpQuotes[s]&&(E=t.levelUpQuotes[s]),E){const v=this.add.text(this.gameBounds.x+this.gameBounds.width/2,i+e*.05,E,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(e*.23))}px`,color:"#ffffff"});v.setResolution(2),v.setOrigin(.5,.5),this.skillCutInContainer.add(v)}let T=t.description;t.levelUpMessages&&t.levelUpMessages[s]&&(T=t.levelUpMessages[s]);const A=this.add.text(this.gameBounds.x+this.gameBounds.width/2,i+e*.25,T,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(e*.15))}px`,color:U.Display.Color.IntegerToColor(t.color).rgba});if(A.setResolution(2),A.setOrigin(.5,.5),this.skillCutInContainer.add(A),s>=t.maxLevel&&t.maxExtraAbility){const v=t.maxExtraAbility,I=v.isPercentage?(v.perLevel*100).toFixed(2):v.perLevel.toFixed(2);let b=`【${v.name}】${v.description.replace("{value}",`角色每級 +${I}${v.unit}`)}`;const P=this.add.text(this.gameBounds.x+this.gameBounds.width/2,i+e*.42,b,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(e*.13))}px`,color:"#ffcc00"});P.setResolution(2),P.setOrigin(.5,.5),this.skillCutInContainer.add(P)}this.skillCutInContainer.setX(-this.gameBounds.width),this.skillCutInContainer.setVisible(!0),this.skillCutInContainer.setAlpha(1),this.tweens.add({targets:this.skillCutInContainer,x:0,duration:250,ease:"Power2.easeOut",onComplete:()=>{this.time.delayedCall(2e3,()=>{this.tweens.add({targets:this.skillCutInContainer,x:this.gameBounds.width,duration:250,ease:"Power2.easeIn",onComplete:()=>{this.skillCutInContainer.setVisible(!1),this.skillCutInContainer.setX(0),this.isSkillSelecting=!1}})})}})}showTriggerCutIn(t,s,e){this.skillCutInContainer.removeAll(!0);const i=this.gameBounds.height*.22,a=this.gameBounds.y+this.gameBounds.height*.25,n=this.gameBounds.width*.15,o=this.gameBounds.width-n*2,r=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,a,o,i,0,.85);this.skillCutInContainer.add(r);const c=this.add.graphics(),h=this.gameBounds.x,l=20;for(let E=0;E<l;E++){const T=E/l*.85,A=h+n/l*E,v=n/l+1;c.fillStyle(0,T),c.fillRect(A,a-i/2,v,i)}this.skillCutInContainer.add(c);const d=this.add.graphics(),g=this.gameBounds.x+this.gameBounds.width-n;for(let E=0;E<l;E++){const T=(1-E/l)*.85,A=g+n/l*E,v=n/l+1;d.fillStyle(0,T),d.fillRect(A,a-i/2,v,i)}this.skillCutInContainer.add(d);const f=3,m=this.gameBounds.x+n,M=this.add.graphics(),p=a-i/2-f/2;for(let E=0;E<l;E++){const T=E/l*.8,A=h+n/l*E,v=n/l+1;M.fillStyle(t.color,T),M.fillRect(A,p,v,f)}M.fillStyle(t.color,.8),M.fillRect(m,p,o,f);for(let E=0;E<l;E++){const T=(1-E/l)*.8,A=g+n/l*E,v=n/l+1;M.fillStyle(t.color,T),M.fillRect(A,p,v,f)}this.skillCutInContainer.add(M);const S=this.add.graphics(),x=a+i/2-f/2;for(let E=0;E<l;E++){const T=E/l*.8,A=h+n/l*E,v=n/l+1;S.fillStyle(t.color,T),S.fillRect(A,x,v,f)}S.fillStyle(t.color,.8),S.fillRect(m,x,o,f);for(let E=0;E<l;E++){const T=(1-E/l)*.8,A=g+n/l*E,v=n/l+1;S.fillStyle(t.color,T),S.fillRect(A,x,v,f)}this.skillCutInContainer.add(S);const k=this.add.text(this.gameBounds.x+this.gameBounds.width/2,a-i*.25,s,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(i*.24))}px`,color:U.Display.Color.IntegerToColor(t.color).rgba,fontStyle:"bold"});k.setResolution(2),k.setOrigin(.5,.5),this.skillCutInContainer.add(k);const y=this.add.text(this.gameBounds.x+this.gameBounds.width/2,a+i*.15,e,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(i*.17))}px`,color:"#ffffff"});y.setResolution(2),y.setOrigin(.5,.5),this.skillCutInContainer.add(y),this.skillCutInContainer.setX(-this.gameBounds.width),this.skillCutInContainer.setVisible(!0),this.skillCutInContainer.setAlpha(1),this.tweens.add({targets:this.skillCutInContainer,x:0,duration:250,ease:"Power2.easeOut",onComplete:()=>{this.time.delayedCall(2e3,()=>{this.tweens.add({targets:this.skillCutInContainer,x:this.gameBounds.width,duration:250,ease:"Power2.easeIn",onComplete:()=>{this.skillCutInContainer.setVisible(!1),this.skillCutInContainer.setX(0)}})})}})}createSkillOptions(){this.skillOptions.forEach(l=>l.destroy()),this.skillOptions=[],this.skillCardBgs=[],this.mixedSkillTypes=[],this.mixedNormalIndices=[],this.mixedAdvancedIndices=[];const t=this.skillManager.getMixedSkillOptions();if(this.currentSkillChoices=t.normal,this.currentAdvancedSkillChoices=t.advanced,this.currentSkillChoices.length+this.currentAdvancedSkillChoices.length===0)return;if(this.currentSkillChoices.length===0&&this.currentAdvancedSkillChoices.length>0){this.isSelectingAdvancedSkill=!0,this.currentAdvancedSkillChoices.length>3&&(this.currentAdvancedSkillChoices=this.currentAdvancedSkillChoices.slice(0,3)),this.createAdvancedSkillOptions();return}if(this.currentAdvancedSkillChoices.length>0){this.createMixedSkillOptions();return}this.isSelectingAdvancedSkill=!1;const e=this.gameBounds.width*.25,i=this.gameBounds.height*(this.isMobile?.55:.5),a=this.gameBounds.width*.05,n=this.currentSkillChoices.length,o=e*n+a*(n-1),r=this.gameBounds.x+(this.gameBounds.width-o)/2+e/2,c=this.gameBounds.y+this.gameBounds.height*.55;let h;n===1?h=["2"]:n===2?h=["1","3"]:h=["1","2","3"];for(let l=0;l<this.currentSkillChoices.length;l++){const d=this.currentSkillChoices[l],g=this.skillManager.getSkillLevel(d.id),f=g<0,m=f?"-":g,M=f?0:g+1,p=r+l*(e+a),S=this.add.container(p,c),x=this.add.rectangle(0,0,e,i,2236962);x.setStrokeStyle(2,6710886),S.add(x);const k=this.add.text(0,-i*.42,d.type==="active"?"ACTIVE":"PASSIVE",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.045))}px`,color:d.type==="active"?"#ff6666":"#66ffff",fontStyle:"bold"});k.setResolution(2),k.setOrigin(.5,.5),S.add(k);const y=e*.5,E=-i*.18,T=this.add.rectangle(0,E,y,y,d.color,.3);if(T.setStrokeStyle(2,d.color),S.add(T),d.iconPrefix){const F=d.iconPrefix.startsWith("P")?`skill_icon_${d.iconPrefix}`:`skill_icon_${d.iconPrefix}${M.toString().padStart(2,"0")}`;if(this.textures.exists(F)){const _=this.add.sprite(0,E,F);_.setOrigin(.5,.5);const H=(y-8)/Math.max(_.width,_.height);_.setScale(H),S.add(_),T.setAlpha(0)}}const A=i*.06,v=this.add.text(0,A,d.name,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(i*.08))}px`,color:"#ffffff",fontStyle:"bold"});if(v.setResolution(2),v.setOrigin(.5,.5),S.add(v),d.subtitle){const G=this.isMobile?Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.045)):Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.055)),F=this.add.text(0,i*.12,d.subtitle,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${G}px`,color:"#999999"});F.setResolution(2),F.setOrigin(.5,.5),S.add(F)}let I;M>=d.maxLevel?I=`Lv.${m} → MAX`:f?I=`NEW → Lv.${M}`:I=`Lv.${m} → Lv.${M}`;const b=this.add.text(0,i*.2,I,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.05))}px`,color:M>=d.maxLevel?"#ffff00":"#88ff88",fontStyle:"bold"});b.setResolution(2),b.setOrigin(.5,.5),S.add(b);const P=i*.26,B=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.045)),R=e*(1-u.CARD_TEXT_PADDING*2),D=this.add.text(0,P,d.description,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${B}px`,color:"#dddddd",wordWrap:{width:R,useAdvancedWrap:!0},align:"center"});if(D.setResolution(2),D.setOrigin(.5,0),S.add(D),!this.isMobile){const G=i*.5+i*.08,F=this.add.text(0,G,`[ ${h[l]} ]`,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(i*.06))}px`,color:"#ffff00",fontStyle:"bold"});F.setResolution(2),F.setOrigin(.5,.5),S.add(F)}x.setInteractive({useHandCursor:!0});const L=l;x.on("pointerover",()=>{this.setSelectedSkill(L)}),x.on("pointerdown",()=>{this.isMobile?this.selectedSkillIndex===L?this.confirmSkillSelection():this.setSelectedSkill(L):(this.setSelectedSkill(L),this.confirmSkillSelection())}),this.skillPanelContainer.add(S),this.skillOptions.push(S),this.skillCardBgs.push(x)}this.selectedSkillIndex=0}showSkillPanel(){const t=this.skillManager.hasUpgradeableSkills(),s=this.skillManager.getUpgradeableAdvancedSkills().length>0;!t&&!s||(this.createSkillOptions(),!(this.currentSkillChoices.length>0||this.mixedSkillTypes.length>0||this.isSelectingAdvancedSkill&&this.currentAdvancedSkillChoices.length>0))||(this.isPaused=!0,this.isSkillSelecting=!1,this.isPointerDown=!1,this.skillPanelContainer.setVisible(!0),this.selectedSkillIndex=0,this.skillCardBgs.forEach((i,a)=>{a===0?(i.setFillStyle(3355443),i.setStrokeStyle(3,16777215)):(i.setFillStyle(2236962),i.setStrokeStyle(2,6710886))}),this.skillPanelContainer.setAlpha(0),this.tweens.add({targets:this.skillPanelContainer,alpha:1,duration:200}),this.skillOptions.forEach((i,a)=>{i.setScale(a===0?1.05:1),i.setY(this.gameBounds.y+this.gameBounds.height*.55+50),i.setAlpha(0),this.tweens.add({targets:i,y:this.gameBounds.y+this.gameBounds.height*.55,alpha:1,duration:300,delay:a*100,ease:"Back.easeOut"})}))}hideSkillPanel(){this.isPaused=!1,this.tweens.add({targets:this.skillPanelContainer,alpha:0,duration:200,onComplete:()=>{this.skillPanelContainer.setVisible(!1)}})}selectSkill(t,s){const e=this.currentSkillChoices[t];if(!this.skillManager.learnOrUpgradeSkill(s)){console.warn(`Failed to learn/upgrade skill: ${s}`),this.isSkillSelecting=!1,this.isPaused=!1;return}const a=this.skillManager.getPlayerSkill(s),n=(a==null?void 0:a.level)??0;this.updateSkillBarDisplay(),(a==null?void 0:a.definition.type)==="passive"&&(this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.drawHpBarFill(),this.updateHpText()),this.hideSkillPanel();const o=this.skillOptions[t];this.tweens.add({targets:o,scaleX:1.1,scaleY:1.1,duration:100,yoyo:!0,onComplete:()=>{this.showSkillCutIn(e,n)}})}selectAdvancedSkill(t,s){const e=this.currentAdvancedSkillChoices[t],i=this.skillManager.getEquippedAdvancedSkill(),a=(i==null?void 0:i.definition.id)===s,n=!i;if(!a&&!n&&this.clearAdvancedSkillEffects(),!this.skillManager.setEquippedAdvancedSkill(s)){console.warn(`Failed to equip advanced skill: ${s}`),this.isSkillSelecting=!1,this.isPaused=!1;return}this.skillManager.upgradeAdvancedSkill(s);const r=this.skillManager.getEquippedAdvancedSkill(),c=(r==null?void 0:r.level)??1;this.advancedSkillSlotVisible||this.showAdvancedSkillSlot(),this.updateAdvancedSkillDisplay(),r&&(n||!a&&c===1)?(this.advancedSkillCooldownTime=0,this.activateAdvancedSkill(r),this.advancedSkillCooldownTime=this.time.now):a||(this.advancedSkillCooldownTime=this.time.now),this.hideSkillPanel();const h=this.skillOptions[t];this.tweens.add({targets:h,scaleX:1.1,scaleY:1.1,duration:100,yoyo:!0,onComplete:()=>{this.showAdvancedSkillCutIn(e,c)}})}createAdvancedSkillOptions(){const t=this.gameBounds.width*.25,s=this.gameBounds.height*(this.isMobile?.55:.5),e=this.gameBounds.width*.05,i=this.currentAdvancedSkillChoices.length,a=t*i+e*(i-1),n=this.gameBounds.x+(this.gameBounds.width-a)/2+t/2,o=this.gameBounds.y+this.gameBounds.height*.55;let r;i===1?r=["2"]:i===2?r=["1","3"]:r=["1","2","3"];for(let c=0;c<this.currentAdvancedSkillChoices.length;c++){const h=this.currentAdvancedSkillChoices[c],l=this.skillManager.getAdvancedSkillLevel(h.id),d=l===0,g=d?"-":l,f=d?1:l+1,m=n+c*(t+e),M=this.add.container(m,o),p=this.add.rectangle(0,0,t,s,1710638);p.setStrokeStyle(3,16766720),M.add(p);const S=this.add.text(0,-s*.42,"ADVANCED",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(s*.045))}px`,color:"#ffd700",fontStyle:"bold"});S.setResolution(2),S.setOrigin(.5,.5),M.add(S);const x=t*.5,k=-s*.18,y=this.add.rectangle(0,k,x,x,h.color,.3);if(y.setStrokeStyle(2,h.color),M.add(y),h.iconPrefix){const D=`skill_${h.iconPrefix}0${Math.min(f,h.maxLevel)}`;if(this.textures.exists(D)){const L=this.add.sprite(0,k,D);L.setOrigin(.5,.5);const F=(x-8)/Math.max(L.width,L.height);L.setScale(F),M.add(L),y.setAlpha(0)}}const E=s*.06,T=this.add.text(0,E,h.name,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(s*.08))}px`,color:"#ffd700",fontStyle:"bold"});if(T.setResolution(2),T.setOrigin(.5,.5),M.add(T),h.subtitle){const D=this.isMobile?Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(s*.045)):Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(s*.055)),L=this.add.text(0,s*.12,h.subtitle,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${D}px`,color:"#999999"});L.setResolution(2),L.setOrigin(.5,.5),M.add(L)}let A;const v=h.maxLevel>=0&&f>h.maxLevel;v?A=`Lv.${g} (MAX)`:d?A=`NEW → Lv.${f}`:A=`Lv.${g} → Lv.${f}`;const I=this.add.text(0,s*.2,A,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(s*.05))}px`,color:v?"#ffff00":"#88ff88",fontStyle:"bold"});I.setResolution(2),I.setOrigin(.5,.5),M.add(I);const b=s*.26,P=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(s*.045)),B=t*(1-u.CARD_TEXT_PADDING*2),R=this.add.text(0,b,h.description,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${P}px`,color:"#dddddd",wordWrap:{width:B,useAdvancedWrap:!0},align:"center"});if(R.setResolution(2),R.setOrigin(.5,0),M.add(R),!this.isMobile){const D=s*.5+s*.08,L=this.add.text(0,D,`[ ${r[c]} ]`,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(s*.07))}px`,color:"#ffff00",fontStyle:"bold"});L.setResolution(2),L.setOrigin(.5,.5),M.add(L)}p.setInteractive({useHandCursor:!0}),p.on("pointerover",()=>{const D=this.selectedSkillIndex;this.selectedSkillIndex=c,this.updateSkillCardStyle(D,!1),this.updateSkillCardStyle(c,!0)}),p.on("pointerdown",()=>{this.selectedSkillIndex=c,this.confirmSkillSelection()}),this.skillOptions.push(M),this.skillCardBgs.push(p),this.skillPanelContainer.add(M)}this.selectedSkillIndex=0,this.updateSkillCardStyle(0,!0)}createMixedSkillOptions(){this.mixedSkillTypes=[],this.mixedNormalIndices=[],this.mixedAdvancedIndices=[],this.isSelectingAdvancedSkill=!1;const t=[];for(let l=0;l<Math.min(3,this.currentSkillChoices.length);l++)t.push({type:"normal",index:l});const s=3-t.length;for(let l=0;l<Math.min(s,this.currentAdvancedSkillChoices.length);l++)t.push({type:"advanced",index:l});t.forEach(l=>{this.mixedSkillTypes.push(l.type),l.type==="normal"?(this.mixedNormalIndices.push(l.index),this.mixedAdvancedIndices.push(-1)):(this.mixedNormalIndices.push(-1),this.mixedAdvancedIndices.push(l.index))});const e=this.gameBounds.width*.25,i=this.gameBounds.height*(this.isMobile?.55:.5),a=this.gameBounds.width*.05,n=t.length,o=e*n+a*(n-1),r=this.gameBounds.x+(this.gameBounds.width-o)/2+e/2,c=this.gameBounds.y+this.gameBounds.height*.55;let h;n===1?h=["2"]:n===2?h=["1","3"]:h=["1","2","3"];for(let l=0;l<t.length;l++){const d=t[l],g=r+l*(e+a),f=this.add.container(g,c);if(d.type==="normal"){const m=this.currentSkillChoices[d.index],M=this.skillManager.getSkillLevel(m.id),p=M<0,S=p?"-":M,x=p?0:M+1,k=this.add.rectangle(0,0,e,i,2236962);k.setStrokeStyle(2,6710886),f.add(k);const y=this.add.text(0,-i*.42,m.type==="active"?"ACTIVE":"PASSIVE",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.045))}px`,color:m.type==="active"?"#ff6666":"#66ffff",fontStyle:"bold"});y.setResolution(2),y.setOrigin(.5,.5),f.add(y);const E=e*.5,T=-i*.18,A=this.add.rectangle(0,T,E,E,m.color,.3);if(A.setStrokeStyle(2,m.color),f.add(A),m.iconPrefix){const _=m.iconPrefix.startsWith("P")?`skill_icon_${m.iconPrefix}`:`skill_icon_${m.iconPrefix}${x.toString().padStart(2,"0")}`;if(this.textures.exists(_)){const X=this.add.sprite(0,T,_);X.setOrigin(.5,.5);const z=(E-8)/Math.max(X.width,X.height);X.setScale(z),f.add(X),A.setAlpha(0)}}const v=i*.06,I=this.add.text(0,v,m.name,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(i*.08))}px`,color:"#ffffff",fontStyle:"bold"});if(I.setResolution(2),I.setOrigin(.5,.5),f.add(I),m.subtitle){const F=this.isMobile?Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.045)):Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.055)),_=this.add.text(0,i*.12,m.subtitle,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${F}px`,color:"#999999"});_.setResolution(2),_.setOrigin(.5,.5),f.add(_)}let b;x>=m.maxLevel?b=`Lv.${S} → MAX`:p?b=`NEW → Lv.${x}`:b=`Lv.${S} → Lv.${x}`;const P=this.add.text(0,i*.2,b,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.05))}px`,color:x>=m.maxLevel?"#ffff00":"#88ff88",fontStyle:"bold"});P.setResolution(2),P.setOrigin(.5,.5),f.add(P);const B=i*.26,R=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.045)),D=e*(1-u.CARD_TEXT_PADDING*2),L=this.add.text(0,B,m.description,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${R}px`,color:"#dddddd",wordWrap:{width:D,useAdvancedWrap:!0},align:"center"});if(L.setResolution(2),L.setOrigin(.5,0),f.add(L),!this.isMobile){const F=i*.5+i*.08,_=this.add.text(0,F,`[ ${h[l]} ]`,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(i*.06))}px`,color:"#ffff00",fontStyle:"bold"});_.setResolution(2),_.setOrigin(.5,.5),f.add(_)}k.setInteractive({useHandCursor:!0});const G=l;k.on("pointerover",()=>{this.setSelectedSkill(G)}),k.on("pointerdown",()=>{this.isMobile?this.selectedSkillIndex===G?this.confirmMixedSkillSelection():this.setSelectedSkill(G):(this.setSelectedSkill(G),this.confirmMixedSkillSelection())}),this.skillCardBgs.push(k)}else{const m=this.currentAdvancedSkillChoices[d.index],M=this.skillManager.getAdvancedSkillLevel(m.id),p=M===0,S=p?"-":M,x=p?1:M+1,k=this.add.rectangle(0,0,e,i,1710638);k.setStrokeStyle(3,16766720),f.add(k);const y=this.add.text(0,-i*.42,"ADVANCED",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.045))}px`,color:"#ffd700",fontStyle:"bold"});y.setResolution(2),y.setOrigin(.5,.5),f.add(y);const E=e*.5,T=-i*.18,A=this.add.rectangle(0,T,E,E,m.color,.3);if(A.setStrokeStyle(2,m.color),f.add(A),m.iconPrefix){const _=`skill_${m.iconPrefix}0${Math.min(x,m.maxLevel<0?x:m.maxLevel)}`;if(this.textures.exists(_)){const X=this.add.sprite(0,T,_);X.setOrigin(.5,.5);const z=(E-8)/Math.max(X.width,X.height);X.setScale(z),f.add(X),A.setAlpha(0)}}const v=i*.06,I=this.add.text(0,v,m.name,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(i*.08))}px`,color:"#ffd700",fontStyle:"bold"});if(I.setResolution(2),I.setOrigin(.5,.5),f.add(I),m.subtitle){const _=this.isMobile?Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.045)):Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.055)),X=this.add.text(0,i*.12,m.subtitle,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${_}px`,color:"#999999"});X.setResolution(2),X.setOrigin(.5,.5),f.add(X)}let b;const P=m.maxLevel>=0&&x>m.maxLevel;P?b=`Lv.${S} (MAX)`:p?b=`NEW → Lv.${x}`:b=`Lv.${S} → Lv.${x}`;const B=this.add.text(0,i*.2,b,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.05))}px`,color:P?"#ffff00":"#88ff88",fontStyle:"bold"});B.setResolution(2),B.setOrigin(.5,.5),f.add(B);const R=i*.26,D=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.045)),L=e*(1-u.CARD_TEXT_PADDING*2),G=this.add.text(0,R,m.description,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${D}px`,color:"#dddddd",wordWrap:{width:L,useAdvancedWrap:!0},align:"center"});if(G.setResolution(2),G.setOrigin(.5,0),f.add(G),!this.isMobile){const _=i*.5+i*.08,X=this.add.text(0,_,`[ ${h[l]} ]`,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(i*.07))}px`,color:"#ffff00",fontStyle:"bold"});X.setResolution(2),X.setOrigin(.5,.5),f.add(X)}k.setInteractive({useHandCursor:!0});const F=l;k.on("pointerover",()=>{this.setSelectedSkill(F)}),k.on("pointerdown",()=>{this.isMobile?this.selectedSkillIndex===F?this.confirmMixedSkillSelection():this.setSelectedSkill(F):(this.setSelectedSkill(F),this.confirmMixedSkillSelection())}),this.skillCardBgs.push(k)}this.skillOptions.push(f),this.skillPanelContainer.add(f)}this.selectedSkillIndex=0,this.updateSkillCardStyle(0,!0)}confirmMixedSkillSelection(){if(this.isSkillSelecting)return;this.isSkillSelecting=!0;const t=this.selectedSkillIndex;if(t<0||t>=this.mixedSkillTypes.length)return;if(this.mixedSkillTypes[t]==="normal"){const e=this.mixedNormalIndices[t];if(e>=0&&e<this.currentSkillChoices.length){const i=this.currentSkillChoices[e];this.selectSkill(e,i.id)}}else{const e=this.mixedAdvancedIndices[t];if(e>=0&&e<this.currentAdvancedSkillChoices.length){const i=this.currentAdvancedSkillChoices[e],a=this.skillManager.getEquippedAdvancedSkill(),n=(a==null?void 0:a.definition.id)===i.id,o=!a;!n&&!o&&this.clearAdvancedSkillEffects(),this.skillManager.setEquippedAdvancedSkill(i.id),this.skillManager.upgradeAdvancedSkill(i.id);const r=this.skillManager.getAdvancedSkillLevel(i.id);this.showAdvancedSkillSlot(),this.updateAdvancedSkillDisplay();const c=this.skillManager.getEquippedAdvancedSkill();c&&(o||!n&&r===1)?(this.advancedSkillCooldownTime=0,this.activateAdvancedSkill(c),this.advancedSkillCooldownTime=this.time.now):n||(this.advancedSkillCooldownTime=this.time.now),this.hideSkillPanel(),this.showAdvancedSkillCutIn(i,r)}}}showAdvancedSkillCutIn(t,s){const e=this.generateAdvancedSkillMessage(t,s),i=this.generateAdvancedSkillQuote(t,s);this.showAdvancedSkillCutInDirect(t,s,e,i)}showAdvancedSkillCutInDirect(t,s,e,i){this.skillCutInContainer.removeAll(!0);const a=this.gameBounds.height*.22,n=this.gameBounds.y+this.gameBounds.height*.25,o=this.gameBounds.width*.15,r=this.gameBounds.width-o*2,c=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,n,r,a,0,.75);this.skillCutInContainer.add(c);const h=this.add.graphics(),l=this.gameBounds.x,d=this.gameBounds.x+o,g=20;for(let v=0;v<g;v++){const I=v/g*.75,b=l+o/g*v,P=o/g+1;h.fillStyle(0,I),h.fillRect(b,n-a/2,P,a)}this.skillCutInContainer.add(h);const f=this.add.graphics(),m=this.gameBounds.x+this.gameBounds.width-o;for(let v=0;v<g;v++){const I=(1-v/g)*.75,b=m+o/g*v,P=o/g+1;f.fillStyle(0,I),f.fillRect(b,n-a/2,P,a)}this.skillCutInContainer.add(f);const M=3,p=t.color,S=this.add.graphics(),x=n-a/2-M/2;for(let v=0;v<g;v++){const I=v/g*.8,b=l+o/g*v,P=o/g+1;S.fillStyle(p,I),S.fillRect(b,x,P,M)}S.fillStyle(p,.8),S.fillRect(d,x,r,M);for(let v=0;v<g;v++){const I=(1-v/g)*.8,b=m+o/g*v,P=o/g+1;S.fillStyle(p,I),S.fillRect(b,x,P,M)}this.skillCutInContainer.add(S);const k=this.add.graphics(),y=n+a/2-M/2;for(let v=0;v<g;v++){const I=v/g*.8,b=l+o/g*v,P=o/g+1;k.fillStyle(p,I),k.fillRect(b,y,P,M)}k.fillStyle(p,.8),k.fillRect(d,y,r,M);for(let v=0;v<g;v++){const I=(1-v/g)*.8,b=m+o/g*v,P=o/g+1;k.fillStyle(p,I),k.fillRect(b,y,P,M)}this.skillCutInContainer.add(k);const E=`${t.name} 提升到 Lv.${s}`,T=this.add.text(this.gameBounds.x+this.gameBounds.width/2,n-a*.3,E,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(a*.26))}px`,color:"#ffffff",fontStyle:"bold"});if(T.setResolution(2),T.setOrigin(.5,.5),this.skillCutInContainer.add(T),i){const v=this.add.text(this.gameBounds.x+this.gameBounds.width/2,n+a*.05,i,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(a*.23))}px`,color:"#ffffff"});v.setResolution(2),v.setOrigin(.5,.5),this.skillCutInContainer.add(v)}const A=this.add.text(this.gameBounds.x+this.gameBounds.width/2,n+a*.25,e,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(a*.15))}px`,color:U.Display.Color.IntegerToColor(p).rgba});A.setResolution(2),A.setOrigin(.5,.5),this.skillCutInContainer.add(A),this.skillCutInContainer.setX(-this.gameBounds.width),this.skillCutInContainer.setVisible(!0),this.skillCutInContainer.setAlpha(1),this.tweens.add({targets:this.skillCutInContainer,x:0,duration:250,ease:"Power2.easeOut",onComplete:()=>{this.time.delayedCall(1500,()=>{this.tweens.add({targets:this.skillCutInContainer,x:this.gameBounds.width,duration:200,ease:"Power2.easeIn",onComplete:()=>{this.skillCutInContainer.setVisible(!1),this.isSkillSelecting=!1}})})}})}generateAdvancedSkillMessage(t,s){const e=this.currentLevel+s,i=u.DAMAGE_UNIT*e;switch(t.id){case"advanced_burning_celluloid":return`Lv.${s} - 傷害 ${e} 單位（${i}）`;case"advanced_tech_artist":return`Lv.${s} - 傷害 ${e} 單位（${i}）`;case"advanced_absolute_defense":return`Lv.${s} - 傷害 ${e} 單位（${i}）`;case"advanced_perfect_pixel":return`Lv.${s} - 傷害 ${e} 單位（${i}）`;case"advanced_vfx_burst":return`Lv.${s} - 傷害 ${e} 單位（${i}）`;case"advanced_phantom_iteration":{const a=Math.floor(s/5)+8;return`Lv.${s} - 持續 ${a} 秒`}case"advanced_zero_trust":return`Lv.${s} - 傷害 ${e} 單位（${i}）`;case"advanced_soul_slash":return`Lv.${s} - 傷害 ${e} 單位（${i}）`;default:return`Lv.${s}`}}generateAdvancedSkillQuote(t,s){return t.levelUpQuotes&&t.levelUpQuotes.length>0?t.levelUpQuotes[0]:t.subtitle||""}createSkillGrid(){const t=this.cameras.main.width,s=1920,e=20/this.gridScaleMultiplier,i=6/this.gridScaleMultiplier,a=Math.min(1,t/s);this.skillGridCellSize=Math.max(i,Math.floor(e*a));const n=u.SKILL_GRID_GAP;this.skillGridCols=Math.ceil((this.gameBounds.width+n)/(this.skillGridCellSize+n)),this.skillGridRows=Math.ceil((this.gameBounds.height+n)/(this.skillGridCellSize+n)),this.skillGridContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.skillGridContainer.setDepth(3);for(let o=0;o<this.skillGridRows;o++)for(let r=0;r<this.skillGridCols;r++){const c=r*(this.skillGridCellSize+n)+this.skillGridCellSize/2,h=o*(this.skillGridCellSize+n)+this.skillGridCellSize/2,l=this.add.rectangle(c,h,this.skillGridCellSize,this.skillGridCellSize,16777215,0);l.setVisible(!1),this.skillGridCells.push(l),this.skillGridContainer.add(l)}this.drawBorderFrame()}recreateSkillGrid(){this.skillGridCells.forEach(t=>t.destroy()),this.skillGridCells=[],this.skillGridContainer&&this.skillGridContainer.destroy(),this.createSkillGrid(),this.recreateSkillBar(),this.bringUIToTop()}bringUIToTop(){this.characterContainer&&this.uiContainer.bringToTop(this.characterContainer),this.hpBarContainer&&this.uiContainer.bringToTop(this.hpBarContainer),this.shieldText&&this.uiContainer.bringToTop(this.shieldText),this.expBarContainer&&this.uiContainer.bringToTop(this.expBarContainer),this.skillIconContainers.forEach(t=>{this.uiContainer.bringToTop(t)}),this.skillIconGridGraphics.forEach(t=>{this.uiContainer.bringToTop(t)}),this.skillInfoPanel&&this.uiContainer.bringToTop(this.skillInfoPanel),this.skillPanelContainer&&this.uiContainer.bringToTop(this.skillPanelContainer)}recreateSkillBar(){this.skillIcons.forEach(t=>t.destroy()),this.skillIcons=[],this.skillIconContainers.forEach(t=>t.destroy()),this.skillIconContainers=[],this.skillLevelTexts.forEach(t=>t.destroy()),this.skillLevelTexts=[],this.skillIconGridGraphics.forEach(t=>t.destroy()),this.skillIconGridGraphics=[],this.skillIconGridData=[],this.skillIconSprites=[],this.skillInfoPanel&&this.skillInfoPanel.destroy(),this.createSkillBar()}initSkillEffectPool(){for(let t=0;t<u.SKILL_EFFECT_POOL_SIZE;t++){const s=this.add.sprite(0,0,u.TEXTURE_CIRCLE);s.setVisible(!1),s.setActive(!1),s.setDepth(51),this.worldContainer.add(s),this.skillEffectPool.push(s)}}getSkillEffectSprite(){let t=this.skillEffectPool.pop();return t||(t=this.add.sprite(0,0,u.TEXTURE_CIRCLE),t.setDepth(51),this.worldContainer.add(t)),t.setVisible(!0),t.setActive(!0),this.activeSkillEffects.push(t),t}releaseSkillEffectSprite(t){t.setVisible(!1),t.setActive(!1),t.setScale(1),t.setRotation(0),t.setAlpha(1),t.setTint(16777215);const s=this.activeSkillEffects.indexOf(t);s>-1&&this.activeSkillEffects.splice(s,1),this.skillEffectPool.push(t)}initLineEffectPool(){for(let t=0;t<u.LINE_EFFECT_POOL_SIZE;t++){const s=this.add.sprite(0,0,u.TEXTURE_LINE);s.setVisible(!1),s.setActive(!1),s.setDepth(58),this.skillGridContainer.add(s),this.lineEffectPool.push(s)}}getLineEffectSprite(){let t=this.lineEffectPool.pop();return t||(t=this.add.sprite(0,0,u.TEXTURE_LINE),t.setDepth(58),this.skillGridContainer.add(t)),t.setVisible(!0),t.setActive(!0),this.activeLineEffects.push(t),t}releaseLineEffectSprite(t){t.setVisible(!1),t.setActive(!1),t.setScale(1),t.setRotation(0),t.setAlpha(1),t.setTint(16777215);const s=this.activeLineEffects.indexOf(t);s>-1&&this.activeLineEffects.splice(s,1),this.lineEffectPool.push(t)}initCircleLineEffectPool(){for(let t=0;t<u.CIRCLE_LINE_EFFECT_POOL_SIZE;t++){const s=this.add.sprite(0,0,u.TEXTURE_CIRCLE_LINE);s.setVisible(!1),s.setActive(!1),s.setDepth(55),this.skillGridContainer.add(s),this.circleLineEffectPool.push(s)}}getCircleLineEffectSprite(){let t=this.circleLineEffectPool.pop();return t||(t=this.add.sprite(0,0,u.TEXTURE_CIRCLE_LINE),t.setDepth(55),this.skillGridContainer.add(t)),t.setVisible(!0),t.setActive(!0),this.activeCircleLineEffects.push(t),t}releaseCircleLineEffectSprite(t){t.setVisible(!1),t.setActive(!1),t.setScale(1),t.setRotation(0),t.setAlpha(1),t.setTint(16777215);const s=this.activeCircleLineEffects.indexOf(t);s>-1&&this.activeCircleLineEffects.splice(s,1),this.circleLineEffectPool.push(t)}showHitSparkEffect(t,s,e,i,a=4){const n=this.worldToScreen(t,s),o=this.gameBounds.height/10,r=a,c=o*1.2,h=36,l=35*(Math.PI/180),d=e>>16&255,g=e>>8&255,f=e&255,m=[e,Math.min(255,d+30)<<16|Math.min(255,g+30)<<8|Math.min(255,f+30),Math.min(255,d+60)<<16|Math.min(255,g+60)<<8|Math.min(255,f+60),16777215,Math.min(255,d+40)<<16|Math.min(255,g+40)<<8|Math.min(255,f+40),e,Math.min(255,d+20)<<16|Math.min(255,g+20)<<8|Math.min(255,f+20),16777215];for(let M=0;M<r;M++){let p,S,x;const k=.6+Math.random()*.8,y=.7+Math.random()*.6,E=c*k,T=h*y;if(i!==void 0){const R=i+Math.PI,D=(M/(r-1)-.5)*2*l,L=(Math.random()-.5)*.5;p=R+D+L;const G=R+Math.PI/2,F=(M/(r-1)-.5)*o*.8,_=(Math.random()-.5)*o*.3,X=E*.5;S=n.x+Math.cos(G)*(F+_)+Math.cos(p)*X,x=n.y+Math.sin(G)*(F+_)+Math.sin(p)*X}else{p=Math.random()*Math.PI*2;const R=E*.5;S=n.x+Math.cos(p)*R+(Math.random()-.5)*o*.3,x=n.y+Math.sin(p)*R+(Math.random()-.5)*o*.3}const A=this.getLineEffectSprite();A.setPosition(S,x),A.setTint(m[M%m.length]),A.setRotation(p);const v=E/u.EFFECT_TEXTURE_SIZE,I=T/u.EFFECT_LINE_HEIGHT;A.setScale(v,I),A.setAlpha(1);const b=o*(1.2+Math.random()*1.3),P=S+Math.cos(p)*b,B=x+Math.sin(p)*b;this.tweens.add({targets:A,x:P,y:B,alpha:0,scaleX:v*.2,scaleY:I*.4,duration:280+Math.random()*140,ease:"Power2",onComplete:()=>{this.releaseLineEffectSprite(A)}})}}showExplosionSparkEffect(t,s,e,i=1.5){const a=this.gameBounds.height/10,n=8,o=a*1.5,r=32,c=a*i,h=e>>16&255,l=e>>8&255,d=e&255,g=[Math.max(0,h-40)<<16|Math.max(0,l-40)<<8|Math.max(0,d-40),Math.max(0,h-20)<<16|Math.max(0,l-20)<<8|Math.max(0,d-20),e,Math.min(255,h+30)<<16|Math.min(255,l+30)<<8|Math.min(255,d+30),Math.min(255,h+60)<<16|Math.min(255,l+60)<<8|Math.min(255,d+60),Math.min(255,h+90)<<16|Math.min(255,l+90)<<8|Math.min(255,d+90),16777215,Math.min(255,h+50)<<16|Math.min(255,l+50)<<8|Math.min(255,d+50)];for(let f=0;f<n;f++){const m=.6+Math.random()*.8,M=.7+Math.random()*.6,p=o*m,S=r*M,x=f/n*Math.PI*2+(Math.random()-.5)*.6,k=p*.5,y=t+Math.cos(x)*k,E=s+Math.sin(x)*k,T=this.getLineEffectSprite();T.setPosition(y,E),T.setTint(g[f%g.length]),T.setRotation(x);const A=p/u.EFFECT_TEXTURE_SIZE,v=S/u.EFFECT_LINE_HEIGHT;T.setScale(A,v),T.setAlpha(1);const I=c*(.9+Math.random()*.5),b=t+Math.cos(x)*I,P=s+Math.sin(x)*I;this.tweens.add({targets:T,x:b,y:P,alpha:0,scaleX:A*.3,duration:250+Math.random()*100,ease:"Power2",onComplete:()=>{this.releaseLineEffectSprite(T)}})}}getSectorTextureKey(t){const s=[30,40,50,60,70,80,90,100,110,120,130,140,150,160];let e=s[0],i=Math.abs(t-e);for(const a of s){const n=Math.abs(t-a);n<i&&(i=n,e=a)}return u.TEXTURE_SECTOR_PREFIX+e}flashSkillEffectSector(t,s,e,i,a,n){const o=this.getSkillEffectSprite();if(!o)return;const r=this.getSectorTextureKey(a*2);o.setTexture(r),o.setPosition(t,s),o.setRotation(i);const c=e*2/u.EFFECT_TEXTURE_SIZE;o.setScale(c),o.setTint(n),o.setAlpha(0),this.tweens.add({targets:o,alpha:{from:0,to:.75},scale:{from:c*.5,to:c},duration:150,ease:"Quad.easeOut",onComplete:()=>{this.time.delayedCall(150,()=>{this.tweens.add({targets:o,alpha:0,scale:c*1.1,duration:200,ease:"Quad.easeIn",onComplete:()=>{this.releaseSkillEffectSprite(o)}})})}})}flashSkillEffectCircle(t,s,e,i){const a=this.getSkillEffectSprite();if(!a)return;a.setTexture(u.TEXTURE_CIRCLE),a.setPosition(t,s);const n=e*2/u.EFFECT_TEXTURE_SIZE;a.setScale(n*.3),a.setTint(i),a.setAlpha(0),a.setRotation(0);const o=500,r=this.time.now,c=Math.PI*5,h=Math.PI*200,l=()=>{if(!a.active)return;const d=this.time.now-r,g=Math.min(d/o,1);let f;if(g<.8)f=g*o/1e3*c;else{const p=.8*o/1e3*c,x=(g-.8)/.2*.2*o/1e3*h;f=p+x}a.setRotation(f);let m,M;if(g<.8){const p=g/.8;m=n*.3+(n-n*.3)*p,M=.75}else{const p=(g-.8)/.2;m=n+n*.2*p,M=.75*(1-p)}a.setScale(m),a.setAlpha(M),g<1?this.time.delayedCall(16,l):this.releaseSkillEffectSprite(a)};l()}flashShieldEffect(t,s,e,i){const a=this.worldToScreen(t,s),n=this.gameBounds.height/10,o=this.getSkillEffectSprite();if(!o)return;o.setTexture(u.TEXTURE_SECTOR_360),o.setPosition(a.x,a.y+n*.3);const r=e*2.5/u.EFFECT_TEXTURE_SIZE,c=r*.3;o.setScale(r*.1,c*.1),o.setTint(i),o.setAlpha(0),o.setRotation(0),o.setDepth(199),this.tweens.add({targets:o,scaleX:{from:r*.1,to:r},scaleY:{from:c*.1,to:c},alpha:{from:.8,to:0},duration:500,ease:"Quad.easeOut",onComplete:()=>{this.releaseSkillEffectSprite(o)}});const h=8;for(let l=0;l<h;l++){const d=this.getLineEffectSprite(),g=l/h*Math.PI*2+(Math.random()-.5)*.5,f=n*(.3+Math.random()*.5),m=a.x+Math.cos(g)*f,M=a.y+n*(.1+Math.random()*.3),p=n*(.25+Math.random()*.2),S=20+Math.random()*16;d.setPosition(m,M),d.setRotation(-Math.PI/2+(Math.random()-.5)*.4),d.setScale(p/u.EFFECT_TEXTURE_SIZE,S/u.EFFECT_LINE_HEIGHT),d.setTint(i),d.setAlpha(.9),d.setDepth(200);const x=n*(2+Math.random()*1.5),k=p*2.5,y=500+Math.random()*300,E=l*40;this.tweens.add({targets:d,y:M-x,alpha:0,scaleX:k/u.EFFECT_TEXTURE_SIZE,scaleY:S*.4/u.EFFECT_LINE_HEIGHT,duration:y,delay:E,ease:"Quad.easeOut",onComplete:()=>{this.releaseLineEffectSprite(d)}})}}flashSkillEffectLine(t,s,e,i,a,n){const o=this.getSkillEffectSprite();if(!o)return;o.setTexture(u.TEXTURE_LINE);const r=e-t,c=i-s,h=Math.sqrt(r*r+c*c),l=(t+e)/2,d=(s+i)/2,g=Math.atan2(c,r);o.setPosition(l,d),o.setRotation(g);const f=h/u.EFFECT_TEXTURE_SIZE,m=a/u.EFFECT_LINE_HEIGHT;o.setScale(f,m),o.setTint(n),o.setAlpha(0),this.tweens.add({targets:o,alpha:{from:0,to:.85},scaleY:{from:m*.5,to:m},duration:80,ease:"Quad.easeOut",onComplete:()=>{this.time.delayedCall(300,()=>{this.tweens.add({targets:o,alpha:0,scaleY:m*.2,duration:400,ease:"Quad.easeIn",onComplete:()=>{this.releaseSkillEffectSprite(o)}})})}})}flashSkillEffectSectorMoving(t,s,e,i,a,n,o){const r=this.getSkillEffectSprite();if(!r)return;r.setTexture(u.TEXTURE_SOULWAVE);const c=e*2/u.EFFECT_TEXTURE_SIZE;r.setScale(c),r.setRotation(i),r.setTint(n),r.setAlpha(.6);const h=t+Math.cos(i)*e,l=s+Math.sin(i)*e;r.setPosition(h,l);const d=1e3,g=this.time.now,f=()=>{const m=this.time.now-g,M=Math.min(m/d,1);if(M>=1){this.releaseSkillEffectSprite(r);return}const p=e+o*M,S=t+Math.cos(i)*p,x=s+Math.sin(i)*p;r.setPosition(S,x);const k=.6*(1-M*.7);r.setAlpha(k),this.time.delayedCall(16,f)};f()}worldToScreen(t,s){return{x:t-this.cameraOffsetX,y:s-this.cameraOffsetY}}showSkillRangeCircle(t,s,e,i,a=.3){const n=this.worldToScreen(t,s),o=n.x,r=n.y,c=u.SKILL_GRID_GAP,h=this.skillGridCellSize+c,l=Math.max(0,Math.floor((o-e)/h)),d=Math.min(this.skillGridCols-1,Math.ceil((o+e)/h)),g=Math.max(0,Math.floor((r-e)/h)),f=Math.min(this.skillGridRows-1,Math.ceil((r+e)/h));for(let m=g;m<=f;m++)for(let M=l;M<=d;M++){const p=M*h+this.skillGridCellSize/2,S=m*h+this.skillGridCellSize/2,x=p-o,k=S-r;if(Math.sqrt(x*x+k*k)<=e){const E=m*this.skillGridCols+M;this.activateSkillGridCell(E,i,a)}}}showSkillRangeSector(t,s,e,i,a,n,o=.3){const r=this.worldToScreen(t,s),c=r.x,h=r.y,l=u.SKILL_GRID_GAP,d=this.skillGridCellSize+l,g=Math.max(0,Math.floor((c-e)/d)),f=Math.min(this.skillGridCols-1,Math.ceil((c+e)/d)),m=Math.max(0,Math.floor((h-e)/d)),M=Math.min(this.skillGridRows-1,Math.ceil((h+e)/d));for(let p=m;p<=M;p++)for(let S=g;S<=f;S++){const x=S*d+this.skillGridCellSize/2,k=p*d+this.skillGridCellSize/2,y=x-c,E=k-h,T=Math.sqrt(y*y+E*E);if(T<=e&&T>0){const A=Math.atan2(E,y);let v=Math.abs(A-i);if(v>Math.PI&&(v=2*Math.PI-v),v<=a){const I=p*this.skillGridCols+S;this.activateSkillGridCell(I,n,o)}}}}showSkillRangeLine(t,s,e,i,a,n,o=.3){const r=this.worldToScreen(t,s),c=this.worldToScreen(e,i),h=u.SKILL_GRID_GAP,l=this.skillGridCellSize+h,d=c.x-r.x,g=c.y-r.y,f=Math.sqrt(d*d+g*g);if(f===0)return;const m=d/f,M=g/f,p=-M,S=m,x=a/2,k=[{x:r.x+p*x,y:r.y+S*x},{x:r.x-p*x,y:r.y-S*x},{x:c.x+p*x,y:c.y+S*x},{x:c.x-p*x,y:c.y-S*x}],y=Math.min(...k.map(B=>B.x)),E=Math.max(...k.map(B=>B.x)),T=Math.min(...k.map(B=>B.y)),A=Math.max(...k.map(B=>B.y)),v=Math.max(0,Math.floor(y/l)),I=Math.min(this.skillGridCols-1,Math.ceil(E/l)),b=Math.max(0,Math.floor(T/l)),P=Math.min(this.skillGridRows-1,Math.ceil(A/l));for(let B=b;B<=P;B++)for(let R=v;R<=I;R++){const D=R*l+this.skillGridCellSize/2,L=B*l+this.skillGridCellSize/2,G=Math.max(0,Math.min(1,((D-r.x)*m+(L-r.y)*M)/f)),F=r.x+G*d,_=r.y+G*g;if(Math.sqrt((D-F)**2+(L-_)**2)<=x){const H=B*this.skillGridCols+R;this.activateSkillGridCell(H,n,o)}}}clearSkillGrid(){for(const t of this.activeSkillGridCells){if(this.vignetteEdgeCells.has(t)&&(this.isLowHp||this.currentShield>0))continue;const s=Math.floor(t/this.skillGridCols),e=t%this.skillGridCols;if(s===0||s===this.skillGridRows-1||e===0||e===this.skillGridCols-1||s>=1&&s<=3||s>=this.skillGridRows-3)continue;const i=this.skillGridCells[t];i&&i.setVisible(!1)}this.activeSkillGridCells.clear()}activateSkillGridCell(t,s,e){if(t<0||t>=this.skillGridCells.length)return;const i=this.skillGridCells[t];i&&(i.setFillStyle(s,e),i.setVisible(!0),this.activeSkillGridCells.add(t))}flashGridAt(t,s,e,i=1){const a=this.worldToScreen(t,s),n=u.SKILL_GRID_GAP,o=this.skillGridCellSize+n,r=Math.floor(a.x/o),c=Math.floor(a.y/o),h=600,l=200,d=this.time.now,g=[];for(let M=-i;M<=i;M++)for(let p=-i;p<=i;p++){const S=r+p,x=c+M;if(S<0||S>=this.skillGridCols||x<0||x>=this.skillGridRows)continue;const k=Math.sqrt(M*M+p*p);if(k<=i){const y=x*this.skillGridCols+S,E=this.skillGridCells[y];E&&g.push({cell:E,dist:k})}}if(g.length===0)return;const f=()=>{const M=this.time.now-d,p=Math.min(M/h,1);let S=0;M>l&&(S=(M-l)/(h-l));for(const{cell:x,dist:k}of g){const y=k/Math.max(i,1),T=(1-y*.4)*(1-S);if(T>.01)if(M<l){const v=(1-y)*.5;if(x.setFillStyle(e,T),x.setVisible(!0),k<i*.5){const I=e>>16&255,b=e>>8&255,P=e&255,B=Math.min(255,I+Math.floor((255-I)*v)),R=Math.min(255,b+Math.floor((255-b)*v)),D=Math.min(255,P+Math.floor((255-P)*v)),L=B<<16|R<<8|D;x.setFillStyle(L,T)}}else x.setFillStyle(e,T),x.setVisible(!0);else x.setVisible(!1)}if(p>=1)for(const{cell:x}of g)x.setVisible(!1),x.setAlpha(1)};f();const m=this.time.addEvent({delay:16,callback:f,callbackScope:this,repeat:Math.ceil(h/16)});this.time.delayedCall(h+50,()=>{m.remove();for(const{cell:M}of g)M.setVisible(!1),M.setAlpha(1)})}flashGridAtPositions(t,s,e=1){t.forEach(i=>{this.flashGridAt(i.x,i.y,s,e)})}flashDeathEffect(t,s){const e=this.worldToScreen(t,s),i=u.SKILL_GRID_GAP,a=this.skillGridCellSize+i,n=Math.floor(e.x/a),o=Math.floor(e.y/a),r=3,c=400,h=this.time.now,l=[];for(let S=0;S<r;S++){const x=Math.random()*Math.PI*2,k=2+Math.random()*2;l.push({col:n+Math.round(Math.cos(x)*k),row:o+Math.round(Math.sin(x)*k),radius:3+Math.floor(Math.random()*3)})}const d=new Map;for(const S of l){const x=S.radius;for(let k=-x;k<=x;k++)for(let y=-x;y<=x;y++){const E=Math.sqrt(k*k+y*y);if(E<=x){const T=S.col+y,A=S.row+k;if(T>=0&&T<this.skillGridCols&&A>=0&&A<this.skillGridRows){const v=`${T},${A}`,I=d.get(v);(!I||E<I.dist)&&d.set(v,{col:T,row:A,dist:E})}}}}const g=Array.from(d.values());if(g.length===0)return;const f=Math.max(...g.map(S=>S.dist)),m=[];for(const{col:S,row:x,dist:k}of g){const y=S*a+this.skillGridCellSize/2,E=x*a+this.skillGridCellSize/2,T=this.add.rectangle(y,E,this.skillGridCellSize,this.skillGridCellSize,16777215,0);T.setVisible(!1),this.skillGridContainer.add(T),m.push({rect:T,dist:k})}const M=()=>{const S=this.time.now-h,x=Math.min(S/c,1);for(const{rect:k,dist:y}of m){const E=y/(f+1),T=E+.5;let A=0;if(x>=E&&x<=T&&(x<E+.1?A=(x-E)/.1:A=1-(x-E-.1)/(T-E-.1),A=Math.max(0,Math.min(.8,A))),A>.01){const v=200+Math.floor(Math.random()*55),I=v<<16|v<<8|v;k.setFillStyle(I,A),k.setVisible(!0)}else k.setVisible(!1)}if(x>=1)for(const{rect:k}of m)k.destroy()};M();const p=this.time.addEvent({delay:16,callback:M,callbackScope:this,repeat:Math.ceil(c/16)});this.time.delayedCall(c+50,()=>{p.remove();for(const{rect:S}of m)S.active&&S.destroy()})}flashSkillAreaSector(t,s,e,i,a,n){const o=t,r=s,c=u.SKILL_GRID_GAP,h=this.skillGridCellSize+c,l=500,d=150,g=150,f=this.time.now,m=[],M=o-e,p=o+e,S=r-e,x=r+e;for(let T=S;T<=x;T+=h)for(let A=M;A<=p;A+=h){const v=Math.round(A/h)*h,I=Math.round(T/h)*h,b=v-o,P=I-r,B=Math.sqrt(b*b+P*P);if(B<=e&&B>0){const R=Math.atan2(P,b);let D=Math.abs(R-i);D>Math.PI&&(D=2*Math.PI-D),D<=a&&m.push({worldX:v,worldY:I,dist:B,angleDist:D})}}if(m.length===0)return;const k=[];for(const{worldX:T,worldY:A}of m){const v=this.add.rectangle(T,A,this.skillGridCellSize,this.skillGridCellSize,n,0);v.setVisible(!1),v.setDepth(50),this.worldContainer.add(v),k.push(v)}const y=()=>{const T=this.time.now-f,A=Math.min(T/l,1),v=Math.min(T/d,1),I=e*v;let b=0;T>d+g&&(b=(T-d-g)/(l-d-g));const P=e*b;let B=0;for(const{dist:R,angleDist:D}of m){const L=k[B++];if(L)if(R<=I&&R>=P){const G=R/e,F=D/a,H=Math.max(G,F),z=Math.max(0,Math.min(1,(H-.3)/.7)),V=z*z*(3-2*z),Z=.15+V*.6;let $=1;if(P>0){const N=e*.15;R<P+N&&($=(R-P)/N)}const O=Z*$;if(O>.01){const N=.5+V*.5,Y=n>>16&255,W=n>>8&255,K=n&255;let Q=Y,q=W,j=K;if(H>.85&&T<d+g){const et=(H-.85)/.15;Q=Math.min(255,Y+Math.floor((255-Y)*et*.3)),q=Math.min(255,W+Math.floor((255-W)*et*.3)),j=Math.min(255,K+Math.floor((255-K)*et*.3))}else Q=Math.floor(Y*N),q=Math.floor(W*N),j=Math.floor(K*N);const st=Q<<16|q<<8|j;L.setFillStyle(st,O),L.setVisible(!0)}else L.setVisible(!1)}else L.setVisible(!1)}if(A>=1)for(const R of k)R.destroy()};y();const E=this.time.addEvent({delay:16,callback:y,callbackScope:this,repeat:Math.ceil(l/16)});this.time.delayedCall(l+50,()=>{E.remove();for(const T of k)T.active&&T.destroy()})}flashSkillAreaCircle(t,s,e,i){const a=t,n=s,o=u.SKILL_GRID_GAP,r=this.skillGridCellSize+o,c=500,h=150,l=150,d=this.time.now,g=[],f=a-e,m=a+e,M=n-e,p=n+e;for(let y=M;y<=p;y+=r)for(let E=f;E<=m;E+=r){const T=Math.round(E/r)*r,A=Math.round(y/r)*r,v=T-a,I=A-n,b=Math.sqrt(v*v+I*I);b<=e&&g.push({worldX:T,worldY:A,dist:b})}if(g.length===0)return;const S=[];for(const{worldX:y,worldY:E}of g){const T=this.add.rectangle(y,E,this.skillGridCellSize,this.skillGridCellSize,i,0);T.setVisible(!1),T.setDepth(50),this.worldContainer.add(T),S.push(T)}const x=()=>{const y=this.time.now-d,E=Math.min(y/c,1),T=Math.min(y/h,1),A=e*T;let v=0;y>h+l&&(v=(y-h-l)/(c-h-l));const I=e*v;let b=0;for(const{dist:P}of g){const B=S[b++];if(B)if(P<=A&&P>=I){const R=P/e,D=Math.max(0,Math.min(1,(R-.3)/.7)),L=D*D*(3-2*D),G=.15+L*.6;let F=1;if(I>0){const X=e*.15;P<I+X&&(F=(P-I)/X)}const _=G*F;if(_>.01){const X=.5+L*.5,H=i>>16&255,z=i>>8&255,V=i&255;let Z=H,$=z,O=V;if(R>.85&&y<h+l){const Y=(R-.85)/.15;Z=Math.min(255,H+Math.floor((255-H)*Y*.3)),$=Math.min(255,z+Math.floor((255-z)*Y*.3)),O=Math.min(255,V+Math.floor((255-V)*Y*.3))}else Z=Math.floor(H*X),$=Math.floor(z*X),O=Math.floor(V*X);const N=Z<<16|$<<8|O;B.setFillStyle(N,_),B.setVisible(!0)}else B.setVisible(!1)}else B.setVisible(!1)}if(E>=1)for(const P of S)P.destroy()};x();const k=this.time.addEvent({delay:16,callback:x,callbackScope:this,repeat:Math.ceil(c/16)});this.time.delayedCall(c+50,()=>{k.remove();for(const y of S)y.active&&y.destroy()})}flashSkillAreaLine(t,s,e,i,a,n){const o=t,r=s,c=e,h=i,l=u.SKILL_GRID_GAP,d=this.skillGridCellSize+l,g=c-o,f=h-r,m=Math.sqrt(g*g+f*f);if(m===0)return;const M=g/m,p=f/m,S=-p,x=M,k=a/2,y=800,E=80,T=300,A=y-E-T,v=this.time.now,I=[],b=[{x:o+S*k,y:r+x*k},{x:o-S*k,y:r-x*k},{x:c+S*k,y:h+x*k},{x:c-S*k,y:h-x*k}],P=Math.min(...b.map(_=>_.x)),B=Math.max(...b.map(_=>_.x)),R=Math.min(...b.map(_=>_.y)),D=Math.max(...b.map(_=>_.y));for(let _=R;_<=D;_+=d)for(let X=P;X<=B;X+=d){const H=Math.round(X/d)*d,z=Math.round(_/d)*d,V=H-o,Z=z-r,$=V*M+Z*p;if($<0||$>m)continue;const O=o+M*$,N=r+p*$,Y=Math.sqrt((H-O)**2+(z-N)**2);Y<=k&&I.push({worldX:H,worldY:z,distAlong:$,distToLine:Y})}if(I.length===0)return;const L=[];for(const{worldX:_,worldY:X}of I){const H=this.add.rectangle(_,X,this.skillGridCellSize,this.skillGridCellSize,n,0);H.setVisible(!1),H.setDepth(50),this.worldContainer.add(H),L.push(H)}const G=()=>{const _=this.time.now-v,X=Math.min(_/y,1),H=Math.min(_/E,1),z=m*H;let V=0;_>E+T&&(V=(_-E-T)/A);const Z=m*V,$=1-V;let O=0;for(const{distAlong:N,distToLine:Y}of I){const W=L[O++];if(!W)continue;const K=k*$;if(N<=z&&N>=Z&&Y<=K){const Q=K>0?Y/K:1,q=1-Q*Q;let j=.2+q*.5;const st=N/m,et=Math.min(1,st/.15),pt=Math.min(1,(1-st)/.15),ht=Math.min(et,pt);j*=ht*ht;let ct=1;if(Z>0){const at=m*.1;N<Z+at&&(ct=(N-Z)/at)}const dt=j*ct;if(dt>.01){const at=.6+q*.4,gt=n>>16&255,mt=n>>8&255,St=n&255;let Mt,xt,Ct;if(Q<.2&&_<E+T){const Et=1-Q/.2;Mt=Math.min(255,gt+Math.floor((255-gt)*Et*.3)),xt=Math.min(255,mt+Math.floor((255-mt)*Et*.3)),Ct=Math.min(255,St+Math.floor((255-St)*Et*.3))}else Mt=Math.floor(gt*at),xt=Math.floor(mt*at),Ct=Math.floor(St*at);const At=Mt<<16|xt<<8|Ct;W.setFillStyle(At,dt),W.setVisible(!0)}else W.setVisible(!1)}else W.setVisible(!1)}if(X>=1)for(const N of L)N.destroy()};G();const F=this.time.addEvent({delay:16,callback:G,callbackScope:this,repeat:Math.ceil(y/16)});this.time.delayedCall(y+50,()=>{F.remove();for(const _ of L)_.active&&_.destroy()})}};C(u,"MAP_SCALE",10),C(u,"ACTIVE_SKILLS",4),C(u,"PASSIVE_SKILLS",3),C(u,"FLOOR_HEX_MAX",500),C(u,"FLOOR_HEX_GRID_SIZE",.025),C(u,"HEX_CHARS","0123456789ABCDEF"),C(u,"BINARY_CHARS","01"),C(u,"HEX_CHANCE",.3),C(u,"HEX_TINT_NORMAL",1727002),C(u,"HEX_TINT_HIGHLIGHT",16777215),C(u,"PHANTOM_COLOR",5579434),C(u,"PHANTOM_COLOR_LIGHT",7816396),C(u,"SCAN_INTERVAL",3e4),C(u,"SCAN_WIDTH",.15),C(u,"SCAN_SPEED",.3),C(u,"SCAN_BRIGHTNESS",1),C(u,"CIRCULAR_SCAN_INTERVAL",1e4),C(u,"CIRCULAR_SCAN_WIDTH",.1),C(u,"CIRCULAR_SCAN_SPEED",.8),C(u,"CIRCULAR_SCAN_MAX",1.5),C(u,"DAMAGE_SCAN_COLOR",16729156),C(u,"DAMAGE_SCAN_WIDTH",.08),C(u,"DAMAGE_SCAN_SPEED",1.2),C(u,"DAMAGE_SCAN_MAX",.6),C(u,"SHIELD_SCAN_COLOR",16763904),C(u,"SHIELD_SCAN_WIDTH",.1),C(u,"SHIELD_SCAN_EXPAND_SPEED",1),C(u,"SHIELD_SCAN_CONTRACT_SPEED",2.5),C(u,"SHIELD_SCAN_BURST_SPEED",3),C(u,"SHIELD_SCAN_EXPAND_MAX",.35),C(u,"SHIELD_SCAN_BURST_MAX",.8),C(u,"LEVELUP_SCAN_COLOR",4491519),C(u,"LEVELUP_SCAN_WIDTH",.1),C(u,"LEVELUP_SCAN_EXPAND_SPEED",1.2),C(u,"LEVELUP_SCAN_CONTRACT_SPEED",3),C(u,"LEVELUP_SCAN_BURST_SPEED",3.5),C(u,"LEVELUP_SCAN_EXPAND_MAX",.4),C(u,"LEVELUP_SCAN_BURST_MAX",1),C(u,"RADIUS_WAVE_INTERVAL",5e3),C(u,"RADIUS_WAVE_POINTS",5),C(u,"GAMEOVER_SCAN_COLOR",16729156),C(u,"GAMEOVER_SCAN_WIDTH",.12),C(u,"GAMEOVER_SCAN_EXPAND_SPEED",.8),C(u,"GAMEOVER_SCAN_CONTRACT_SPEED",2),C(u,"GAMEOVER_SCAN_BURST_SPEED",2.5),C(u,"GAMEOVER_SCAN_EXPAND_MAX",.5),C(u,"GAMEOVER_SCAN_BURST_MAX",1.2),C(u,"DOT_MATRIX_FONT",{G:[[0,0,1,1,1,1,0],[0,1,1,1,1,1,1],[1,1,0,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,0,1,1,1],[1,1,0,0,1,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,1],[0,0,1,1,1,1,0]],A:[[0,0,1,1,1,0,0],[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1]],M:[[1,1,0,0,0,1,1],[1,1,1,0,1,1,1],[1,1,1,1,1,1,1],[1,1,0,1,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1]],E:[[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,0,0,0,0,0],[1,1,0,0,0,0,0],[1,1,1,1,1,1,0],[1,1,1,1,1,1,0],[1,1,0,0,0,0,0],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1]],O:[[0,0,1,1,1,0,0],[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0],[0,0,1,1,1,0,0]],V:[[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,0,1,1,0],[0,1,1,0,1,1,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,1,0,0,0]],R:[[1,1,1,1,1,1,0],[1,1,1,1,1,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,1,1,1,1,0],[1,1,1,1,1,0,0],[1,1,0,1,1,0,0],[1,1,0,0,1,1,0],[1,1,0,0,0,1,1]]}),C(u,"CAMERA_DEAD_ZONE",.3),C(u,"HP_DAMAGE_DELAY",1e3),C(u,"HP_DAMAGE_LERP_SPEED",3),C(u,"MIN_FONT_SIZE_LARGE",16),C(u,"MIN_FONT_SIZE_MEDIUM",14),C(u,"MIN_FONT_SIZE_SMALL",12),C(u,"CARD_TEXT_PADDING",.12),C(u,"BASE_HP",200),C(u,"HP_PER_LEVEL",50),C(u,"BASE_EXP",100),C(u,"EXP_GROWTH_RATE",1.2),C(u,"DAMAGE_UNIT",10),C(u,"HURT_DURATION",200),C(u,"ATTACK_DURATION",150),C(u,"SKILL_GRID_GAP",1),C(u,"SKILL_EFFECT_POOL_SIZE",50),C(u,"LINE_EFFECT_POOL_SIZE",80),C(u,"CIRCLE_LINE_EFFECT_POOL_SIZE",20),C(u,"TEXTURE_SECTOR_PREFIX","effect_sector_"),C(u,"TEXTURE_SECTOR_360","effect_sector_360"),C(u,"TEXTURE_CIRCLE","effect_circle"),C(u,"TEXTURE_CIRCLE_LINE","effect_circle_line"),C(u,"TEXTURE_LINE","effect_line"),C(u,"TEXTURE_SOULWAVE","effect_soulwave"),C(u,"TEXTURE_SHIELD","effect_shield"),C(u,"EFFECT_TEXTURE_SIZE",256),C(u,"EFFECT_LINE_HEIGHT",64);let Tt=u;const Rt=7,Bt={0:{width:5,pixels:[" ### ","#   #","#  ##","# # #","##  #","#   #"," ### "]},1:{width:3,pixels:[" # ","## "," # "," # "," # "," # ","###"]},2:{width:5,pixels:[" ### ","#   #","    #","  ## "," #   ","#    ","#####"]},3:{width:5,pixels:[" ### ","#   #","    #","  ## ","    #","#   #"," ### "]},4:{width:5,pixels:["#   #","#   #","#   #","#####","    #","    #","    #"]},5:{width:5,pixels:["#####","#    ","#    ","#### ","    #","#   #"," ### "]},6:{width:5,pixels:[" ### ","#    ","#    ","#### ","#   #","#   #"," ### "]},7:{width:5,pixels:["#####","    #","   # ","  #  ","  #  ","  #  ","  #  "]},8:{width:5,pixels:[" ### ","#   #","#   #"," ### ","#   #","#   #"," ### "]},9:{width:5,pixels:[" ### ","#   #","#   #"," ####","    #","    #"," ### "]},A:{width:5,pixels:[" ### ","#   #","#   #","#####","#   #","#   #","#   #"]},B:{width:5,pixels:["#### ","#   #","#   #","#### ","#   #","#   #","#### "]},C:{width:5,pixels:[" ### ","#   #","#    ","#    ","#    ","#   #"," ### "]},D:{width:5,pixels:["#### ","#   #","#   #","#   #","#   #","#   #","#### "]},E:{width:4,pixels:["####","#   ","#   ","### ","#   ","#   ","####"]},F:{width:4,pixels:["####","#   ","#   ","### ","#   ","#   ","#   "]},G:{width:5,pixels:[" ### ","#    ","#    ","# ###","#   #","#   #"," ### "]},H:{width:5,pixels:["#   #","#   #","#   #","#####","#   #","#   #","#   #"]},I:{width:3,pixels:["###"," # "," # "," # "," # "," # ","###"]},J:{width:4,pixels:["####","   #","   #","   #","   #","#  #"," ## "]},K:{width:5,pixels:["#   #","#  # ","# #  ","##   ","# #  ","#  # ","#   #"]},L:{width:4,pixels:["#   ","#   ","#   ","#   ","#   ","#   ","####"]},M:{width:5,pixels:["#   #","## ##","# # #","#   #","#   #","#   #","#   #"]},N:{width:5,pixels:["#   #","##  #","# # #","#  ##","#   #","#   #","#   #"]},O:{width:5,pixels:[" ### ","#   #","#   #","#   #","#   #","#   #"," ### "]},P:{width:4,pixels:["### ","#  #","#  #","### ","#   ","#   ","#   "]},Q:{width:5,pixels:[" ### ","#   #","#   #","#   #","# # #","#  # "," ## #"]},R:{width:4,pixels:["### ","#  #","#  #","### ","# # ","#  #","#  #"]},S:{width:4,pixels:[" ###","#   ","#   "," ## ","   #","   #","### "]},T:{width:5,pixels:["#####","  #  ","  #  ","  #  ","  #  ","  #  ","  #  "]},U:{width:5,pixels:["#   #","#   #","#   #","#   #","#   #","#   #"," ### "]},V:{width:5,pixels:["#   #","#   #","#   #","#   #"," # # "," # # ","  #  "]},W:{width:5,pixels:["#   #","#   #","#   #","#   #","# # #","## ##","#   #"]},X:{width:5,pixels:["#   #"," # # "," # # ","  #  "," # # "," # # ","#   #"]},Y:{width:5,pixels:["#   #","#   #"," # # ","  #  ","  #  ","  #  ","  #  "]},Z:{width:5,pixels:["#####","    #","   # ","  #  "," #   ","#    ","#####"]},"%":{width:5,pixels:["##  #","## # ","  #  "," #   "," # ##","#  ##","   ##"]}," ":{width:3,pixels:["   ","   ","   ","   ","   ","   ","   "]}},_t={charHeight:Rt,chars:Bt};class Dt{constructor(){C(this,"font");this.font=_t}textToPixels(w,t,s){const e=[],i=w.letterSpacing??1,a=w.color.replace("#",""),n=parseInt(a.substring(0,2),16),o=parseInt(a.substring(2,4),16),r=parseInt(a.substring(4,6),16),c=n<<16|o<<8|r;let h=0;const l=w.text.toUpperCase().split("");for(let p=0;p<l.length;p++){const S=this.font.chars[l[p]];S&&(h+=S.width,p<l.length-1&&(h+=i))}const d=Math.floor(t*w.position.x),g=Math.floor(s*w.position.y),f=d-Math.floor(h/2),m=g-Math.floor(this.font.charHeight/2);let M=f;for(const p of l){const S=this.font.chars[p];if(S){for(let x=0;x<S.pixels.length;x++){const k=S.pixels[x];for(let y=0;y<k.length;y++)if(k[y]==="#"){const E=M+y,T=m+x;E>=0&&E<t&&T>=0&&T<s&&e.push({gridX:E,gridY:T,color:c})}}M+=S.width+i}}return e}processConfig(w,t,s){const e=new Map;for(const i of w.texts){const a=this.textToPixels(i,t,s);e.set(i.id,a)}return e}}const Ft=[{id:"title1",text:"PRESS TO",letterSpacing:2,position:{x:.5,y:.44},color:"#ffffff"},{id:"title2",text:"STARE INTO THE VOID",letterSpacing:2,position:{x:.5,y:.56},color:"#ffffff"}],Gt={texts:Ft},nt=class nt extends U.Scene{constructor(){super("GridScene");C(this,"cells",[]);C(this,"cols",0);C(this,"rows",0);C(this,"cellWidth",10);C(this,"cellHeight",10);C(this,"gap",1);C(this,"isAnimating",!1);C(this,"isReady",!1);C(this,"textRenderer");C(this,"textPixels",new Map);C(this,"cursorGlowRadius",4);C(this,"glowPhase",0);C(this,"textBreathPhase",0);C(this,"isLoading",!0);C(this,"loadingCells",new Set);C(this,"backgroundImage");C(this,"cubeImage");C(this,"neroSImage");C(this,"glowImage");C(this,"cubeBaseScale",1);C(this,"cubeBaseY",0);C(this,"titleBgm");C(this,"pendingClickOrigin",null);C(this,"isPreloadingMain",!1);this.textRenderer=new Dt}preload(){this.load.image("background","background.png"),this.load.image("cube","cube.png"),this.load.image("neros","NeroS.png"),this.load.image("glow","glow.png"),this.load.audio("bgm_title","audio/BGM00.mp3"),this.load.on("progress",t=>{this.updateLoadingProgress(Math.floor(t*100))})}create(){this.cameras.main.setBackgroundColor("rgba(0,0,0,0)"),this.createBackground(),this.calculateGridSize(),this.createGrid(),this.showLoadingText(0),this.startEntryAnimation(),this.preloadGameAssets(),this.input.on("pointerdown",t=>{!this.isReady||this.isAnimating||this.isPreloadingMain||(this.titleBgm&&this.titleBgm.isPlaying&&this.titleBgm.stop(),this.startMainScenePreload(t.x,t.y))}),this.input.on("pointermove",t=>{!this.isReady||this.isAnimating||this.updateCursorGlow(t.x,t.y)})}update(t,s){if(!this.isReady||this.isAnimating)return;this.glowPhase+=s*.002,this.textBreathPhase+=s*.004;const e=this.input.activePointer;e&&this.updateCursorGlow(e.x,e.y),this.updateTextBreath()}updateTextBreath(){const t=.5+.5*Math.sin(this.textBreathPhase),s=Math.floor(204+51*t),e=s<<16|s<<8|s,i=.5+.5*Math.sin(this.textBreathPhase*3),a=t>.6?i*.8:0,n=new Set;this.cells.forEach(o=>{o.isText&&n.add(`${o.x},${o.y}`)}),this.cells.forEach(o=>{if(o.isText)o.graphics.setFillStyle(e),o.graphics.setAlpha(.95);else{const r=`${o.x-1},${o.y-1}`;n.has(r)&&a>0&&(o.graphics.setFillStyle(8939263),o.graphics.setAlpha(a))}})}updateCursorGlow(t,s){const e=Math.floor(t/(this.cellWidth+this.gap)),i=Math.floor(s/(this.cellHeight+this.gap)),a=.3+.7*(.5+.5*Math.sin(this.glowPhase));this.cells.forEach(n=>{const o=n.x-e,r=n.y-i,c=Math.sqrt(o*o+r*r);if(c<=this.cursorGlowRadius){const l=(1-c/this.cursorGlowRadius)*a,d=n.originalColor>>16&255,g=n.originalColor>>8&255,f=n.originalColor&255,m=Math.min(255,Math.floor(d+(255-d)*l)),M=Math.min(255,Math.floor(g+(255-g)*l)),p=Math.min(255,Math.floor(f+(255-f)*l)),S=m<<16|M<<8|p;n.graphics.setFillStyle(S)}else n.graphics.setFillStyle(n.originalColor)})}createBackground(){const t=this.cameras.main.width,s=this.cameras.main.height,e=500,i=1e3,a=1e3;this.backgroundImage=this.add.image(t/2,s/2,"background");const n=t/this.backgroundImage.width,o=s/this.backgroundImage.height,r=Math.max(n,o);this.backgroundImage.setScale(r),this.backgroundImage.setDepth(-2),this.backgroundImage.setTint(0);const c=t*.7,h=s/2,l=s*2;this.glowImage=this.add.image(c,h,"glow"),this.glowImage.setDepth(-1.6);const d=l/this.glowImage.height;this.glowImage.setScale(.1),this.glowImage.setAlpha(0),this.tweens.add({targets:this.glowImage,scaleX:d,scaleY:d,alpha:1,duration:e,ease:"Sine.easeOut",onComplete:()=>{this.tweens.addCounter({from:0,to:128,duration:i,ease:"Sine.easeOut",onUpdate:p=>{const S=Math.floor(p.getValue()??0),x=S<<16|S<<8|S;this.backgroundImage.setTint(x)},onComplete:()=>{this.startCharacterEntrance(t,s,a,d)}})}});const g=s*1.5/this.textures.get("neros").getSourceImage().height,f=t+s*1.5*.5;this.neroSImage=this.add.image(f,s/2,"neros"),this.neroSImage.setOrigin(1,.5),this.neroSImage.setDepth(-1.5),this.neroSImage.setScale(g),this.neroSImage.setTint(12566463),this.neroSImage.setAlpha(0);const m=s*.7/this.textures.get("cube").getSourceImage().height,M=-s*.7*.5;this.cubeImage=this.add.image(M,s,"cube"),this.cubeImage.setOrigin(0,1),this.cubeImage.setDepth(-1),this.cubeImage.setScale(m),this.cubeImage.setAlpha(0),this.cubeBaseScale=m,this.cubeBaseY=s}startCharacterEntrance(t,s,e,i){const a=s*1.5/this.textures.get("neros").getSourceImage().height,n=t;this.tweens.add({targets:this.neroSImage,x:n,alpha:1,duration:e,ease:"Sine.easeOut",onComplete:()=>{this.tweens.add({targets:this.neroSImage,scaleX:a*1.015,scaleY:a*1.015,duration:2e3,ease:"Sine.easeInOut",yoyo:!0,repeat:-1})}});const o=s*.7/this.textures.get("cube").getSourceImage().height,r=t*.1;this.tweens.add({targets:this.cubeImage,x:r,alpha:1,duration:e,ease:"Sine.easeOut",onComplete:()=>{this.tweens.add({targets:this.cubeImage,scaleX:o*1.03,scaleY:o*1.03,duration:2e3,ease:"Sine.easeInOut",yoyo:!0,repeat:-1}),this.tweens.add({targets:this.cubeImage,y:s-s*.02,duration:2500,ease:"Sine.easeInOut",yoyo:!0,repeat:-1});const c=()=>{const h=i*(1+Math.random()*.15),l=.6+Math.random()*.4,d=30+Math.random()*120;this.tweens.add({targets:this.glowImage,scaleX:h,scaleY:h,alpha:l,duration:d,ease:"Sine.easeInOut",onComplete:c})};c()}})}showLoadingText(t){this.loadingCells.forEach(d=>{this.cells[d]&&(this.cells[d].originalColor=2236962,this.cells[d].isText=!1,this.cells[d].graphics.setFillStyle(2236962),this.cells[d].graphics.setAlpha(.2))}),this.loadingCells.clear();const s=`LOADING ${t}%`;this.textRenderer.textToPixels({id:"loading",text:s,letterSpacing:2,position:{x:.5,y:.45},color:"#ffffff"},this.cols,this.rows).forEach(d=>{const g=d.gridY*this.cols+d.gridX;this.cells[g]&&(this.cells[g].originalColor=d.color,this.cells[g].isText=!0,this.cells[g].graphics.setFillStyle(d.color),this.cells[g].graphics.setAlpha(.95),this.loadingCells.add(g))});const n=Math.floor(this.rows*.45)+Math.floor(7/2)+3,o=3,r=2,h=this.cols-2-r,l=Math.floor(t/100*h);for(let d=0;d<o;d++){const g=n+d;if(!(g>=this.rows))for(let f=0;f<l;f++){const m=r+f,M=g*this.cols+m;this.cells[M]&&(this.cells[M].originalColor=16777215,this.cells[M].isText=!0,this.cells[M].graphics.setFillStyle(16777215),this.cells[M].graphics.setAlpha(.95),this.loadingCells.add(M))}}}updateLoadingProgress(t){this.isLoading&&this.showLoadingText(t)}preloadGameAssets(){this.onLoadingComplete()}startMainScenePreload(t,s){this.pendingClickOrigin={x:t,y:s},this.isPreloadingMain=!0,this.isReady=!1,this.textPixels.forEach(n=>{n.forEach(o=>{const r=o.gridY*this.cols+o.gridX;this.cells[r]&&(this.cells[r].originalColor=2236962,this.cells[r].isText=!1,this.cells[r].graphics.setFillStyle(2236962),this.cells[r].graphics.setAlpha(.2))})}),this.textPixels.clear(),this.showLoadingText(0),this.load.off("progress"),this.load.on("progress",n=>{this.showLoadingText(Math.floor(n*100))}),this.load.on("complete",()=>{this.onMainScenePreloadComplete()}),this.load.image("char_idle_1","sprites/character/IDEL01.png"),this.load.image("char_idle_2","sprites/character/IDEL02.png"),this.load.image("char_run_1","sprites/character/RUN01.png"),this.load.image("char_run_2","sprites/character/RUN02.png"),this.load.image("char_attack_1","sprites/character/ATTACK01.png"),this.load.image("char_attack_2","sprites/character/ATTACK02.png"),this.load.image("char_hurt","sprites/character/HURT01.png"),this.load.audio("bgm_game_01","audio/BGM01.mp3"),this.load.audio("bgm_game_02","audio/BGM02.mp3"),this.load.image("effect_circle","effects/circle.png"),this.load.image("effect_circle_line","effects/circle_line.png"),this.load.image("effect_line","effects/line.png"),this.load.image("effect_soulwave","effects/soulwave.png"),this.load.image("effect_shield","effects/shield.png");const e=[30,40,50,60,70,80,90,100,110,120,130,140,150,160,360];for(const n of e)this.load.image(`effect_sector_${n}`,`effects/sector_${n}.png`);const i="0123456789ABCDEF";for(const n of i)this.load.image(`hex_${n}`,`effects/hex/${n}.png`);const a=["A","B","C"];for(const n of a)for(let o=0;o<=5;o++)this.load.image(`skill_icon_${n}${o.toString().padStart(2,"0")}`,`icons/skills/${n}${o.toString().padStart(2,"0")}.png`);for(let n=1;n<=4;n++)this.load.image(`skill_icon_P${n.toString().padStart(2,"0")}`,`icons/skills/P${n.toString().padStart(2,"0")}.png`);this.load.start()}onMainScenePreloadComplete(){this.isPreloadingMain=!1,this.time.delayedCall(500,()=>{this.tweens.addCounter({from:128,to:0,duration:1e3,ease:"Sine.easeIn",onUpdate:s=>{const e=Math.floor(s.getValue()??0),i=e<<16|e<<8|e;this.backgroundImage.setTint(i)}}),this.tweens.add({targets:this.neroSImage,alpha:0,duration:1e3,ease:"Sine.easeIn"}),this.tweens.add({targets:this.cubeImage,alpha:0,duration:1e3,ease:"Sine.easeIn"}),this.tweens.add({targets:this.glowImage,alpha:0,duration:1e3,ease:"Sine.easeIn"}),this.time.delayedCall(1e3,()=>{if(this.pendingClickOrigin){const s=Math.floor(this.pendingClickOrigin.x/(this.cellWidth+this.gap)),e=Math.floor(this.pendingClickOrigin.y/(this.cellHeight+this.gap));this.startExitAnimation(s,e),this.pendingClickOrigin=null}})})}onLoadingComplete(){this.isLoading=!1,this.time.delayedCall(500,()=>{this.cells.forEach(t=>{t.originalColor=2236962,t.isText=!1,t.graphics.setFillStyle(2236962),t.graphics.setAlpha(.2)}),this.loadingCells.clear(),this.time.delayedCall(300,()=>{this.processTextConfig(),this.textPixels.forEach(t=>{t.forEach(s=>{const e=s.gridY*this.cols+s.gridX;this.cells[e]&&(this.cells[e].graphics.setFillStyle(s.color),this.cells[e].graphics.setAlpha(.95))})}),this.isAnimating||(this.isReady=!0),this.cache.audio.exists("bgm_title")&&(this.titleBgm=this.sound.add("bgm_title",{volume:.5,loop:!0}),this.titleBgm.play())})})}calculateGridSize(){const t=this.cameras.main.width,s=this.cameras.main.height,e=Math.min(1,t/nt.BASE_WIDTH),i=Math.max(nt.MIN_CELL_SIZE,Math.floor(nt.BASE_CELL_SIZE*e));this.gap=1,this.cellWidth=i,this.cellHeight=i,this.cols=Math.ceil((t+this.gap)/(i+this.gap)),this.rows=Math.ceil((s+this.gap)/(i+this.gap));const a=.05,n=t*(1-a*2),o=s*(1-a*2),r=16/9,c=n/o;let h,l;c>r?(l=o,h=o*r):(h=n,l=n/r);const d=(t-h)/2,g=(s-l)/2;this.registry.set("gameBounds",{x:d,y:g,width:h,height:l})}createGrid(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.cols;s++){const e=s*(this.cellWidth+this.gap)+this.cellWidth/2,i=t*(this.cellHeight+this.gap)+this.cellHeight/2,a=this.add.rectangle(e,i,this.cellWidth,this.cellHeight,2236962);a.setAlpha(0),this.cells.push({x:s,y:t,graphics:a,delay:0,originalColor:2236962,isText:!1})}}processTextConfig(){this.textPixels=this.textRenderer.processConfig(Gt,this.cols,this.rows),this.textPixels.forEach(t=>{t.forEach(s=>{const e=s.gridY*this.cols+s.gridX;this.cells[e]&&(this.cells[e].originalColor=s.color,this.cells[e].isText=!0)})})}startEntryAnimation(){this.isAnimating=!0;const t=new Set;for(let m=0;m<this.cells.length;m++)t.add(m);const s=20,e=50,i=10,n=Math.floor(200/i),o=3e3;let r=0,c=!1;const h=(m,M)=>M*this.cols+m,l=m=>({x:m%this.cols,y:Math.floor(m/this.cols)}),d=m=>{const M=this.cells[m];M.graphics.setAlpha(1),M.graphics.setFillStyle(16777215),this.tweens.add({targets:M.graphics,fillColor:{from:16777215,to:M.originalColor},alpha:{from:1,to:.2},duration:80,ease:"Linear"})},g=m=>{const{x:M,y:p}=l(m),S=n,x=[];for(let E=0;E<=S;E++)x[E]=[];for(let E=-S;E<=S;E++)for(let T=-S;T<=S;T++){const A=M+T,v=p+E;if(A>=0&&A<this.cols&&v>=0&&v<this.rows){const I=Math.sqrt(T*T+E*E),b=Math.floor(I);if(b<=S){const P=h(A,v);x[b].push(P)}}}let k=0;const y=()=>{k>S||(x[k].forEach(E=>{t.has(E)&&(t.delete(E),d(E))}),k++,k<=S&&this.time.delayedCall(i,y))};y()},f=()=>{if(c)return;if(r>=o||t.size===0){this.finishEntry(t),c=!0;return}const m=Array.from(t),M=Math.min(s,m.length);for(let p=0;p<M&&m.length!==0;p++){const S=Math.floor(Math.random()*m.length),x=m[S];m.splice(S,1),t.has(x)&&g(x)}r+=e,t.size>0&&r<o?this.time.delayedCall(e,f):c||(this.finishEntry(t),c=!0)};f()}finishEntry(t){t.forEach(s=>{const e=this.cells[s];e.graphics.setAlpha(.2),e.graphics.setFillStyle(e.originalColor)}),this.time.delayedCall(100,()=>{this.isAnimating=!1,this.isLoading||(this.isReady=!0)})}startExitAnimation(t,s){this.isAnimating=!0;const e=this.cameras.main.width,i=this.cameras.main.height;this.scene.launch("MainScene"),this.scene.bringToTop("GridScene");const a=t*(this.cellWidth+this.gap)+this.cellWidth/2,n=s*(this.cellHeight+this.gap)+this.cellHeight/2;this.registry.events.emit("reveal-update",{x:a,y:n,radius:0}),this.cells.forEach(l=>{l.graphics.setFillStyle(0),l.graphics.setAlpha(1)}),this.backgroundImage.setVisible(!1),this.cubeImage.setVisible(!1),this.neroSImage.setVisible(!1),this.glowImage.setVisible(!1);const o=5;let r=0;this.cells.forEach(l=>{const d=l.x-t,g=l.y-s,f=Math.sqrt(d*d+g*g);l.delay=Math.floor(f*o),l.delay>r&&(r=l.delay)});const c=Math.sqrt(Math.max(a,e-a)**2+Math.max(n,i-n)**2)+50,h=r+150;this.tweens.addCounter({from:0,to:c,duration:h,ease:"Linear",onUpdate:l=>{const d=l.getValue()??0;this.registry.events.emit("reveal-update",{x:a,y:n,radius:d})}}),this.cells.forEach(l=>{this.time.delayedCall(l.delay,()=>{l.graphics.setFillStyle(16777215),l.graphics.setAlpha(1),this.tweens.addCounter({from:0,to:100,duration:200,ease:"Linear",onUpdate:d=>{const g=d.getValue()??0;let f,m;g<15?(f=16777215,m=1):g<30?(f=16776960,m=1):g<50?(f=16746496,m=1):g<70?(f=16720384,m=1-(g-50)/50):(f=6684672,m=1-(g-50)/50),l.graphics.setFillStyle(f),l.graphics.setAlpha(Math.max(0,m))},onComplete:()=>{l.graphics.setVisible(!1)}})})}),this.time.delayedCall(r+200,()=>{this.registry.events.emit("reveal-complete"),this.scene.stop("GridScene")})}};C(nt,"BASE_CELL_SIZE",10),C(nt,"MIN_CELL_SIZE",4),C(nt,"BASE_WIDTH",1920);let yt=nt;const It=document.getElementById("version-info");It&&(It.textContent="v0.9.6a");let J=null;function Xt(){return window.innerWidth>window.innerHeight}function vt(){return window.visualViewport?window.visualViewport.height:window.innerHeight}function Ht(){if(J)return;const tt={type:U.AUTO,width:window.innerWidth,height:vt(),parent:"app",backgroundColor:"#111111",antialias:!0,scale:{mode:U.Scale.RESIZE,autoCenter:U.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[yt,Lt,Tt]};J=new U.Game(tt),J.events.once("ready",()=>{J&&J.sound&&(J.sound.volume=.5)})}function wt(){(window.innerWidth>900||Xt())&&Ht()}wt();window.addEventListener("resize",wt);window.addEventListener("orientationchange",()=>{setTimeout(wt,100)});window.visualViewport&&window.visualViewport.addEventListener("resize",()=>{J&&J.scale.resize(window.innerWidth,vt())});document.addEventListener("fullscreenchange",()=>{J&&setTimeout(()=>{J.scale.resize(window.innerWidth,vt())},100)});window.addEventListener("volumechange",tt=>{J&&J.sound&&(J.sound.volume=tt.detail.volume)});
