var Ht=Object.defineProperty;var Xt=(K,C,t)=>C in K?Ht(K,C,{enumerable:!0,configurable:!0,writable:!0,value:t}):K[C]=t;var x=(K,C,t)=>Xt(K,typeof C!="symbol"?C+"":C,t);import{P as G}from"./phaser-0RJB29YE.js";(function(){const C=document.createElement("link").relList;if(C&&C.supports&&C.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&e(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function e(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();const j={SOUL_RENDER:6724095,SOUL_RENDER_CRIT:8961023,VFX_SNIPE:6750054,VFX_SNIPE_CRIT:8978312,SAWBLADE:16763904,SAWBLADE_CRIT:16772676,TECH_ARTIST:10053375,TECH_ARTIST_CRIT:12290303,SOUL_SLASH:16729190,SOUL_SLASH_CRIT:16737928,CELLULOID:4491519,CELLULOID_CRIT:6728447},dt=[{id:"advanced_burning_celluloid",name:"燃燒的賽璐珞",subtitle:"傳統手繪動畫師、逐幀動畫師",description:`【靈魂渲染＋鈦金肝】
-10HP旋轉攻擊7單位，(10%+Lv%)燃燒`,color:16737792,flashColor:16750899,cooldown:2e3,maxLevel:-1,iconPrefix:"SA0",requiredSkills:["active_soul_render","passive_titanium_liver"],levelUpQuotes:["你選擇成為傳統手繪動畫師、逐幀動畫師"]},{id:"advanced_tech_artist",name:"技術美術大神",subtitle:"一人成軍的遊戲開發者",description:`【咒言幻象＋視網膜】
5單位內連發5道落雷，3單位爆炸+暈眩1秒`,color:10053375,flashColor:12294655,cooldown:2e3,maxLevel:-1,iconPrefix:"SC0",requiredSkills:["active_coder","passive_retina_module"],levelUpQuotes:["左手寫 Code，右手畫圖，一人成軍的遊戲開發者"]},{id:"advanced_absolute_defense",name:"絕對邏輯防禦",subtitle:"無懈可擊的系統架構",description:`【靈魂統領＋同步率】
3+Lv/5輪鋸(max8)，覆蓋盾時輪鋸射向敵人彈飛`,color:16768256,flashColor:16772710,cooldown:100,maxLevel:-1,iconPrefix:"SD0",requiredSkills:["active_architect","passive_sync_rate"],levelUpQuotes:["系統架構固若金湯，邏輯防線無懈可擊"]},{id:"advanced_perfect_pixel",name:"完美像素審判",subtitle:"構圖之神的鐵律",description:`【疾光狙擊＋視網膜】
井字線4焦點各炸1次，3單位+暈眩1秒`,color:6750156,flashColor:8978414,cooldown:3e3,maxLevel:-1,iconPrefix:"SB0",requiredSkills:["active_vfx","passive_retina_module"],levelUpQuotes:["構圖的黃金法則，像素的完美審判"]},{id:"advanced_vfx_burst",name:"爆發的影視特效",subtitle:"好萊塢級的視覺轟炸",description:`【疾光狙擊＋AI強化】
2秒30導彈，命中Lv%燃燒`,color:16729088,flashColor:16737843,cooldown:5e3,maxLevel:-1,iconPrefix:"SB1",requiredSkills:["active_vfx","passive_ai_enhancement"],levelUpQuotes:["好萊塢級的視覺轟炸，每一幀都是藝術"]},{id:"advanced_phantom_iteration",name:"幻影迭代模式",subtitle:"咒言幻象的創作者",description:`【咒言幻象＋AI強化】
分身max3，滿時每分身咒言圈2秒`,color:10053375,flashColor:12290303,cooldown:8e3,maxLevel:-1,iconPrefix:"SC1",requiredSkills:["active_coder","passive_ai_enhancement"],levelUpQuotes:["影分身現身，咒言幻象的創作者"]},{id:"advanced_zero_trust",name:"零信任防禦協定",subtitle:"絕對安全的系統架構",description:`【靈魂統領＋AI強化】
8光點5單位場，減速50%，擊殺Lv%重置盾CD`,color:16763904,flashColor:16772710,cooldown:0,maxLevel:-1,iconPrefix:"SD1",requiredSkills:["active_architect","passive_ai_enhancement"],levelUpQuotes:["零信任，驗證一切，絕不妥協"]},{id:"advanced_soul_slash",name:"次元向量疾劃",subtitle:"貫穿次元的向量之刃",description:`【靈魂渲染＋AI強化】
全螢幕直線斬擊，暴擊3倍，每級1%連鎖`,color:16724838,flashColor:16737945,cooldown:500,maxLevel:-1,iconPrefix:"SA1",requiredSkills:["active_soul_render","passive_ai_enhancement"],levelUpQuotes:["向量運算，次元切割"]}],Et=[{id:"active_soul_render",name:"靈魂渲染",subtitle:"動畫大師",description:"朝最近敵人發射 3 單位扇形攻擊，每級擴大 10°",type:"active",color:6724095,flashColor:6737151,cooldown:1e3,maxLevel:5,iconPrefix:"A",levelUpMessages:["60° 扇形、2 傷害","70° 扇形、3 傷害","80° 扇形、4 傷害","90° 扇形、5 傷害","100° 扇形、6 傷害","3 向衝擊波（0°/120°/240°）、10 傷害、10 單位射程，已達最大等級！"],levelUpQuotes:["你練習了繪畫技法，動畫美術的能力提升了","你習得了分鏡設計，並獲得了動態腳本製作技術","你增進了手繪動畫和停格動畫的製作技術","你苦練了3D角色模型和3D場景的設計","你完全理解了動畫法則，提升了角色動畫的製作精度","你成為了動畫大師，解鎖了進階技能組合"],maxExtraAbility:{name:"三向衝擊",description:"改為 3 向衝擊波（0°/120°/240°），飛行 10 單位",baseValue:0,perLevel:0,unit:"",isPercentage:!1}},{id:"active_coder",name:"咒言幻象",subtitle:"遊戲先知",description:"對周圍 3 單位敵人造成傷害，每級增加 0.5 單位範圍",type:"active",color:11167487,flashColor:13404415,cooldown:2e3,maxLevel:5,iconPrefix:"C",levelUpMessages:["3 單位範圍、2 傷害","3.5 單位範圍、4 傷害","4 單位範圍、6 傷害","4.5 單位範圍、8 傷害","5 單位範圍、10 傷害","5.5 單位範圍、12 傷害，已達最大等級！"],levelUpQuotes:["你參透了互動設計的原理，同時了解遊戲企劃架構","你習得動作捕捉的技術，將應用到虛擬實境製作","你增進了程式設計能力和遊戲引擎的創作能力","你整合了虛擬網紅製作技術，讓自媒體營銷具爆發力","你導入了人工智慧協作能力，產能提升了數倍","你成為了遊戲先知，解鎖了進階技能組合"],maxExtraAbility:{name:"爆發",description:"擊殺時 {value} 機率再發動（可連鎖）",baseValue:0,perLevel:.01,unit:"%",isPercentage:!0}},{id:"active_vfx",name:"疾光狙擊",subtitle:"超級導演",description:"朝隨機敵人發射 10 單位貫穿光束，每級增加 1 道",type:"active",color:6750054,flashColor:8978312,cooldown:2500,maxLevel:5,iconPrefix:"B",levelUpMessages:["1 道光束、1 傷害","2 道光束、2 傷害","3 道光束、3 傷害","4 道光束、4 傷害","5 道光束、5 傷害","3 道精準鎖定超粗射線、6 傷害、15 單位射程，已達最大等級！"],levelUpQuotes:["你研究了影像美學，劇本編導的能力提升了","你習得了動靜態攝影的能力，獲得了畫面控制的技術","你增進了影片剪輯和動態影像的設計能力","你苦練了數位成音技術影像獲得更多回饋","你學會應用特效合成後製提升了影像各種可能性","你成為了超級導演，解鎖了進階技能組合"],maxExtraAbility:{name:"精準",description:"改為 3 條精準鎖定超粗射線，射程 15 單位",baseValue:0,perLevel:0,unit:"",isPercentage:!1}},{id:"active_architect",name:"靈魂統領",subtitle:"架構師",description:"產生 30% HP 護盾（霸體），反傷並擊退攻擊者 1 單位",type:"active",color:16763904,flashColor:16768324,cooldown:1e4,maxLevel:5,iconPrefix:"D",levelUpMessages:["30% HP 護盾、2 反傷","30% HP 護盾、4 反傷","30% HP 護盾、6 反傷","30% HP 護盾、8 反傷","30% HP 護盾、10 反傷","30% HP 護盾、20 反傷＋擊退，已達最大等級！"],levelUpQuotes:["你開始學習系統架構，建立了基礎的防禦機制","你理解了模組化設計，防禦層級變得更有條理","你掌握了負載平衡，系統承受能力大幅提升","你建構了冗餘備援，任何攻擊都能被有效分散","你精通了高可用架構，防禦系統近乎無懈可擊","你成為了頂尖架構師，解鎖了進階技能組合"],maxExtraAbility:{name:"八角爆盾",description:"冷卻刷新時護盾殘值×10 傷害、4 單位範圍金色八角盾爆炸並擊退",baseValue:1,perLevel:0,unit:"",isPercentage:!1}},{id:"passive_titanium_liver",name:"鈦金屬賽博肝臟",subtitle:"超級肝",description:"每級 +10% HP，回血間隔 -1 秒",type:"passive",color:11189196,maxLevel:5,iconPrefix:"P01",levelUpMessages:["+10% HP、每 15 秒回血","+20% HP、每 14 秒回血","+30% HP、每 13 秒回血","+40% HP、每 12 秒回血","+50% HP、每 11 秒回血","+60% HP、每 10 秒回血，已達最大等級！"],levelUpQuotes:["驚人無懈可擊的耐力，你的工作時長不斷提升","驚人無懈可擊的耐力，你的工作時長不斷提升","驚人無懈可擊的耐力，你的工作時長不斷提升","驚人無懈可擊的耐力，你的工作時長不斷提升","驚人無懈可擊的耐力，你的工作時長不斷提升","千錘百鍊的鈦金肝再也不怕熬夜"],maxExtraAbility:{name:"不死",description:"抵銷一次死亡，觸發暗影爆炸",triggerQuote:"不知何處湧上的力量將你推回現實...",baseValue:1,perLevel:0,unit:"次",isPercentage:!1}},{id:"passive_sync_rate",name:"精神同步率強化",subtitle:"零的領域",description:"提升 10% 移速、減少 8% 冷卻，每級再疊加",type:"passive",color:14518340,maxLevel:5,iconPrefix:"P02",levelUpMessages:["+10% 移速、-8% 冷卻","+20% 移速、-16% 冷卻","+30% 移速、-24% 冷卻","+40% 移速、-32% 冷卻","+50% 移速、-40% 冷卻","+60% 移速、-48% 冷卻，已達最大等級！"],levelUpQuotes:["進入到心流狀態，專注力提升且變的敏捷","進入到心流狀態，專注力提升且變的敏捷","進入到心流狀態，專注力提升且變的敏捷","進入到心流狀態，專注力提升且變的敏捷","進入到心流狀態，專注力提升且變的敏捷","你已進入無限心流狀態，感覺身手異常敏捷迅速"],maxExtraAbility:{name:"迅捷",description:"閃避機率 +{value}",baseValue:0,perLevel:.002,unit:"%",isPercentage:!0}},{id:"passive_retina_module",name:"視網膜增強模組",subtitle:"血輪眼",description:"提升 30% 經驗獲取與 0.5 單位拾取範圍，每級再 +30%/+0.5",type:"passive",color:10035763,maxLevel:5,iconPrefix:"P03",levelUpMessages:["+30% 經驗、+0.5 拾取範圍","+60% 經驗、+1 拾取範圍","+90% 經驗、+1.5 拾取範圍","+120% 經驗、+2 拾取範圍","+150% 經驗、+2.5 拾取範圍","+180% 經驗、+3 拾取範圍，已達最大等級！"],levelUpQuotes:["敏銳的觀察力，視野範圍擴大了","敏銳的觀察力，視野範圍擴大了","敏銳的觀察力，視野範圍擴大了","敏銳的觀察力，視野範圍擴大了","敏銳的觀察力，視野範圍擴大了","千錘百鍊的敏銳觀察，再沒什麼看不穿、看不清"],maxExtraAbility:{name:"洞察",description:"暴擊率 +{value}",baseValue:0,perLevel:.005,unit:"%",isPercentage:!0}},{id:"passive_ai_enhancement",name:"AI賦能強化",subtitle:"智能輔助",description:"提升 25% 攻擊、15% 防禦，每級再疊加",type:"passive",color:6719658,maxLevel:5,iconPrefix:"P04",levelUpMessages:["+25% 攻擊、+15% 防禦","+50% 攻擊、+30% 防禦","+75% 攻擊、+45% 防禦","+100% 攻擊、+60% 防禦","+125% 攻擊、+75% 防禦","+150% 攻擊、+90% 防禦，已達最大等級！"],levelUpQuotes:["攻守兼備，各方面能力全面提升","攻守兼備，各方面能力全面提升","攻守兼備，各方面能力全面提升","攻守兼備，各方面能力全面提升","攻守兼備，各方面能力全面提升","熟練的AI操作，讓你無論做任何事情效率提高數十倍"],maxExtraAbility:{name:"超載",description:"暴擊傷害 +{value}",baseValue:0,perLevel:.005,unit:"%",isPercentage:!0}}],ft=class ft{constructor(){x(this,"playerSkills",new Map);x(this,"advancedSkillLevels",new Map);x(this,"equippedAdvancedSkillId",null)}reset(){this.playerSkills.clear(),this.advancedSkillLevels.clear(),this.equippedAdvancedSkillId=null}getActiveSkillDefinitions(){return Et.filter(C=>C.type==="active")}getPassiveSkillDefinitions(){return Et.filter(C=>C.type==="passive")}getPlayerSkill(C){return this.playerSkills.get(C)}getPlayerActiveSkills(){const C=[];this.playerSkills.forEach(e=>{e.definition.type==="active"&&C.push(e)});const t=[];for(let e=0;e<4;e++)t.push(C[e]||null);return t}getPlayerPassiveSkills(){const C=[];this.playerSkills.forEach(e=>{e.definition.type==="passive"&&C.push(e)});const t=[];for(let e=0;e<ft.MAX_PASSIVE_SLOTS;e++)t.push(C[e]||null);return t}getOwnedPassiveCount(){let C=0;return this.playerSkills.forEach(t=>{t.definition.type==="passive"&&C++}),C}isPassiveSlotsFull(){return this.getOwnedPassiveCount()>=ft.MAX_PASSIVE_SLOTS}getSkillLevel(C){const t=this.playerSkills.get(C);return t?t.level:-1}isSkillMaxLevel(C){const t=this.playerSkills.get(C);return t?t.level>=t.definition.maxLevel:!1}learnOrUpgradeSkill(C){const t=Et.find(s=>s.id===C);if(!t)return!1;const e=this.playerSkills.get(C);if(e){if(e.level>=t.maxLevel)return!1;e.level++}else this.playerSkills.set(C,{definition:t,level:0});return!0}getUpgradeableActiveSkills(){return this.getActiveSkillDefinitions().filter(C=>{const t=this.playerSkills.get(C.id);return!t||t.level<C.maxLevel})}getUpgradeablePassiveSkills(){const C=this.isPassiveSlotsFull();return this.getPassiveSkillDefinitions().filter(t=>{const e=this.playerSkills.get(t.id);return C?e&&e.level<t.maxLevel:!e||e.level<t.maxLevel})}hasAnyActiveSkill(){return this.getActiveSkillDefinitions().some(t=>this.playerSkills.has(t.id))}getRandomSkillOptions(){const C=this.getUpgradeableActiveSkills(),t=this.getUpgradeablePassiveSkills(),e=[];if(!this.hasAnyActiveSkill()){for(let i=0;i<Math.min(3,C.length);i++)e.push(C[i]);return e}const s=this.shuffleArray([...C]);for(let i=0;i<Math.min(2,s.length);i++)e.push(s[i]);const a=this.shuffleArray([...t]);return a.length>0&&e.push(a[0]),e}getMixedSkillOptions(){const C=this.getUpgradeableActiveSkills(),t=this.getUpgradeablePassiveSkills(),e=this.getUpgradeableAdvancedSkills(),s=[];if(!this.hasAnyActiveSkill()){for(let o=0;o<Math.min(3,C.length);o++)s.push(C[o]);return{normal:s,advanced:[]}}const a=this.shuffleArray([...C]);for(let o=0;o<Math.min(2,a.length);o++)s.push(a[o]);const i=this.shuffleArray([...t]);i.length>0&&s.push(i[0]);let n=[];if(this.equippedAdvancedSkillId){const o=e.find(h=>h.id===this.equippedAdvancedSkillId);if(o){const h=e.filter(c=>c.id!==this.equippedAdvancedSkillId),r=this.shuffleArray([...h]);n=[o,...r]}else n=this.shuffleArray([...e])}else n=this.shuffleArray([...e]);return{normal:s,advanced:n}}hasUpgradeableSkills(){return this.getUpgradeableActiveSkills().length>0||this.getUpgradeablePassiveSkills().length>0}shuffleArray(C){for(let t=C.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[C[t],C[e]]=[C[e],C[t]]}return C}static formatLevel(C,t=5){return C<=0?"Lv.0":C>=t?"MAX":`Lv.${C}`}getTitaniumLiverHpBonus(){const C=this.playerSkills.get("passive_titanium_liver");return C?(C.level+1)*.1:0}getTitaniumLiverRegenInterval(){const C=this.playerSkills.get("passive_titanium_liver");return C?(15-C.level)*1e3:0}hasTitaniumLiver(){return this.playerSkills.has("passive_titanium_liver")}getSyncRateSpeedBonus(){const C=this.playerSkills.get("passive_sync_rate");return C?(C.level+1)*.1:0}getSyncRateCooldownReduction(){const C=this.playerSkills.get("passive_sync_rate");return C?(C.level+1)*.08:0}getRetinaModuleExpBonus(){const C=this.playerSkills.get("passive_retina_module");return C?(C.level+1)*.3:0}getRetinaModulePickupBonus(){const C=this.playerSkills.get("passive_retina_module");return C?(C.level+1)*.5:0}getAiEnhancementDamageBonus(){const C=this.playerSkills.get("passive_ai_enhancement");return C?(C.level+1)*.25:0}getAiEnhancementDefenseBonus(){const C=this.playerSkills.get("passive_ai_enhancement");return C?(C.level+1)*.15:0}calculateFinalMaxHp(C){const t=this.getTitaniumLiverHpBonus();return Math.floor(C*(1+t))}calculateFinalMoveSpeed(C){const t=this.getSyncRateSpeedBonus();return C*(1+t)}calculateFinalCooldown(C){const t=this.getSyncRateCooldownReduction();return C*(1-t)}calculateFinalExp(C){const t=this.getRetinaModuleExpBonus();return Math.floor(C*(1+t))}calculateFinalDamage(C){const t=this.getAiEnhancementDamageBonus();return Math.floor(C*(1+t))}getCritChance(C){const t=this.getRetinaModuleCritChance(C),e=this.getTechArtistCritBonus();return t+e}calculateFinalDamageWithCrit(C,t){const e=this.getAiEnhancementDamageBonus();let s=Math.floor(C*(1+e));const a=this.getRetinaModuleCritChance(t),i=this.getTechArtistCritBonus(),n=a+i;let o=!1;if(n>0&&Math.random()<n){o=!0;const h=1.5,r=this.getAiEnhancementCritDamage(t),c=h+r;s=Math.floor(s*c)}return{damage:s,isCrit:o}}calculateFinalDamageTaken(C){const t=this.getAiEnhancementDefenseBonus();return Math.floor(C*(1-t))}getMaxExtraAbilityValue(C,t){const e=this.playerSkills.get(C);if(!e||e.level<e.definition.maxLevel)return 0;const s=e.definition.maxExtraAbility;return s?s.baseValue+s.perLevel*t:0}getMaxExtraAbilityText(C,t){const e=this.playerSkills.get(C);if(!e||e.level<e.definition.maxLevel)return null;const s=e.definition.maxExtraAbility;if(!s)return null;const a=this.getMaxExtraAbilityValue(C,t),i=s.isPercentage?(a*100).toFixed(1):a.toFixed(1);return`【${s.name}】${s.description.replace("{value}",i+s.unit)}`}getAllMaxExtraAbilities(C){const t=[];return this.playerSkills.forEach((e,s)=>{const a=this.getMaxExtraAbilityText(s,C);a&&t.push({skillId:s,text:a})}),t}getSoulRenderWaveChance(C){return this.getMaxExtraAbilityValue("active_soul_render",C)}getCoderBurstChance(C){return this.getMaxExtraAbilityValue("active_coder",C)}getVfxChainChance(C){return this.getMaxExtraAbilityValue("active_vfx",C)}getArchitectExplosionChance(C){return this.getMaxExtraAbilityValue("active_architect",C)}hasTitaniumLiverRevive(){const C=this.playerSkills.get("passive_titanium_liver");return C?C.level>=C.definition.maxLevel:!1}getSyncRateDodgeChance(C){return this.getMaxExtraAbilityValue("passive_sync_rate",C)}getRetinaModuleCritChance(C){return this.getMaxExtraAbilityValue("passive_retina_module",C)}getAiEnhancementCritDamage(C){return this.getMaxExtraAbilityValue("passive_ai_enhancement",C)}getTechArtistCritBonus(){const C=this.advancedSkillLevels.get("advanced_tech_artist")??-1;return C<0?0:(C+1)*.01}areAllBasicSkillsMaxed(){const t=this.getActiveSkillDefinitions().every(i=>{const n=this.playerSkills.get(i.id);return n&&n.level>=i.maxLevel});if(this.getOwnedPassiveCount()<ft.MAX_PASSIVE_SLOTS)return!1;const s=this.getPassiveSkillDefinitions();let a=0;return s.forEach(i=>{const n=this.playerSkills.get(i.id);n&&n.level>=i.maxLevel&&a++}),t&&a>=ft.MAX_PASSIVE_SLOTS}getAvailableAdvancedSkills(){return dt.filter(C=>C.requiredSkills.every(e=>{const s=this.playerSkills.get(e);return s?s.level>=s.definition.maxLevel:!1}))}getUpgradeableAdvancedSkills(){return this.getAvailableAdvancedSkills().filter(C=>C.maxLevel<0?!0:(this.advancedSkillLevels.get(C.id)??-1)<C.maxLevel)}getRandomAdvancedSkillOptions(){const C=this.getUpgradeableAdvancedSkills();if(this.equippedAdvancedSkillId){const e=C.find(s=>s.id===this.equippedAdvancedSkillId);if(e){const s=C.filter(i=>i.id!==this.equippedAdvancedSkillId),a=this.shuffleArray([...s]);return[e,...a.slice(0,2)]}}return this.shuffleArray([...C]).slice(0,3)}getEquippedAdvancedSkill(){if(!this.equippedAdvancedSkillId)return null;const C=dt.find(e=>e.id===this.equippedAdvancedSkillId);if(!C)return null;const t=this.advancedSkillLevels.get(this.equippedAdvancedSkillId)??-1;return{definition:C,level:t}}getEquippedAdvancedSkillId(){return this.equippedAdvancedSkillId}setEquippedAdvancedSkill(C){const t=dt.find(s=>s.id===C);return!t||!t.requiredSkills.every(s=>{const a=this.playerSkills.get(s);return a?a.level>=a.definition.maxLevel:!1})?!1:(this.equippedAdvancedSkillId=C,!0)}getAdvancedSkillLevel(C){return this.advancedSkillLevels.get(C)??-1}upgradeAdvancedSkill(C){const t=dt.find(s=>s.id===C);if(!t)return!1;const e=this.advancedSkillLevels.get(C)??-1;return t.maxLevel>=0&&e>=t.maxLevel?!1:(this.advancedSkillLevels.set(C,e+1),!0)}isAdvancedSkillMaxLevel(C){const t=dt.find(s=>s.id===C);return!t||t.maxLevel<0?!1:(this.advancedSkillLevels.get(C)??-1)>=t.maxLevel}hasAnyAdvancedSkill(){return this.equippedAdvancedSkillId!==null}getAdvancedSkillDefinition(C){return dt.find(t=>t.id===C)}calculateAdvancedSkillCooldown(C){return this.calculateFinalCooldown(C)}getLearnedAdvancedSkills(){const C=[];for(const[t,e]of this.advancedSkillLevels.entries())if(e>0){const s=dt.find(a=>a.id===t);s&&C.push(s)}return C}getAdvancedSkillBonusForActiveSkill(C){const e={active_soul_render:["advanced_burning_celluloid","advanced_soul_slash"],active_coder:["advanced_tech_artist","advanced_phantom_iteration"],active_vfx:["advanced_perfect_pixel","advanced_vfx_burst"],active_architect:["advanced_absolute_defense","advanced_zero_trust"]}[C];if(!e)return 0;let s=0;for(const a of e){const i=this.advancedSkillLevels.get(a)??-1;i>=0&&(s+=i)}return s}stopAllSkills(){}};x(ft,"MAX_PASSIVE_SLOTS",3);let ut=ft;const Lt={ui_click:{key:"se_ui_click",volume:.5,minInterval:50},ui_confirm:{key:"se_ui_confirm",volume:.6,minInterval:100},ui_popup:{key:"se_ui_popup",volume:.5,minInterval:200},ui_close:{key:"se_ui_close",volume:.4,minInterval:200},ui_start:{key:"se_ui_start",volume:.7,minInterval:500},hit_normal_1:{key:"se_hit_normal_1",volume:.12,minInterval:50},hit_normal_2:{key:"se_hit_normal_2",volume:.12,minInterval:50},hit_normal_3:{key:"se_hit_normal_3",volume:.12,minInterval:50},hit_crit:{key:"se_hit_crit",volume:.25,minInterval:100},hit_skill_1:{key:"se_hit_skill_1",volume:.5,minInterval:80},hit_skill_2:{key:"se_hit_skill_2",volume:.5,minInterval:80},hit_skill_3:{key:"se_hit_skill_3",volume:.5,minInterval:80}},gt=class gt{constructor(C){x(this,"scene");x(this,"lastPlayTime",new Map);x(this,"masterVolume",1);x(this,"sfxVolume",1);x(this,"enabled",!0);this.scene=C,gt.instance=this}static getInstance(){return gt.instance}updateScene(C){this.scene=C}setMasterVolume(C){this.masterVolume=Math.max(0,Math.min(1,C))}setSfxVolume(C){this.sfxVolume=Math.max(0,Math.min(1,C))}setEnabled(C){this.enabled=C}play(C,t){if(!this.enabled)return!1;const e=Lt[C];if(!e)return console.warn(`SoundManager: Unknown sound ID "${C}"`),!1;const s=(t==null?void 0:t.key)??e.key,a=((t==null?void 0:t.volume)??e.volume??1)*this.masterVolume*this.sfxVolume,i=(t==null?void 0:t.minInterval)??e.minInterval??0;if(i>0){const n=Date.now(),o=this.lastPlayTime.get(C)??0;if(n-o<i)return!1;this.lastPlayTime.set(C,n)}return this.scene.cache.audio.exists(s)?(this.scene.sound.play(s,{volume:a}),!0):(console.warn(`SoundManager: Audio "${s}" not loaded`),!1)}playHit(C="normal",t=1){var a;let e;if(C==="normal"||C==="skill"){const i=Math.floor(Math.random()*3)+1;e=`hit_${C}_${i}`}else e=`hit_${C}`;const s=t>1?.7+.3/t:1;this.play(e,{volume:(((a=Lt[e])==null?void 0:a.volume)??.5)*s})}playClick(){this.play("ui_click")}playConfirm(){this.play("ui_confirm")}playPopup(){this.play("ui_popup")}playClose(){this.play("ui_close")}playStart(){this.play("ui_start")}};x(gt,"instance",null);let rt=gt;function mt(K){const C=rt.getInstance();return C?C.play(K):!1}function Ft(){mt("ui_click")}function Gt(){mt("ui_confirm")}function Nt(){mt("ui_popup")}function Yt(){mt("ui_close")}const st=10;class Ut{constructor(C){x(this,"scene");x(this,"sawBladeLastHitTime",new Map);x(this,"sawBladeAngle",0);this.scene=C}get characterX(){return this.scene.getCharacterX()}get characterY(){return this.scene.getCharacterY()}get currentLevel(){return this.scene.getCurrentLevel()}get gameBounds(){return this.scene.getGameBounds()}get monsterManager(){return this.scene.getMonsterManager()}get skillManager(){return this.scene.getSkillManager()}get showGridSkillEffects(){return this.scene.getShowGridSkillEffects()}get cameraOffsetX(){return this.scene.getCameraOffsetX()}get cameraOffsetY(){return this.scene.getCameraOffsetY()}call(C,...t){return this.scene[C](...t)}getSawBladeAngle(){return this.sawBladeAngle}clearSawBladeHitTime(){this.sawBladeLastHitTime.clear()}resetSawBladeState(){this.sawBladeAngle=0,this.sawBladeLastHitTime.clear()}activateSoulRender(C){const t=this.monsterManager.getMonsters();if(t.length===0)return;if(C.level>=C.definition.maxLevel){this.triggerSoulRenderTripleWave(C);return}let e=t[0],s=1/0;for(const g of t){const m=g.x-this.characterX,M=g.y-this.characterY,S=Math.sqrt(m*m+M*M);S<s&&(s=S,e=g)}const a=Math.atan2(e.y-this.characterY,e.x-this.characterX);this.scene.setFacingRight(Math.cos(a)>=0);const i=this.gameBounds.height*.3,o=(60+C.level*10)/2*(Math.PI/180),h=this.skillManager.getAdvancedSkillBonusForActiveSkill(C.definition.id),r=2+C.level+h,c=st*r,{damage:l,isCrit:d}=this.skillManager.calculateFinalDamageWithCrit(c,this.currentLevel),p=[];for(const g of t){const m=this.gameBounds.height*g.definition.size*.5,M=g.x-this.characterX,S=g.y-this.characterY,E=Math.sqrt(M*M+S*S);if(E-m>i)continue;let y=Math.atan2(S,M)-a;for(;y>Math.PI;)y-=Math.PI*2;for(;y<-Math.PI;)y+=Math.PI*2;const k=E>0?Math.atan2(m,E):Math.PI;Math.abs(y)<=o+k&&p.push(g.id)}this.call("drawSectorEdge",a,i,o,C.definition.color);const f=C.definition.flashColor||C.definition.color;if(this.showGridSkillEffects)this.call("flashSkillAreaSector",this.characterX,this.characterY,i,a,o,f);else{const g=o*(180/Math.PI);this.call("flashSkillEffectSector",this.characterX,this.characterY,i,a,g,f)}if(p.length>0){const g=t.filter(M=>p.includes(M.id)),m=this.monsterManager.damageMonsters(p,l);m.totalExp>0&&this.call("addExp",m.totalExp),this.call("shakeScreen",p.length);for(const M of g){const S=Math.atan2(M.y-this.characterY,M.x-this.characterX);this.call("showHitSparkEffect",M.x,M.y,d?j.SOUL_RENDER_CRIT:j.SOUL_RENDER,S,4)}}}triggerSoulRenderTripleWave(C){this.call("triggerSoulRenderTripleWave",C)}activateCoder(C){const t=this.monsterManager.getMonsters();if(t.length===0)return;const e=this.gameBounds.height*.1,s=3+C.level*.5,a=e*s,i=this.skillManager.getAdvancedSkillBonusForActiveSkill(C.definition.id),n=(1+C.level)*2+i,o=st*n,{damage:h}=this.skillManager.calculateFinalDamageWithCrit(o,this.currentLevel),r=[];for(const l of t){const d=this.gameBounds.height*l.definition.size*.5,p=l.x-this.characterX,f=l.y-this.characterY;Math.sqrt(p*p+f*f)-d<=a&&r.push(l.id)}this.call("drawCircleEdge",a,C.definition.color);const c=C.definition.flashColor||C.definition.color;if(this.showGridSkillEffects?this.call("flashSkillAreaCircle",this.characterX,this.characterY,a,c):this.call("flashSkillEffectCircle",this.characterX,this.characterY,a,c),r.length>0){const l=t.filter(f=>r.includes(f.id)),d=this.monsterManager.damageMonsters(r,h);d.totalExp>0&&this.call("addExp",d.totalExp),this.call("shakeScreen",r.length);for(const f of l){const g=this.call("worldToScreen",f.x,f.y);this.call("showExplosionSparkEffect",g.x,g.y,11167487,.8)}const p=this.skillManager.getCoderBurstChance(this.currentLevel);p>0&&d.killedPositions.length>0&&this.call("triggerCoderBurst",d.killedPositions,a,h,C,p)}}activateVfx(C){const t=this.monsterManager.getMonsters();if(t.length===0)return;const e=C.level>=C.definition.maxLevel,s=e?3:C.level+1,a=e?this.gameBounds.height*1.5:this.gameBounds.height*1,i=e?this.gameBounds.height*.5:this.gameBounds.height*.05,n=this.skillManager.getAdvancedSkillBonusForActiveSkill(C.definition.id),o=1+C.level+n,h=st*o,{damage:r,isCrit:c}=this.skillManager.calculateFinalDamageWithCrit(h,this.currentLevel),l=new Set,d=[];if(e){const f=t.map(m=>{const M=m.x-this.characterX,S=m.y-this.characterY;return{monster:m,dist:Math.sqrt(M*M+S*S)}});f.sort((m,M)=>m.dist-M.dist);const g=Math.min(s,f.length);for(let m=0;m<g;m++){const M=f[m].monster,S=Math.atan2(M.y-this.characterY,M.x-this.characterX);d.push(S)}}else{const f=t.map((g,m)=>m);for(let g=0;g<s;g++){let m;if(f.length>0){const M=Math.floor(Math.random()*f.length),S=f[M];f.splice(M,1);const E=t[S];m=Math.atan2(E.y-this.characterY,E.x-this.characterX)}else m=Math.random()*Math.PI*2;d.push(m)}}for(const f of d){for(const S of t){const E=this.gameBounds.height*S.definition.size*.5,T=S.x-this.characterX,y=S.y-this.characterY;if(Math.sqrt(T*T+y*y)-E>a)continue;const v=Math.cos(f),I=Math.sin(f);if(T*v+y*I<-E)continue;Math.abs(T*I-y*v)<=i/2+E&&l.add(S.id)}this.call("drawBeamEdge",f,a,i,C.definition.color);const g=this.characterX+Math.cos(f)*a,m=this.characterY+Math.sin(f)*a,M=C.definition.flashColor||C.definition.color;this.showGridSkillEffects?this.call("flashSkillAreaLine",this.characterX,this.characterY,g,m,i,M):this.call("flashSkillEffectLine",this.characterX,this.characterY,g,m,i,M)}d.length>0&&this.scene.setFacingRight(Math.cos(d[0])>=0);const p=Array.from(l);if(p.length>0){const f=t.filter(S=>p.includes(S.id)),g=f.map(S=>({x:S.x,y:S.y})),m=this.monsterManager.damageMonsters(p,r);m.totalExp>0&&this.call("addExp",m.totalExp),this.call("shakeScreen",p.length);for(const S of f){const E=Math.atan2(S.y-this.characterY,S.x-this.characterX);this.call("showHitSparkEffect",S.x,S.y,c?j.VFX_SNIPE_CRIT:j.VFX_SNIPE,E,5)}const M=this.skillManager.getVfxChainChance(this.currentLevel);M>0&&g.length>0&&this.call("triggerVfxChain",g,r,M,C,c)}}activateArchitect(C){this.scene.setArchitectSkillLevel(C.level),this.skillManager.getArchitectExplosionChance(this.currentLevel)>0&&this.scene.getCurrentShield()>0&&this.call("triggerShieldExplosion",C);const e=this.scene.getCurrentSawBladePositions();e&&e.length>0&&this.call("launchSawBladesOutward");const s=this.scene.getMaxHp(),a=Math.floor(s*.3);this.scene.setCurrentShield(a),this.scene.setMaxShield(a);const i=[2,4,6,8,10,20],n=this.skillManager.getAdvancedSkillBonusForActiveSkill(C.definition.id),o=(i[C.level]||2)+n;this.scene.setShieldReflectDamage(st*o),this.call("drawShieldBarFill");const h=this.gameBounds.height*.18,r=C.definition.flashColor||C.definition.color;this.call("flashShieldEffect",this.characterX,this.characterY,h,r),this.call("triggerShieldBreathScan")}executeBurningCelluloid(C){const e=this.scene.getCurrentHp();if(e>10){this.scene.setCurrentHp(e-10),this.call("drawHpBarFill"),this.call("updateHpText");const g=this.scene.getCharacter();g.setTint(16737792),this.scene.getTime().delayedCall(100,()=>{g.clearTint()})}else return;const s=this.currentLevel+C,a=st*s,i=this.gameBounds.height*.7,o=30/2*(Math.PI/180),h=this.monsterManager.getMonsters();let r=0;if(h.length>0){let g=1/0;for(const m of h){const M=m.x-this.characterX,S=m.y-this.characterY,E=Math.sqrt(M*M+S*S);E<g&&(g=E,r=Math.atan2(S,M))}this.scene.setFacingRight(Math.cos(r)>=0)}const c=12,l=600,d=l/c,p=new Set,f=this.scene.getTime();for(let g=0;g<c;g++)f.delayedCall(g*d,()=>{var k;const m=r+g/c*Math.PI*2,{damage:M,isCrit:S}=this.skillManager.calculateFinalDamageWithCrit(a,this.currentLevel),E=this.monsterManager.getMonsters(),T=[],y=[];for(const v of E){if(p.has(v.id))continue;const I=v.x-this.characterX,w=v.y-this.characterY,A=Math.sqrt(I*I+w*w),P=this.gameBounds.height*v.definition.size*.5;if(A-P>i)continue;let R=Math.atan2(w,I)-m;for(;R>Math.PI;)R-=Math.PI*2;for(;R<-Math.PI;)R+=Math.PI*2;const D=A>0?Math.atan2(P,A):Math.PI;Math.abs(R)<=o+D&&(T.push(v.id),y.push({x:v.x,y:v.y}),p.add(v.id))}if(T.length>0){const v=this.monsterManager.damageMonsters(T,M);v.totalExp>0&&this.call("addExp",v.totalExp);for(const b of y)this.call("showHitSparkEffect",b.x,b.y,S?j.CELLULOID_CRIT:j.CELLULOID,m);const I=.1+C*.01,w=Math.floor(a*.2),A=5e3,P=[];for(const b of T)Math.random()<I&&P.push(b);P.length>0&&(this.monsterManager.burnMonsters(P,A,w),(k=rt.getInstance())==null||k.playHit("skill",P.length))}this.call("flashSlashEffect",this.characterX,this.characterY,i,m,16737792)});f.delayedCall(l,()=>{this.call("shakeScreen",p.size)})}executeTechArtist(C){const t=this.currentLevel+C,e=st*t,s=this.gameBounds.height/10,a=5,i=3,n=1e3,o=5,r=500/o,c=j.TECH_ARTIST,l=i*s,d=this.scene.getTime();for(let p=0;p<o;p++)d.delayedCall(p*r,()=>{const f=Math.random()*Math.PI*2,g=Math.random()*a*s,m=this.characterX+Math.cos(f)*g,M=this.characterY+Math.sin(f)*g,S=(Math.random()-.5)*2*s,E=this.call("worldToScreen",m,M),T=-Math.PI/2-Math.atan2(S,E.y+50);this.call("showLightBeamEffect",m,M,l,c,S),d.delayedCall(200,()=>{var A;const{damage:y,isCrit:k}=this.skillManager.calculateFinalDamageWithCrit(e,this.currentLevel),v=this.monsterManager.getMonsters(),I=[],w=[];for(const P of v){const b=P.x-m,R=P.y-M,B=Math.sqrt(b*b+R*R)/s,_=P.definition.size*.5;B-_<=i&&(I.push(P.id),w.push({x:P.x,y:P.y}))}if(I.length>0){this.monsterManager.stunMonsters(I,n),(A=rt.getInstance())==null||A.playHit("skill",I.length);const P=this.monsterManager.damageMonsters(I,y);P.totalExp>0&&this.call("addExp",P.totalExp);for(const b of w){const R=this.call("worldToScreen",b.x,b.y);this.call("showExplosionSparkEffect",R.x,R.y,k?j.TECH_ARTIST_CRIT:j.TECH_ARTIST,1)}this.call("shakeScreen",I.length)}this.call("showExplosionEffect",m,M,l,c,T,k)})})}executeAbsoluteDefense(C){const t=this.scene.getCurrentShield(),e=this.scene.getMaxShield();if(t<=0){this.call("hideSawBlades");return}const s=this.currentLevel+C,a=st*s,i=this.gameBounds.height/10,n=2,o=.5,h=n*i,r=o*i,c=8,l=Math.min(c,3+Math.floor(C/5)),f=Math.PI*2/2e3*100;this.sawBladeAngle+=f,this.sawBladeAngle>Math.PI*2&&(this.sawBladeAngle-=Math.PI*2);const g=e>0?t/e:0,m=1-g,M=g,S=1+m*10,E=Math.random()<M;let T=Math.floor(a*S);E&&(T=Math.floor(T*1.5));const y=[];for(let P=0;P<l;P++){const b=this.sawBladeAngle+P/l*Math.PI*2,R=this.characterX+Math.cos(b)*h,D=this.characterY+Math.sin(b)*h;y.push({x:R,y:D})}const k=this.monsterManager.getMonsters(),v=[],I=[],w=Date.now(),A=500;for(const P of k)for(const b of y){const R=P.x-b.x,D=P.y-b.y,_=Math.sqrt(R*R+D*D)/i,O=P.definition.size*.5;if(_-O<=o){const X=this.sawBladeLastHitTime.get(P.id)||0;if(w-X>=A){v.push(P.id),I.push({x:P.x,y:P.y}),this.sawBladeLastHitTime.set(P.id,w);break}}}if(v.length>0){const P=this.gameBounds.height*.1;this.monsterManager.knockbackMonsters(v,this.characterX,this.characterY,P);const b=this.monsterManager.damageMonsters(v,T);b.totalExp>0&&this.call("addExp",b.totalExp);let R=.01;l>=c&&(R=.01-(C-25)*.001);const B=Math.ceil(e*Math.abs(R))*v.length;let _=t;R>=0?_=Math.max(0,t-B):_=Math.min(e,t+B),this.scene.setCurrentShield(_),this.call("drawShieldBarFill")}this.call("drawSawBladesWithParams",{bladePositions:y,bladeRadius:r,hitPositions:I,isCrit:E}),this.call("setCurrentSawBladePositions",y),this.call("setSawBladeRadius",r)}performSawBladeHit(C,t,e,s,a,i){const{damage:n,isCrit:o}=this.skillManager.calculateFinalDamageWithCrit(s,this.currentLevel),h=this.monsterManager.damageMonsters([C],n);h.totalExp>0&&this.call("addExp",h.totalExp);const r=this.gameBounds.height*.1;return this.monsterManager.knockbackMonsters([C],a,i,r),this.call("showHitSparkEffect",t,e,o?j.SAWBLADE_CRIT:j.SAWBLADE),{isCrit:o}}executePerfectPixel(C){const t=this.currentLevel+C,e=st*t,s=this.gameBounds.x+this.gameBounds.width/3,a=this.gameBounds.x+this.gameBounds.width*2/3,i=this.gameBounds.y+this.gameBounds.height/3,n=this.gameBounds.y+this.gameBounds.height*2/3,o=[{x:s,y:i},{x:a,y:i},{x:s,y:n},{x:a,y:n}],h=this.gameBounds.height*.3,r=this.gameBounds.height/10,c=3,l=[0,1,2,3];for(let d=l.length-1;d>0;d--){const p=Math.floor(Math.random()*(d+1));[l[d],l[p]]=[l[p],l[d]]}this.call("startPerfectPixelSequence",{focusPoints:o,shuffledIndices:l,baseDamage:e,explosionRadius:h,unitSize:r,explosionRadiusUnits:c})}performPerfectPixelExplosion(C,t,e,s,a){var l;const i=C+this.cameraOffsetX-this.gameBounds.x,n=t+this.cameraOffsetY-this.gameBounds.y,{damage:o,isCrit:h}=this.skillManager.calculateFinalDamageWithCrit(e,this.currentLevel),r=this.monsterManager.getMonsters(),c=[];for(const d of r){const p=d.x-i,f=d.y-n,m=Math.sqrt(p*p+f*f)/s,M=d.definition.size*.5;m-M<=a&&c.push(d.id)}if(c.length>0){this.monsterManager.stunMonsters(c,1e3),(l=rt.getInstance())==null||l.playHit("skill",c.length);const d=this.monsterManager.damageMonsters(c,o);d.totalExp>0&&this.call("addExp",d.totalExp)}return{hitMonsters:c,isCrit:h,finalDamage:o}}executeVfxBurst(C){const t=this.currentLevel+C,e=st*t;this.monsterManager.getMonsters().length!==0&&this.call("startVfxBurstSequence",{baseDamage:e,skillLevel:C,characterX:this.characterX,characterY:this.characterY})}selectMissileTarget(){const C=this.monsterManager.getMonsters();if(C.length===0)return null;const t=C.map(i=>{const n=i.x-this.characterX,o=i.y-this.characterY;return{monster:i,dist:Math.sqrt(n*n+o*o)}});t.sort((i,n)=>i.dist-n.dist);const e=Math.min(5,t.length),s=t.slice(0,e),a=Math.floor(Math.random()*s.length);return s[a].monster.id}performMissileHit(C,t,e,s,a){const i=this.gameBounds.height/10,n=this.monsterManager.getMonsters(),{damage:o,isCrit:h}=this.skillManager.calculateFinalDamageWithCrit(s,this.currentLevel),r=n.find(f=>f.id===C);if(r){const f=this.monsterManager.damageMonsters([r.id],o);f.totalExp>0&&this.call("addExp",f.totalExp);const g=a*.01;if(Math.random()<g){const m=Math.floor(s*.2);this.monsterManager.burnMonsters([r.id],5e3,m)}}const c=3,l=[],d=t+this.cameraOffsetX-this.gameBounds.x,p=e+this.cameraOffsetY-this.gameBounds.y;for(const f of n){const g=f.x-d,m=f.y-p;Math.sqrt(g*g+m*m)/i<=c&&l.push(f.id)}if(l.length>0){const f=this.monsterManager.damageMonsters(l,o);f.totalExp>0&&this.call("addExp",f.totalExp);const g=a*.01,m=Math.floor(s*.2),M=[];for(const S of l)Math.random()<g&&M.push(S);M.length>0&&this.monsterManager.burnMonsters(M,5e3,m)}return{hitMonsterIds:l,isCrit:h}}executeSoulSlash(C){const t=this.currentLevel+C,e=st*t,s=this.monsterManager.getMonsters();if(s.length===0)return;let a=s[0],i=1/0;for(const r of s){const c=r.x-this.characterX,l=r.y-this.characterY,d=Math.sqrt(c*c+l*l);d<i&&(i=d,a=r)}const n=a.x-this.characterX,o=a.y-this.characterY,h=Math.atan2(o,n);this.performSoulSlash(this.characterX,this.characterY,h,e,C,!1)}performSoulSlash(C,t,e,s,a,i){const n=Math.max(this.gameBounds.width,this.gameBounds.height)*2,o=C-Math.cos(e)*n,h=t-Math.sin(e)*n,r=C+Math.cos(e)*n,c=t+Math.sin(e)*n;i?this.call("drawChainSlashEffect",o,h,r,c,e,C,t):this.call("drawSoulSlashEffect",o,h,r,c,e,C,t);const l=this.monsterManager.getMonsters(),d=[],p=[],f=this.gameBounds.height*.05;for(const g of l){const m=this.pointToLineDistance(g.x,g.y,o,h,r,c),M=this.gameBounds.height*g.definition.size*.5;m<=f+M&&(d.push(g.id),p.push({x:g.x,y:g.y}))}if(d.length>0){const g=this.skillManager.getCritChance(this.currentLevel),m=Math.random()<g,S=Math.floor(s*(m?3:1)),E=this.monsterManager.damageMonsters(d,S);E.totalExp>0&&this.call("addExp",E.totalExp);for(const T of p)this.call("showHitSparkEffect",T.x,T.y,m?j.SOUL_SLASH_CRIT:j.SOUL_SLASH,e);if(!i){const T=.1+a*.01;for(const y of p)if(Math.random()<T){const v=(30+Math.random()*30)*Math.PI/180,I=e+(Math.random()<.5?v:-v);this.performSoulSlash(y.x,y.y,I,s*2,a,!0)}}}}pointToLineDistance(C,t,e,s,a,i){const n=C-e,o=t-s,h=a-e,r=i-s,c=n*h+o*r,l=h*h+r*r;let d=-1;l!==0&&(d=c/l);let p,f;d<0?(p=e,f=s):d>1?(p=a,f=i):(p=e+d*h,f=s+d*r);const g=C-p,m=t-f;return Math.sqrt(g*g+m*m)}activateZeroTrust(C){if(this.scene.getZeroTrustActive())return;this.scene.setZeroTrustActive(!0);const s=5*(this.gameBounds.height/10);this.call("createZeroTrustShieldSprite");for(let a=0;a<8;a++)this.call("createZeroTrustPoint",a,s);this.monsterManager.setSlowZone(this.characterX,this.characterY,5,.5)}executePhantomIteration(C){if(this.scene.getPhantomCount()>=this.scene.getPhantomMaxCount()){this.activatePhantomFollowingCurseCircles(C);return}this.call("createPhantom",C)}executePhantomSkillAt(C,t,e,s){const a=this.skillManager.getEquippedAdvancedSkill(),i=a?a.level:t,n=this.currentLevel+i,o=st*n;switch(this.call("showPhantomCastEffectAt",e,s),C){case"advanced_burning_celluloid":this.call("startPhantomBurningCelluloid",{baseDamage:o,phantomX:e,phantomY:s,skillLevel:i});break;case"advanced_tech_artist":this.call("startPhantomTechArtist",{baseDamage:o,phantomX:e,phantomY:s});break;case"advanced_perfect_pixel":this.call("startPhantomPerfectPixel",{baseDamage:o,phantomX:e,phantomY:s});break}}performPhantomBurningCelluloidStep(C,t,e,s,a,i,n){const o=this.monsterManager.getMonsters(),h=[];for(const r of o){const c=r.x-C,l=r.y-t;if(Math.sqrt(c*c+l*l)<=s){const p=Math.atan2(l,c);let f=Math.abs(p-e);f>Math.PI&&(f=Math.PI*2-f),f<=a&&h.push(r.id)}}if(h.length>0){const{damage:r}=this.skillManager.calculateFinalDamageWithCrit(i,this.currentLevel),c=this.monsterManager.damageMonsters(h,r);c.totalExp>0&&this.call("addExp",c.totalExp);const l=.1+n*.01,d=Math.floor(i*.2),p=[];for(const f of h)Math.random()<l&&p.push(f);p.length>0&&this.monsterManager.burnMonsters(p,5e3,d)}return h}performPhantomTechArtistHit(C,t,e,s){const a=this.gameBounds.height/10,i=this.monsterManager.getMonsters(),n=[];for(const r of i){const c=r.x-C,l=r.y-t,d=Math.sqrt(c*c+l*l),p=a*r.definition.size*.5;d-p<=e&&n.push(r.id)}const{damage:o,isCrit:h}=this.skillManager.calculateFinalDamageWithCrit(s,this.currentLevel);if(n.length>0){const r=this.monsterManager.damageMonsters(n,o);r.totalExp>0&&this.call("addExp",r.totalExp)}return{hitMonsters:n,isCrit:h}}performPhantomPerfectPixelExplosion(C,t,e,s){var r;const a=this.gameBounds.height/10,i=this.monsterManager.getMonsters(),n=[];for(const c of i){const l=c.x-C,d=c.y-t,f=Math.sqrt(l*l+d*d)/a,g=c.definition.size*.5;f-g<=s&&n.push(c.id)}const{damage:o,isCrit:h}=this.skillManager.calculateFinalDamageWithCrit(e,this.currentLevel);if(n.length>0){this.monsterManager.stunMonsters(n,500),(r=rt.getInstance())==null||r.playHit("skill",n.length);const c=this.monsterManager.damageMonsters(n,o);c.totalExp>0&&this.call("addExp",c.totalExp)}return{hitMonsters:n,isCrit:h}}activatePhantomFollowingCurseCircles(C){const t=this.skillManager.getEquippedAdvancedSkill(),e=t?t.level:C,s=this.currentLevel+e,a=st*s;this.call("startPhantomCurseCircles",a,e)}performCurseCircleDamage(C,t,e,s,a){const i=this.monsterManager.getMonsters(),n=[];for(const o of i){const h=o.x-C,r=o.y-t,c=Math.sqrt(h*h+r*r),l=this.gameBounds.height*o.definition.size*.5;c-l<=e&&n.push(o.id)}if(n.length>0){const o=Math.floor(s*.5),{damage:h}=this.skillManager.calculateFinalDamageWithCrit(o,this.currentLevel),r=this.monsterManager.damageMonsters(n,h);r.totalExp>0&&this.call("addExp",r.totalExp);const c=.1+a*.01,l=Math.floor(s*.2),d=5e3,p=[];for(const f of n)Math.random()<c&&p.push(f);p.length>0&&this.monsterManager.burnMonsters(p,d,l)}return{hitMonsters:n}}performZeroTrustPointDamage(C,t,e,s){const a=this.gameBounds.height/10,o=(1+(e-1)*.5)*a,h=this.currentLevel+s,r=st*h,c=this.monsterManager.getMonsters(),l=[];for(const g of c){const m=g.x-C,M=g.y-t;Math.sqrt(m*m+M*M)<=o&&l.push(g.id)}let d=!1,p=0,f=!1;if(l.length>0){const g=(e-1)*s*.01,m=Math.floor(r*(1+g)),M=this.skillManager.calculateFinalDamageWithCrit(m,this.currentLevel);d=M.isCrit;const S=this.monsterManager.damageMonsters(l,M.damage);if(S.totalExp>0&&this.call("addExp",S.totalExp),p=S.killCount,p>0){const E=s*.01;for(let T=0;T<p;T++)if(Math.random()<E){f=!0;break}}}return{hitMonsters:l,isCrit:d,killCount:p,shouldResetShield:f}}deactivateZeroTrust(){this.scene.setZeroTrustActive(!1);const C=this.scene.getZeroTrustPoints();for(const e of C)e.pointSprite.destroy(),e.beamSprite.destroy();this.scene.clearZeroTrustPoints(),this.scene.clearZeroTrustTrackedMonsters();const t=this.scene.getZeroTrustSprite();t&&(t.destroy(),this.scene.clearZeroTrustSprite()),this.monsterManager.clearSlowZone()}}const pt=[{id:"slime",name:"史萊姆",color:6750054,speed:1,damage:1,size:.05,hp:30,exp:20},{id:"elite_slime",name:"菁英史萊姆",color:4856427,speed:1,damage:3,size:.15,hp:30,exp:200},{id:"bat",name:"蝙蝠",color:8930474,speed:8,damage:.5,size:.025,hp:10,exp:5}],$=class ${constructor(C,t,e,s){x(this,"scene");x(this,"monsters",[]);x(this,"nextMonsterId",0);x(this,"clipMask",null);x(this,"spawnInterval",2e3);x(this,"lastSpawnTime",0);x(this,"isSpawning",!1);x(this,"gameStartTime",0);x(this,"difficultyMultiplier",1);x(this,"speedMultiplier",1);x(this,"hpMultiplier",1);x(this,"damageMultiplier",1);x(this,"debuffResistance",0);x(this,"batSwarmInterval",3e4);x(this,"lastBatSwarmTime",0);x(this,"batSwarmCount",8);x(this,"waveSpawnInterval",6e4);x(this,"lastWaveSpawnTime",0);x(this,"waveBaseCount",50);x(this,"pendingMonsters",0);x(this,"eliteSpawnedAtLevels",new Set);x(this,"tauntTarget",{x:0,y:0,active:!1});x(this,"onMonsterKilledCallback",null);x(this,"gameBounds");x(this,"mapWidth");x(this,"mapHeight");x(this,"playerLevel",0);x(this,"gridCellSize",4);x(this,"gridScaleMultiplier",3);x(this,"monsterGridContainer");x(this,"monsterGridCells",[]);x(this,"screenGridCols",0);x(this,"screenGridRows",0);x(this,"slowZone",{active:!1,centerX:0,centerY:0,radius:0,multiplier:1});this.scene=C,this.gameBounds=t,this.mapWidth=e,this.mapHeight=s,this.updateGridCellSize(),this.createMonsterGrid()}setPlayerLevel(C){return this.playerLevel=C,C>=5&&C%5===0&&!this.eliteSpawnedAtLevels.has(C)?(this.eliteSpawnedAtLevels.add(C),!0):!1}spawnElite(C,t){const e=this.playerLevel,s=pt.find(g=>g.id==="elite_slime");if(!s)return;const a=["top","left","right"],i=a[Math.floor(Math.random()*a.length)];let n,o;const h=150,r=C,c=C+this.gameBounds.width,l=t;switch(i){case"top":n=r+Math.random()*this.gameBounds.width,o=l-h;break;case"left":n=r-h,o=l+Math.random()*this.gameBounds.height;break;case"right":n=c+h,o=l+Math.random()*this.gameBounds.height;break}const p=this.calculateMonsterHp(s.hp)*e,f={id:this.nextMonsterId++,definition:s,x:n,y:o,hp:p,lastDamageTime:0,bouncePhase:Math.random()*Math.PI*2,bounceSpeed:1.5+Math.random()*.5,squashStretch:1,flashStartTime:0,isElite:!0,eliteHpMultiplier:e,statusEffects:[]};this.monsters.push(f)}setGridScaleMultiplier(C){this.gridScaleMultiplier=C,this.updateGridCellSize(),this.recreateMonsterGrid()}updateGridCellSize(){const C=this.scene.cameras.main.width,t=1920,e=20/this.gridScaleMultiplier,s=6/this.gridScaleMultiplier,a=Math.min(1,C/t);this.gridCellSize=Math.max(s,Math.floor(e*a))}setClipMask(C){this.clipMask=C,this.monsterGridContainer&&this.monsterGridContainer.setMask(C)}createMonsterGrid(){this.monsterGridContainer=this.scene.add.container(this.gameBounds.x,this.gameBounds.y),this.monsterGridContainer.setDepth(5),this.clipMask&&this.monsterGridContainer.setMask(this.clipMask),this.screenGridCols=Math.ceil(this.gameBounds.width/this.gridCellSize)+1,this.screenGridRows=Math.ceil(this.gameBounds.height/this.gridCellSize)+1;for(let C=0;C<this.screenGridRows;C++)for(let t=0;t<this.screenGridCols;t++){const e=t*this.gridCellSize,s=C*this.gridCellSize,a=this.scene.add.rectangle(e,s,this.gridCellSize,this.gridCellSize,0,0);a.setOrigin(0,0),a.setVisible(!1),this.monsterGridContainer.add(a),this.monsterGridCells.push({rect:a,screenCol:t,screenRow:C})}}recreateMonsterGrid(){this.monsterGridCells.forEach(C=>C.rect.destroy()),this.monsterGridCells=[],this.monsterGridContainer&&this.monsterGridContainer.destroy(),this.createMonsterGrid()}getHighLevelMultiplier(){return this.playerLevel<=50?1:1+.15*Math.floor((this.playerLevel-50)/5)}calculateMonsterHp(C){const t=C*Math.pow($.HP_GROWTH_RATE,this.playerLevel);return Math.floor(t*this.getHighLevelMultiplier()*this.hpMultiplier)}calculateMonsterDamage(C){const t=Math.max(1,this.playerLevel);return $.DAMAGE_UNIT*t*C.definition.damage*this.getHighLevelMultiplier()*this.damageMultiplier}calculateMonsterExp(C){const t=Math.floor(this.playerLevel/10);return Math.floor(C*Math.pow(2,t)*this.getHighLevelMultiplier())}startSpawning(){this.isSpawning=!0,this.lastSpawnTime=this.scene.time.now,this.lastBatSwarmTime=this.scene.time.now,this.lastWaveSpawnTime=this.scene.time.now,this.pendingMonsters=0,this.gameStartTime=this.scene.time.now}getSpawnMultiplier(C){const t=C-this.gameStartTime;return t<$.SPAWN_PHASE1_END?$.SPAWN_MULTIPLIER_PHASE1:t<$.SPAWN_PHASE2_END?$.SPAWN_MULTIPLIER_PHASE2:$.SPAWN_MULTIPLIER_PHASE3}stopSpawning(){this.isSpawning=!1}hideAllMonsters(){this.monsterGridContainer&&this.monsterGridContainer.setVisible(!1)}reset(){this.isSpawning=!1,this.monsters=[],this.nextMonsterId=0,this.lastSpawnTime=0,this.lastBatSwarmTime=0,this.eliteSpawnedAtLevels.clear(),this.tauntTarget={x:0,y:0,active:!1},this.slowZone={active:!1,centerX:0,centerY:0,radius:0,multiplier:1},this.playerLevel=0;for(const C of this.monsterGridCells)C.rect.setFillStyle(0,0),C.rect.setVisible(!1);this.monsterGridContainer&&this.monsterGridContainer.setVisible(!0)}update(C,t,e,s,a){const i=this.scene.time.now;let n=0;const o=[],h=$.MAX_MONSTERS-this.monsters.length,c=180/Math.max(1,this.monsters.length),l=this.getSpawnMultiplier(i),d=3e3/l,p=Math.max(100,d/c);if(this.isSpawning&&i-this.lastSpawnTime>=p&&h>0){const m=Math.floor($.SPAWN_BASE_COUNT*l*this.difficultyMultiplier);let M=Math.min(Math.max(1,m),h);if(this.pendingMonsters>0){const S=h-M,E=Math.min(this.pendingMonsters,S);M+=E,this.pendingMonsters-=E}for(let S=0;S<M;S++)this.spawnMonster(t,e,s,a);this.lastSpawnTime=i}if(this.isSpawning&&i-this.lastWaveSpawnTime>=this.waveSpawnInterval&&(this.spawnWave(s,a),this.lastWaveSpawnTime=i),this.isSpawning&&i-this.lastBatSwarmTime>=this.batSwarmInterval){const m=$.MAX_MONSTERS-this.monsters.length;m>0&&this.spawnBatSwarm(s,a,m),this.lastBatSwarmTime=i}this.teleportDistantMonsters(t,e,s,a);const f=this.gameBounds.height*.06,g=[];return this.monsters.forEach(m=>{const M=this.isMonsterStunned(m);if(m.isBat&&m.directionX!==void 0&&m.directionY!==void 0){if(!M){const v=this.getSlowMultiplier(m.x,m.y),w=m.definition.speed*this.speedMultiplier*this.gameBounds.height*.1*v*C/1e3;m.x+=m.directionX*w,m.y+=m.directionY*w}const S=this.gameBounds.height*.3,E=s-S,T=s+this.gameBounds.width+S,y=a-S,k=a+this.gameBounds.height+S;if((m.x<E||m.x>T||m.y<y||m.y>k)&&g.push(m.id),!M){const v=t-m.x,I=e-m.y;Math.sqrt(v*v+I*I)<=f&&i-m.lastDamageTime>=3e3&&(n+=this.calculateMonsterDamage(m),m.lastDamageTime=i,o.push(m))}}else if(!M){let S=t,E=e;this.tauntTarget.active&&(S=this.tauntTarget.x,E=this.tauntTarget.y);const T=S-m.x,y=E-m.y,k=Math.sqrt(T*T+y*y);if(k>f){const v=this.getSlowMultiplier(m.x,m.y),A=m.definition.speed*this.speedMultiplier*this.gameBounds.height*.1*v*C/1e3/k;m.x+=T*A,m.y+=y*A}else!this.tauntTarget.active&&i-m.lastDamageTime>=3e3&&(n+=this.calculateMonsterDamage(m),m.lastDamageTime=i,o.push(m))}if(M)m.squashStretch=1;else{m.bouncePhase+=m.bounceSpeed*C/1e3,m.bouncePhase>Math.PI*2&&(m.bouncePhase-=Math.PI*2);const S=.08;m.squashStretch=1+Math.sin(m.bouncePhase)*S}}),g.forEach(m=>{this.monsters=this.monsters.filter(M=>M.id!==m)}),this.renderMonstersToGrid(s,a),{damage:n,hitMonsters:o}}teleportDistantMonsters(C,t,e,s){const a=this.gameBounds.height*.1,i=a*$.TELEPORT_UNITS,n=a*$.SPAWN_EDGE_UNITS,o=e,h=e+this.gameBounds.width,r=s,c=s+this.gameBounds.height;for(const l of this.monsters){if(l.isBat||l.isElite||l.isBoss)continue;let d=0;if(l.x<o?d=Math.max(d,o-l.x):l.x>h&&(d=Math.max(d,l.x-h)),l.y<r?d=Math.max(d,r-l.y):l.y>c&&(d=Math.max(d,l.y-c)),d>i){const p=["top","bottom","left","right"];switch(p[Math.floor(Math.random()*p.length)]){case"top":l.x=o+Math.random()*this.gameBounds.width,l.y=r-n;break;case"bottom":l.x=o+Math.random()*this.gameBounds.width,l.y=c+n;break;case"left":l.x=o-n,l.y=r+Math.random()*this.gameBounds.height;break;case"right":l.x=h+n,l.y=r+Math.random()*this.gameBounds.height;break}}}}spawnMonster(C,t,e,s){const a=["top","left","right"],i=a[Math.floor(Math.random()*a.length)];let n,o;const h=100,r=e,c=e+this.gameBounds.width,l=s;switch(i){case"top":n=r+Math.random()*this.gameBounds.width,o=l-h;break;case"left":n=r-h,o=l+Math.random()*this.gameBounds.height;break;case"right":n=c+h,o=l+Math.random()*this.gameBounds.height;break}n=Phaser.Math.Clamp(n,0,this.mapWidth),o=Phaser.Math.Clamp(o,0,this.mapHeight);const d=pt[0],p=this.calculateMonsterHp(d.hp),f={id:this.nextMonsterId++,definition:d,x:n,y:o,hp:p,lastDamageTime:0,bouncePhase:Math.random()*Math.PI*2,bounceSpeed:3+Math.random()*2,squashStretch:1,flashStartTime:0,statusEffects:[]};this.monsters.push(f)}spawnBatSwarm(C,t,e=this.batSwarmCount){const s=["topLeft","topRight","bottomLeft","bottomRight"],a=s[Math.floor(Math.random()*s.length)],i=C,n=C+this.gameBounds.width,o=t,h=t+this.gameBounds.height,r=this.gameBounds.height*.15;let c,l,d,p;switch(a){case"topLeft":c=i-r,l=o-r,d=n+r*2,p=h+r*2;break;case"topRight":c=n+r,l=o-r,d=i-r*2,p=h+r*2;break;case"bottomLeft":c=i-r,l=h+r,d=n+r*2,p=o-r*2;break;case"bottomRight":default:c=n+r,l=h+r,d=i-r*2,p=o-r*2;break}const f=pt.find(S=>S.id==="bat")||pt[0],g=[],m=this.gameBounds.height*.04,M=Math.min(this.batSwarmCount,e);for(let S=0;S<M;S++){let E,T,y=0;const k=50;do{const R=Math.random()*Math.PI*2,D=Math.random()*r;if(E=c+Math.cos(R)*D,T=l+Math.sin(R)*D,y++,!g.some(_=>{const O=_.x-E,X=_.y-T;return Math.sqrt(O*O+X*X)<m})||y>=k)break}while(!0);g.push({x:E,y:T});const v=d-E,I=p-T,w=Math.sqrt(v*v+I*I),A=v/w,P=I/w,b={id:this.nextMonsterId++,definition:f,x:E,y:T,hp:Math.floor($.BAT_FIXED_HP*this.hpMultiplier),lastDamageTime:0,bouncePhase:Math.random()*Math.PI*2,bounceSpeed:5+Math.random()*3,squashStretch:1,flashStartTime:0,statusEffects:[],isBat:!0,directionX:A,directionY:P};this.monsters.push(b)}}renderMonstersToGrid(C,t){const e=this.gridCellSize,s=this.scene.time.now,a=new Map;this.monsters.forEach(i=>{const n=this.gameBounds.height*i.definition.size,o=i.squashStretch,h=1/i.squashStretch,r=i.x-C,c=i.y-t,l=Math.floor(r/e),d=Math.floor(c/e),p=Math.ceil(n/e/2),f=Math.ceil(p*h),g=Math.ceil(p*o),m=i.definition.color;let M=m>>16&255,S=m>>8&255,E=m&255,T=!1;const y=300;if(i.flashStartTime>0){const R=s-i.flashStartTime;if(R<y){T=!0;const D=Math.floor(R/60)%2,B=R<y/2?1:1-(R-y/2)/(y/2);D===0?(M=Math.min(255,Math.floor(M+(255-M)*B)),S=Math.min(255,Math.floor(S+(255-S)*B)),E=Math.min(255,Math.floor(E+(255-E)*B))):(M=Math.min(255,Math.floor(M+(255-M)*B)),S=Math.floor(S*(1-B*.8)),E=Math.floor(E*(1-B*.8)))}else i.flashStartTime=0}const k=this.isMonsterStunned(i);if(k&&!T){const R=Math.floor((M+S+E)/3);M=Math.floor(R*.7+M*.3),S=Math.floor(R*.7+S*.3),E=Math.floor(R*.7+E*.3),M=Math.min(255,M+60),S=Math.min(255,S+60),E=Math.min(255,E+60)}if(this.isMonsterBurning(i)&&!T&&!k&&(Math.floor(s/100)%2===0?(M=Math.min(255,Math.floor(M*.3+255*.7)),S=Math.min(255,Math.floor(S*.3+102*.7)),E=Math.floor(E*.3)):(M=Math.min(255,Math.floor(M*.6+200*.4)),S=Math.floor(S*.7+60*.3),E=Math.floor(E*.5))),i.isBat){const D=(Math.sin(i.bouncePhase*3)*.5+.5)*.8-.2,B=Math.max(2,Math.ceil(f*.6)),_=Math.max(2,Math.ceil(g*.8)),O=Math.max(3,Math.ceil(f*3)),X=Math.max(2,Math.ceil(g*1.5)),L=(N,U,V,q)=>{if(N>=0&&N<this.screenGridCols&&U>=0&&U<this.screenGridRows){const J=`${N},${U}`,tt=a.get(J);(!tt||q>tt.alpha)&&a.set(J,{color:V,alpha:q})}},H=M<<16|S<<8|E,F=Math.floor(M*.7)<<16|Math.floor(S*.7)<<8|Math.floor(E*.7),z=Math.floor(M*.5)<<16|Math.floor(S*.5)<<8|Math.floor(E*.5);for(let N=-_;N<=_;N++)for(let U=-B;U<=B;U++){const V=U/B,q=N/_;V*V+q*q<=1&&L(l+U,d+N,H,.95)}const Y=Math.max(1,Math.floor(B*.6)),W=Math.max(1,Math.floor(_*.6));for(let N=0;N<=W;N++){const U=Math.max(1,W-N);for(let V=0;V<U;V++)L(l-Y+V,d-_-N-1,H,.9)}for(let N=0;N<=W;N++){const U=Math.max(1,W-N);for(let V=0;V<U;V++)L(l+Y-V,d-_-N-1,H,.9)}for(let N=1;N<=O;N++){const U=N/O,V=Math.floor(X*U*(1-U*.3)),q=Math.floor(D*U*X),J=-V+q,tt=Math.floor(V*.3)+q;for(let Q=J;Q<=tt;Q++){const nt=Math.floor(Math.sin(U*Math.PI*2+i.bouncePhase)*.5),at=.85-U*.3,ct=Q<(J+tt)/2?F:z;L(l-B-N,d+Q+nt,ct,at)}if(N%2===0&&N<O-1){const Q=Math.floor((J+tt)/2+q);L(l-B-N,d+Q,H,.9)}}for(let N=1;N<=O;N++){const U=N/O,V=Math.floor(X*U*(1-U*.3)),q=Math.floor(D*U*X),J=-V+q,tt=Math.floor(V*.3)+q;for(let Q=J;Q<=tt;Q++){const nt=Math.floor(Math.sin(U*Math.PI*2+i.bouncePhase)*.5),at=.85-U*.3,ct=Q<(J+tt)/2?F:z;L(l+B+N,d+Q+nt,ct,at)}if(N%2===0&&N<O-1){const Q=Math.floor((J+tt)/2+q);L(l+B+N,d+Q,H,.9)}}const Z=d-Math.floor(_*.3),et=Math.max(1,Math.floor(B*.4));L(l-et,Z,16711680,1),L(l+et,Z,16711680,1);return}else{for(let R=-g;R<=0;R++)for(let D=-f;D<=f;D++){const B=D/f,_=R/g,O=B*B+_*_;if(O<=1.1){const L=(.5+(1-Math.pow(Math.min(1,O),.5))*.5)*(O<=1?1:(1.1-O)/.1),H=T?1:1+(1-_)*.4,F=Math.min(255,Math.floor(M*H)),z=Math.min(255,Math.floor(S*H)),Y=Math.min(255,Math.floor(E*H)),W=F<<16|z<<8|Y,Z=l+D,et=d+R;if(Z>=0&&Z<this.screenGridCols&&et>=0&&et<this.screenGridRows){const N=`${Z},${et}`,U=a.get(N);(!U||L>U.alpha)&&a.set(N,{color:W,alpha:L})}}}for(let R=-f;R<=f;R++){const D=R/f;if(Math.abs(D)<=1){const B=T?1:.7,_=Math.floor(M*B),O=Math.floor(S*B),X=Math.floor(E*B),L=_<<16|O<<8|X,H=l+R,F=d;if(H>=0&&H<this.screenGridCols&&F>=0&&F<this.screenGridRows){const z=`${H},${F}`;a.set(z,{color:L,alpha:.9})}}}}const I=Math.max(1,Math.floor(f*.35)),w=Math.floor(g*.5),A=l-I,P=l+I,b=d-w;if(A>=0&&A<this.screenGridCols&&b>=0&&b<this.screenGridRows&&a.set(`${A},${b}`,{color:0,alpha:1}),P>=0&&P<this.screenGridCols&&b>=0&&b<this.screenGridRows&&a.set(`${P},${b}`,{color:0,alpha:1}),!T){const R=Math.floor(f*.4),D=Math.floor(g*.7),B=l-R,_=d-D;B>=0&&B<this.screenGridCols&&_>=0&&_<this.screenGridRows&&a.set(`${B},${_}`,{color:16777215,alpha:.8})}});for(const i of this.monsterGridCells){const n=`${i.screenCol},${i.screenRow}`,o=a.get(n);o?(i.rect.setFillStyle(o.color,o.alpha),i.rect.setVisible(!0)):i.rect.setVisible(!1)}}removeMonster(C){const t=this.monsters.findIndex(e=>e.id===C);t!==-1&&this.monsters.splice(t,1)}getMonsters(){return this.monsters}clearAllMonsters(){this.monsters=[]}setSpawnInterval(C){this.spawnInterval=C}setDifficultyMultiplier(C){this.difficultyMultiplier=C}setSpeedMultiplier(C){this.speedMultiplier=C}setHpMultiplier(C){this.hpMultiplier=C}setDamageMultiplier(C){this.damageMultiplier=C}setDebuffResistance(C){this.debuffResistance=C}setWaveBaseCount(C){this.waveBaseCount=C}isDebuffResisted(){return this.debuffResistance<=0?!1:Math.random()<this.debuffResistance}spawnWave(C,t){const e=$.MAX_MONSTERS-this.monsters.length,s=this.waveBaseCount,a=Math.min(s,e),i=s-a;if(this.pendingMonsters+=i,a<=0)return;const n=["top","bottom","left","right"],o=n[Math.floor(Math.random()*n.length)],h=C,r=C+this.gameBounds.width,c=t,l=t+this.gameBounds.height,d=100;for(let p=0;p<a;p++){let f,g;switch(o){case"top":f=h+Math.random()*this.gameBounds.width,g=c-d-Math.random()*50;break;case"bottom":f=h+Math.random()*this.gameBounds.width,g=l+d+Math.random()*50;break;case"left":f=h-d-Math.random()*50,g=c+Math.random()*this.gameBounds.height;break;case"right":f=r+d+Math.random()*50,g=c+Math.random()*this.gameBounds.height;break;default:f=h+Math.random()*this.gameBounds.width,g=c-d}f=Phaser.Math.Clamp(f,0,this.mapWidth),g=Phaser.Math.Clamp(g,0,this.mapHeight);const m=pt[0],M=this.calculateMonsterHp(m.hp),S={id:this.nextMonsterId++,definition:m,x:f,y:g,hp:M,lastDamageTime:0,bouncePhase:Math.random()*Math.PI*2,bounceSpeed:3+Math.random()*2,squashStretch:1,flashStartTime:0,statusEffects:[]};this.monsters.push(S)}}getSpawnInfo(){const C=this.scene.time.now,e=180/Math.max(1,this.monsters.length),s=this.getSpawnMultiplier(C),a=3e3/s,i=Math.max(100,a/e),n=Math.floor($.SPAWN_BASE_COUNT*s*this.difficultyMultiplier);return{spawnMultiplier:s,interval:i,spawnCount:Math.max(1,n)}}damageMonster(C,t){const e=this.monsters.find(s=>s.id===C);if(!e)return{killed:!1,exp:0,isElite:!1,x:0,y:0};if(e.hp-=t,this.flashMonster(e),e.hp<=0){const s=e.isBat?$.BAT_FIXED_EXP:this.calculateMonsterExp(e.definition.exp),a=e.isElite||!1,i=e.isBoss||!1,n=e.x,o=e.y,h=e.definition;return this.playDeathSmoke(e.x,e.y),this.removeMonster(C),this.onMonsterKilledCallback&&this.onMonsterKilledCallback({x:n,y:o,isElite:a,isBoss:i,definition:h,exp:s}),{killed:!0,exp:s,isElite:a,x:n,y:o}}return{killed:!1,exp:0,isElite:!1,x:e.x,y:e.y}}flashMonster(C){C.flashStartTime=this.scene.time.now}playDeathSmoke(C,t){const e=this.scene;e.flashDeathEffect&&e.flashDeathEffect(C,t)}damageMonsters(C,t){let e=0;const s=[];for(const a of C){const i=this.monsters.find(h=>h.id===a),n=i?{x:i.x,y:i.y}:null;this.damageMonster(a,t).killed&&n&&(e++,s.push(n))}return{totalExp:0,killCount:e,killedPositions:s}}applyStatusEffect(C,t){const e=this.scene.time.now;for(const s of C){const a=this.monsters.find(n=>n.id===s);if(!a||this.isDebuffResisted())continue;const i=a.statusEffects.find(n=>n.type===t.type);i?(i.endTime=Math.max(i.endTime,t.endTime),t.damage!==void 0&&(i.damage=t.damage),t.aoeRadius!==void 0&&(i.aoeRadius=t.aoeRadius)):a.statusEffects.push({...t,lastTickTime:e})}}stunMonsters(C,t){const e=this.scene.time.now;this.applyStatusEffect(C,{type:"stun",endTime:e+t})}burnMonsters(C,t,e,s=.1){const a=this.scene.time.now;this.applyStatusEffect(C,{type:"burn",endTime:a+t,damage:e,tickInterval:1e3,aoeRadius:s})}hasStatusEffect(C,t){const e=this.scene.time.now;return C.statusEffects.some(s=>s.type===t&&s.endTime>e)}getStatusEffect(C,t){const e=this.scene.time.now;return C.statusEffects.find(s=>s.type===t&&s.endTime>e)}isMonsterStunned(C){return this.hasStatusEffect(C,"stun")}isMonsterBurning(C){return this.hasStatusEffect(C,"burn")}getMonstersWithStatus(C){return this.monsters.filter(t=>this.hasStatusEffect(t,C))}getBurningMonsters(){return this.getMonstersWithStatus("burn")}clearStatusEffect(C,t){const e=this.monsters.find(s=>s.id===C);e&&(e.statusEffects=e.statusEffects.filter(s=>s.type!==t))}cleanupExpiredEffects(){const C=this.scene.time.now;for(const t of this.monsters)t.statusEffects=t.statusEffects.filter(e=>e.endTime>C)}knockbackMonsters(C,t,e,s){for(const a of C){const i=this.monsters.find(n=>n.id===a);if(i){if(this.isDebuffResisted())continue;const n=i.x-t,o=i.y-e,h=Math.sqrt(n*n+o*o);if(h>0){const r=n/h,c=o/h;i.x+=r*s,i.y+=c*s,i.x=Math.max(0,Math.min(this.mapWidth,i.x)),i.y=Math.max(0,Math.min(this.mapHeight,i.y))}}}}setTauntTarget(C,t,e){this.tauntTarget={x:C,y:t,active:e}}clearTauntTarget(){this.tauntTarget.active=!1}setSlowZone(C,t,e,s){this.slowZone={active:!0,centerX:C,centerY:t,radius:e,multiplier:s}}clearSlowZone(){this.slowZone.active=!1}getSlowMultiplier(C,t){if(!this.slowZone.active)return 1;const e=C-this.slowZone.centerX,s=t-this.slowZone.centerY,a=Math.sqrt(e*e+s*s),i=this.slowZone.radius*this.gameBounds.height*.1;return a<=i?this.slowZone.multiplier:1}getTauntTarget(){return this.tauntTarget}setOnMonsterKilled(C){this.onMonsterKilledCallback=C}};x($,"MAX_MONSTERS",200),x($,"TELEPORT_UNITS",2),x($,"SPAWN_EDGE_UNITS",1),x($,"SPAWN_BASE_COUNT",10),x($,"SPAWN_MULTIPLIER_PHASE1",.3),x($,"SPAWN_MULTIPLIER_PHASE2",.6),x($,"SPAWN_MULTIPLIER_PHASE3",1),x($,"SPAWN_PHASE1_END",2e4),x($,"SPAWN_PHASE2_END",6e4),x($,"BAT_FIXED_HP",10),x($,"BAT_FIXED_EXP",5),x($,"HP_GROWTH_RATE",1.12),x($,"DAMAGE_UNIT",10);let Pt=$;const u=class u extends G.Scene{constructor(){super("MainScene");x(this,"character");x(this,"characterState","idle");x(this,"facingRight",!0);x(this,"skillIcons",[]);x(this,"skillIconGridGraphics",[]);x(this,"skillIconGridData",[]);x(this,"gameBounds");x(this,"boundsBorder");x(this,"background");x(this,"gameAreaContainer");x(this,"revealMask");x(this,"mapWidth");x(this,"mapHeight");x(this,"characterX");x(this,"characterY");x(this,"characterSize");x(this,"isPointerDown",!1);x(this,"moveDirX",0);x(this,"moveDirY",0);x(this,"joystickContainer");x(this,"joystickBase");x(this,"joystickKnob");x(this,"joystickOriginX",0);x(this,"joystickOriginY",0);x(this,"baseMoveSpeed",0);x(this,"moveSpeed",0);x(this,"mapScale",10);x(this,"floorGrid");x(this,"floorRT");x(this,"floorHexContainer");x(this,"floorHexChars",[]);x(this,"floorHexUsedPositions",new Set);x(this,"floorHexPool",[]);x(this,"floorObstacles",[]);x(this,"floorObstacleContainer");x(this,"parallaxBackground");x(this,"edgeWavePulses",[]);x(this,"lastEdgePulseTime",0);x(this,"scanLineX",-1);x(this,"scanLineActive",!1);x(this,"lastScanTime",-25e3);x(this,"circularScanRadius",0);x(this,"circularScanActive",!1);x(this,"lastCircularScanTime",-5e3);x(this,"damageScanRings",[]);x(this,"shieldBreathScan",{phase:"idle",radius:0,targetRadius:0});x(this,"levelUpBreathScan",{phase:"idle",radius:0,targetRadius:0});x(this,"radiusWaves",[]);x(this,"lastRadiusWaveTime",0);x(this,"gameOverActive",!1);x(this,"gameOverSprites",[]);x(this,"gameOverBreathScan",{phase:"idle",radius:0,targetRadius:0});x(this,"worldContainer");x(this,"characterContainer");x(this,"uiContainer");x(this,"cameraOffsetX",0);x(this,"cameraOffsetY",0);x(this,"cursors");x(this,"isKeyboardMoving",!1);x(this,"currentGameMode",u.GAME_MODES[0]);x(this,"modePanelContainer");x(this,"modeCardBgs",[]);x(this,"modeCardContainers",[]);x(this,"modeCardImages",[]);x(this,"selectedModeIndex",0);x(this,"isModeSelecting",!1);x(this,"hasModeSelected",!1);x(this,"skillPanelContainer");x(this,"isPaused",!1);x(this,"popupPaused",!1);x(this,"popupPauseStartTime",0);x(this,"isSkillSelecting",!1);x(this,"pendingSkillPoints",0);x(this,"debugMode",!1);x(this,"debugText");x(this,"debugKey");x(this,"skillOptions",[]);x(this,"keyOne");x(this,"keyTwo");x(this,"keyThree");x(this,"skillCardBgs",[]);x(this,"gameTimer",0);x(this,"totalDamageReceived",0);x(this,"timerText");x(this,"selectedSkillIndex",0);x(this,"currentSkillChoices",[]);x(this,"skillCutInContainer");x(this,"skillManager",new ut);x(this,"skillExecutor");x(this,"soundManager");x(this,"skillIconContainers",[]);x(this,"skillLevelTexts",[]);x(this,"skillIconSprites",[]);x(this,"advancedSkillContainer");x(this,"advancedSkillSlotVisible",!1);x(this,"advancedSkillIconSprite",null);x(this,"advancedSkillLevelText");x(this,"advancedSkillGridGraphics");x(this,"advancedSkillGridData");x(this,"advancedSkillHue",0);x(this,"advancedSkillCooldownTime",0);x(this,"isSelectingAdvancedSkill",!1);x(this,"currentAdvancedSkillChoices",[]);x(this,"mixedSkillTypes",[]);x(this,"mixedNormalIndices",[]);x(this,"mixedAdvancedIndices",[]);x(this,"sawBladeSpinAngle",0);x(this,"sawBladeSprites",[]);x(this,"currentSawBladePositions",[]);x(this,"sawBladeRadius",0);x(this,"perfectPixelLineSprites",[]);x(this,"perfectPixelFocusIndex",0);x(this,"perfectPixelLineAlpha",0);x(this,"zeroTrustActive",!1);x(this,"zeroTrustSprite");x(this,"zeroTrustTrackedMonsters",new Set);x(this,"zeroTrustPoints",[]);x(this,"phantoms",[]);x(this,"nextPhantomId",0);x(this,"skillInfoPanel");x(this,"skillInfoBg");x(this,"skillInfoText");x(this,"skillInfoHideTimer");x(this,"currentExp",0);x(this,"maxExp",100);x(this,"currentLevel",0);x(this,"expBarContainer");x(this,"expBarFlowOffset",0);x(this,"levelText");x(this,"currentHp",200);x(this,"maxHp",200);x(this,"hpBarContainer");x(this,"hpBarFlowOffset",0);x(this,"hpText");x(this,"currentShield",0);x(this,"maxShield",0);x(this,"shieldBarFlowOffset",0);x(this,"shieldReflectDamage",0);x(this,"architectSkillLevel",0);x(this,"shieldText");x(this,"shieldAuraGraphics");x(this,"shieldSparkleTimer",0);x(this,"shieldGroundSprite",null);x(this,"hpRegenTimer",0);x(this,"reviveUsed",!1);x(this,"displayedHp",200);x(this,"hpDamageDelay",0);x(this,"isMobile",!1);x(this,"keyPlus");x(this,"keyMinus");x(this,"keyShift");x(this,"keyCtrl");x(this,"keyZero");x(this,"keyBackspace");x(this,"keyF5");x(this,"keyF6");x(this,"keyF7");x(this,"keyF8");x(this,"keyF9");x(this,"keyF10");x(this,"keyF11");x(this,"keyF12");x(this,"showGridSkillEffects",!1);x(this,"monsterManager");x(this,"isHurt",!1);x(this,"hurtEndTime",0);x(this,"lowHpBreathTimer",0);x(this,"isLowHp",!1);x(this,"vignetteEdgeCells",new Set);x(this,"skillCooldowns",new Map);x(this,"isAttacking",!1);x(this,"attackEndTime",0);x(this,"gameBgm");x(this,"currentBgmKey","");x(this,"gridScaleHandler");x(this,"popupStateHandler");x(this,"suicideHandler");x(this,"restartHandler");x(this,"healingItems",[]);x(this,"nextHealingItemId",0);x(this,"healingItemContainer");x(this,"basePickupRange",2);x(this,"expCrystals",[]);x(this,"nextExpCrystalId",0);x(this,"expCrystalContainer");x(this,"expCrystalPool",[]);x(this,"pendingMergeExp",0);x(this,"skillGridContainer");x(this,"skillGridCells",[]);x(this,"skillGridCols",0);x(this,"skillGridRows",0);x(this,"skillGridCellSize",10);x(this,"gridScaleMultiplier",3);x(this,"activeSkillGridCells",new Set);x(this,"skillEffectPool",[]);x(this,"activeSkillEffects",[]);x(this,"lineEffectPool",[]);x(this,"activeLineEffects",[]);x(this,"circleLineEffectPool",[]);x(this,"activeCircleLineEffects",[])}create(){this.cameras.main.setBackgroundColor("#111111"),this.soundManager=new rt(this),this.isMobile=this.sys.game.device.input.touch&&window.innerWidth<1024,this.gridScaleMultiplier=3;const t=this.cameras.main.width,e=this.cameras.main.height;if(this.gameBounds=this.registry.get("gameBounds"),!this.gameBounds){const r=t*.9,c=e*(1-.05*2),l=16/9,d=r/c;let p,f;d>l?(f=c,p=c*l):(p=r,f=r/l),this.gameBounds={x:(t-p)/2,y:(e-f)/2,width:p,height:f}}const s=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;this.mapScale=s?u.MAP_SCALE_IOS:u.MAP_SCALE_DEFAULT,this.mapWidth=this.gameBounds.width*this.mapScale,this.mapHeight=this.gameBounds.height*this.mapScale,this.skillExecutor=new Ut(this),this.characterSize=this.gameBounds.height*.15,this.baseMoveSpeed=this.gameBounds.height*.3,this.moveSpeed=this.baseMoveSpeed,this.characterX=this.mapWidth/2,this.characterY=this.mapHeight/2,this.createFullscreenBackground(t,e),this.gameAreaContainer=this.add.container(0,0),this.gameAreaContainer.setDepth(0),this.drawGameBorder(),this.worldContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.createParallaxBackground();const a=this.make.graphics({x:0,y:0});a.fillStyle(1710618,1),a.fillRect(0,0,this.mapWidth,this.mapHeight),a.lineStyle(4,16729156,1),a.strokeRect(0,0,this.mapWidth,this.mapHeight),this.floorRT=this.add.renderTexture(0,0,this.mapWidth,this.mapHeight),this.floorRT.setOrigin(0,0),this.floorRT.draw(a,0,0),a.destroy(),this.worldContainer.add(this.floorRT),this.floorGrid=this.add.graphics(),this.floorGrid.setVisible(!1),this.floorHexContainer=this.add.container(0,0),this.worldContainer.add(this.floorHexContainer),this.floorObstacleContainer=this.add.container(0,0),this.worldContainer.add(this.floorObstacleContainer),this.generateFloorObstacles(),this.createCharacterAnimations(),this.characterContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.healingItemContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.healingItemContainer.setDepth(4),this.expCrystalContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.expCrystalContainer.setDepth(3),this.shieldAuraGraphics=this.add.graphics(),this.characterContainer.add(this.shieldAuraGraphics),this.character=this.add.sprite(this.characterX,this.characterY,"char_idle_1"),this.character.setScale(this.characterSize/this.character.height),this.character.setOrigin(.5,1),this.character.play("char_idle"),this.characterContainer.add(this.character),this.gameAreaContainer.add([this.boundsBorder,this.worldContainer]);const i=this.make.graphics({x:0,y:0});i.fillStyle(16777215),i.fillRect(this.gameBounds.x,this.gameBounds.y,this.gameBounds.width,this.gameBounds.height);const n=i.createGeometryMask();this.worldContainer.setMask(n),this.healingItemContainer.setMask(n),this.expCrystalContainer.setMask(n),this.uiContainer=this.add.container(0,0),this.uiContainer.setDepth(100),this.monsterManager=new Pt(this,this.gameBounds,this.mapWidth,this.mapHeight),this.monsterManager.setGridScaleMultiplier(this.gridScaleMultiplier),this.monsterManager.setClipMask(n),this.monsterManager.setOnMonsterKilled(h=>{this.handleMonsterDeath(h)}),this.createSkillGrid(),this.initSkillEffectPool(),this.initLineEffectPool(),this.initCircleLineEffectPool(),this.initExpCrystalPool(),this.gridScaleHandler&&window.removeEventListener("gridscalechange",this.gridScaleHandler),this.popupStateHandler&&window.removeEventListener("popupStateChange",this.popupStateHandler),this.suicideHandler&&window.removeEventListener("playerSuicide",this.suicideHandler),this.restartHandler&&window.removeEventListener("gameRestart",this.restartHandler),this.gridScaleHandler=h=>{this.gridScaleMultiplier=h.detail.scale,this.recreateSkillGrid(),this.monsterManager.setGridScaleMultiplier(h.detail.scale)},window.addEventListener("gridscalechange",this.gridScaleHandler),this.popupStateHandler=h=>{const r=this.popupPaused;if(this.popupPaused=h.detail.open,h.detail.open&&!r)this.popupPauseStartTime=this.time.now;else if(!h.detail.open&&r){const c=this.time.now-this.popupPauseStartTime;c>0&&(this.skillCooldowns.forEach((l,d)=>{this.skillCooldowns.set(d,l+c)}),this.advancedSkillCooldownTime+=c)}},window.addEventListener("popupStateChange",this.popupStateHandler),this.suicideHandler=()=>{this.gameOverActive||this.triggerGameOver()},window.addEventListener("playerSuicide",this.suicideHandler),this.restartHandler=()=>{this.cleanupBeforeRestart(),this.registry.set("skipReveal",!0),this.scene.restart()},window.addEventListener("gameRestart",this.restartHandler),this.characterContainer.setDepth(60),this.characterContainer.setMask(n),this.uiContainer.add(this.characterContainer),this.createSkillBar(),this.revealMask=this.make.graphics({x:0,y:0});const o=this.revealMask.createGeometryMask();this.gameAreaContainer.setMask(o),this.uiContainer.setMask(o),this.registry.events.on("reveal-update",this.updateRevealMask,this),this.registry.events.on("reveal-complete",this.onRevealComplete,this),this.registry.get("skipReveal")&&(this.registry.set("skipReveal",!1),this.time.delayedCall(100,()=>{this.onRevealComplete()})),this.input.on("pointerdown",this.onPointerDown,this),this.input.on("pointermove",this.onPointerMove,this),this.input.on("pointerup",this.onPointerUp,this),this.input.keyboard&&(this.cursors={W:this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.W),A:this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.A),S:this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.S),D:this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.D),UP:this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.UP),DOWN:this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.DOWN),LEFT:this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.LEFT),RIGHT:this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.RIGHT)},this.keyOne=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.ONE),this.keyTwo=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.TWO),this.keyThree=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.THREE),this.keyPlus=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.PLUS),this.keyMinus=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.MINUS),this.keyShift=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.SHIFT),this.keyCtrl=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.CTRL),this.keyZero=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.ZERO),this.keyBackspace=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.BACKSPACE),this.keyF5=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.F5),this.keyF6=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.F6),this.keyF7=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.F7),this.keyF8=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.F8),this.keyF9=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.F9),this.keyF10=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.F10),this.keyF11=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.F11),this.keyF12=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.F12),this.debugKey=this.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.BACKTICK)),this.createDebugDisplay(),this.updateCamera(!0),this.createHpBar(),this.createShieldBar(),this.createExpBar(),this.createModePanel(),this.createSkillPanel(),this.createSkillCutIn(),this.createLowHpVignette(),this.createVirtualJoystick()}createVirtualJoystick(){const t=u.JOYSTICK_RADIUS,e=u.JOYSTICK_KNOB_RADIUS;this.joystickContainer=this.add.container(0,0),this.joystickContainer.setScrollFactor(0),this.joystickContainer.setDepth(1e3),this.joystickContainer.setVisible(!1),this.joystickBase=this.add.graphics(),this.joystickBase.fillStyle(0,.3),this.joystickBase.fillCircle(0,0,t),this.joystickBase.lineStyle(2,16777215,.5),this.joystickBase.strokeCircle(0,0,t),this.joystickContainer.add(this.joystickBase),this.joystickKnob=this.add.graphics(),this.joystickKnob.fillStyle(16777215,.6),this.joystickKnob.fillCircle(0,0,e),this.joystickKnob.lineStyle(2,16777215,.8),this.joystickKnob.strokeCircle(0,0,e),this.joystickContainer.add(this.joystickKnob)}update(t,e){if(this.debugKey&&this.keyCtrl&&G.Input.Keyboard.JustDown(this.debugKey)&&this.keyCtrl.isDown&&this.toggleDebugMode(),this.updateDebugDisplay(),this.isPaused||this.popupPaused){this.updateHpBarFlow(e),this.updateShieldBarFlow(e),this.updateExpBarFlow(e),this.updateShieldAura(e),this.updateLowHpVignetteBreathing(e),this.updateSkillCooldownDisplay(),this.handleModePanelInput(),this.handleSkillPanelInput();return}this.updateHpBarFlow(e),this.updateShieldBarFlow(e),this.updateExpBarFlow(e),this.updateShieldAura(e),this.updateHpRegen(e),this.updateLowHpVignetteBreathing(e),this.updateSkillCooldownDisplay(),this.updateAdvancedSkillCooldown(e),this.updatePhantomVisual(e),this.updateZeroTrustVisual(e),this.updateFloorHexChars(),this.updateBurningMonsters(),this.gameTimer+=e,this.updateTimerDisplay(),this.handleExpTestInput();const s=this.time.now;this.isHurt&&s>=this.hurtEndTime&&(this.isHurt=!1,this.isPointerDown||this.isKeyboardMoving?this.setCharacterState("run"):this.setCharacterState("idle"),this.updateCharacterSprite()),this.isAttacking&&s>=this.attackEndTime&&(this.isAttacking=!1,this.character.clearTint(),this.isPointerDown||this.isKeyboardMoving?this.setCharacterState("run",!0):this.setCharacterState("idle",!0)),this.isHurt||(this.handleKeyboardInput(e),this.isPointerDown&&!this.isKeyboardMoving&&this.moveCharacter(e));const a=this.monsterManager.update(e,this.characterX,this.characterY,this.cameraOffsetX,this.cameraOffsetY);a.damage>0&&this.takeDamage(a.damage,a.hitMonsters),this.updateHealingItems(e),this.updateExpCrystals(e),this.tryActivateSkills(s)}tryActivateSkills(t){if(this.isHurt||this.gameOverActive||this.popupPaused)return;const e=this.skillManager.getPlayerActiveSkills();for(const s of e){if(!s)continue;const a=s.definition;let i=a.cooldown||1e3;a.id==="active_architect"&&(i=i-s.level*500);const n=this.skillManager.calculateFinalCooldown(i),o=this.skillCooldowns.get(a.id)||0;t-o>=n&&(this.activateSkill(s,t),this.skillCooldowns.set(a.id,t))}}activateSkill(t,e){const s=t.definition;switch(this.isAttacking=!0,this.attackEndTime=e+u.ATTACK_DURATION,this.setCharacterState("attack",!0),this.soundManager.playHit("normal",1),s.flashColor&&this.character.setTint(s.flashColor),s.id){case"active_soul_render":this.skillExecutor.activateSoulRender(t);break;case"active_coder":this.skillExecutor.activateCoder(t);break;case"active_vfx":this.skillExecutor.activateVfx(t);break;case"active_architect":this.skillExecutor.activateArchitect(t);break}}drawSectorEdge(t,e,s,a){const i=t-s,n=t+s,o=this.characterX,h=this.characterY,r=500,c=300,l=e,d=24,p=M=>{const S=this.worldToScreen(o,h),E=S.x+Math.cos(M)*(l/2),T=S.y+Math.sin(M)*(l/2),y=this.add.sprite(E,T,u.TEXTURE_LINE);return this.skillGridContainer.add(y),y.setDepth(55),y.setTint(16777215),y.setRotation(M),y.setScale(l/u.EFFECT_TEXTURE_SIZE,d/u.EFFECT_LINE_HEIGHT),y.setAlpha(.9),y},f=p(i),g=p(n);this.tweens.add({targets:[f,g],alpha:0,delay:c,duration:r-c,ease:"Power2",onUpdate:()=>{const M=this.worldToScreen(o,h),S=M.x+Math.cos(i)*(l/2),E=M.y+Math.sin(i)*(l/2),T=M.x+Math.cos(n)*(l/2),y=M.y+Math.sin(n)*(l/2);f.setPosition(S,E),g.setPosition(T,y)},onComplete:()=>{f.destroy(),g.destroy()}});const m=this.time.addEvent({delay:16,callback:()=>{if(!f.active||!g.active)return;const M=this.worldToScreen(o,h),S=M.x+Math.cos(i)*(l/2),E=M.y+Math.sin(i)*(l/2),T=M.x+Math.cos(n)*(l/2),y=M.y+Math.sin(n)*(l/2);f.setPosition(S,E),g.setPosition(T,y)},callbackScope:this,repeat:Math.ceil(c/16)});this.time.delayedCall(r+50,()=>{m.remove(),f.active&&f.destroy(),g.active&&g.destroy()})}drawCircleEdge(t,e,s,a){const i=s??this.characterX,n=a??this.characterY,o=500,h=300,r=this.getCircleLineEffectSprite(),c=t*2/u.EFFECT_TEXTURE_SIZE;r.setScale(c),r.setTint(16777215),r.setAlpha(1),r.setRotation(0);const l=this.time.now,d=Math.PI*2,p=()=>{const g=this.time.now-l,m=Math.min(g/o,1),M=this.worldToScreen(i,n);r.setPosition(M.x,M.y);let S=1;g>h&&(S=1-(g-h)/(o-h)),r.setAlpha(S);let E;if(m<.8)E=m*o/1e3*d;else{const T=.8*o/1e3*d,k=(m-.8)/.2*.2*o/1e3*d*3;E=T+k}r.setRotation(E),m>=1&&this.releaseCircleLineEffectSprite(r)};p();const f=this.time.addEvent({delay:16,callback:p,callbackScope:this,repeat:Math.ceil(o/16)});this.time.delayedCall(o+50,()=>{f.remove(),r.active&&r.visible&&this.releaseCircleLineEffectSprite(r)})}drawBeamEdge(t,e,s,a,i,n){const o=this.add.graphics();this.worldContainer.add(o);const h=i??this.characterX,r=n??this.characterY,c=Math.cos(t),l=Math.sin(t),d=800,p=380,f=this.time.now,g=20,m=()=>{const S=this.time.now-f,E=Math.min(S/d,1);o.clear();let T=0;S>p&&(T=(S-p)/(d-p));const y=.6*(1-T*.5);if(y>.01)for(let k=0;k<g;k++){const v=k/g,I=(k+1)/g,w=(v+I)/2,A=Math.min(1,w/.15),P=Math.min(1,(1-w)/.15),b=Math.min(A,P),R=y*b*b;if(R>.01){const D=h+c*e*v,B=r+l*e*v,_=h+c*e*I,O=r+l*e*I;o.lineStyle(2,16777215,R),o.beginPath(),o.moveTo(D,B),o.lineTo(_,O),o.strokePath()}}E>=1&&o.destroy()};m();const M=this.time.addEvent({delay:16,callback:m,callbackScope:this,repeat:Math.ceil(d/16)});this.time.delayedCall(d+50,()=>{o.active&&o.destroy(),M.remove()})}triggerSoulRenderWave(t,e,s,a,i){const n=this.gameBounds.height*.1,o=n*5,h=e*s*2,r=i.definition.flashColor||i.definition.color,c=this.characterX,l=this.characterY;this.showGridSkillEffects?this.flashSkillAreaSectorMoving(c,l,e,t,s,r,o):this.flashSkillEffectSectorMoving(c,l,e,t,s,r,o);const d=1e3,p=300,f=n*1,g=m=>{const M=e+o*m,S=h/(2*M),E=this.monsterManager.getMonsters(),T=[];for(const y of E){const k=this.gameBounds.height*y.definition.size*.5,v=y.x-c,I=y.y-l,w=Math.sqrt(v*v+I*I);if(Math.abs(w-M)>f+k)continue;let P=Math.atan2(I,v)-t;for(;P>Math.PI;)P-=Math.PI*2;for(;P<-Math.PI;)P+=Math.PI*2;const b=w>0?Math.atan2(k,w):Math.PI;Math.abs(P)<=S+b&&T.push(y.id)}if(T.length>0){const y=E.filter(v=>T.includes(v.id)),k=this.monsterManager.damageMonsters(T,a);k.totalExp>0&&this.addExp(k.totalExp),this.shakeScreen(T.length);for(const v of y){const I=Math.atan2(v.y-l,v.x-c);this.showHitSparkEffect(v.x,v.y,j.SOUL_RENDER,I,3)}}};for(let m=p;m<=d;m+=p){const M=m/d;this.time.delayedCall(m,()=>{g(M)})}}triggerSoulRenderTripleWave(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;let s=e[0],a=1/0;for(const y of e){const k=y.x-this.characterX,v=y.y-this.characterY,I=Math.sqrt(k*k+v*v);I<a&&(a=I,s=y)}const i=Math.atan2(s.y-this.characterY,s.x-this.characterX);this.facingRight=Math.cos(i)>=0,this.updateCharacterSprite();const n=this.gameBounds.height*.1,o=this.gameBounds.height*.3,h=n*10,c=110/2*(Math.PI/180),l=o*c*2,d=t.definition.flashColor||t.definition.color,f=10+this.skillManager.getAdvancedSkillBonusForActiveSkill("active_soul_render"),g=u.DAMAGE_UNIT*f,{damage:m,isCrit:M}=this.skillManager.calculateFinalDamageWithCrit(g,this.currentLevel),S=this.characterX,E=this.characterY,T=[i,i+Math.PI*2/3,i+Math.PI*4/3];for(const y of T){this.showGridSkillEffects?this.flashSkillAreaSectorMoving(S,E,o,y,c,d,h):this.flashSkillEffectSectorMoving(S,E,o,y,c,d,h);const k=1e3,v=100,I=n*1.5,w=o+h,A=new Set,P=b=>{const R=w*b,D=R>0?l/(2*R):Math.PI,B=this.monsterManager.getMonsters(),_=[];for(const O of B){if(A.has(O.id))continue;const X=this.gameBounds.height*O.definition.size*.5,L=O.x-S,H=O.y-E,F=Math.sqrt(L*L+H*H);if(F>R+I+X||F<R-I-X&&R>I)continue;let Y=Math.atan2(H,L)-y;for(;Y>Math.PI;)Y-=Math.PI*2;for(;Y<-Math.PI;)Y+=Math.PI*2;const W=F>0?Math.atan2(X,F):Math.PI;Math.abs(Y)<=D+W&&(_.push(O.id),A.add(O.id))}if(_.length>0){const O=B.filter(L=>_.includes(L.id)),X=this.monsterManager.damageMonsters(_,m);X.totalExp>0&&this.addExp(X.totalExp),this.shakeScreen(_.length);for(const L of O){const H=Math.atan2(L.y-E,L.x-S);this.showHitSparkEffect(L.x,L.y,M?j.SOUL_RENDER_CRIT:j.SOUL_RENDER,H,3)}}};for(let b=0;b<=k;b+=v){const R=b/k;this.time.delayedCall(b,()=>{P(R)})}}}flashSkillAreaSectorMoving(t,e,s,a,i,n,o){const h=this.worldToScreen(t,e),r=h.x,c=h.y,l=u.SKILL_GRID_GAP,d=this.skillGridCellSize+l,p=1e3,f=this.time.now,g=Math.cos(a),m=Math.sin(a),M=s+o+s,S=[],E=Math.max(0,Math.floor((r-M)/d)),T=Math.min(this.skillGridCols-1,Math.ceil((r+M)/d)),y=Math.max(0,Math.floor((c-M)/d)),k=Math.min(this.skillGridRows-1,Math.ceil((c+M)/d));for(let w=y;w<=k;w++)for(let A=E;A<=T;A++){const P=A*d+this.skillGridCellSize/2,b=w*d+this.skillGridCellSize/2;S.push({col:A,row:w,screenX:P,screenY:b})}if(S.length===0)return;const v=[];for(const{col:w,row:A}of S){const P=w*d+this.skillGridCellSize/2,b=A*d+this.skillGridCellSize/2,R=this.add.rectangle(P,b,this.skillGridCellSize,this.skillGridCellSize,n,0);R.setVisible(!1),this.skillGridContainer.add(R),v.push(R)}const I=()=>{const w=this.time.now-f,A=Math.min(w/p,1),P=o*A,b=r+g*P,R=c+m*P,D=.5,B=A>D?(A-D)/(1-D):0;let _=0;for(const{screenX:O,screenY:X}of S){const L=v[_++];if(!L)continue;const H=O-b,F=X-R,z=Math.sqrt(H*H+F*F),Y=s*.5;if(z>=Y&&z<=s){let Z=Math.atan2(F,H)-a;for(;Z>Math.PI;)Z-=Math.PI*2;for(;Z<-Math.PI;)Z+=Math.PI*2;if(Math.abs(Z)<=i){const et=(z-Y)/(s-Y),N=Math.abs(Z)/i,U=Math.max(et,N),V=Math.max(0,Math.min(1,(U-.3)/.7)),q=V*V*(3-2*V),tt=(.15+q*.6)*(1-B);if(tt>.01){const Q=.5+q*.5,nt=n>>16&255,at=n>>8&255,ct=n&255,St=Math.floor(nt*Q),Mt=Math.floor(at*Q),Ct=Math.floor(ct*Q),ot=St<<16|Mt<<8|Ct;L.setFillStyle(ot,tt),L.setVisible(!0)}else L.setVisible(!1)}else L.setVisible(!1)}else L.setVisible(!1)}if(A>=1)for(const O of v)O.destroy();else this.time.delayedCall(16,I)};I()}triggerCoderBurst(t,e,s,a,i){const n=this.monsterManager.getMonsters();if(n.length===0)return;const o=e*.5;for(const h of t){if(Math.random()>=i)continue;const r=[];for(const l of n){const d=this.gameBounds.height*l.definition.size*.5,p=l.x-h.x,f=l.y-h.y;Math.sqrt(p*p+f*f)-d<=o&&r.push(l.id)}this.drawCircleEdge(o,a.definition.color,h.x,h.y);const c=a.definition.flashColor||a.definition.color;if(this.showGridSkillEffects?this.flashSkillAreaCircle(h.x,h.y,o,c):this.flashSkillEffectCircle(h.x,h.y,o,c),r.length>0){n.filter(d=>r.includes(d.id)).map(d=>({x:d.x,y:d.y}));const l=this.monsterManager.damageMonsters(r,s);l.totalExp>0&&this.addExp(l.totalExp)}}}triggerVfxChain(t,e,s,a,i){if(Math.random()>=s)return;const n=this.monsterManager.getMonsters();if(n.length===0)return;const o=this.gameBounds.height*1.5,h=this.gameBounds.height*.5,r=a.definition.flashColor||a.definition.color,c=n.map(f=>{const g=f.x-this.characterX,m=f.y-this.characterY;return{monster:f,dist:Math.sqrt(g*g+m*m)}});c.sort((f,g)=>f.dist-g.dist);const l=Math.min(3,c.length),d=new Set;for(let f=0;f<l;f++){const g=c[f].monster,m=Math.atan2(g.y-this.characterY,g.x-this.characterX);for(const E of n){const T=this.gameBounds.height*E.definition.size*.5,y=E.x-this.characterX,k=E.y-this.characterY;if(Math.sqrt(y*y+k*k)-T>o)continue;const I=Math.cos(m),w=Math.sin(m);if(y*I+k*w<-T)continue;Math.abs(y*w-k*I)<=h/2+T&&d.add(E.id)}this.drawBeamEdge(m,o,h,a.definition.color);const M=this.characterX+Math.cos(m)*o,S=this.characterY+Math.sin(m)*o;this.showGridSkillEffects?this.flashSkillAreaLine(this.characterX,this.characterY,M,S,h,r):this.flashSkillEffectLine(this.characterX,this.characterY,M,S,h,r)}const p=Array.from(d);if(p.length>0){const f=n.filter(m=>d.has(m.id)),g=this.monsterManager.damageMonsters(p,e);g.totalExp>0&&this.addExp(g.totalExp),this.shakeScreen(p.length);for(const m of f){const M=Math.atan2(m.y-this.characterY,m.x-this.characterX);this.showHitSparkEffect(m.x,m.y,i?j.VFX_SNIPE_CRIT:j.VFX_SNIPE,M,5)}}}_drawBeamEffect(t,e,s,a){const i=this.add.graphics();this.worldContainer.add(i);const n=this.characterX,o=this.characterY,h=n+Math.cos(t)*e,r=o+Math.sin(t)*e,c=s*1.5,l=Math.sin(t)*c/2,d=-Math.cos(t)*c/2,p=Math.sin(t)*c*.4/2,f=-Math.cos(t)*c*.4/2,g=15,m=1e3,M=this.time.now,S=()=>{const T=this.time.now-M,y=Math.min(T/m,1);i.clear();const k=.3,v=y<k?0:(y-k)/(1-k);for(let A=0;A<g;A++){const P=A/g,b=(A+1)/g,R=n+(h-n)*P,D=o+(r-o)*P,B=n+(h-n)*b,_=o+(r-o)*b,X=.85*(1-P*.6)*(1-v);X>.01&&(i.fillStyle(a,X),i.beginPath(),i.moveTo(R-l,D-d),i.lineTo(B-l,_-d),i.lineTo(B+l,_+d),i.lineTo(R+l,D+d),i.closePath(),i.fillPath())}for(let A=0;A<g;A++){const P=A/g,b=(A+1)/g,R=n+(h-n)*P,D=o+(r-o)*P,B=n+(h-n)*b,_=o+(r-o)*b,O=.98*(1-P*.5)*(1-v);O>.01&&(i.fillStyle(16777215,O),i.beginPath(),i.moveTo(R-p,D-f),i.lineTo(B-p,_-f),i.lineTo(B+p,_+f),i.lineTo(R+p,D+f),i.closePath(),i.fillPath())}const I=1*(1-v);I>.01&&(i.lineStyle(6,16777215,I),i.beginPath(),i.moveTo(n,o),i.lineTo(h,r),i.strokePath());const w=1*(1-v);w>.01&&(i.lineStyle(4,a,w),i.beginPath(),i.moveTo(n-l,o-d),i.lineTo(h-l,r-d),i.lineTo(h+l,r+d),i.lineTo(n+l,o+d),i.closePath(),i.strokePath(),i.lineStyle(2,16777215,w*.6),i.beginPath(),i.moveTo(n-l*1.1,o-d*1.1),i.lineTo(h-l*1.1,r-d*1.1),i.lineTo(h+l*1.1,r+d*1.1),i.lineTo(n+l*1.1,o+d*1.1),i.closePath(),i.strokePath()),y>=1&&i.destroy()},E=this.time.addEvent({delay:16,callback:S,callbackScope:this,repeat:Math.ceil(m/16)});this.time.delayedCall(m+50,()=>{i.active&&i.destroy(),E.remove()})}_drawCrossStarBurst(t,e){const a=this.gameBounds.height*.1*1,i=600;for(const n of t){const o=this.add.graphics();this.worldContainer.add(o);const h=this.time.now,r=()=>{const l=this.time.now-h,d=Math.min(l/i,1);o.clear();const p=d<.2?d/.2:1,f=d<.4?0:(d-.4)/.6,g=a*p,m=1-f;if(m>.01&&g>0){const M=g*.2,S=g,E=g*.4;o.fillStyle(16777215,m),o.fillCircle(n.x,n.y,E);for(let k=0;k<4;k++){const v=k*Math.PI/2,I=Math.cos(v),w=Math.sin(v),A=-w,P=I,b=6;for(let R=0;R<b;R++){const D=R/b,B=(R+1)/b,_=M*(1-D*.8),O=M*(1-B*.8),X=n.x+I*S*D,L=n.y+w*S*D,H=n.x+I*S*B,F=n.y+w*S*B,z=m*(1-D*.7);o.fillStyle(e,z*.8),o.beginPath(),o.moveTo(X+A*_,L+P*_),o.lineTo(H+A*O,F+P*O),o.lineTo(H-A*O,F-P*O),o.lineTo(X-A*_,L-P*_),o.closePath(),o.fillPath();const Y=_*.5,W=O*.5;o.fillStyle(16777215,z*.9),o.beginPath(),o.moveTo(X+A*Y,L+P*Y),o.lineTo(H+A*W,F+P*W),o.lineTo(H-A*W,F-P*W),o.lineTo(X-A*Y,L-P*Y),o.closePath(),o.fillPath()}}const T=S*.5,y=M*.6;for(let k=0;k<4;k++){const v=k*Math.PI/2+Math.PI/4,I=Math.cos(v),w=Math.sin(v),A=-w,P=I,b=4;for(let R=0;R<b;R++){const D=R/b,B=(R+1)/b,_=y*(1-D*.9),O=y*(1-B*.9),X=n.x+I*T*D,L=n.y+w*T*D,H=n.x+I*T*B,F=n.y+w*T*B,z=m*(1-D*.8)*.7;o.fillStyle(e,z),o.beginPath(),o.moveTo(X+A*_,L+P*_),o.lineTo(H+A*O,F+P*O),o.lineTo(H-A*O,F-P*O),o.lineTo(X-A*_,L-P*_),o.closePath(),o.fillPath()}}}d>=1&&o.destroy()};r();const c=this.time.addEvent({delay:16,callback:r,callbackScope:this,repeat:Math.ceil(i/16)});this.time.delayedCall(i+50,()=>{o.active&&o.destroy(),c.remove()})}}triggerShieldExplosion(t){const s=this.gameBounds.height*.1*4,a=t.definition.flashColor||t.definition.color,i=this.currentShield*10;this.flashOctagonShieldExplosion(this.characterX,this.characterY,s,a);const n=this.monsterManager.getMonsters(),o=[];for(const h of n){const r=this.gameBounds.height*h.definition.size*.5,c=h.x-this.characterX,l=h.y-this.characterY;Math.sqrt(c*c+l*l)-r<=s&&o.push(h.id)}if(o.length>0){const h=n.filter(l=>o.includes(l.id)),r=this.monsterManager.damageMonsters(o,i);r.totalExp>0&&this.addExp(r.totalExp);const c=this.gameBounds.height*.1;this.monsterManager.knockbackMonsters(o,this.characterX,this.characterY,c),this.shakeScreen(o.length);for(const l of h)this.showHitSparkEffect(l.x,l.y,j.SAWBLADE)}}handleExpTestInput(){if(!(!this.keyPlus||!this.keyMinus||!this.keyShift)){if(this.keyShift.isDown&&G.Input.Keyboard.JustDown(this.keyBackspace)){this.showGridSkillEffects=!this.showGridSkillEffects;return}if(this.keyShift.isDown&&G.Input.Keyboard.JustDown(this.keyZero)){this.maxOutAllSkills();return}if(this.keyCtrl.isDown&&this.keyShift.isDown){const t=[{key:this.keyF5,skillId:"active_soul_render"},{key:this.keyF6,skillId:"active_coder"},{key:this.keyF7,skillId:"active_vfx"},{key:this.keyF8,skillId:"active_architect"},{key:this.keyF9,skillId:"passive_titanium_liver"},{key:this.keyF10,skillId:"passive_sync_rate"},{key:this.keyF11,skillId:"passive_retina_module"},{key:this.keyF12,skillId:"passive_ai_enhancement"}];for(const{key:e,skillId:s}of t)if(e&&G.Input.Keyboard.JustDown(e)){this.maxOutSingleSkill(s);return}}if(this.keyShift.isDown&&G.Input.Keyboard.JustDown(this.keyPlus)){this.levelUp();return}this.keyPlus.isDown&&!this.keyShift.isDown&&this.addExp(10),this.keyMinus.isDown&&this.addExp(-10)}}maxOutSingleSkill(t){const e=Et.find(o=>o.id===t);if(!e)return;const s=this.skillManager.getSkillLevel(t),a=e.type==="passive";if(s>=e.maxLevel||a&&s<0&&this.skillManager.isPassiveSlotsFull())return;const i=s<0?-1:s,n=e.maxLevel-i;this.currentLevel+=n,this.monsterManager.setPlayerLevel(this.currentLevel);for(let o=0;o<n;o++)this.skillManager.learnOrUpgradeSkill(t);this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(u.BASE_EXP*Math.pow(u.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay()}maxOutAllSkills(){this.currentLevel=24;const e=this.skillManager.getActiveSkillDefinitions();for(const s of e)for(let a=0;a<=s.maxLevel;a++)this.skillManager.learnOrUpgradeSkill(s.id);this.monsterManager.setPlayerLevel(this.currentLevel),this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(u.BASE_EXP*Math.pow(u.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay()}addExp(t){t>0&&(t=this.skillManager.calculateFinalExp(t)),this.currentExp+=t,this.currentExp<0&&(this.currentExp=0),this.currentExp>=this.maxExp&&this.levelUp(),this.drawExpBarFill()}levelUp(){this.currentLevel++,this.currentExp=0,this.maxExp=Math.floor(u.BASE_EXP*Math.pow(u.EXP_GROWTH_RATE,this.currentLevel)),this.recalculateMaxHp(),this.displayedHp=this.currentHp,this.monsterManager.setPlayerLevel(this.currentLevel)&&this.monsterManager.spawnElite(this.cameraOffsetX,this.cameraOffsetY),this.levelText.setText(`Lv.${this.currentLevel}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.pendingSkillPoints++,this.tryShowSkillPanel(),this.drawExpBarFill(),this.triggerLevelUpBreathScan()}recalculateMaxHp(){const t=u.BASE_HP+u.HP_PER_LEVEL*this.currentLevel,e=this.maxHp;if(this.maxHp=this.skillManager.calculateFinalMaxHp(t),this.maxHp>e&&e>0){const s=this.maxHp-e;this.currentHp+=s}this.currentHp=Math.min(this.currentHp,this.maxHp)}recalculateMoveSpeed(){this.moveSpeed=this.skillManager.calculateFinalMoveSpeed(this.baseMoveSpeed)}handleSkillPanelInput(){if(!this.keyOne||this.popupPaused)return;let t;this.mixedSkillTypes.length>0?t=this.mixedSkillTypes.length:this.isSelectingAdvancedSkill?t=this.currentAdvancedSkillChoices.length:t=this.currentSkillChoices.length,t===1?G.Input.Keyboard.JustDown(this.keyTwo)&&(this.selectedSkillIndex===0?this.confirmSkillSelection():this.setSelectedSkill(0)):t===2?(G.Input.Keyboard.JustDown(this.keyOne)&&(this.selectedSkillIndex===0?this.confirmSkillSelection():this.setSelectedSkill(0)),G.Input.Keyboard.JustDown(this.keyThree)&&(this.selectedSkillIndex===1?this.confirmSkillSelection():this.setSelectedSkill(1))):(G.Input.Keyboard.JustDown(this.keyOne)&&(this.selectedSkillIndex===0?this.confirmSkillSelection():this.setSelectedSkill(0)),G.Input.Keyboard.JustDown(this.keyTwo)&&(this.selectedSkillIndex===1?this.confirmSkillSelection():this.setSelectedSkill(1)),G.Input.Keyboard.JustDown(this.keyThree)&&(this.selectedSkillIndex===2?this.confirmSkillSelection():this.setSelectedSkill(2)))}setSelectedSkill(t){this.popupPaused||(this.updateSkillCardStyle(this.selectedSkillIndex,!1),this.selectedSkillIndex=t,this.updateSkillCardStyle(this.selectedSkillIndex,!0))}updateSkillCardStyle(t,e){const s=this.skillCardBgs[t],a=this.skillOptions[t];!s||!a||(e?(s.setFillStyle(3355443),s.setStrokeStyle(3,16777215),this.tweens.add({targets:a,scaleX:1.05,scaleY:1.05,duration:100})):(s.setFillStyle(2236962),s.setStrokeStyle(2,6710886),this.tweens.add({targets:a,scaleX:1,scaleY:1,duration:100})))}confirmSkillSelection(){if(this.popupPaused)return;if(this.mixedSkillTypes.length>0){this.confirmMixedSkillSelection();return}if(this.isSkillSelecting)return;if(this.isSkillSelecting=!0,this.isSelectingAdvancedSkill){if(this.currentAdvancedSkillChoices.length===0||this.selectedSkillIndex>=this.currentAdvancedSkillChoices.length)return;const e=this.currentAdvancedSkillChoices[this.selectedSkillIndex];this.selectAdvancedSkill(this.selectedSkillIndex,e.id);return}if(this.currentSkillChoices.length===0||this.selectedSkillIndex>=this.currentSkillChoices.length)return;const t=this.currentSkillChoices[this.selectedSkillIndex];this.selectSkill(this.selectedSkillIndex,t.id)}handleKeyboardInput(t){if(!this.cursors||this.gameOverActive||this.popupPaused)return;let e=0,s=0;if((this.cursors.W.isDown||this.cursors.UP.isDown)&&(s=-1),(this.cursors.S.isDown||this.cursors.DOWN.isDown)&&(s=1),(this.cursors.A.isDown||this.cursors.LEFT.isDown)&&(e=-1),(this.cursors.D.isDown||this.cursors.RIGHT.isDown)&&(e=1),e!==0||s!==0){if(this.isKeyboardMoving=!0,this.isPointerDown=!1,e!==0&&(this.facingRight=e>0),e!==0&&s!==0){const h=1/Math.sqrt(2);e*=h,s*=h}const a=this.moveSpeed*t/1e3;let i=this.characterX+e*a,n=this.characterY+s*a;i=G.Math.Clamp(i,this.characterSize,this.mapWidth-this.characterSize),n=G.Math.Clamp(n,this.characterSize,this.mapHeight-this.characterSize);const o=this.characterSize*.15;if(!this.checkObstacleCollision(i,n,o))this.characterX=i,this.characterY=n;else{const h=G.Math.Clamp(this.characterX+e*a,this.characterSize,this.mapWidth-this.characterSize);if(!this.checkObstacleCollision(h,this.characterY,o))this.characterX=h;else{const r=G.Math.Clamp(this.characterY+s*a,this.characterSize,this.mapHeight-this.characterSize);this.checkObstacleCollision(this.characterX,r,o)||(this.characterY=r)}}this.setCharacterState("run"),this.updateCharacterSprite(),this.updateCamera()}else this.isKeyboardMoving=!1,this.isPointerDown||(this.setCharacterState("idle"),this.updateCharacterSprite())}onPointerDown(t){this.isPaused||this.gameOverActive||this.popupPaused||this.isPointerInGameArea(t)&&(this.isPointerDown=!0,this.joystickOriginX=t.x,this.joystickOriginY=t.y,this.joystickContainer.setPosition(t.x,t.y),this.joystickKnob.setPosition(0,0),this.joystickContainer.setVisible(!0),this.moveDirX=0,this.moveDirY=0)}onPointerMove(t){if(!this.isPointerDown||this.isPaused||this.popupPaused)return;const e=t.x-this.joystickOriginX,s=t.y-this.joystickOriginY,a=Math.sqrt(e*e+s*s),i=u.JOYSTICK_RADIUS;if(a>0){this.moveDirX=e/a,this.moveDirY=s/a,Math.abs(e)>5&&(this.facingRight=e>0);const n=Math.min(a,i),o=this.moveDirX*n,h=this.moveDirY*n;this.joystickKnob.setPosition(o,h)}else this.moveDirX=0,this.moveDirY=0,this.joystickKnob.setPosition(0,0)}onPointerUp(){this.isPointerDown=!1,this.joystickContainer.setVisible(!1),this.moveDirX=0,this.moveDirY=0,this.isKeyboardMoving||(this.setCharacterState("idle"),this.updateCharacterSprite())}isPointerInGameArea(t){return t.x>=this.gameBounds.x&&t.x<=this.gameBounds.x+this.gameBounds.width&&t.y>=this.gameBounds.y&&t.y<=this.gameBounds.y+this.gameBounds.height}moveCharacter(t){const e=this.moveSpeed*t/1e3;let s=this.characterX+this.moveDirX*e,a=this.characterY+this.moveDirY*e;s=G.Math.Clamp(s,this.characterSize,this.mapWidth-this.characterSize),a=G.Math.Clamp(a,this.characterSize,this.mapHeight-this.characterSize);const i=this.characterSize*.15;if(!this.checkObstacleCollision(s,a,i))this.characterX=s,this.characterY=a;else{const n=G.Math.Clamp(this.characterX+this.moveDirX*e,this.characterSize,this.mapWidth-this.characterSize);if(!this.checkObstacleCollision(n,this.characterY,i))this.characterX=n;else{const o=G.Math.Clamp(this.characterY+this.moveDirY*e,this.characterSize,this.mapHeight-this.characterSize);this.checkObstacleCollision(this.characterX,o,i)||(this.characterY=o)}}this.moveDirX!==0&&this.updateCharacterFacing(this.characterX+this.moveDirX),this.setCharacterState("run"),this.updateCharacterSprite(),this.updateCamera()}updateCamera(t=!1){const e=this.cameraOffsetX+this.gameBounds.width/2,s=this.cameraOffsetY+this.gameBounds.height/2,a=this.characterX-e,i=this.characterY-s,n=this.gameBounds.width*u.CAMERA_DEAD_ZONE,o=this.gameBounds.height*u.CAMERA_DEAD_ZONE;t?(this.cameraOffsetX=this.characterX-this.gameBounds.width/2,this.cameraOffsetY=this.characterY-this.gameBounds.height/2):(Math.abs(a)>n/2&&(a>0?this.cameraOffsetX+=a-n/2:this.cameraOffsetX+=a+n/2),Math.abs(i)>o/2&&(i>0?this.cameraOffsetY+=i-o/2:this.cameraOffsetY+=i+o/2)),this.cameraOffsetX=G.Math.Clamp(this.cameraOffsetX,0,this.mapWidth-this.gameBounds.width),this.cameraOffsetY=G.Math.Clamp(this.cameraOffsetY,0,this.mapHeight-this.gameBounds.height),this.worldContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY),this.characterContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY),this.healingItemContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY),this.expCrystalContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY),this.updateParallaxBackground()}updateRevealMask(t){this.revealMask&&(this.revealMask.clear(),this.revealMask.fillStyle(16777215),this.revealMask.fillCircle(t.x,t.y,t.radius))}onRevealComplete(){this.gameAreaContainer.clearMask(!0),this.uiContainer.clearMask(!0),this.revealMask.destroy(),this.registry.events.off("reveal-update",this.updateRevealMask,this),this.registry.events.off("reveal-complete",this.onRevealComplete,this);const t=document.getElementById("controls");t&&t.classList.add("visible");const e=document.getElementById("left-controls");e&&e.classList.add("visible"),this.showModePanel(),this.playRandomGameBgm()}playRandomGameBgm(){const t=["bgm_game_01","bgm_game_02"];let e;if(this.currentBgmKey&&t.length>1){const s=t.filter(a=>a!==this.currentBgmKey);e=s[Math.floor(Math.random()*s.length)]}else e=t[Math.floor(Math.random()*t.length)];this.currentBgmKey=e,this.gameBgm&&(this.gameBgm.stop(),this.gameBgm.destroy()),this.cache.audio.exists(e)&&(this.gameBgm=this.sound.add(e,{volume:.5,loop:!1}),this.gameBgm.on("complete",()=>{this.playRandomGameBgm()}),this.gameBgm.play())}createFullscreenBackground(t,e){this.background=this.add.image(t/2,e/2,"background");const s=t/this.background.width,a=e/this.background.height,i=Math.max(s,a);this.background.setScale(i)}drawGameBorder(){this.boundsBorder=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0),this.boundsBorder.setStrokeStyle(2,4473924)}createDebugDisplay(){const t=Math.max(12,Math.floor(this.gameBounds.height*.02));this.debugText=this.add.text(this.gameBounds.x+10,this.gameBounds.y+this.gameBounds.height-10,"",{fontFamily:"monospace",fontSize:`${t}px`,color:"#00ff00",backgroundColor:"rgba(0, 0, 0, 0.7)",padding:{x:6,y:4}}),this.debugText.setOrigin(0,1),this.debugText.setDepth(9999),this.debugText.setVisible(!1)}updateDebugDisplay(){if(!this.debugMode||!this.debugText)return;const t=Math.round(this.game.loop.actualFps),e=this.monsterManager?this.monsterManager.getMonsters().length:0,s=`(${Math.round(this.characterX)}, ${Math.round(this.characterY)})`,a=`(${Math.round(this.cameraOffsetX)}, ${Math.round(this.cameraOffsetY)})`,i=Math.floor(this.gameTimer/1e3),n=Math.floor(i/60),o=i%60,h=this.monsterManager?this.monsterManager.getSpawnInfo():null,r=i<20?"階段1 (0-20s)":i<60?"階段2 (20-60s)":"階段3 (60s+)",c=[`FPS: ${t}`,`遊戲時間: ${n}:${String(o).padStart(2,"0")}`,"--- 難度資訊 ---",`遊戲模式: ${this.currentGameMode.name} (怪物x${this.currentGameMode.multiplier}, 經驗x${this.currentGameMode.expMultiplier})`,`生怪階段: ${r}`,`時間倍率: ${h?h.spawnMultiplier.toFixed(1):"-"}`,`生怪間隔: ${h?(h.interval/1e3).toFixed(2):"-"}s`,`每次生成: ${h?h.spawnCount:"-"} 隻`,"--- 狀態資訊 ---",`怪物數量: ${e} / 200`,`經驗水晶: ${this.expCrystals.length} / 200`,`待合併經驗: ${this.pendingMergeExp}`,`等級: ${this.currentLevel}`,`HP: ${Math.round(this.currentHp)} / ${Math.round(this.maxHp)}`,`護盾: ${Math.round(this.currentShield)} / ${Math.round(this.maxShield)}`,`待分配點數: ${this.pendingSkillPoints}`,"--- 位置資訊 ---",`玩家位置: ${s}`,`鏡頭位置: ${a}`].join(`
`);this.debugText.setText(c)}toggleDebugMode(){this.debugMode=!this.debugMode,this.debugText&&this.debugText.setVisible(this.debugMode)}createHpBar(){this.hpBarContainer=this.add.container(0,0),this.hpBarContainer.setDepth(1001);const t=this.skillGridCellSize,e=this.gameBounds.y+t*2,s=Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(this.gameBounds.height*.03));this.hpText=this.add.text(this.gameBounds.x+this.gameBounds.width/2,e+t/2,`${this.currentHp} / ${this.maxHp}`,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${s}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:4}),this.hpText.setResolution(2),this.hpText.setOrigin(.5,.5),this.hpText.setDepth(1002),this.hpBarContainer.add(this.hpText),this.drawHpBarFill(),this.uiContainer.add(this.hpBarContainer)}drawHpBarFill(){const t=[1,2,3],e=[1,2],s=this.skillGridCols-2,a=this.currentHp/this.maxHp,i=Math.floor(s*a),n=this.displayedHp/this.maxHp,o=Math.floor(s*n);for(const h of t)for(let r=0;r<s;r++){const c=r+1,l=h*this.skillGridCols+c,d=this.skillGridCells[l];d&&(d.setFillStyle(0,.9),d.setVisible(!0),d.setDepth(1e3))}if(o>i)for(const h of t)for(let r=i;r<o;r++){const c=r+1,l=h*this.skillGridCols+c,d=this.skillGridCells[l];if(!d)continue;const p=t.indexOf(h),f=p===0?.85:p===1?.75:.65;d.setFillStyle(16777215,f)}if(i>0)for(const h of t)for(let r=0;r<i;r++){const c=r+1,l=h*this.skillGridCols+c,d=this.skillGridCells[l];if(!d)continue;const p=r/s,f=this.hpBarFlowOffset,g=(p+f)%1,m=(Math.sin(g*Math.PI*2-Math.PI/2)+1)/2,M=Math.floor(136-34*m),S=0,E=Math.floor(34+102*m),T=M<<16|S<<8|E,y=t.indexOf(h),k=y===0?.95:y===1?.85:.75;d.setFillStyle(T,k)}if(this.currentShield>0&&this.maxShield>0){const h=this.currentShield/this.maxShield,r=Math.floor(s*h);for(const c of e)for(let l=0;l<s;l++){const d=l+1,p=c*this.skillGridCols+d,f=this.skillGridCells[p];if(f&&l<r){const g=l/s,m=this.shieldBarFlowOffset,M=(g+m)%1,S=(Math.sin(M*Math.PI*2-Math.PI/2)+1)/2,E=255,T=Math.floor(204+51*S),y=Math.floor(0+204*S),k=E<<16|T<<8|y,v=c===e[0]?.95:.8;f.setFillStyle(k,v)}}}}updateHpBarFlow(t){this.hpBarFlowOffset+=.2*t/1e3,this.hpBarFlowOffset>=1&&(this.hpBarFlowOffset-=1),this.updateDamageDisplay(t),this.drawHpBarFill()}updateDamageDisplay(t){if(this.displayedHp>this.currentHp)if(this.hpDamageDelay>0)this.hpDamageDelay-=t;else{const s=(this.displayedHp-this.currentHp)*u.HP_DAMAGE_LERP_SPEED*(t/1e3);this.displayedHp-=Math.max(1,s),this.displayedHp<this.currentHp&&(this.displayedHp=this.currentHp)}else this.displayedHp<this.currentHp&&(this.displayedHp=this.currentHp)}updateHpText(){this.hpText&&(this.currentShield>0?this.hpText.setText(`${this.currentHp}+${this.currentShield}/${this.maxHp}`):this.hpText.setText(`${this.currentHp}/${this.maxHp}`))}createShieldBar(){const t=this.skillGridCellSize,e=this.gameBounds.y+t*2,s=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.025));this.shieldText=this.add.text(this.gameBounds.x+this.gameBounds.width-10,e+t/2,"",{fontFamily:"monospace",fontSize:`${s}px`,color:"#ffdd44",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.shieldText.setOrigin(1,.5),this.shieldText.setDepth(1002),this.shieldText.setVisible(!1),this.uiContainer.add(this.shieldText)}drawShieldBarFill(){this.shieldText.setVisible(!1),this.updateHpText()}updateShieldBarFlow(t){if(this.currentShield<=0)return;const e=.6;this.shieldBarFlowOffset+=e*t/1e3,this.shieldBarFlowOffset>=1&&(this.shieldBarFlowOffset-=1),this.drawShieldBarFill()}updateShieldAura(t){if(this.shieldAuraGraphics.clear(),this.currentShield<=0){this.shieldGroundSprite&&this.shieldGroundSprite.visible&&this.shieldGroundSprite.setVisible(!1);return}const e=this.characterX,s=this.characterY,a=this.characterSize*.8,i=this.characterSize*.35,n=s-this.characterSize*.15;this.shieldGroundSprite||(this.shieldGroundSprite=this.add.sprite(0,0,u.TEXTURE_SECTOR_360),this.skillGridContainer.add(this.shieldGroundSprite),this.shieldGroundSprite.setDepth(55));const o=this.worldToScreen(e,n);this.shieldGroundSprite.setPosition(o.x,o.y);const h=a*1/u.EFFECT_TEXTURE_SIZE,r=h*.35;this.shieldGroundSprite.setScale(h,r),this.shieldGroundSprite.setTint(16768324),this.shieldGroundSprite.setAlpha(.5),this.shieldGroundSprite.setVisible(!0),this.shieldSparkleTimer+=t;const c=80;this.shieldSparkleTimer>=c&&(this.shieldSparkleTimer-=c,this.createShieldSparkle(e,n,a,i))}createShieldSparkle(t,e,s,a){const i=Math.random()*Math.PI*2,n=t+Math.cos(i)*(s/2),o=e+Math.sin(i)*(a/2),h=this.worldToScreen(n,o),r=this.getLineEffectSprite();if(!r)return;const c=this.gameBounds.height/10,l=c*.2,d=c*.6,p=24+Math.random()*16,f=c*1.2,g=700+Math.random()*300;r.setPosition(h.x,h.y),r.setRotation(-Math.PI/2+(Math.random()-.5)*.4),r.setScale(l/u.EFFECT_TEXTURE_SIZE,p/u.EFFECT_LINE_HEIGHT),r.setTint(16768324),r.setAlpha(.85),r.setDepth(150),this.tweens.add({targets:r,y:h.y-f,scaleX:d/u.EFFECT_TEXTURE_SIZE,scaleY:p*.5/u.EFFECT_LINE_HEIGHT,alpha:0,duration:g,ease:"Quad.easeOut",onComplete:()=>{this.releaseLineEffectSprite(r)}})}updateHpRegen(t){const e=this.skillManager.getTitaniumLiverRegenInterval();if(!(e<=0)){if(this.currentHp>=this.maxHp){this.hpRegenTimer=0;return}if(this.hpRegenTimer+=t,this.hpRegenTimer>=e){this.hpRegenTimer-=e;const s=Math.max(1,Math.floor(this.maxHp*.01));this.currentHp=Math.min(this.currentHp+s,this.maxHp),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showHpHealEffect(s)}}}showHpHealEffect(t){for(let s=0;s<12;s++)this.time.delayedCall(s*30,()=>{this.createHpHealSparkle()})}createHpHealSparkle(){const t=this.characterX,e=this.characterY,s=this.characterSize*.8,a=this.characterSize*.35,i=e-this.characterSize*.15,n=Math.random()*Math.PI*2,o=t+Math.cos(n)*(s/2),h=i+Math.sin(n)*(a/2),r=this.worldToScreen(o,h),c=this.getLineEffectSprite();if(!c)return;const l=this.gameBounds.height/10,d=l*.2,p=l*.6,f=24+Math.random()*16,g=l*1.2,m=700+Math.random()*300,M=[11176191,12294655,13408767,10070783],S=M[Math.floor(Math.random()*M.length)];c.setPosition(r.x,r.y),c.setRotation(-Math.PI/2+(Math.random()-.5)*.4),c.setScale(d/u.EFFECT_TEXTURE_SIZE,f/u.EFFECT_LINE_HEIGHT),c.setTint(S),c.setAlpha(.9),c.setDepth(150),this.tweens.add({targets:c,y:r.y-g,scaleX:p/u.EFFECT_TEXTURE_SIZE,alpha:0,duration:m,ease:"Quad.easeOut",onComplete:()=>{this.releaseLineEffectSprite(c)}})}takeDamage(t,e=[]){var o;const s=this.skillManager.getSyncRateDodgeChance(this.currentLevel);if(s>0&&Math.random()<s){this.flashDodgeEffect();return}let i=this.skillManager.calculateFinalDamageTaken(t),n=0;if(this.currentShield>0&&(this.currentShield>0,this.currentShield>=i?(n=i,this.currentShield-=i,i=0):(n=this.currentShield,i-=this.currentShield,this.currentShield=0),this.drawShieldBarFill(),n>0&&this.showGridSkillEffects&&this.flashShieldHitEffect(),this.shieldReflectDamage>0&&e.length>0)){const h=e.map(c=>c.id),r=this.monsterManager.damageMonsters(h,this.shieldReflectDamage);if(r.totalExp>0&&this.addExp(r.totalExp),this.architectSkillLevel>=5){const c=this.gameBounds.height*.1;this.monsterManager.knockbackMonsters(h,this.characterX,this.characterY,c)}}if(i>0&&(this.currentHp-=i,this.totalDamageReceived+=i,this.currentHp<0&&(this.currentHp=0),this.hpDamageDelay=u.HP_DAMAGE_DELAY,this.drawHpBarFill(),this.updateHpText(),this.isHurt=!0,this.hurtEndTime=this.time.now+u.HURT_DURATION,this.setCharacterState("hurt"),this.updateCharacterSprite(),this.flashCharacter(),this.triggerDamageScan(),this.updateLowHpVignette()),this.currentHp<=0)if(!this.reviveUsed&&this.skillManager.hasTitaniumLiverRevive()){this.reviveUsed=!0,this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.triggerShadowExplosion(),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.flashReviveEffect();const h=this.skillManager.getPlayerSkill("passive_titanium_liver");(o=h==null?void 0:h.definition.maxExtraAbility)!=null&&o.triggerQuote&&this.showTriggerCutIn(h.definition,"【不死】觸發",h.definition.maxExtraAbility.triggerQuote)}else this.triggerGameOver()}triggerGameOver(){if(this.gameOverActive)return;this.monsterManager.stopSpawning(),this.character.setVisible(!1),this.monsterManager.hideAllMonsters(),this.uiContainer.setVisible(!1),this.skillCooldowns.clear(),this.showGameOver(),this.startGameOverBreathScan();const t=Math.floor(this.gameTimer/6e4),e=Math.floor(this.gameTimer%6e4/1e3),s=`${String(t).padStart(2,"0")}:${String(e).padStart(2,"0")}`,a=Math.floor(this.currentExp/this.maxExp*100),i=this.currentLevel+a/100;this.time.delayedCall(2e3,()=>{window.dispatchEvent(new CustomEvent("playerDeath",{detail:{survivalTime:s,level:i,totalDamage:Math.floor(this.totalDamageReceived),difficulty:this.currentGameMode.id}}))})}startGameOverBreathScan(){this.triggerGameOverBreathScan(),this.time.addEvent({delay:5e3,callback:()=>this.triggerGameOverBreathScan(),loop:!0})}triggerGameOverBreathScan(){this.gameOverActive&&(this.gameOverBreathScan={phase:"expand",radius:0,targetRadius:this.gameBounds.height*.5})}flashShieldHitEffect(){const t=this.worldToScreen(this.characterX,this.characterY),e=t.x,s=t.y,a=u.SKILL_GRID_GAP,i=this.skillGridCellSize+a,n=16763904,o=this.gameBounds.height*.2,h=400,r=200,c=this.time.now,l=[],d=Math.max(0,Math.floor((e-o)/i)),p=Math.min(this.skillGridCols-1,Math.ceil((e+o)/i)),f=Math.max(0,Math.floor((s-o)/i)),g=Math.min(this.skillGridRows-1,Math.ceil((s+o)/i));for(let E=f;E<=g;E++)for(let T=d;T<=p;T++){const y=T*i+this.skillGridCellSize/2,k=E*i+this.skillGridCellSize/2,v=y-e,I=k-s,w=Math.sqrt(v*v+I*I);w<=o&&l.push({col:T,row:E,dist:w})}if(l.length===0)return;const m=[];for(const{col:E,row:T}of l){const y=E*i+this.skillGridCellSize/2,k=T*i+this.skillGridCellSize/2,v=this.add.rectangle(y,k,this.skillGridCellSize,this.skillGridCellSize,n,0);v.setVisible(!1),this.skillGridContainer.add(v),m.push(v)}const M=()=>{const E=this.time.now-c,T=Math.min(E/h,1),y=Math.min(E/r,1),k=o*y,v=o*.3,I=Math.max(0,k-v);let w=0;E>r&&(w=(E-r)/(h-r));let A=0;for(const{dist:P}of l){const b=m[A++];if(b)if(P>=I&&P<=k){const R=(I+k)/2,D=Math.abs(P-R),B=v/2,_=D/B,X=.9*(1-_*.5)*(1-w);if(X>.01){if(E<r&&_<.3){const L=n>>16&255,H=n>>8&255,F=n&255,z=Math.min(255,L+Math.floor((255-L)*.5)),Y=Math.min(255,H+Math.floor((255-H)*.5)),W=Math.min(255,F+Math.floor((255-F)*.5)),Z=z<<16|Y<<8|W;b.setFillStyle(Z,X)}else b.setFillStyle(n,X);b.setVisible(!0)}else b.setVisible(!1)}else b.setVisible(!1)}if(T>=1)for(const P of m)P.destroy()};M();const S=this.time.addEvent({delay:16,callback:M,callbackScope:this,repeat:Math.ceil(h/16)});this.time.delayedCall(h+50,()=>{S.remove();for(const E of m)E.active&&E.destroy()})}flashCharacter(){this.character.setTint(16777215),this.time.delayedCall(50,()=>{this.character.setTint(16724787)}),this.time.delayedCall(100,()=>{this.character.setTint(16777215)}),this.time.delayedCall(150,()=>{this.character.clearTint()})}flashDodgeEffect(){this.character.setTint(6737151),this.time.delayedCall(50,()=>{this.character.setTint(16777215)}),this.time.delayedCall(100,()=>{this.character.setTint(6737151)}),this.time.delayedCall(150,()=>{this.character.clearTint()})}flashReviveEffect(){const t=[6684774,2228258,8913032,4456516,11141290];let e=0;const s=()=>{e<t.length?(this.character.setTint(t[e]),e++,this.time.delayedCall(80,s)):this.character.clearTint()};s()}triggerShadowExplosion(){const e=this.gameBounds.height*.1*5,s=this.monsterManager.getMonsters(),a=[];for(const i of s){const n=i.x-this.characterX,o=i.y-this.characterY,h=Math.sqrt(n*n+o*o),r=this.gameBounds.height*i.definition.size*.5;h-r<=e&&a.push(i.id)}if(a.length>0){const i=s.filter(o=>a.includes(o.id)).map(o=>({x:o.x,y:o.y}));this.monsterManager.damageMonsters(a,999999),this.flashShadowCrossAtPositions(i)}this.drawCircleEdge(e,6684774),this.showGridSkillEffects?this.flashSkillAreaCircle(this.characterX,this.characterY,e,8913032):this.flashSkillEffectCircle(this.characterX,this.characterY,e,8913032),this.cameras.main.shake(200,.01)}_drawShadowExplosionEffect(t){const e=this.add.graphics();this.worldContainer.add(e);const s=this.characterX,a=this.characterY,i=4456516,n=800,o=this.time.now,h=()=>{const c=this.time.now-o,l=Math.min(c/n,1);e.clear();const d=t*l,p=.6*(1-l);p>.01&&(e.fillStyle(i,p),e.fillCircle(s,a,d),e.lineStyle(4,8913032,p*.8),e.strokeCircle(s,a,d)),l>=1&&e.destroy()};h();const r=this.time.addEvent({delay:16,callback:h,callbackScope:this,repeat:Math.ceil(n/16)});this.time.delayedCall(n+50,()=>{r.remove(),e.active&&e.destroy()})}flashShadowCrossAtPositions(t){t.forEach(e=>{this.flashShadowCrossAt(e.x,e.y)})}flashShadowCrossAt(t,e){const s=this.worldToScreen(t,e),a=u.SKILL_GRID_GAP,i=this.skillGridCellSize+a,n=Math.floor(s.x/i),o=Math.floor(s.y/i),h=n*i+this.skillGridCellSize/2,r=o*i+this.skillGridCellSize/2,c=5,l=500,d=this.time.now,p=Math.random()<.5?1:-1,f=(Math.PI/4+Math.random()*Math.PI/4)*p,g=[];g.push({offsetX:0,offsetY:0,dist:0});const m=[{dc:1,dr:0},{dc:-1,dr:0},{dc:0,dr:1},{dc:0,dr:-1}];for(const{dc:y,dr:k}of m)for(let v=1;v<=c;v++)g.push({offsetX:y*v*i,offsetY:k*v*i,dist:v});if(g.length===0)return;const M=8913032,S=[];for(let y=0;y<g.length;y++){const k=this.add.rectangle(h,r,this.skillGridCellSize,this.skillGridCellSize,M,0);k.setVisible(!1),this.skillGridContainer.add(k),S.push(k)}const E=()=>{const y=this.time.now-d,k=Math.min(y/l,1),v=f*k,I=Math.cos(v),w=Math.sin(v),A=c*k;for(let P=0;P<g.length;P++){const{offsetX:b,offsetY:R,dist:D}=g[P],B=S[P];if(!B)continue;const _=h+b*I-R*w,O=r+b*w+R*I;if(B.setPosition(_,O),D>=A){const L=1-D/c*.2;let H=1;A>0&&D<A+1&&(H=D-A);const F=L*Math.max(0,H);F>.01?(B.setFillStyle(M,F),B.setVisible(!0)):B.setVisible(!1)}else B.setVisible(!1)}if(k>=1)for(const P of S)P.destroy()};E();const T=this.time.addEvent({delay:16,callback:E,callbackScope:this,repeat:Math.ceil(l/16)});this.time.delayedCall(l+50,()=>{T.remove();for(const y of S)y.active&&y.destroy()})}shakeScreen(t){t<10||(this.soundManager.playHit("crit",t),this.cameras.main.shake(100,.005))}createLowHpVignette(){}updateLowHpVignette(){const t=this.currentHp/this.maxHp;this.isLowHp=t<=.3,!this.isLowHp&&this.currentShield<=0&&this.clearVignetteCells()}clearVignetteCells(){for(const t of this.vignetteEdgeCells){const e=Math.floor(t/this.skillGridCols),s=t%this.skillGridCols;if(e===0||e===this.skillGridRows-1||s===0||s===this.skillGridCols-1||e>=1&&e<=3)continue;const a=this.skillGridCells[t];a&&(a.setFillStyle(16777215,0),a.setVisible(!1))}this.vignetteEdgeCells.clear()}updateLowHpVignetteBreathing(t){if(!this.isLowHp&&this.currentShield<=0)return;this.lowHpBreathTimer+=t;const e=1500;this.lowHpBreathTimer>=e&&(this.lowHpBreathTimer-=e);const s=this.lowHpBreathTimer/e,a=Math.sin(s*Math.PI*2)*.5+.5;this.drawGridVignette(a)}drawGridVignette(t){const e=.2+t*.2;let s;this.currentShield>0?s=16768324:s=16720418;const a=this.skillGridCols/2,i=this.skillGridRows/2,n=this.skillGridCols/2*2,o=this.skillGridRows/2*2,h=4,r=this.skillGridRows-3;for(let c=h;c<r;c++)for(let l=1;l<this.skillGridCols-1;l++){const d=c*this.skillGridCols+l,p=this.skillGridCells[d];if(!p)continue;const f=(l-a)/n,g=(c-i)/o,m=Math.sqrt(f*f+g*g);if(m>.5){const M=Math.min(1,(m-.5)/.25),S=e*M;S>.01&&(p.setFillStyle(s,S),p.setVisible(!0),this.vignetteEdgeCells.add(d))}}}createExpBar(){this.expBarContainer=this.add.container(0,0),this.expBarContainer.setDepth(1002);const t=Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(this.gameBounds.height*.03)),e=this.skillGridCellSize,s=this.gameBounds.y+this.gameBounds.height-e*2;this.levelText=this.add.text(this.gameBounds.x+10,s-5,`Lv.${this.currentLevel}`,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${t}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.levelText.setResolution(2),this.levelText.setOrigin(0,1),this.expBarContainer.add(this.levelText),this.timerText=this.add.text(this.gameBounds.x+this.gameBounds.width-10,s-5,"00:00",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${t}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.timerText.setResolution(2),this.timerText.setOrigin(1,1),this.expBarContainer.add(this.timerText),this.uiContainer.add(this.expBarContainer)}drawExpBarFill(){const t=[this.skillGridRows-3,this.skillGridRows-2],e=this.skillGridCols-2;for(const i of t)for(let n=0;n<e;n++){const o=n+1,h=i*this.skillGridCols+o,r=this.skillGridCells[h];r&&(r.setFillStyle(0,.9),r.setVisible(!0),r.setDepth(1e3))}const s=this.currentExp/this.maxExp,a=Math.floor(e*s);if(!(a<=0))for(const i of t)for(let n=0;n<a;n++){const o=n+1,h=i*this.skillGridCols+o,r=this.skillGridCells[h];if(!r)continue;const c=n/e,l=this.expBarFlowOffset,d=(c+l)%1,p=(Math.sin(d*Math.PI*2-Math.PI/2)+1)/2,f=Math.floor(68+68*p),g=Math.floor(136-68*p),M=f<<16|g<<8|255,S=i===this.skillGridRows-2?.95:.8;r.setFillStyle(M,S)}}updateExpBarFlow(t){this.expBarFlowOffset+=.2*t/1e3,this.expBarFlowOffset>=1&&(this.expBarFlowOffset-=1),this.drawExpBarFill()}drawBorderFrame(){for(let s=0;s<this.skillGridCols;s++){const a=0*this.skillGridCols+s,i=this.skillGridCells[a];i&&(i.setFillStyle(3355443,.95),i.setVisible(!0),i.setDepth(1001))}for(let s=0;s<this.skillGridCols;s++){const a=(this.skillGridRows-1)*this.skillGridCols+s,i=this.skillGridCells[a];i&&(i.setFillStyle(3355443,.95),i.setVisible(!0),i.setDepth(1001))}for(let s=1;s<this.skillGridRows-1;s++){const a=s*this.skillGridCols+0,i=this.skillGridCells[a];i&&(i.setFillStyle(3355443,.95),i.setVisible(!0),i.setDepth(1001))}for(let s=1;s<this.skillGridRows-1;s++){const a=s*this.skillGridCols+(this.skillGridCols-1),i=this.skillGridCells[a];i&&(i.setFillStyle(3355443,.95),i.setVisible(!0),i.setDepth(1001))}}createParallaxBackground(){const t=this.gameBounds.width*u.PARALLAX_BG_SCALE,e=this.gameBounds.height*u.PARALLAX_BG_SCALE,s=G.Math.Between(1,5);this.parallaxBackground=this.add.sprite(this.mapWidth/2,this.mapHeight/2,`bg_city_${s}`);const a=t/this.parallaxBackground.width,i=e/this.parallaxBackground.height;this.parallaxBackground.setScale(Math.max(a,i)),this.parallaxBackground.setOrigin(.5,.5),this.parallaxBackground.setAlpha(.5),this.worldContainer.add(this.parallaxBackground)}updateParallaxBackground(){if(!this.parallaxBackground)return;const t=this.gameBounds.width*u.PARALLAX_BG_SCALE,e=this.gameBounds.height*u.PARALLAX_BG_SCALE,s=(this.mapWidth-t)/(this.mapWidth-this.gameBounds.width),a=(this.mapHeight-e)/(this.mapHeight-this.gameBounds.height),i=t/2+this.cameraOffsetX*s,n=e/2+this.cameraOffsetY*a;this.parallaxBackground.setPosition(i,n)}generateFloorObstacles(){const t=this.gameBounds.height/10,e=G.Math.Between(u.FLOOR_OBSTACLE_COUNT_MIN,u.FLOOR_OBSTACLE_COUNT_MAX),s=t*u.FLOOR_OBSTACLE_SIZE_MAX,a=s*2,i=this.characterX,n=this.characterY,o=s*3;for(let h=0;h<e;h++){let r=0;const c=50;let l=!1;const d=t*G.Math.FloatBetween(u.FLOOR_OBSTACLE_SIZE_MIN,u.FLOOR_OBSTACLE_SIZE_MAX);for(;!l&&r<c;){r++;const p=G.Math.FloatBetween(a,this.mapWidth-a),f=G.Math.FloatBetween(a,this.mapHeight-a);if(Math.sqrt((p-i)**2+(f-n)**2)<o)continue;let m=!1;for(const A of this.floorObstacles){const P=Math.sqrt((p-A.x)**2+(f-A.y)**2),b=d/2+A.imageRadius;if(P<b){m=!0;break}}if(m)continue;const S=`floor_water_${G.Math.Between(1,5)}`,E=this.add.sprite(p,f,S);E.setOrigin(.5,.5);const T=d/Math.max(E.width,E.height);E.setScale(T),E.setAlpha(.7);const y=E.width*T,k=E.height*T,v=y/2*.7,I=k/2*.7,w=d/2;this.floorObstacleContainer.add(E),this.eraseFloorWithSprite(E),this.floorObstacles.push({sprite:E,x:p,y:f,halfWidth:v,halfHeight:I,imageRadius:w}),l=!0}}this.createWaterPit(i+t*2,n,t*4,"floor_water_0")}createWaterPit(t,e,s,a){const i=this.add.sprite(t,e,a);i.setOrigin(.5,.5);const n=s/Math.max(i.width,i.height);i.setScale(n),i.setAlpha(.7),this.floorObstacleContainer.add(i);const o=i.width*n,h=i.height*n,r=o/2*.7,c=h/2*.7,l=s/2;this.floorObstacles.push({sprite:i,x:t,y:e,halfWidth:r,halfHeight:c,imageRadius:l}),this.eraseFloorWithSprite(i)}eraseFloorWithSprite(t){if(!this.floorRT)return;const e=t.alpha;t.setAlpha(1),this.floorRT.erase(t,t.x,t.y),t.setAlpha(e)}checkObstacleCollision(t,e,s){for(const a of this.floorObstacles){const i=a.sprite,n=t-a.x,o=e-a.y,h=i.displayWidth/2,r=i.displayHeight/2;if(Math.abs(n)>h||Math.abs(o)>r)continue;const c=Math.floor((n/i.displayWidth+.5)*i.width),l=Math.floor((o/i.displayHeight+.5)*i.height);if(this.textures.getPixelAlpha(c,l,i.texture.key)>128)return!0}return!1}getFloorHexSprite(t){const e=`hex_${t}`;let s=this.floorHexPool.pop();return s?(s.setTexture(e),s.setVisible(!0),s.setActive(!0)):s=this.add.sprite(0,0,e),s.setTint(u.HEX_TINT_NORMAL),s}releaseFloorHexSprite(t){t.setVisible(!1),t.setActive(!1),t.setTint(u.HEX_TINT_NORMAL),this.floorHexPool.push(t)}getRandomHexChar(){const t=Math.random()<u.HEX_CHANCE?u.HEX_CHARS:u.BINARY_CHARS;return t[Math.floor(Math.random()*t.length)]}lerpTint(t){const e=u.HEX_TINT_NORMAL>>16&255,s=u.HEX_TINT_NORMAL>>8&255,a=u.HEX_TINT_NORMAL&255,i=u.HEX_TINT_HIGHLIGHT>>16&255,n=u.HEX_TINT_HIGHLIGHT>>8&255,o=u.HEX_TINT_HIGHLIGHT&255,h=Math.round(e+(i-e)*t),r=Math.round(s+(n-s)*t),c=Math.round(a+(o-a)*t);return h<<16|r<<8|c}lerpTintColor(t,e,s){const a=t>>16&255,i=t>>8&255,n=t&255,o=e>>16&255,h=e>>8&255,r=e&255,c=Math.round(a+(o-a)*s),l=Math.round(i+(h-i)*s),d=Math.round(n+(r-n)*s);return c<<16|l<<8|d}triggerDamageScan(){this.damageScanRings=[{radius:0,active:!0},{radius:-this.gameBounds.height*.1,active:!0}]}updateDamageScan(){const t=this.gameBounds.height,e=this.game.loop.delta/1e3,s=t*u.DAMAGE_SCAN_WIDTH,a=t*u.DAMAGE_SCAN_MAX;for(const i of this.damageScanRings)if(i.active){if(i.radius+=t*u.DAMAGE_SCAN_SPEED*e,i.radius>0){const n=Math.max(0,i.radius-s/2),o=i.radius+s/2;for(const h of this.floorHexChars){const r=h.sprite.x-this.characterX,c=h.sprite.y-this.characterY,l=Math.sqrt(r*r+c*c);if(l>=n&&l<=o){const f=1-Math.abs(l-i.radius)/(s/2),g=this.lerpTintColor(u.DAMAGE_SCAN_COLOR,16777215,f);h.sprite.setTint(g)}}}i.radius>a&&(i.active=!1)}this.damageScanRings=this.damageScanRings.filter(i=>i.active)}triggerShieldBreathScan(){this.shieldBreathScan={phase:"expand",radius:0,targetRadius:this.gameBounds.height*u.SHIELD_SCAN_EXPAND_MAX}}updateShieldBreathScan(){if(this.shieldBreathScan.phase==="idle")return;const t=this.gameBounds.height,e=this.game.loop.delta/1e3,s=t*u.SHIELD_SCAN_WIDTH;let a=0,i=u.SHIELD_SCAN_COLOR,n=16777215;switch(this.shieldBreathScan.phase){case"expand":a=u.SHIELD_SCAN_EXPAND_SPEED,this.shieldBreathScan.radius+=t*a*e,i=u.SHIELD_SCAN_COLOR,n=16777215,this.shieldBreathScan.radius>=this.shieldBreathScan.targetRadius&&(this.shieldBreathScan.phase="contract");break;case"contract":a=u.SHIELD_SCAN_CONTRACT_SPEED,this.shieldBreathScan.radius-=t*a*e,i=16777215,n=16777215,this.shieldBreathScan.radius<=0&&(this.shieldBreathScan.radius=0,this.shieldBreathScan.phase="burst",this.shieldBreathScan.targetRadius=t*u.SHIELD_SCAN_BURST_MAX);break;case"burst":a=u.SHIELD_SCAN_BURST_SPEED,this.shieldBreathScan.radius+=t*a*e,i=16777215,n=u.SHIELD_SCAN_COLOR,this.shieldBreathScan.radius>=this.shieldBreathScan.targetRadius&&(this.shieldBreathScan.phase="idle");break}if(this.shieldBreathScan.radius>0){const o=Math.max(0,this.shieldBreathScan.radius-s/2),h=this.shieldBreathScan.radius+s/2;for(const r of this.floorHexChars){const c=r.sprite.x-this.characterX,l=r.sprite.y-this.characterY,d=Math.sqrt(c*c+l*l);if(d>=o&&d<=h){const g=1-Math.abs(d-this.shieldBreathScan.radius)/(s/2),m=this.lerpTintColor(i,n,g);r.sprite.setTint(m)}}}}triggerLevelUpBreathScan(){this.levelUpBreathScan={phase:"expand",radius:0,targetRadius:this.gameBounds.height*u.LEVELUP_SCAN_EXPAND_MAX}}updateLevelUpBreathScan(){if(this.levelUpBreathScan.phase==="idle")return;const t=this.gameBounds.height,e=this.game.loop.delta/1e3,s=t*u.LEVELUP_SCAN_WIDTH;let a=0,i=u.LEVELUP_SCAN_COLOR,n=16777215;switch(this.levelUpBreathScan.phase){case"expand":a=u.LEVELUP_SCAN_EXPAND_SPEED,this.levelUpBreathScan.radius+=t*a*e,i=u.LEVELUP_SCAN_COLOR,n=16777215,this.levelUpBreathScan.radius>=this.levelUpBreathScan.targetRadius&&(this.levelUpBreathScan.phase="contract");break;case"contract":a=u.LEVELUP_SCAN_CONTRACT_SPEED,this.levelUpBreathScan.radius-=t*a*e,i=16777215,n=16777215,this.levelUpBreathScan.radius<=0&&(this.levelUpBreathScan.radius=0,this.levelUpBreathScan.phase="burst",this.levelUpBreathScan.targetRadius=t*u.LEVELUP_SCAN_BURST_MAX);break;case"burst":a=u.LEVELUP_SCAN_BURST_SPEED,this.levelUpBreathScan.radius+=t*a*e,i=16777215,n=u.LEVELUP_SCAN_COLOR,this.levelUpBreathScan.radius>=this.levelUpBreathScan.targetRadius&&(this.levelUpBreathScan.phase="idle");break}if(this.levelUpBreathScan.radius>0){const o=Math.max(0,this.levelUpBreathScan.radius-s/2),h=this.levelUpBreathScan.radius+s/2;for(const r of this.floorHexChars){const c=r.sprite.x-this.characterX,l=r.sprite.y-this.characterY,d=Math.sqrt(c*c+l*l);if(d>=o&&d<=h){const g=1-Math.abs(d-this.levelUpBreathScan.radius)/(s/2),m=this.lerpTintColor(i,n,g);r.sprite.setTint(m)}}}}updateGameOverBreathScan(){if(this.gameOverBreathScan.phase==="idle")return;const t=this.gameBounds.height,e=this.game.loop.delta/1e3,s=t*u.GAMEOVER_SCAN_WIDTH;let a=0,i=u.GAMEOVER_SCAN_COLOR,n=16777215;switch(this.gameOverBreathScan.phase){case"expand":a=u.GAMEOVER_SCAN_EXPAND_SPEED,this.gameOverBreathScan.radius+=t*a*e,i=u.GAMEOVER_SCAN_COLOR,n=16755370,this.gameOverBreathScan.radius>=this.gameOverBreathScan.targetRadius&&(this.gameOverBreathScan.phase="contract");break;case"contract":a=u.GAMEOVER_SCAN_CONTRACT_SPEED,this.gameOverBreathScan.radius-=t*a*e,i=16777215,n=16777215,this.gameOverBreathScan.radius<=0&&(this.gameOverBreathScan.radius=0,this.gameOverBreathScan.phase="burst",this.gameOverBreathScan.targetRadius=t*u.GAMEOVER_SCAN_BURST_MAX);break;case"burst":a=u.GAMEOVER_SCAN_BURST_SPEED,this.gameOverBreathScan.radius+=t*a*e,i=16777215,n=10044671,this.gameOverBreathScan.radius>=this.gameOverBreathScan.targetRadius&&(this.gameOverBreathScan.phase="idle");break}if(this.gameOverBreathScan.radius>0){const o=Math.max(0,this.gameOverBreathScan.radius-s/2),h=this.gameOverBreathScan.radius+s/2;for(const r of this.floorHexChars){const c=r.sprite.x-this.characterX,l=r.sprite.y-this.characterY,d=Math.sqrt(c*c+l*l);if(d>=o&&d<=h){const g=1-Math.abs(d-this.gameOverBreathScan.radius)/(s/2),m=this.lerpTintColor(i,n,g);r.sprite.setTint(m)}}}}spawnFloorHexChar(){if(this.floorHexChars.length>=u.FLOOR_HEX_MAX)return;const t=this.gameBounds.height*u.FLOOR_HEX_GRID_SIZE,e=this.gameBounds.width*2,s=this.gameBounds.height*2,a=Math.max(0,this.characterX-e/2),i=Math.max(0,this.characterY-s/2),n=Math.min(this.mapWidth,this.characterX+e/2),o=Math.min(this.mapHeight,this.characterY+s/2);let h=0;for(;h<20;){const r=a+Math.random()*(n-a),c=i+Math.random()*(o-i),l=Math.floor(r/t),d=Math.floor(c/t),p=`${l},${d}`;if(!this.floorHexUsedPositions.has(p)){const f=this.getRandomHexChar(),g=t*.25,m=l*t+t/2+d*g,M=d*t+t/2,S=this.getFloorHexSprite(f);S.setPosition(m,M);const E=t;S.setScale(E/80),S.setAlpha(0),this.floorHexContainer.add(S),this.floorHexChars.push({sprite:S,gridKey:p,spawnTime:this.time.now,fadeInDuration:1e3+Math.random()*1e3,lifetime:1e3+Math.random()*2e3,fullyVisible:!1,visibleStartTime:0}),this.floorHexUsedPositions.add(p);return}h++}}updateFloorHexChars(){const t=this.time.now,e=this.gameBounds.width*1.5,s=this.gameBounds.height*u.FLOOR_HEX_GRID_SIZE,a=this.gameBounds.width/2,i=this.gameBounds.height/2,n=this.characterX-a,o=this.characterX+a,h=this.characterY-i,r=this.characterY+i,c=n<0,l=o>this.mapWidth,d=h<0,p=r>this.mapHeight;if((c||l||d||p)&&t-this.lastEdgePulseTime>16){this.lastEdgePulseTime=t;const M=[];c&&M.push("left"),l&&M.push("right"),d&&M.push("top"),p&&M.push("bottom");const S=3+Math.floor(Math.random()*3);for(let E=0;E<S&&M.length>0;E++){const T=M[Math.floor(Math.random()*M.length)];let y=0,k=0;T==="left"||T==="right"?(y=T==="left"?0:this.mapWidth,k=h+Math.random()*this.gameBounds.height,k=Math.max(0,Math.min(this.mapHeight,k))):(k=T==="top"?0:this.mapHeight,y=n+Math.random()*this.gameBounds.width,y=Math.max(0,Math.min(this.mapWidth,y))),this.edgeWavePulses.push({x:y,y:k,edge:T,startTime:t,length:6+Math.floor(Math.random()*5),duration:1e3+Math.random()*500})}}this.edgeWavePulses=this.edgeWavePulses.filter(M=>t-M.startTime<M.duration);for(let M=this.floorHexChars.length-1;M>=0;M--){const S=this.floorHexChars[M],E=t-S.spawnTime,T=S.sprite.x,y=S.sprite.y;if(Math.sqrt(Math.pow(T-this.characterX,2)+Math.pow(y-this.characterY,2))>e){this.releaseFloorHexSprite(S.sprite),this.floorHexUsedPositions.delete(S.gridKey),this.floorHexChars.splice(M,1);continue}let v=.7;if(!S.fullyVisible)E<S.fadeInDuration?v=.7*(E/S.fadeInDuration):(S.fullyVisible=!0,S.visibleStartTime=t);else{const A=t-S.visibleStartTime,P=S.lifetime*.2;if(A>=S.lifetime){this.releaseFloorHexSprite(S.sprite),this.floorHexUsedPositions.delete(S.gridKey),this.floorHexChars.splice(M,1);continue}else A>S.lifetime-P&&(v=.7*((S.lifetime-A)/P))}let I=0,w=0;for(const A of this.edgeWavePulses){const b=(t-A.startTime)/A.duration,R=A.length*s;let D=0,B=0;A.edge==="left"?(D=T,B=Math.abs(y-A.y)):A.edge==="right"?(D=this.mapWidth-T,B=Math.abs(y-A.y)):A.edge==="top"?(D=y,B=Math.abs(T-A.x)):(D=this.mapHeight-y,B=Math.abs(T-A.x));const _=b*R*1.5,O=Math.max(0,_-R),X=s*(1+Math.random()*.5);if(D>=O&&D<=_&&B<X&&D<R){const L=Math.abs(D-_),H=R*.4,F=Math.exp(-L*L/(H*H)),z=b>.7?(1-b)/.3:1,Y=F*z;Y>I&&(I=Y,w=D/R)}}if(I>.1){const P=Math.floor(51+w*85),R=255<<16|P<<8|51;S.sprite.setTint(R),S.sprite.setAlpha(v*(.6+I*.4))}else S.sprite.setTint(u.HEX_TINT_NORMAL),S.sprite.setAlpha(v)}const g=u.FLOOR_HEX_MAX,m=Math.min(20,g-this.floorHexChars.length);for(let M=0;M<m;M++)this.spawnFloorHexChar();this.updateRadiusWaves(),this.updateScanLine(),this.updateGameOverFlicker()}showGameOver(){if(this.gameOverActive)return;this.gameOverActive=!0;for(const E of this.floorHexChars)this.releaseFloorHexSprite(E.sprite);this.floorHexChars=[],this.floorHexUsedPositions.clear();const t=this.gameBounds.height*u.FLOOR_HEX_GRID_SIZE,e=7,s=9,a=2,i=2,n=e+a,o="GAME",h="OVER",r=o.length*(e+a)-a,c=h.length*(e+a)-a,l=s*2+i,d=-t*.25,p=this.characterX,f=this.characterY,g=p-r*t/2-n*t/2,m=f-l*t/2;this.spawnDotMatrixLine(o,g,m,t,d,0);const M=p-c*t/2+n*t/2,S=f-l*t/2+(s+i)*t;this.spawnDotMatrixLine(h,M,S,t,d,s+i)}spawnDotMatrixLine(t,e,s,a,i,n){let c=e;for(const l of t){const d=u.DOT_MATRIX_FONT[l];if(d){for(let p=0;p<9;p++)for(let f=0;f<d[p].length;f++)if(d[p][f]===1){const g=n+p,m=c+f*a+a/2+g*i,M=s+p*a+a/2,S=Math.floor(m/a),E=Math.floor(M/a),T=`go_${S},${E}`;if(!this.floorHexUsedPositions.has(T)){this.floorHexUsedPositions.add(T);const y=u.HEX_CHARS[Math.floor(Math.random()*16)],k=this.getFloorHexSprite(y);k.setPosition(m,M),k.setScale(a/80),k.setAlpha(0),k.setTint(16729156),this.floorHexContainer.add(k),this.gameOverSprites.push(k),this.floorHexChars.push({sprite:k,gridKey:T,spawnTime:this.time.now,fadeInDuration:300,lifetime:999999,fullyVisible:!1,visibleStartTime:0});const v=Math.random()*500;this.tweens.add({targets:k,alpha:.9,duration:300,delay:v,ease:"Power2",onComplete:()=>{const I=this.floorHexChars.find(w=>w.sprite===k);I&&(I.fullyVisible=!0,I.visibleStartTime=this.time.now)}})}}c+=9*a}}}updateGameOverFlicker(){if(!(!this.gameOverActive||this.gameOverSprites.length===0)){for(const t of this.gameOverSprites)if(t.active){if(Math.random()<.02){const e=u.HEX_CHARS[Math.floor(Math.random()*16)];t.setTexture(`hex_${e}`)}if(Math.random()<.05){const e=.7+Math.random()*.3;t.setAlpha(e)}Math.random()<.01&&(t.setTint(16777215),this.time.delayedCall(50+Math.random()*100,()=>{t.active&&t.setTint(16729156)}))}}}updateScanLine(){const t=this.time.now,e=this.gameBounds.width,s=e*u.SCAN_WIDTH;if(!this.scanLineActive&&t-this.lastScanTime>=u.SCAN_INTERVAL&&(this.scanLineActive=!0,this.scanLineX=this.characterX-e/2-s,this.lastScanTime=t),this.scanLineActive){const a=this.game.loop.delta/1e3;this.scanLineX+=e*u.SCAN_SPEED*a;const i=this.scanLineX,n=this.scanLineX+s,o=this.scanLineX+s/2;for(const h of this.floorHexChars){const r=h.sprite.x;if(r>=i&&r<=n){const d=1-Math.abs(r-o)/(s/2);h.sprite.setTint(this.lerpTint(d))}else h.sprite.setTint(u.HEX_TINT_NORMAL)}this.scanLineX>this.characterX+e/2+s&&(this.scanLineActive=!1)}this.updateCircularScan(),this.updateDamageScan(),this.updateShieldBreathScan(),this.updateLevelUpBreathScan(),this.updateGameOverBreathScan()}updateCircularScan(){const t=this.time.now,e=this.gameBounds.height,s=e*u.CIRCULAR_SCAN_WIDTH,a=e*u.CIRCULAR_SCAN_MAX;if(!this.circularScanActive&&t-this.lastCircularScanTime>=u.CIRCULAR_SCAN_INTERVAL&&(this.circularScanActive=!0,this.circularScanRadius=0,this.lastCircularScanTime=t),this.circularScanActive){const i=this.game.loop.delta/1e3;this.circularScanRadius+=e*u.CIRCULAR_SCAN_SPEED*i;const n=Math.max(0,this.circularScanRadius-s/2),o=this.circularScanRadius+s/2;for(const h of this.floorHexChars){const r=h.sprite.x-this.characterX,c=h.sprite.y-this.characterY,l=Math.sqrt(r*r+c*c);if(l>=n&&l<=o){const f=1-Math.abs(l-this.circularScanRadius)/(s/2);h.sprite.setTint(this.lerpTint(f))}}this.circularScanRadius>a&&(this.circularScanActive=!1)}}startRadiusWave(){const t=this.gameBounds.height*u.FLOOR_HEX_GRID_SIZE,e=t*.25,a=this.gameBounds.height*.1/t,i=this.characterX-this.gameBounds.width/2,n=this.characterX+this.gameBounds.width/2,o=this.characterY-this.gameBounds.height/2,h=this.characterY+this.gameBounds.height/2,r=Math.floor(o/t),c=Math.ceil(h/t);for(let l=0;l<u.RADIUS_WAVE_POINTS;l++){let d=0;for(;d<50;){const p=r+Math.floor(Math.random()*(c-r)),f=p*e,g=Math.floor((i-f)/t),m=Math.ceil((n-f)/t),M=g+Math.floor(Math.random()*(m-g)),S=4+Math.random()*6,E=Math.floor(S*a),T=40+Math.random()*60,y=[];for(let k=0;k<=E;k++)y[k]=[];for(let k=-E;k<=E;k++)for(let v=-E;v<=E;v++){const I=Math.sqrt(v*v+k*k),w=Math.floor(I);if(w<=E){const A=M+v,P=p+k;y[w].push(`${A},${P}`)}}this.radiusWaves.push({centerCol:M,centerRow:p,rings:y,currentRing:0,lastExpandTime:this.time.now,expandSpeed:T});break}}}updateRadiusWaves(){const t=this.time.now,e=this.gameBounds.height*u.FLOOR_HEX_GRID_SIZE,s=e*.25;t-this.lastRadiusWaveTime>=u.RADIUS_WAVE_INTERVAL&&(this.startRadiusWave(),this.lastRadiusWaveTime=t);const a=this.characterX-this.gameBounds.width/2,i=this.characterX+this.gameBounds.width/2,n=this.characterY-this.gameBounds.height/2,o=this.characterY+this.gameBounds.height/2,h=this.gameBounds.height*.2;for(let r=this.radiusWaves.length-1;r>=0;r--){const c=this.radiusWaves[r];if(!(t-c.lastExpandTime<c.expandSpeed)){if(c.lastExpandTime=t,c.currentRing<c.rings.length){const l=c.rings[c.currentRing];for(const d of l){if(this.floorHexUsedPositions.has(d))continue;const[p,f]=d.split(",").map(Number),g=p*e+e/2+f*s,m=f*e+e/2;if(g<a-h||g>i+h||m<n-h||m>o+h)continue;const M=this.getRandomHexChar(),S=this.getFloorHexSprite(M);S.setPosition(g,m);const E=e;S.setScale(E/80),S.setAlpha(0),this.floorHexContainer.add(S),this.floorHexChars.push({sprite:S,gridKey:d,spawnTime:t,fadeInDuration:300+Math.random()*400,lifetime:500+Math.random()*1e3,fullyVisible:!1,visibleStartTime:0}),this.floorHexUsedPositions.add(d)}c.currentRing++}c.currentRing>=c.rings.length&&this.radiusWaves.splice(r,1)}}}createSkillBar(){const t=this.skillGridCellSize,e=u.SKILL_GRID_GAP,s=8,a=s*(t+e)-e,i=1,n=2,o=u.ACTIVE_SKILLS,h=u.PASSIVE_SKILLS,r=s+n,c=o*s+(o-1)*i,l=h*s+(h-1)*i,p=(c+n+l)*(t+e)-e,f=this.gameBounds.x+(this.gameBounds.width-p)/2,g=2*(t+e),m=t+e,M=this.gameBounds.y+this.gameBounds.height-g-a-m;this.createAdvancedSkillSlot(f,M,s,a,r,t,e);let S=f;for(let E=0;E<o;E++){const T=S+a/2,y=M+a/2,k=this.add.container(T,y),v=this.add.rectangle(0,0,a,a);v.setStrokeStyle(0,16777215,0),v.setFillStyle(0,0),k.add(v);const I=this.add.rectangle(0,0,a-4,a-4,3355443,0);k.add(I),this.skillIconSprites.push(null);const w=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.2)),A=this.add.text(0,a*.3,"",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${w}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});A.setResolution(2),A.setOrigin(.5,.5),k.add(A),this.skillIcons.push(v),this.skillIconContainers.push(k),this.skillLevelTexts.push(A),k.setDepth(1002),this.uiContainer.add(k),this.drawSkillIconGrid(S,M,s,E),S+=a+i*(t+e)}S+=(n-i)*(t+e);for(let E=0;E<h;E++){const T=S+a/2,y=M+a/2,k=this.add.container(T,y),v=this.add.rectangle(0,0,a,a);v.setStrokeStyle(0,16777215,0),v.setFillStyle(0,0),k.add(v);const I=this.add.rectangle(0,0,a-4,a-4,3355443,0);k.add(I),this.skillIconSprites.push(null);const w=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.2)),A=this.add.text(0,a*.3,"",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${w}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});A.setResolution(2),A.setOrigin(.5,.5),k.add(A),this.skillIcons.push(v),this.skillIconContainers.push(k),this.skillLevelTexts.push(A),k.setDepth(1002),this.uiContainer.add(k),this.drawSkillIconGrid(S,M,s,o+E),S+=a+i*(t+e)}this.createSkillInfoPanel(),this.setupSkillIconInteractions()}createAdvancedSkillSlot(t,e,s,a,i,n,o){const h=t-i*(n+o),r=h+a/2,c=e+a/2;this.advancedSkillContainer=this.add.container(r,c),this.advancedSkillContainer.setDepth(1002),this.advancedSkillContainer.setVisible(!1),this.advancedSkillContainer.setAlpha(0),this.uiContainer.add(this.advancedSkillContainer);const l=this.add.rectangle(0,0,a,a);l.setStrokeStyle(0,16777215,0),l.setFillStyle(0,0),this.advancedSkillContainer.add(l);const d=this.add.rectangle(0,0,a-4,a-4,3355443,0);this.advancedSkillContainer.add(d);const p=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.2));this.advancedSkillLevelText=this.add.text(0,a*.3,"",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${p}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.advancedSkillLevelText.setResolution(2),this.advancedSkillLevelText.setOrigin(.5,.5),this.advancedSkillContainer.add(this.advancedSkillLevelText),this.advancedSkillGridGraphics=this.add.graphics(),this.advancedSkillGridGraphics.setDepth(1001),this.advancedSkillGridGraphics.setVisible(!1),this.uiContainer.add(this.advancedSkillGridGraphics),this.advancedSkillGridData={startX:h,startY:e,gridSize:s},l.setInteractive({useHandCursor:!0}),l.on("pointerdown",()=>{const f=this.skillManager.getEquippedAdvancedSkill();f&&this.showAdvancedSkillInfo(f)})}showAdvancedSkillSlot(){if(this.advancedSkillSlotVisible)return;this.advancedSkillSlotVisible=!0,this.advancedSkillContainer.setVisible(!0),this.advancedSkillGridGraphics.setVisible(!0);const t=this.advancedSkillContainer.x;this.advancedSkillContainer.x=t-50,this.tweens.add({targets:this.advancedSkillContainer,x:t,alpha:1,duration:300,ease:"Power2"})}updateAdvancedSkillDisplay(){const t=this.skillManager.getEquippedAdvancedSkill();if(!t)return;const e=t.definition;e.maxLevel>=0&&t.level>=e.maxLevel?(this.advancedSkillLevelText.setText("MAX"),this.advancedSkillLevelText.setColor("#FFD700")):(this.advancedSkillLevelText.setText(`Lv.${t.level}`),this.advancedSkillLevelText.setColor("#ffffff"));const a=/\d$/.test(e.iconPrefix)?`skill_icon_${e.iconPrefix}`:`skill_${e.iconPrefix}0${t.level}`;if(this.textures.exists(a))if(this.advancedSkillIconSprite)this.advancedSkillIconSprite.setTexture(a);else{const i=this.skillGridCellSize,n=u.SKILL_GRID_GAP,h=8*(i+n)-n-4;this.advancedSkillIconSprite=this.add.sprite(0,0,a),this.advancedSkillIconSprite.setDisplaySize(h,h),this.advancedSkillContainer.add(this.advancedSkillIconSprite),this.advancedSkillContainer.sendToBack(this.advancedSkillIconSprite)}}redrawAdvancedSkillRainbowBorder(t,e){if(!this.advancedSkillSlotVisible||!this.advancedSkillGridGraphics)return;this.advancedSkillHue=(this.advancedSkillHue+e*.1)%360;const s=this.advancedSkillGridGraphics,a=this.advancedSkillGridData;if(!a)return;s.clear();const i=this.skillGridCellSize,n=u.SKILL_GRID_GAP,{startX:o,startY:h,gridSize:r}=a,c=[],l=Math.floor(r/2);for(let f=l;f<r;f++)c.push({row:0,col:f});for(let f=1;f<r;f++)c.push({row:f,col:r-1});for(let f=r-2;f>=0;f--)c.push({row:r-1,col:f});for(let f=r-2;f>=1;f--)c.push({row:f,col:0});c.push({row:0,col:0});for(let f=1;f<l;f++)c.push({row:0,col:f});const d=c.length,p=Math.floor(d*t);for(let f=0;f<d;f++){const{row:g,col:m}=c[f],M=o+m*(i+n),S=h+g*(i+n);if(f<p){const E=(this.advancedSkillHue+f*12)%360,T=G.Display.Color.HSLToColor(E/360,1,.5).color;s.fillStyle(T,.8)}else s.fillStyle(0,.5);s.fillRect(M,S,i,i)}}drawSkillIconGrid(t,e,s,a){const i=this.add.graphics();i.setDepth(1001),this.uiContainer.add(i),this.skillIconGridData[a]={startX:t,startY:e,gridSize:s},this.redrawSkillIconGrid(a,0),this.skillIconGridGraphics[a]=i}redrawSkillIconGrid(t,e){const s=this.skillIconGridGraphics[t],a=this.skillIconGridData[t];if(!s||!a)return;s.clear();const i=this.skillGridCellSize,n=u.SKILL_GRID_GAP,{startX:o,startY:h,gridSize:r}=a,c=u.ACTIVE_SKILLS,l=t<c,d=l?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills(),p=l?t:t-c;if(!d[p]){s.fillStyle(0,.5);for(let E=0;E<r;E++)for(let T=0;T<r;T++){const y=o+T*(i+n),k=h+E*(i+n);s.fillRect(y,k,i,i)}return}const g=[],m=Math.floor(r/2);for(let E=m;E<r;E++)g.push({row:0,col:E});for(let E=1;E<r;E++)g.push({row:E,col:r-1});for(let E=r-2;E>=0;E--)g.push({row:r-1,col:E});for(let E=r-2;E>=1;E--)g.push({row:E,col:0});g.push({row:0,col:0});for(let E=1;E<m;E++)g.push({row:0,col:E});const M=g.length,S=Math.floor(M*e);for(let E=0;E<M;E++){const{row:T,col:y}=g[E],k=o+y*(i+n),v=h+T*(i+n);if(E<S){const I=this.getSkillColorForIndex(t);s.fillStyle(I,.4)}else s.fillStyle(0,.5);s.fillRect(k,v,i,i)}}getSkillColorForIndex(t){const e=u.ACTIVE_SKILLS,s=t<e,a=s?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills(),i=s?t:t-e,n=a[i];return n?n.definition.color:6710886}updateSkillCooldownDisplay(){const t=this.time.now,e=this.skillManager.getPlayerActiveSkills();for(let i=0;i<e.length;i++){const n=e[i];if(!n){this.redrawSkillIconGrid(i,0);continue}const o=n.definition;let h=o.cooldown||1e3;o.id==="active_architect"&&(h=h-n.level*500);const r=this.skillManager.calculateFinalCooldown(h),c=this.skillCooldowns.get(o.id)||0,l=t-c;if(l>=r)this.redrawSkillIconGrid(i,1);else{const d=l/r;this.redrawSkillIconGrid(i,d)}}const s=this.skillManager.getPlayerPassiveSkills(),a=u.ACTIVE_SKILLS;for(let i=0;i<s.length;i++){const n=s[i];if(!n){this.redrawSkillIconGrid(a+i,0);continue}const o=n.definition;let h=1;switch(o.id){case"passive_titanium_liver":{const r=this.skillManager.getTitaniumLiverRegenInterval();r>0&&this.currentHp<this.maxHp&&(h=this.hpRegenTimer/r);break}}this.redrawSkillIconGrid(a+i,h)}}updateAdvancedSkillCooldown(t){if(!this.advancedSkillSlotVisible)return;const e=this.skillManager.getEquippedAdvancedSkill();if(!e)return;const s=this.time.now,a=this.skillManager.calculateFinalCooldown(e.definition.cooldown),i=s-this.advancedSkillCooldownTime,n=Math.min(1,i/a);this.redrawAdvancedSkillRainbowBorder(n,t),e.definition.id==="advanced_absolute_defense"&&this.updateSawBladeSpinVisual(t),n>=1&&!this.isPaused&&!this.popupPaused&&!this.isHurt&&!this.gameOverActive&&(this.activateAdvancedSkill(e),this.advancedSkillCooldownTime=s)}activateAdvancedSkill(t){switch(t.definition.id){case"advanced_burning_celluloid":this.skillExecutor.executeBurningCelluloid(t.level);break;case"advanced_tech_artist":this.skillExecutor.executeTechArtist(t.level);break;case"advanced_absolute_defense":this.skillExecutor.executeAbsoluteDefense(t.level);break;case"advanced_perfect_pixel":this.skillExecutor.executePerfectPixel(t.level);break;case"advanced_vfx_burst":this.skillExecutor.executeVfxBurst(t.level);break;case"advanced_phantom_iteration":this.skillExecutor.executePhantomIteration(t.level);break;case"advanced_zero_trust":this.skillExecutor.activateZeroTrust(t.level);break;case"advanced_soul_slash":this.skillExecutor.executeSoulSlash(t.level);break}}flashSlashEffect(t,e,s,a,i){const n=this.getSkillEffectSprite();if(!n)return;n.setTexture(u.TEXTURE_SLASH),n.setPosition(t,e),n.setRotation(a);const o=s*2/u.EFFECT_TEXTURE_SIZE;n.setScale(o),n.setTint(i),n.setAlpha(0),this.tweens.add({targets:n,alpha:{from:0,to:.75},scale:{from:o*.5,to:o},duration:150,ease:"Quad.easeOut",onComplete:()=>{this.time.delayedCall(150,()=>{this.tweens.add({targets:n,alpha:0,scale:o*1.1,duration:200,ease:"Quad.easeIn",onComplete:()=>{this.releaseSkillEffectSprite(n)}})})}})}updateBurningMonsters(){const t=this.time.now,e=this.monsterManager.getBurningMonsters();for(const s of e){const a=this.monsterManager.getStatusEffect(s,"burn");if(!a)continue;const i=a.tickInterval||1e3,n=a.lastTickTime||t;if(t-n>=i){a.lastTickTime=t;const o=a.damage||0;if(o<=0)continue;const h=this.gameBounds.height*(a.aoeRadius||.1),r=this.monsterManager.getMonsters(),c=[];for(const l of r){const d=l.x-s.x,p=l.y-s.y,f=Math.sqrt(d*d+p*p),g=this.gameBounds.height*l.definition.size*.5;f<=h+g&&c.push(l.id)}if(c.length>0){const l=this.monsterManager.damageMonsters(c,o);l.totalExp>0&&this.addExp(l.totalExp),this.soundManager.playHit("skill",c.length)}this.showBurnExplosionEffect(s.x,s.y,h)}}this.monsterManager.cleanupExpiredEffects()}showBurnExplosionEffect(t,e,s){const a=this.worldToScreen(t,e),i=this.add.circle(a.x,a.y,s,16737792,.3);i.setDepth(60),this.skillGridContainer.add(i);const n=t,o=e;this.tweens.add({targets:i,alpha:0,scale:1.3,duration:250,ease:"Cubic.easeOut",onUpdate:()=>{const h=this.worldToScreen(n,o);i.setPosition(h.x,h.y)},onComplete:()=>{i.destroy()}})}_showRotatingSectorEffect_deprecated(t,e,s,a){const i=this.add.graphics();this.skillGridContainer.add(i),i.setDepth(55);const n=150,o=this.time.now,h=this.characterX,r=this.characterY,c=()=>{const l=this.time.now-o,d=Math.min(l/n,1),p=.8*(1-d),f=this.worldToScreen(h,r);i.clear(),i.fillStyle(a,p*.5),i.beginPath(),i.moveTo(f.x,f.y),i.arc(f.x,f.y,e,t-s,t+s,!1),i.lineTo(f.x,f.y),i.closePath(),i.fillPath(),i.lineStyle(2,16777215,p),i.beginPath(),i.moveTo(f.x,f.y),i.lineTo(f.x+Math.cos(t-s)*e,f.y+Math.sin(t-s)*e),i.strokePath(),i.beginPath(),i.moveTo(f.x,f.y),i.lineTo(f.x+Math.cos(t+s)*e,f.y+Math.sin(t+s)*e),i.strokePath(),d>=1&&i.destroy()};this.time.addEvent({callback:c,loop:!0,delay:16})}showLightBeamEffect(t,e,s,a,i){const n=this.worldToScreen(t,e),o=this.gameBounds.height/10,h=i!==void 0?i:(Math.random()-.5)*2*o,r=n.x+h,c=-200,l=n.x,d=n.y,p=l-r,f=d-c,g=Math.sqrt(p*p+f*f),m=Math.atan2(f,p),M=this.add.sprite((r+l)/2,(c+d)/2,u.TEXTURE_LINE);this.skillGridContainer.add(M),M.setDepth(55),M.setTint(a),M.setRotation(m);const S=160,E=g/u.EFFECT_TEXTURE_SIZE,T=S/u.EFFECT_LINE_HEIGHT;M.setScale(E,T*.3),M.setAlpha(1),this.tweens.add({targets:M,scaleY:{from:T*.3,to:T},alpha:{from:1,to:.9},duration:50,ease:"Quad.easeOut",onComplete:()=>{this.tweens.add({targets:M,alpha:0,scaleY:T*.2,duration:300,ease:"Quad.easeIn",onComplete:()=>{M.destroy()}})}});const y=this.add.graphics();this.skillGridContainer.add(y),y.setDepth(54);const k=this.time.now,v=400,I=()=>{const A=(this.time.now-k)/v,P=this.worldToScreen(t,e);if(y.clear(),A<1){const b=.5*(1-A);y.lineStyle(2,a,b),y.strokeCircle(P.x,P.y,s*Math.min(A*2,1))}else y.destroy()};this.time.addEvent({callback:I,loop:!0,delay:16})}showExplosionEffect(t,e,s,a,i,n){const o=this.worldToScreen(t,e),h=300;this.gameBounds.height/10;const r=this.add.sprite(o.x,o.y,u.TEXTURE_CIRCLE);this.skillGridContainer.add(r),r.setDepth(55),r.setTint(a);const c=s*2/u.EFFECT_TEXTURE_SIZE;r.setScale(c),r.setAlpha(.8);const l=this.add.sprite(o.x,o.y,u.TEXTURE_SECTOR_360);this.skillGridContainer.add(l),l.setDepth(56),l.setTint(16777215);const d=s*.4/u.EFFECT_TEXTURE_SIZE;if(l.setScale(d),l.setAlpha(1),i!==void 0){const p=i+Math.PI;this.showHitSparkEffect(t,e,n?j.TECH_ARTIST_CRIT:j.TECH_ARTIST,p)}this.tweens.add({targets:r,rotation:Math.PI*4,alpha:0,scale:c*1.5,duration:h,ease:"Power2",onUpdate:()=>{const p=this.worldToScreen(t,e);r.setPosition(p.x,p.y),l.setPosition(p.x,p.y)},onComplete:()=>{r.destroy()}}),this.tweens.add({targets:l,alpha:0,scale:d*.5,duration:h*.8,ease:"Power2",onComplete:()=>{l.destroy()}})}hideSawBlades(){for(const t of this.sawBladeSprites)t.outer.setVisible(!1),t.inner.setVisible(!1)}setCurrentSawBladePositions(t){this.currentSawBladePositions=t}setSawBladeRadius(t){this.sawBladeRadius=t}drawSawBladesWithParams(t){const{bladePositions:e,bladeRadius:s,hitPositions:a,isCrit:i}=t;for(const n of a)this.showHitSparkEffect(n.x,n.y,i?j.SAWBLADE_CRIT:j.SAWBLADE);this.drawSawBlades(e,s)}drawSawBlades(t,e){for(;this.sawBladeSprites.length<t.length;){const s=this.add.sprite(0,0,u.TEXTURE_SHIELD);this.skillGridContainer.add(s),s.setDepth(56),s.setTint(16768256),s.setAlpha(.7);const a=this.add.sprite(0,0,u.TEXTURE_CIRCLE);this.skillGridContainer.add(a),a.setDepth(57),a.setTint(16772710),a.setAlpha(.8),this.sawBladeSprites.push({outer:s,inner:a})}for(let s=t.length;s<this.sawBladeSprites.length;s++)this.sawBladeSprites[s].outer.setVisible(!1),this.sawBladeSprites[s].inner.setVisible(!1);for(let s=0;s<t.length;s++){const a=t[s],{outer:i,inner:n}=this.sawBladeSprites[s],o=this.worldToScreen(a.x,a.y);i.setPosition(o.x,o.y),i.setVisible(!0);const h=e*2/u.EFFECT_TEXTURE_SIZE;i.setScale(h),i.setRotation(this.sawBladeSpinAngle),n.setPosition(o.x,o.y),n.setVisible(!0),n.setScale(h*.5),n.setRotation(-this.sawBladeSpinAngle*1.5)}}launchSawBladesOutward(){const t=this.currentSawBladePositions.length;if(t===0)return;const e=this.sawBladeRadius||this.gameBounds.height*.05,s=this.skillManager.getEquippedAdvancedSkill(),a=s?s.level:1,i=this.currentLevel+a,n=u.DAMAGE_UNIT*i,h=[...this.monsterManager.getMonsters()].sort((r,c)=>{const l=Math.sqrt((r.x-this.characterX)**2+(r.y-this.characterY)**2),d=Math.sqrt((c.x-this.characterX)**2+(c.y-this.characterY)**2);return l-d});for(let r=0;r<t;r++){const c=this.currentSawBladePositions[r];let l;if(h.length>0){const d=h[r%h.length];l=Math.atan2(d.y-c.y,d.x-c.x)}else l=Math.atan2(c.y-this.characterY,c.x-this.characterX);this.launchSingleSawBladeToTarget(c.x,c.y,e,n,l)}this.currentSawBladePositions=[]}launchSingleSawBlade(t,e,s){const a=this.add.sprite(0,0,u.TEXTURE_SHIELD);this.skillGridContainer.add(a),a.setDepth(100),a.setTint(16768256),a.setAlpha(.7);const i=this.add.sprite(0,0,u.TEXTURE_CIRCLE);this.skillGridContainer.add(i),i.setDepth(101),i.setTint(16772710),i.setAlpha(.8);const n=this.gameBounds.height*.2,o=this.gameBounds.height*1,h=1600,r=1.5,c={orbitAngle:s,orbitRadius:n,spinAngle:this.sawBladeSpinAngle,progress:0},l=t*2/u.EFFECT_TEXTURE_SIZE,d=()=>{const f=this.characterX+Math.cos(c.orbitAngle)*c.orbitRadius,g=this.characterY+Math.sin(c.orbitAngle)*c.orbitRadius,m=this.worldToScreen(f,g);return a.setPosition(m.x,m.y),a.setScale(l),a.setRotation(c.spinAngle),i.setPosition(m.x,m.y),i.setScale(l*.5),i.setRotation(-c.spinAngle*1.5),{worldX:f,worldY:g}},p=new Set;this.tweens.add({targets:c,progress:1,duration:h,ease:"Quad.easeIn",onUpdate:()=>{c.orbitRadius=n+(o-n)*c.progress,c.orbitAngle=s+r*Math.PI*2*c.progress,c.spinAngle+=.3,c.spinAngle>Math.PI*2&&(c.spinAngle-=Math.PI*2);const{worldX:f,worldY:g}=d(),m=this.monsterManager.getMonsters();for(const M of m){if(p.has(M.id))continue;const S=M.x-f,E=M.y-g,T=Math.sqrt(S*S+E*E),y=this.gameBounds.height*M.definition.size*.5;T-y<=t&&(p.add(M.id),this.skillExecutor.performSawBladeHit(M.id,M.x,M.y,e,this.characterX,this.characterY))}},onComplete:()=>{a.destroy(),i.destroy()}}),d()}launchSingleSawBladeToTarget(t,e,s,a,i){const n=this.add.sprite(0,0,u.TEXTURE_SHIELD);this.skillGridContainer.add(n),n.setDepth(100),n.setTint(16768256),n.setAlpha(.7);const o=this.add.sprite(0,0,u.TEXTURE_CIRCLE);this.skillGridContainer.add(o),o.setDepth(101),o.setTint(16772710),o.setAlpha(.8);const h=s*2/u.EFFECT_TEXTURE_SIZE,r=this.gameBounds.height/10,c={x:t,y:e,angle:i,spinAngle:this.sawBladeSpinAngle},l=r*15,d=new Map,p=200,f=()=>{const M=this.worldToScreen(c.x,c.y);n.setPosition(M.x,M.y),n.setScale(h),n.setRotation(c.spinAngle),o.setPosition(M.x,M.y),o.setScale(h*.5),o.setRotation(-c.spinAngle*1.5)},g=()=>{const M=c.x-this.characterX,S=c.y-this.characterY;return Math.sqrt(M*M+S*S)<r*15},m=this.time.addEvent({delay:16,loop:!0,callback:()=>{const M=this.time.now,S=16/1e3;c.x+=Math.cos(c.angle)*l*S,c.y+=Math.sin(c.angle)*l*S,c.spinAngle+=.3,c.spinAngle>Math.PI*2&&(c.spinAngle-=Math.PI*2);for(const[T,y]of d)M-y>p&&d.delete(T);const E=this.monsterManager.getMonsters();for(const T of E){if(d.has(T.id))continue;const y=T.x-c.x,k=T.y-c.y,v=Math.sqrt(y*y+k*k),I=r*T.definition.size*.5;if(v-I<=s){d.set(T.id,M),this.skillExecutor.performSawBladeHit(T.id,T.x,T.y,a,c.x,c.y);let w=null;for(const A of E){if(d.has(A.id))continue;const P=A.x-c.x,b=A.y-c.y,R=Math.sqrt(P*P+b*b);if(R<r*.5)continue;let B=Math.atan2(b,P)-c.angle;for(;B>Math.PI;)B-=Math.PI*2;for(;B<-Math.PI;)B+=Math.PI*2;Math.abs(B)<=Math.PI/4&&(!w||R<w.dist)&&(w={id:A.id,x:A.x,y:A.y,dist:R})}w?c.angle=Math.atan2(w.y-c.y,w.x-c.x):c.angle+=(Math.random()-.5)*(Math.PI/2);break}}f(),g()||(m.destroy(),n.destroy(),o.destroy())}});f()}updateSawBladeSpinVisual(t){if(this.currentShield<=0){for(const l of this.sawBladeSprites)l.outer.setVisible(!1),l.inner.setVisible(!1);return}const e=Math.PI*2/150;this.sawBladeSpinAngle+=e*t,this.sawBladeSpinAngle>Math.PI*2&&(this.sawBladeSpinAngle-=Math.PI*2);const s=this.gameBounds.height*.2,a=this.gameBounds.height*.05,i=this.skillManager.getEquippedAdvancedSkill(),n=i?i.level:1,h=Math.min(8,3+Math.floor(n/5)),r=[],c=this.skillExecutor.getSawBladeAngle();for(let l=0;l<h;l++){const d=c+l/h*Math.PI*2,p=this.characterX+Math.cos(d)*s,f=this.characterY+Math.sin(d)*s;r.push({x:p,y:f})}this.drawSawBlades(r,a)}clearAdvancedSkillEffects(){for(const t of this.sawBladeSprites)t.outer.setVisible(!1),t.inner.setVisible(!1);this.skillExecutor.clearSawBladeHitTime();for(const t of this.perfectPixelLineSprites)t.destroy();this.perfectPixelLineSprites=[],this.perfectPixelFocusIndex=0,this.perfectPixelLineAlpha=0,this.dismissAllPhantoms(!0)}cleanupBeforeRestart(){this.monsterManager.reset(),this.skillManager.reset(),this.clearAdvancedSkillEffects(),this.skillExecutor.deactivateZeroTrust();for(const t of this.sawBladeSprites)t.outer.setVisible(!1),t.inner.setVisible(!1);this.skillExecutor.resetSawBladeState(),this.sawBladeSpinAngle=0,this.currentSawBladePositions=[];for(const t of this.skillEffectPool)t.setVisible(!1),t.setActive(!1);for(const t of this.lineEffectPool)t.setVisible(!1),t.setActive(!1);for(const t of this.circleLineEffectPool)t.setVisible(!1),t.setActive(!1);for(const t of this.floorHexPool)t.setVisible(!1),t.setActive(!1);for(const t of this.healingItems)t.sprite.destroy();this.healingItems=[],this.nextHealingItemId=0;for(const t of this.expCrystals)this.releaseExpCrystalToPool(t.sprite);this.expCrystals=[],this.nextExpCrystalId=0,this.character&&this.character.setVisible(!1),this.gameBgm&&this.gameBgm.isPlaying&&this.gameBgm.stop(),this.gameOverActive=!1,this.isHurt=!1,this.isAttacking=!1,this.popupPaused=!1,this.isPaused=!1,this.skillCooldowns.clear(),this.gameTimer=0,this.currentLevel=0,this.currentExp=0,this.currentHp=200,this.currentShield=0,this.totalDamageReceived=0;for(const t of this.gameOverSprites)t.setVisible(!1);this.uiContainer&&this.uiContainer.setVisible(!0),this.scanLineX=-1,this.scanLineActive=!1,this.circularScanRadius=0,this.circularScanActive=!1,this.damageScanRings=[],this.shieldBreathScan={phase:"idle",radius:0,targetRadius:0},this.levelUpBreathScan={phase:"idle",radius:0,targetRadius:0},this.gameOverBreathScan={phase:"idle",radius:0,targetRadius:0},this.skillPanelContainer&&this.skillPanelContainer.setVisible(!1),this.skillInfoPanel&&this.skillInfoPanel.setVisible(!1)}spawnHealingItems(t,e){const s=G.Math.Between(u.HEALING_ITEM_DROP_COUNT_MIN,u.HEALING_ITEM_DROP_COUNT_MAX),a=this.gameBounds.height*.1,i=u.HEALING_ITEM_SCATTER_RADIUS*a,n=u.HEALING_ITEM_SIZE*this.gameBounds.height;for(let o=0;o<s;o++){const h=Math.random()*Math.PI*2,r=Math.random()*i,c=t+Math.cos(h)*r,l=e+Math.sin(h)*r,d=this.add.graphics(),p=n/2,f=n/2,g=n*.4;d.fillStyle(13395711,1),d.fillCircle(p-g*.3,f-g*.2,g*.4),d.fillCircle(p+g*.3,f-g*.2,g*.4),d.fillTriangle(p-g*.65,f,p+g*.65,f,p,f+g*.7),d.fillStyle(16777215,.4),d.fillCircle(p-g*.2,f-g*.3,g*.15);const m=`healing_item_${this.nextHealingItemId}`;d.generateTexture(m,n,n),d.destroy();const M=this.add.sprite(c,l,m);M.setOrigin(.5,.5),this.healingItemContainer.add(M),this.healingItems.push({id:this.nextHealingItemId++,x:c,y:l,sprite:M,floatPhase:Math.random()*Math.PI*2})}}updateHealingItems(t){if(this.healingItems.length===0)return;const e=this.gameBounds.height*.1,s=this.skillManager.getRetinaModulePickupBonus(),a=(this.basePickupRange+s)*e,i=[];for(const n of this.healingItems){n.floatPhase+=t*.003;const o=Math.sin(n.floatPhase)*5;n.sprite.setY(n.y+o);const h=this.characterX-n.x,r=this.characterY-n.y;if(Math.sqrt(h*h+r*r)<=a){const l=Math.floor(this.maxHp*u.HEALING_ITEM_HEAL_PERCENT);this.currentHp=Math.min(this.maxHp,this.currentHp+l),this.displayedHp=this.currentHp,this.drawHpBarFill(),this.updateHpText(),this.playPickupEffect(n.x,n.y),i.push(n.id)}}for(const n of i){const o=this.healingItems.findIndex(h=>h.id===n);if(o!==-1){const h=this.healingItems[o];this.textures.remove(`healing_item_${h.id}`),h.sprite.destroy(),this.healingItems.splice(o,1)}}}playPickupEffect(t,e){const s=this.getSkillEffectSprite();s&&(s.setTexture(u.TEXTURE_CIRCLE),s.setPosition(t,e),s.setScale(.1),s.setTint(6750054),s.setAlpha(1),s.setVisible(!0),s.setActive(!0),this.tweens.add({targets:s,y:e-50,scaleX:.3,scaleY:.3,alpha:0,duration:400,ease:"Quad.easeOut",onComplete:()=>{this.releaseSkillEffectSprite(s)}}))}handleMonsterDeath(t){if(t.exp>0){const e=Math.floor(t.exp*this.currentGameMode.expMultiplier);this.spawnExpCrystal(t.x,t.y,e)}t.isElite&&this.spawnHealingItems(t.x,t.y),t.isBoss}startPerfectPixelSequence(t){const{focusPoints:e,shuffledIndices:s,baseDamage:a,explosionRadius:i,unitSize:n,explosionRadiusUnits:o}=t,h=e[0].x,r=e[1].x,c=e[0].y,l=e[2].y;this.perfectPixelLineAlpha=1,this.drawPerfectPixelLines(h,r,c,l);const d=250;s.forEach((p,f)=>{this.time.delayedCall(f*d,()=>{const g=e[p],m=this.skillExecutor.performPerfectPixelExplosion(g.x,g.y,a,n,o);if(m.hitMonsters.length>0){const M=this.monsterManager.getMonsters();for(const S of m.hitMonsters){const E=M.find(T=>T.id===S);if(E){const T=this.worldToScreen(E.x,E.y);this.showExplosionSparkEffect(T.x,T.y,6750156,1)}}}this.showPerfectPixelExplosion(g.x,g.y,i,m.isCrit)})}),this.time.delayedCall(4*d,()=>{this.tweens.add({targets:this,perfectPixelLineAlpha:0,duration:2e3,ease:"Power2",onUpdate:()=>{this.drawPerfectPixelLines(h,r,c,l)}})})}drawPerfectPixelLines(t,e,s,a){const i=this.gameBounds,n=16;if(this.perfectPixelLineSprites.length===0){const h=this.add.sprite(t,i.y+i.height/2,u.TEXTURE_LINE);this.uiContainer.add(h),h.setDepth(1005),h.setTint(6750156),h.setRotation(Math.PI/2),h.setScale(i.height/u.EFFECT_TEXTURE_SIZE,n/u.EFFECT_LINE_HEIGHT),this.perfectPixelLineSprites.push(h);const r=this.add.sprite(e,i.y+i.height/2,u.TEXTURE_LINE);this.uiContainer.add(r),r.setDepth(1005),r.setTint(6750156),r.setRotation(Math.PI/2),r.setScale(i.height/u.EFFECT_TEXTURE_SIZE,n/u.EFFECT_LINE_HEIGHT),this.perfectPixelLineSprites.push(r);const c=this.add.sprite(i.x+i.width/2,s,u.TEXTURE_LINE);this.uiContainer.add(c),c.setDepth(1005),c.setTint(6750156),c.setRotation(0),c.setScale(i.width/u.EFFECT_TEXTURE_SIZE,n/u.EFFECT_LINE_HEIGHT),this.perfectPixelLineSprites.push(c);const l=this.add.sprite(i.x+i.width/2,a,u.TEXTURE_LINE);this.uiContainer.add(l),l.setDepth(1005),l.setTint(6750156),l.setRotation(0),l.setScale(i.width/u.EFFECT_TEXTURE_SIZE,n/u.EFFECT_LINE_HEIGHT),this.perfectPixelLineSprites.push(l)}const o=this.perfectPixelLineAlpha*.8;for(const h of this.perfectPixelLineSprites)h.setAlpha(o)}showPerfectPixelExplosion(t,e,s,a){const i=[],o=s*1.2,h=a?16776960:6750156,r=this.add.sprite(t,e,u.TEXTURE_SECTOR_360);this.uiContainer.add(r),r.setDepth(1006),r.setTint(h),r.setScale(s*.6/u.EFFECT_TEXTURE_SIZE),r.setAlpha(1),i.push(r);const c=this.add.sprite(t,e,u.TEXTURE_CIRCLE_LINE);this.uiContainer.add(c),c.setDepth(1005),c.setTint(6750156),c.setScale(s*1/u.EFFECT_TEXTURE_SIZE),c.setAlpha(.8),i.push(c);const l=this.add.sprite(t,e,u.TEXTURE_CIRCLE_LINE);this.uiContainer.add(l),l.setDepth(1004),l.setTint(8978414),l.setScale(s*2/u.EFFECT_TEXTURE_SIZE),l.setAlpha(.4),i.push(l);const d=this.add.sprite(t,e,u.TEXTURE_LINE);this.uiContainer.add(d),d.setDepth(1007),d.setTint(6750156),d.setRotation(0),d.setScale(o*2/u.EFFECT_TEXTURE_SIZE,24/u.EFFECT_LINE_HEIGHT),d.setAlpha(.8),i.push(d);const p=this.add.sprite(t,e,u.TEXTURE_LINE);this.uiContainer.add(p),p.setDepth(1007),p.setTint(6750156),p.setRotation(Math.PI/2),p.setScale(o*2/u.EFFECT_TEXTURE_SIZE,24/u.EFFECT_LINE_HEIGHT),p.setAlpha(.8),i.push(p);for(const M of i)this.tweens.add({targets:M,alpha:0,duration:500,ease:"Power2",onComplete:()=>M.destroy()});const f=this.add.sprite(t,e,u.TEXTURE_SECTOR_360);this.uiContainer.add(f),f.setDepth(1005),f.setTint(6750156);const g=s*.6/u.EFFECT_TEXTURE_SIZE,m=s*2/u.EFFECT_TEXTURE_SIZE;f.setScale(g),f.setAlpha(1),this.tweens.add({targets:f,scale:m,alpha:0,duration:300,ease:"Power2",onComplete:()=>f.destroy()})}startVfxBurstSequence(t){const{baseDamage:e,skillLevel:s}=t,a=30,i=67;for(let n=0;n<a;n++)this.time.delayedCall(n*i,()=>{const o=this.skillExecutor.selectMissileTarget();o!==null&&this.launchMissile(o,e,s)})}launchMissile(t,e,s){const a=this.gameBounds.height/10,i=this.gameBounds.height*.2,n=this.worldToScreen(this.characterX,this.characterY),o=n.x,h=n.y,r=this.add.sprite(o,h,u.TEXTURE_LINE);this.skillGridContainer.add(r),r.setDepth(100),r.setTint(16737792);const c=32;let l=a*.3;const d=()=>{const S=l/u.EFFECT_TEXTURE_SIZE,E=c/u.EFFECT_LINE_HEIGHT;r.setScale(S,E)};d();const f=this.monsterManager.getMonsters().find(S=>S.id===t);if(!f){r.destroy();return}const g=Math.random()*Math.PI*2;r.setRotation(g);const m=o+Math.cos(g)*i,M=h+Math.sin(g)*i;this.tweens.add({targets:r,x:m,y:M,duration:400,ease:"Quad.easeOut",onComplete:()=>{const S=this.worldToScreen(f.x,f.y),E=S.x-r.x,T=S.y-r.y;r.setRotation(Math.atan2(T,E)),l=a*2.4,d(),this.tweens.add({targets:r,x:S.x,y:S.y,duration:500,ease:"Linear",onComplete:()=>{const y=this.skillExecutor.performMissileHit(t,r.x,r.y,e,s);if(y.hitMonsterIds.length>0){const k=this.monsterManager.getMonsters();for(const v of y.hitMonsterIds){const I=k.find(w=>w.id===v);if(I){const w=this.worldToScreen(I.x,I.y);this.showExplosionSparkEffect(w.x,w.y,16737792,1)}}}this.showMissileExplosion(r.x,r.y,y.isCrit),r.destroy()}})}})}showMissileExplosion(t,e,s){const i=this.gameBounds.height/10*3,n=this.add.sprite(t,e,u.TEXTURE_SECTOR_360);this.skillGridContainer.add(n),n.setDepth(101),n.setTint(16737792);const o=i*.6/u.EFFECT_TEXTURE_SIZE;n.setScale(o),n.setAlpha(.9);const h=this.add.sprite(t,e,u.TEXTURE_CIRCLE_LINE);this.skillGridContainer.add(h),h.setDepth(100),h.setTint(16763904);const r=i*2/u.EFFECT_TEXTURE_SIZE;h.setScale(r),h.setAlpha(.7),this.showExplosionSparkEffect(t,e,16737792,3),this.tweens.add({targets:n,alpha:0,scale:o*1.5,duration:250,ease:"Power2",onComplete:()=>{n.destroy()}}),this.tweens.add({targets:h,alpha:0,scale:r*1.3,duration:300,ease:"Power2",onComplete:()=>{h.destroy()}})}createZeroTrustShieldSprite(){this.zeroTrustSprite||(this.zeroTrustSprite=this.add.sprite(0,0,u.TEXTURE_SHIELD),this.skillGridContainer.add(this.zeroTrustSprite),this.zeroTrustSprite.setDepth(49),this.zeroTrustSprite.setAlpha(.15))}createZeroTrustPoint(t,e){const s=this.gameBounds.height/10,a=t/8*Math.PI*2-Math.PI/2,i=this.characterX+Math.cos(a)*e,n=this.characterY+Math.sin(a)*e,o=this.add.sprite(0,0,u.TEXTURE_SECTOR_360);this.skillGridContainer.add(o),o.setDepth(56),o.setTint(16777215),o.setAlpha(.8);const h=s*.3/u.EFFECT_TEXTURE_SIZE,r=h*.35;o.setScale(h,r);const c=this.add.sprite(0,0,u.TEXTURE_LINE);this.skillGridContainer.add(c),c.setDepth(55),c.setTint(16768324),c.setAlpha(.6),c.setRotation(-Math.PI/2),this.zeroTrustPoints.push({targetMonsterId:null,currentX:i,currentY:n,homeAngle:a,lastDamageTime:0,pointSprite:o,beamSprite:c,flickerPhase:Math.random()*Math.PI*2,lockStartTime:0,beamMultiplier:1})}updateZeroTrust(t,e){if(!this.zeroTrustActive)return;this.monsterManager.setSlowZone(this.characterX,this.characterY,5,.5);const s=this.gameBounds.height/10,i=5*s,n=500,o=this.time.now,h=16763904,r=s*8,c=this.worldToScreen(this.characterX,this.characterY);if(this.zeroTrustSprite){this.zeroTrustSprite.setPosition(c.x,c.y);const f=i*2/u.EFFECT_TEXTURE_SIZE;this.zeroTrustSprite.setScale(f),this.zeroTrustSprite.setTint(h),this.zeroTrustSprite.setAlpha(.15),this.zeroTrustSprite.rotation+=.015}const l=this.monsterManager.getMonsters(),d=new Set(l.map(f=>f.id)),p=[];for(const f of l){const g=f.x-this.characterX,m=f.y-this.characterY;Math.sqrt(g*g+m*m)<=i&&p.push(f)}for(const f of this.zeroTrustPoints){if(f.flickerPhase+=e*.02,f.targetMonsterId!==null){const _=d.has(f.targetMonsterId),X=l.find(L=>L.id===f.targetMonsterId)&&p.some(L=>L.id===f.targetMonsterId);(!_||!X)&&(this.zeroTrustTrackedMonsters.delete(f.targetMonsterId),f.targetMonsterId=null,f.lockStartTime=0,f.beamMultiplier=1)}if(f.targetMonsterId===null&&p.length>0){let _=null,O=1/0;for(const X of p){if(this.zeroTrustTrackedMonsters.has(X.id))continue;const L=X.x-f.currentX,H=X.y-f.currentY,F=Math.sqrt(L*L+H*H);F<O&&(O=F,_=X)}_&&(f.targetMonsterId=_.id,this.zeroTrustTrackedMonsters.add(_.id),f.lockStartTime=o,f.beamMultiplier=1)}let g,m;if(f.targetMonsterId!==null){const _=l.find(O=>O.id===f.targetMonsterId);_?(g=_.x,m=_.y):(g=this.characterX+Math.cos(f.homeAngle)*i,m=this.characterY+Math.sin(f.homeAngle)*i)}else g=this.characterX+Math.cos(f.homeAngle)*i,m=this.characterY+Math.sin(f.homeAngle)*i;const M=g-f.currentX,S=m-f.currentY,E=Math.sqrt(M*M+S*S);if(E>1){const _=Math.min(r*e/1e3,E);f.currentX+=M/E*_,f.currentY+=S/E*_}if(Math.sqrt(Math.pow(f.currentX-this.characterX,2)+Math.pow(f.currentY-this.characterY,2))>i){const _=Math.atan2(f.currentY-this.characterY,f.currentX-this.characterX);f.currentX=this.characterX+Math.cos(_)*i,f.currentY=this.characterY+Math.sin(_)*i}const y=this.worldToScreen(f.currentX,f.currentY);f.pointSprite.setPosition(y.x,y.y);const k=f.targetMonsterId!==null,v=Math.sin(f.flickerPhase)*.5+.5;if(k){const _=v>.5?16737894:16711680;f.pointSprite.setTint(_)}else{const _=v>.5?16777215:14540253;f.pointSprite.setTint(_)}if(f.pointSprite.setAlpha(.7+v*.3),f.targetMonsterId!==null&&f.lockStartTime>0){const _=o-f.lockStartTime;f.beamMultiplier=1+Math.floor(_/500)}else f.beamMultiplier=1;const I=this.gameBounds.height*.8,w=y.y-I;f.beamSprite.setPosition(y.x,(w+y.y)/2);const A=I/u.EFFECT_TEXTURE_SIZE,R=12*f.beamMultiplier/u.EFFECT_LINE_HEIGHT;f.beamSprite.setScale(A,R);const D=v>.5?16768324:16777215;f.beamSprite.setTint(D);const B=Math.min(.9,.3+v*.4+(f.beamMultiplier-1)*.1);if(f.beamSprite.setAlpha(B),f.targetMonsterId!==null&&o-f.lastDamageTime>=n){f.lastDamageTime=o;const _=this.skillExecutor.performZeroTrustPointDamage(f.currentX,f.currentY,f.beamMultiplier,t);_.hitMonsters.length>0&&(_.shouldResetShield&&this.skillCooldowns.delete("active_architect"),this.showZeroTrustHitEffect(f.currentX,f.currentY,_.isCrit))}}}showZeroTrustHitEffect(t,e,s){const a=this.worldToScreen(t,e),i=this.gameBounds.height/10,n=s?16737792:16763904,h=i*2*2/u.EFFECT_TEXTURE_SIZE,r=Math.PI*4,c=300,l=Math.random()*Math.PI*2,d=Math.PI/2;this.showHitSparkEffect(t,e,n,d);const p=this.add.sprite(a.x,a.y,u.TEXTURE_SHIELD);this.skillGridContainer.add(p),p.setDepth(59),p.setTint(n),p.setScale(.1),p.setAlpha(.8),p.setRotation(l);const f=this.add.sprite(a.x,a.y,u.TEXTURE_SHIELD);this.skillGridContainer.add(f),f.setDepth(60),f.setTint(16777215),f.setScale(.05),f.setAlpha(.9),f.setRotation(-l),this.tweens.add({targets:p,scale:h,rotation:l+r,alpha:0,duration:c,ease:"Quad.easeOut",onComplete:()=>{p.destroy()}}),this.tweens.add({targets:f,scale:h*.5,rotation:-l-r*1.5,alpha:0,duration:c,ease:"Quad.easeOut",onComplete:()=>{f.destroy()}})}drawChainSlashEffect(t,e,s,a,i,n,o){const h=t-this.cameraOffsetX+this.gameBounds.x,r=e-this.cameraOffsetY+this.gameBounds.y,c=s-this.cameraOffsetX+this.gameBounds.x,l=a-this.cameraOffsetY+this.gameBounds.y,d=c-h,p=l-r,f=Math.sqrt(d*d+p*p),g=(h+c)/2,m=(r+l)/2,M=65535,S=48,E=this.add.sprite(g,m,u.TEXTURE_LINE);this.uiContainer.add(E),E.setDepth(1060),E.setTint(M),E.setRotation(i),E.setScale(f/u.EFFECT_TEXTURE_SIZE,S*1.5/u.EFFECT_LINE_HEIGHT),E.setAlpha(.3);const T=this.add.sprite(g,m,u.TEXTURE_LINE);this.uiContainer.add(T),T.setDepth(1061),T.setTint(M),T.setRotation(i),T.setScale(f/u.EFFECT_TEXTURE_SIZE,S/u.EFFECT_LINE_HEIGHT),T.setAlpha(.6);const y=this.add.sprite(g,m,u.TEXTURE_LINE);this.uiContainer.add(y),y.setDepth(1062),y.setTint(16777215),y.setRotation(i),y.setScale(f/u.EFFECT_TEXTURE_SIZE,S*.3/u.EFFECT_LINE_HEIGHT),y.setAlpha(.9);const k=[E,T,y];for(const w of k)this.tweens.add({targets:w,alpha:0,duration:150,onComplete:()=>w.destroy()});const v=n-this.cameraOffsetX+this.gameBounds.x,I=o-this.cameraOffsetY+this.gameBounds.y;this.showChainSlashFlashEffect(v,I,i)}showChainSlashFlashEffect(t,e,s){const i=this.gameBounds.height*.08*2/u.EFFECT_TEXTURE_SIZE,n=this.add.sprite(t,e,this.getSectorTextureKey(60));this.uiContainer.add(n),n.setDepth(1061),n.setTint(65535),n.setRotation(s),n.setScale(i),n.setAlpha(.8);const o=this.add.sprite(t,e,this.getSectorTextureKey(60));this.uiContainer.add(o),o.setDepth(1062),o.setTint(16777215),o.setRotation(s),o.setScale(i*.7),o.setAlpha(1);for(const h of[n,o])this.tweens.add({targets:h,alpha:0,duration:80,onComplete:()=>h.destroy()})}pointToLineDistance(t,e,s,a,i,n){const o=t-s,h=e-a,r=i-s,c=n-a,l=o*r+h*c,d=r*r+c*c,p=d!==0?l/d:-1,f=p<0?s:p>1?i:s+p*r,g=p<0?a:p>1?n:a+p*c;return Math.sqrt((t-f)**2+(e-g)**2)}drawSoulSlashEffect(t,e,s,a,i,n,o){const h=t-this.cameraOffsetX+this.gameBounds.x,r=e-this.cameraOffsetY+this.gameBounds.y,c=s-this.cameraOffsetX+this.gameBounds.x,l=a-this.cameraOffsetY+this.gameBounds.y,d=c-h,p=l-r,f=Math.sqrt(d*d+p*p),g=(h+c)/2,m=(r+l)/2,M=16724838,S=48,E=this.add.sprite(g,m,u.TEXTURE_LINE);this.uiContainer.add(E),E.setDepth(1060),E.setTint(M),E.setRotation(i),E.setScale(f/u.EFFECT_TEXTURE_SIZE,S*1.5/u.EFFECT_LINE_HEIGHT),E.setAlpha(.3);const T=this.add.sprite(g,m,u.TEXTURE_LINE);this.uiContainer.add(T),T.setDepth(1061),T.setTint(M),T.setRotation(i),T.setScale(f/u.EFFECT_TEXTURE_SIZE,S/u.EFFECT_LINE_HEIGHT),T.setAlpha(.6);const y=this.add.sprite(g,m,u.TEXTURE_LINE);this.uiContainer.add(y),y.setDepth(1062),y.setTint(16777215),y.setRotation(i),y.setScale(f/u.EFFECT_TEXTURE_SIZE,S*.3/u.EFFECT_LINE_HEIGHT),y.setAlpha(.9);const k=[E,T,y];for(const w of k)this.tweens.add({targets:w,alpha:0,duration:150,onComplete:()=>w.destroy()});const v=this.characterContainer.x+this.character.x,I=this.characterContainer.y+this.character.y;this.showSlashFlashEffect(v,I,i)}showSlashFlashEffect(t,e,s){const i=this.gameBounds.height*.1*2/u.EFFECT_TEXTURE_SIZE,n=this.add.sprite(t,e,this.getSectorTextureKey(60));this.uiContainer.add(n),n.setDepth(1061),n.setTint(16724838),n.setRotation(s),n.setScale(i),n.setAlpha(.8);const o=this.add.sprite(t,e,this.getSectorTextureKey(60));this.uiContainer.add(o),o.setDepth(1062),o.setTint(16777215),o.setRotation(s),o.setScale(i*.7),o.setAlpha(1);for(const h of[n,o])this.tweens.add({targets:h,alpha:0,duration:100,onComplete:()=>h.destroy()})}createPhantom(t){const e=this.gameBounds.height/10,s=this.phantoms.length,a=this.phantoms.length+1,i=Math.PI*2/a,n=s*i+i/2,o=(Math.random()-.5)*i*.8,h=n+o,r=(3+Math.random()*2)*e,c=this.characterX+Math.cos(h)*r,l=this.characterY+Math.sin(h)*r,d=this.add.sprite(0,0,"char_idle_1");d.setOrigin(.5,1),d.setScale(this.character.scaleX,this.character.scaleY),d.setAlpha(.7),d.setTint(u.PHANTOM_COLOR),d.play("char_idle"),this.skillGridContainer.add(d),d.setDepth(55);const p=this.nextPhantomId++;let f=0;const g=this.time.addEvent({delay:50,loop:!0,callback:()=>{if(this.isPaused||this.popupPaused)return;const T=this.phantoms.find(y=>y.id===p);if(!(!T||!T.sprite))if(T.isTaunting){f+=.03,f>1&&(f-=1);const y=(Math.sin(f*Math.PI*2)+1)/2,k=255,v=Math.floor(68+y*68),I=Math.floor(y*68),w=k<<16|v<<8|I;T.sprite.setTint(w)}else T.sprite.setTint(u.PHANTOM_COLOR)}}),m=this.time.addEvent({delay:5e3,loop:!0,callback:()=>{const T=this.phantoms.find(y=>y.id===p);T&&(T.isTaunting=!0,this.updatePhantomTauntTarget(),this.time.delayedCall(2e3,()=>{const y=this.phantoms.find(k=>k.id===p);y&&(y.isTaunting=!1,this.updatePhantomTauntTarget())}))}}),M=["advanced_tech_artist"],S=this.time.addEvent({delay:1e3,loop:!0,callback:()=>{if(this.isPaused||this.popupPaused)return;const T=this.phantoms.find(k=>k.id===p);if(!T)return;const y=M[Math.floor(Math.random()*M.length)];this.skillExecutor.executePhantomSkillAt(y,t,T.x,T.y),this.setPhantomMoveTargetFor(T)}}),E={id:p,x:c,y:l,targetX:c,targetY:l,moving:!1,sprite:d,flashTimer:g,skillTimer:S,tauntTimer:m,isTaunting:!0,sectorIndex:s,lastAfterimageTime:0};this.phantoms.push(E),this.updatePhantomTauntTarget(),this.reassignPhantomSectors(),this.showPhantomSpawnEffectAt(c,l),this.setPhantomMoveTargetFor(E)}reassignPhantomSectors(){const t=this.phantoms.length;for(let e=0;e<t;e++)this.phantoms[e].sectorIndex=e}updatePhantomTauntTarget(){const t=this.phantoms.find(e=>e.isTaunting);t?this.monsterManager.setTauntTarget(t.x,t.y,!0):this.monsterManager.clearTauntTarget()}startPhantomCurseCircles(t,e){const a=this.gameBounds.height/10*2;for(const i of this.phantoms)this.createFollowingCurseCircle(i.id,a,t,e)}createFollowingCurseCircle(t,e,s,a){const o=this.gameBounds.height/10,h=o*2,r=o*2.5;let c=0;const l=this.add.sprite(0,0,u.TEXTURE_CIRCLE);this.skillGridContainer.add(l),l.setDepth(57),l.setTint(u.PHANTOM_COLOR),l.setAlpha(.6);const d=this.add.sprite(0,0,u.TEXTURE_CIRCLE);this.skillGridContainer.add(d),d.setDepth(58),d.setTint(16777215),d.setAlpha(.4);const p=this.time.now;let f=0;const g=new Set,m=()=>{const M=this.time.now-p;if(M>=2e3){this.transferCurseCircleToAnotherPhantom(t,l,d);return}const S=this.phantoms.find(v=>v.id===t);if(!S){l.destroy(),d.destroy();return}c+=.25;const E=(Math.sin(c)+1)/2,T=h+(r-h)*E,y=T*2/u.EFFECT_TEXTURE_SIZE;l.setScale(y),d.setScale(y*.6);const k=this.worldToScreen(S.x,S.y);if(l.setPosition(k.x,k.y),d.setPosition(k.x,k.y),l.rotation+=.3,d.rotation-=.4,M-f>=200){f=M,g.clear();const v=this.skillExecutor.performCurseCircleDamage(S.x,S.y,T,s,a);if(v.hitMonsters.length>0){const I=this.monsterManager.getMonsters();for(const w of v.hitMonsters){const A=I.find(P=>P.id===w);A&&(this.showHitSparkEffect(A.x,A.y,u.PHANTOM_COLOR),this.showCurseCircleHitEffect(A.x,A.y))}}}this.time.delayedCall(16,m)};m()}transferCurseCircleToAnotherPhantom(t,e,s){const a=this.phantoms.filter(i=>i.id!==t);if(a.length>0){const i=a[Math.floor(Math.random()*a.length)],n=this.worldToScreen(i.x,i.y),o=e.scaleX;this.tweens.add({targets:[e,s],x:n.x,y:n.y,duration:300,ease:"Quad.easeIn",onUpdate:()=>{e.rotation+=.3,s.rotation-=.4},onComplete:()=>{this.tweens.add({targets:e,scale:o*2.5,alpha:0,duration:300,ease:"Quad.easeOut",onComplete:()=>{e.destroy()}}),this.tweens.add({targets:s,scale:o*.6*2.5,alpha:0,duration:300,ease:"Quad.easeOut",onComplete:()=>{s.destroy()}})}})}else{const i=e.scaleX;this.tweens.add({targets:e,scale:i*2,alpha:0,duration:300,ease:"Quad.easeOut",onComplete:()=>{e.destroy()}}),this.tweens.add({targets:s,scale:i*.6*2,alpha:0,duration:300,ease:"Quad.easeOut",onComplete:()=>{s.destroy()}})}}showCurseCircleHitEffect(t,e){const s=this.worldToScreen(t,e),a=this.gameBounds.height/10,i=this.add.sprite(s.x,s.y,u.TEXTURE_CIRCLE_LINE);this.skillGridContainer.add(i),i.setDepth(60),i.setTint(u.PHANTOM_COLOR_LIGHT),i.setAlpha(.8),i.setScale(.1),this.tweens.add({targets:i,scale:a*.8/u.EFFECT_TEXTURE_SIZE,alpha:0,duration:200,ease:"Quad.easeOut",onComplete:()=>{i.destroy()}})}launchPhantomCurseCircles(t){const e=this.gameBounds.height/10,s=e*.5,a=e*4,i=this.skillManager.getEquippedAdvancedSkill(),n=i?i.level:t,o=this.currentLevel+n,h=u.DAMAGE_UNIT*o,r=this.phantoms.length;let c=[];r===1?c=[0]:r===2?c=[0,Math.PI]:c=[0,Math.PI*2/3,Math.PI*4/3];const l=this.phantoms.map(d=>({x:d.x,y:d.y}));for(let d=0;d<c.length;d++){const p=c[d],f=l[d]||l[0];this.launchSingleCurseCircle(p,f.x,f.y,s,a,h)}}launchSingleCurseCircle(t,e,s,a,i,n){const o=this.gameBounds.height/10;let h=Math.cos(t),r=Math.sin(t);const c=o*8,l=4e3,d=600,p=Math.PI*8,f=o*.5,g=this.worldToScreen(this.characterX,this.characterY),m=this.add.sprite(g.x,g.y,u.TEXTURE_CIRCLE);this.skillGridContainer.add(m),m.setDepth(58),m.setTint(u.PHANTOM_COLOR),m.setAlpha(.8);const M=this.add.sprite(g.x,g.y,u.TEXTURE_CIRCLE);this.skillGridContainer.add(M),M.setDepth(59),M.setTint(u.PHANTOM_COLOR_LIGHT),M.setAlpha(.9);const S=a*2/u.EFFECT_TEXTURE_SIZE;m.setScale(S),M.setScale(S*.7);const E=new Set;let T=this.characterX,y=this.characterY,k=0,v=!1,I=0,w=a;const A=this.time.addEvent({delay:16,loop:!0,callback:()=>{k+=16;const P=16/1e3,b=e-T,R=s-y,D=Math.sqrt(b*b+R*R);if(!v&&D<=f&&(v=!0),!v){const L=Math.min(1,k/l);if(D>.1){const H=b/D,F=R/D,Y=4*(L<.08?0:Math.min(1,(L-.08)*4));h+=(H-h)*Y*P,r+=(F-r)*Y*P;const W=Math.sqrt(h*h+r*r);W>0&&(h/=W,r/=W)}T+=h*c*P,y+=r*c*P,w=a+(i-a)*.5*L,L>=1&&(v=!0)}if(v){I+=16;const L=Math.min(1,I/d);w=a+(i-a)*(.5+.5*L);const H=1-L;if(m.setAlpha(.8*H),M.setAlpha(.9*H),L>=1){A.destroy(),m.destroy(),M.destroy();return}}const B=this.worldToScreen(T,y);m.setPosition(B.x,B.y),M.setPosition(B.x,B.y);const _=w*2/u.EFFECT_TEXTURE_SIZE;m.setScale(_),M.setScale(_*.7);const O=k/1e3*p;m.setRotation(O),M.setRotation(-O*.5);const X=this.monsterManager.getMonsters();for(const L of X){if(E.has(L.id))continue;const H=L.x-T,F=L.y-y,z=Math.sqrt(H*H+F*F),Y=this.gameBounds.height*L.definition.size*.5;if(z<=w+Y){E.add(L.id),this.monsterManager.damageMonster(L.id,n);const W=this.worldToScreen(L.x,L.y);this.showExplosionSparkEffect(W.x,W.y,u.PHANTOM_COLOR_LIGHT,.6)}}}})}dismissAllPhantoms(t=!1){const e=this.phantoms.map(s=>s.id);for(const s of e)this.dismissPhantomById(s,t)}showPhantomCurseExplosion(t,e){const a=this.gameBounds.height/10*2,i=this.skillManager.getEquippedAdvancedSkill(),n=(i==null?void 0:i.level)??1,o=this.currentLevel+n,h=u.DAMAGE_UNIT*o,r=this.worldToScreen(t,e),c=this.add.sprite(r.x,r.y,u.TEXTURE_CIRCLE);this.skillGridContainer.add(c),c.setDepth(60),c.setTint(u.PHANTOM_COLOR),c.setAlpha(.9),c.setScale(.1);const l=this.add.sprite(r.x,r.y,u.TEXTURE_CIRCLE);this.skillGridContainer.add(l),l.setDepth(61),l.setTint(u.PHANTOM_COLOR_LIGHT),l.setAlpha(1),l.setScale(.05);const d=a*2/u.EFFECT_TEXTURE_SIZE;this.tweens.add({targets:c,scaleX:d,scaleY:d,alpha:0,duration:400,ease:"Quad.easeOut",onComplete:()=>c.destroy()}),this.tweens.add({targets:l,scaleX:d*.7,scaleY:d*.7,alpha:0,duration:350,ease:"Quad.easeOut",onComplete:()=>l.destroy()});const p=this.monsterManager.getMonsters();for(const f of p){const g=f.x-t,m=f.y-e,M=Math.sqrt(g*g+m*m),S=this.gameBounds.height*f.definition.size*.5;M<=a+S&&this.monsterManager.damageMonster(f.id,h)}}setPhantomMoveTargetFor(t){const e=this.gameBounds.height/10,s=this.phantoms.length,a=Math.PI*2/s,i=t.sectorIndex*a,n=i+a,o=i+a/2,h=3*e,r=5*e,c=this.monsterManager.getMonsters();let l=o,d=0;for(const m of c){const M=m.x-this.characterX,S=m.y-this.characterY,E=Math.sqrt(M*M+S*S);let T=Math.atan2(S,M);T<0&&(T+=Math.PI*2);let y=!1;if(n<=Math.PI*2?y=T>=i&&T<n:y=T>=i||T<n-Math.PI*2,y&&E<10*e){const k=1/(1+E/e);l+=T*k,d+=k}}let p;d>0?p=l/(1+d):p=i+Math.random()*a;const f=a*.3;for(p+=(Math.random()-.5)*f;p<i;)p+=a;for(;p>=n;)p-=a;const g=h+Math.random()*(r-h);t.targetX=this.characterX+Math.cos(p)*g,t.targetY=this.characterY+Math.sin(p)*g,t.moving=!0,t.sprite&&t.sprite.anims&&t.sprite.play("char_run",!0)}startPhantomBurningCelluloid(t){const{baseDamage:e,phantomX:s,phantomY:a,skillLevel:i}=t,n=this.gameBounds.height*.3,o=15,h=o*Math.PI/180,r=u.PHANTOM_COLOR,c=12,l=80;for(let d=0;d<c;d++)this.time.delayedCall(d*l,()=>{const p=d/c*Math.PI*2;this.skillExecutor.performPhantomBurningCelluloidStep(s,a,p,n,h,e,i),this.flashSkillEffectSector(s,a,n,p,o,r)})}startPhantomTechArtist(t){const{baseDamage:e,phantomX:s,phantomY:a}=t,i=this.gameBounds.height/10,n=i*3,o=i*2,h=5,r=100;for(let c=0;c<h;c++)this.time.delayedCall(c*r,()=>{const l=Math.random()*Math.PI*2,d=Math.random()*n,p=s+Math.cos(l)*d,f=a+Math.sin(l)*d,g=(Math.random()-.5)*2*i,m=this.worldToScreen(p,f),M=-Math.PI/2-Math.atan2(g,m.y+50);this.showLightBeamEffect(p,f,o,u.PHANTOM_COLOR,g),this.time.delayedCall(150,()=>{const S=this.monsterManager.getMonsters(),E=[];for(const y of S){const k=y.x-p,v=y.y-f,I=Math.sqrt(k*k+v*v),w=i*y.definition.size*.5;I-w<=o&&E.push(y.id)}E.length>0&&this.monsterManager.stunMonsters(E,1e3);const T=this.skillExecutor.performPhantomTechArtistHit(p,f,o,e);this.showExplosionEffect(p,f,o,u.PHANTOM_COLOR,M,T.isCrit)})})}startPhantomPerfectPixel(t){const{baseDamage:e,phantomX:s,phantomY:a}=t,i=this.gameBounds.height/10,n=i*2,o=2,h=i*1.5,r=[{x:s-h,y:a-h},{x:s+h,y:a-h},{x:s-h,y:a+h},{x:s+h,y:a+h}];[0,1,2,3].sort(()=>Math.random()-.5).forEach((l,d)=>{this.time.delayedCall(d*250,()=>{const p=r[l],f=this.skillExecutor.performPhantomPerfectPixelExplosion(p.x,p.y,e,o),g=this.worldToScreen(p.x,p.y);if(this.showPhantomPerfectPixelExplosion(g.x,g.y,n),f.hitMonsters.length>0){const m=this.monsterManager.getMonsters();for(const M of f.hitMonsters){const S=m.find(E=>E.id===M);if(S){const E=this.worldToScreen(S.x,S.y);this.showExplosionSparkEffect(E.x,E.y,u.PHANTOM_COLOR_LIGHT,.8)}}}})})}showPhantomPerfectPixelExplosion(t,e,s){const a=[],n=s*1,o=this.add.sprite(t,e,u.TEXTURE_SECTOR_360);this.uiContainer.add(o),o.setDepth(1006),o.setTint(u.PHANTOM_COLOR),o.setScale(s*.5/u.EFFECT_TEXTURE_SIZE),o.setAlpha(.9),a.push(o);const h=this.add.sprite(t,e,u.TEXTURE_CIRCLE_LINE);this.uiContainer.add(h),h.setDepth(1005),h.setTint(u.PHANTOM_COLOR_LIGHT),h.setScale(s*.8/u.EFFECT_TEXTURE_SIZE),h.setAlpha(.7),a.push(h);const r=this.add.sprite(t,e,u.TEXTURE_CIRCLE_LINE);this.uiContainer.add(r),r.setDepth(1004),r.setTint(u.PHANTOM_COLOR_LIGHT),r.setScale(s*1.5/u.EFFECT_TEXTURE_SIZE),r.setAlpha(.35),a.push(r);const c=this.add.sprite(t,e,u.TEXTURE_LINE);this.uiContainer.add(c),c.setDepth(1007),c.setTint(u.PHANTOM_COLOR_LIGHT),c.setRotation(0),c.setScale(n*1.8/u.EFFECT_TEXTURE_SIZE,20/u.EFFECT_LINE_HEIGHT),c.setAlpha(.7),a.push(c);const l=this.add.sprite(t,e,u.TEXTURE_LINE);this.uiContainer.add(l),l.setDepth(1007),l.setTint(u.PHANTOM_COLOR_LIGHT),l.setRotation(Math.PI/2),l.setScale(n*1.8/u.EFFECT_TEXTURE_SIZE,20/u.EFFECT_LINE_HEIGHT),l.setAlpha(.7),a.push(l);for(const g of a)this.tweens.add({targets:g,alpha:0,duration:400,ease:"Power2",onComplete:()=>g.destroy()});const d=this.add.sprite(t,e,u.TEXTURE_SECTOR_360);this.uiContainer.add(d),d.setDepth(1005),d.setTint(u.PHANTOM_COLOR);const p=s*.5/u.EFFECT_TEXTURE_SIZE,f=s*1.5/u.EFFECT_TEXTURE_SIZE;d.setScale(p),d.setAlpha(.8),this.tweens.add({targets:d,scale:f,alpha:0,duration:250,ease:"Power2",onComplete:()=>d.destroy()})}phantomCastVfxBurstAt(t,e,s){const a=this.monsterManager.getMonsters();if(a.length===0)return;const i=a.map(n=>{const o=n.x-e,h=n.y-s;return{monster:n,dist:Math.sqrt(o*o+h*h)}}).sort((n,o)=>n.dist-o.dist).slice(0,5);for(let n=0;n<Math.min(5,i.length);n++)this.time.delayedCall(n*100,()=>{const o=i[n%i.length].monster;this.launchPhantomMissileAt(o.id,t,e,s)})}launchPhantomMissileAt(t,e,s,a){const i=this.gameBounds.height/10,n=this.gameBounds.height*.15,o=this.add.graphics();this.skillGridContainer.add(o),o.setDepth(100);const h=this.worldToScreen(s,a),r={screenX:h.x,screenY:h.y,rotation:0},c=i*.05;let l=i*.25;const d=()=>{o.clear(),o.save(),o.translateCanvas(r.screenX,r.screenY),o.rotateCanvas(r.rotation);const S=l/2,E=[3346824,4465305,5579434,6697915,7816396,8934877],T=l/6;for(let y=0;y<6;y++)o.fillStyle(E[y],.8),o.fillRect(-S+y*T,-c/2,T+1,c);o.restore()},f=this.monsterManager.getMonsters().find(S=>S.id===t);if(!f){o.destroy();return}const g=Math.random()*Math.PI*2;r.rotation=g;const m=r.screenX+Math.cos(g)*n,M=r.screenY+Math.sin(g)*n;d(),this.tweens.add({targets:r,screenX:m,screenY:M,duration:300,ease:"Quad.easeOut",onUpdate:d,onComplete:()=>{const S=this.worldToScreen(f.x,f.y),E=S.x-r.screenX,T=S.y-r.screenY;r.rotation=Math.atan2(T,E),l=i*1.5,this.tweens.add({targets:r,screenX:S.x,screenY:S.y,duration:400,ease:"Linear",onUpdate:d,onComplete:()=>{const k=this.monsterManager.getMonsters().find(v=>v.id===t);if(k){const{damage:v}=this.skillManager.calculateFinalDamageWithCrit(e,this.currentLevel),I=this.monsterManager.damageMonsters([k.id],v);I.totalExp>0&&this.addExp(I.totalExp)}this.showMissileExplosion(r.screenX,r.screenY,!1),o.destroy()}})}})}phantomCastSoulSlashAt(t,e,s){const a=this.monsterManager.getMonsters();if(a.length===0)return;let i=a[0],n=1/0;for(const S of a){const E=S.x-e,T=S.y-s,y=Math.sqrt(E*E+T*T);y<n&&(n=y,i=S)}const o=i.x-e,h=i.y-s,r=Math.atan2(h,o),c=Math.max(this.gameBounds.width,this.gameBounds.height)*2,l=e-Math.cos(r)*c,d=s-Math.sin(r)*c,p=e+Math.cos(r)*c,f=s+Math.sin(r)*c;this.drawPhantomSoulSlashEffect(l,d,p,f,r,e,s);const g=[],m=[],M=this.gameBounds.height*.05;for(const S of a){const E=this.pointToLineDistance(S.x,S.y,l,d,p,f),T=this.gameBounds.height*S.definition.size*.5;E<=M+T&&(g.push(S.id),m.push({x:S.x,y:S.y}))}if(g.length>0){const{damage:S,isCrit:E}=this.skillManager.calculateFinalDamageWithCrit(t,this.currentLevel),T=this.monsterManager.damageMonsters(g,S);T.totalExp>0&&this.addExp(T.totalExp)}}drawPhantomSoulSlashEffect(t,e,s,a,i,n,o){const h=this.worldToScreen(t,e),r=this.worldToScreen(s,a),c=this.add.graphics();this.skillGridContainer.add(c),c.setDepth(60);const l=u.PHANTOM_COLOR;c.lineStyle(12,l,.3),c.beginPath(),c.moveTo(h.x,h.y),c.lineTo(r.x,r.y),c.strokePath(),c.lineStyle(6,l,.6),c.beginPath(),c.moveTo(h.x,h.y),c.lineTo(r.x,r.y),c.strokePath(),c.lineStyle(2,16777215,.9),c.beginPath(),c.moveTo(h.x,h.y),c.lineTo(r.x,r.y),c.strokePath(),this.tweens.add({targets:c,alpha:0,duration:150,onComplete:()=>{c.destroy()}});const d=this.worldToScreen(n,o);this.showPhantomSlashFlashEffect(d.x,d.y,i)}showPhantomSlashFlashEffect(t,e,s){const a=this.add.graphics();this.skillGridContainer.add(a),a.setDepth(61);const i=this.gameBounds.height*.1;a.lineStyle(4,u.PHANTOM_COLOR,.8),a.beginPath(),a.arc(t,e,i,s-.3,s+.3,!1),a.strokePath(),a.lineStyle(2,16777215,1),a.beginPath(),a.arc(t,e,i*.8,s-.2,s+.2,!1),a.strokePath(),this.tweens.add({targets:a,alpha:0,duration:100,onComplete:()=>{a.destroy()}})}pointToSegmentDistance(t,e,s,a,i,n){const o=i-s,h=n-a,r=o*o+h*h;if(r===0)return Math.sqrt((t-s)*(t-s)+(e-a)*(e-a));let c=((t-s)*o+(e-a)*h)/r;c=Math.max(0,Math.min(1,c));const l=s+c*o,d=a+c*h;return Math.sqrt((t-l)*(t-l)+(e-d)*(e-d))}showPhantomSpawnEffectAt(t,e){const s=this.worldToScreen(t,e),i=this.gameBounds.height/10*.5,n=this.add.sprite(s.x,s.y,u.TEXTURE_LINE);n.setOrigin(.5,1),n.setTint(12290303),this.skillGridContainer.add(n),n.setDepth(60);const o=4,h=o/u.EFFECT_TEXTURE_SIZE,r=o/u.EFFECT_LINE_HEIGHT;n.setScale(h,r),n.setAlpha(1);const c=i/u.EFFECT_TEXTURE_SIZE,l=i/u.EFFECT_LINE_HEIGHT;this.tweens.add({targets:n,scaleX:c,scaleY:l,duration:150,ease:"Power2.easeOut",onComplete:()=>{const d=i*3,p=d/u.EFFECT_LINE_HEIGHT,f=c*.1;this.tweens.add({targets:n,scaleX:f,scaleY:p,alpha:0,y:s.y-d*.5,duration:250,ease:"Power2.easeIn",onComplete:()=>n.destroy()})}})}showPhantomCastEffectAt(t,e){const s=this.worldToScreen(t,e),a=this.add.graphics();this.skillGridContainer.add(a),a.fillStyle(12290303,.6),a.fillCircle(s.x,s.y,20),this.tweens.add({targets:a,alpha:0,duration:200,onComplete:()=>a.destroy()})}dismissPhantomById(t,e=!1){const s=this.phantoms.findIndex(m=>m.id===t);if(s===-1)return;const a=this.phantoms[s];a.flashTimer&&a.flashTimer.destroy(),a.skillTimer&&a.skillTimer.destroy(),a.tauntTimer&&a.tauntTimer.destroy();const i=a.x,n=a.y;this.phantoms.splice(s,1),this.reassignPhantomSectors(),this.updatePhantomTauntTarget(),e&&this.showPhantomCurseExplosion(i,n);const o=this.worldToScreen(a.x,a.y),r=this.gameBounds.height/10*.5,c=this.add.sprite(o.x,o.y,u.TEXTURE_LINE);c.setOrigin(.5,1),c.setTint(u.PHANTOM_COLOR),this.skillGridContainer.add(c),c.setDepth(60);const l=4,d=l/u.EFFECT_TEXTURE_SIZE,p=l/u.EFFECT_LINE_HEIGHT;c.setScale(d,p),c.setAlpha(1);const f=r/u.EFFECT_TEXTURE_SIZE,g=r/u.EFFECT_LINE_HEIGHT;this.tweens.add({targets:c,scaleX:f,scaleY:g,duration:150,ease:"Power2.easeOut",onComplete:()=>{const m=r*3,M=m/u.EFFECT_LINE_HEIGHT,S=f*.1;this.tweens.add({targets:c,scaleX:S,scaleY:M,alpha:0,y:o.y-m*.5,duration:250,ease:"Power2.easeIn",onComplete:()=>c.destroy()})}}),a.sprite.destroy()}createAfterimage(t){const e=this.worldToScreen(t.x,t.y),s=this.add.sprite(e.x,e.y,"char_idle_1");s.setOrigin(.5,1),s.setScale(t.sprite.scaleX,t.sprite.scaleY),s.setFlipX(t.sprite.flipX),s.setAlpha(.3),s.setTint(u.PHANTOM_COLOR),this.skillGridContainer.add(s),s.setDepth(54),this.tweens.add({targets:s,alpha:0,duration:300,onComplete:()=>s.destroy()})}updateZeroTrustVisual(t){if(this.isPaused)return;const e=this.skillManager.getEquippedAdvancedSkill();if(!e||e.definition.id!=="advanced_zero_trust"){this.zeroTrustActive&&this.skillExecutor.deactivateZeroTrust();return}this.zeroTrustActive||this.skillExecutor.activateZeroTrust(e.level),this.updateZeroTrust(e.level,t)}updatePhantomVisual(t){if(this.isPaused)return;const e=this.time.now;for(const s of this.phantoms){if(s.moving){const i=s.targetX-s.x,n=s.targetY-s.y,o=Math.sqrt(i*i+n*n),r=this.moveSpeed*4*t/1e3;if(o<=r)s.x=s.targetX,s.y=s.targetY,s.moving=!1,s.sprite.anims&&s.sprite.play("char_idle",!0);else{const c=r/o;s.x+=i*c,s.y+=n*c,i<0?s.sprite.setFlipX(!0):i>0&&s.sprite.setFlipX(!1),e-s.lastAfterimageTime>50&&(this.createAfterimage(s),s.lastAfterimageTime=e)}}const a=this.worldToScreen(s.x,s.y);s.sprite.setPosition(a.x,a.y),s.sprite.setScale(this.character.scaleX,this.character.scaleY)}}getPhantomPosition(){if(this.phantoms.length>0){const t=this.phantoms[0];return{x:t.x,y:t.y,active:!0}}return{x:0,y:0,active:!1}}updateTimerDisplay(){const t=Math.floor(this.gameTimer/1e3),e=Math.floor(t/60),s=t%60,a=`${e.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;this.timerText.setText(a)}createSkillInfoPanel(){const t=this.gameBounds,e=200,s=80,a=t.width*.05,i=t.x+a,n=t.y+t.height-s-a-60;this.skillInfoPanel=this.add.container(i,n),this.skillInfoPanel.setDepth(1003),this.skillInfoBg=this.add.rectangle(0,0,e,s,0,.7),this.skillInfoBg.setOrigin(0,0),this.skillInfoBg.setStrokeStyle(1,6710886),this.skillInfoPanel.add(this.skillInfoBg);const o=10,h=Math.max(u.MIN_FONT_SIZE_SMALL,12);this.skillInfoText=this.add.text(o,o,"",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${h}px`,color:"#ffffff",wordWrap:{width:e-o*2}}),this.skillInfoText.setResolution(2),this.skillInfoPanel.add(this.skillInfoText),this.skillInfoPanel.setVisible(!1),this.uiContainer.add(this.skillInfoPanel)}setupSkillIconInteractions(){const t=u.ACTIVE_SKILLS;for(let e=0;e<this.skillIconContainers.length;e++){const s=this.skillIconContainers[e],a=e<t,i=a?e:e-t;s.setSize(s.getBounds().width,s.getBounds().height),s.setInteractive({useHandCursor:!0}),s.on("pointerdown",()=>{this.showSkillInfo(a,i)})}}showSkillInfo(t,e){const a=(t?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills())[e];if(!a){this.skillInfoPanel.setVisible(!1);return}const i=[];i.push(`【${a.definition.name}】${ut.formatLevel(a.level,a.definition.maxLevel)}`),t?this.appendActiveSkillInfo(i,a):this.appendPassiveSkillInfo(i,a),this.skillInfoText.setText(i.join(`
`));const n=this.skillInfoText.getBounds(),o=10;this.skillInfoBg.setSize(Math.max(180,n.width+o*2),n.height+o*2),this.skillInfoPanel.setVisible(!0),this.skillInfoHideTimer&&this.skillInfoHideTimer.destroy(),this.skillInfoHideTimer=this.time.delayedCall(3e3,()=>{this.skillInfoPanel.setVisible(!1)})}showAdvancedSkillInfo(t){const e=t.definition,s=t.level,a=this.skillManager.getSyncRateCooldownReduction(),i=this.skillManager.getAiEnhancementDamageBonus(),n=[];if(n.push(`【${e.name}】${ut.formatLevel(s,e.maxLevel)}`),e.subtitle&&n.push(e.subtitle),e.id==="advanced_burning_celluloid"){const r=this.currentLevel+s,c=u.DAMAGE_UNIT*r,l=Math.floor(c*(1+i)),p=(e.cooldown*(1-a)/1e3).toFixed(1);n.push("HP 消耗: 10"),n.push(`傷害: ${r} 單位（${l}）`),n.push("範圍: 7 單位 / 30°"),n.push(`冷卻: ${p}s`)}else if(e.id==="advanced_tech_artist"){const r=this.currentLevel+s,c=u.DAMAGE_UNIT*r,l=Math.floor(c*(1+i)),p=(e.cooldown*(1-a)/1e3).toFixed(1);n.push(`傷害: ${r} 單位（${l}）`),n.push("範圍: 5 單位隨機 / 3 單位爆炸"),n.push("癱瘓: 1s"),n.push(`冷卻: ${p}s`)}else if(e.id==="advanced_absolute_defense"){const r=this.currentLevel+s,c=u.DAMAGE_UNIT*r,l=Math.floor(c*(1+i)),d=8,p=Math.min(d,3+Math.floor(s/5));let f=.01;p>=d&&(f=.01-(s-25)*.001);const g=Math.ceil(this.maxShield*Math.abs(f)),m=(f*100).toFixed(1)+"%",M=f>=0?"撞敵耗盾":"撞敵回盾";n.push(`傷害: ${r} 單位（${l}）`),n.push(`輪鋸數量: ${p} / 6（技能Lv${s}）`),n.push("旋轉速度: 2 秒/圈"),n.push(`${M}: ${g} (${m})`),n.push(`當前護盾: ${this.currentShield}/${this.maxShield}`)}else if(e.id==="advanced_perfect_pixel"){const r=this.currentLevel+s,c=u.DAMAGE_UNIT*r,l=Math.floor(c*(1+i)),p=(e.cooldown*(1-a)/1e3).toFixed(1);n.push(`傷害: ${r} 單位（${l}）`),n.push("爆炸範圍: 3 單位"),n.push("焦點輪轉: 四焦點循環"),n.push("暈眩: 1s"),n.push(`冷卻: ${p}s`)}else if(e.id==="advanced_vfx_burst"){const r=this.currentLevel+s,c=u.DAMAGE_UNIT*r,l=Math.floor(c*(1+i)),p=(e.cooldown*(1-a)/1e3).toFixed(1),f=20;n.push(`導彈數量: ${f} 枚`),n.push(`單發傷害: ${r} 單位（${l}）`),n.push(`總傷害: ${l*f}`),n.push(`冷卻: ${p}s`)}else if(e.id==="advanced_zero_trust"){const r=this.currentLevel+s,c=u.DAMAGE_UNIT*r,l=Math.floor(c*(1+i));n.push(`基礎傷害: ${r} 單位（${l}）`),n.push(`鎖敵加成: 每秒 +${s}% 傷害`),n.push("光束加粗: 每秒 x2, x3, x4..."),n.push("傷害範圍: 1 + 每秒 +0.5 單位"),n.push("減速效果: 50%")}else if(e.id==="advanced_phantom_iteration"){const r=Math.floor(s/5)+10,l=(e.cooldown*(1-a)/1e3).toFixed(1),d=r>parseFloat(l);if(n.push(`持續時間: ${r} 秒 (Sk${s}/5+10)`),n.push(`冷卻: ${l}s`),n.push("分身行為: 每0.5秒施放隨機技能"),n.push("可用技: 賽璐珞/美術/特效/彈射"),n.push("嘲諷: 每5秒吸引怪物2秒"),d)n.push("狀態: 可多分身重疊！");else{const p=Math.ceil((parseFloat(l)-8+1)*5);n.push(`狀態: Lv${p} 開始可重疊`)}}else if(e.id==="advanced_soul_slash"){const r=this.currentLevel+s,c=u.DAMAGE_UNIT*r,l=Math.floor(c*(1+i)),p=(e.cooldown*(1-a)/1e3).toFixed(1);n.push(`傷害: ${r} 單位（${l}）`),n.push("範圍: 貫穿全螢幕直線"),n.push("寬度: 0.5 單位"),n.push(`冷卻: ${p}s`)}this.skillInfoText.setText(n.join(`
`));const o=this.skillInfoText.getBounds(),h=10;this.skillInfoBg.setSize(Math.max(180,o.width+h*2),o.height+h*2),this.skillInfoPanel.setVisible(!0),this.skillInfoHideTimer&&this.skillInfoHideTimer.destroy(),this.skillInfoHideTimer=this.time.delayedCall(3e3,()=>{this.skillInfoPanel.setVisible(!1)})}appendActiveSkillInfo(t,e){const s=e.level,a=this.skillManager.getAiEnhancementDamageBonus(),i=this.skillManager.getSyncRateCooldownReduction();switch(e.definition.id){case"active_soul_render":{const n=60+s*10,o=this.skillManager.getAdvancedSkillBonusForActiveSkill(e.definition.id),h=2+s+o,r=u.DAMAGE_UNIT*h,c=Math.floor(r*(1+a)),d=((e.definition.cooldown||1e3)*(1-i)/1e3).toFixed(1);t.push(`扇形角度: ${n}°`),t.push("射程: 3 單位"),t.push(`傷害: ${c}${o>0?` (+${o}組合)`:""}`),t.push(`冷卻: ${d}s`);break}case"active_coder":{const n=3+s*.5,o=this.skillManager.getAdvancedSkillBonusForActiveSkill(e.definition.id),h=(1+s)*2+o,r=u.DAMAGE_UNIT*h,c=Math.floor(r*(1+a)),d=((e.definition.cooldown||2e3)*(1-i)/1e3).toFixed(1);t.push(`範圍: ${n} 單位`),t.push(`傷害: ${c}${o>0?` (+${o}組合)`:""}`),t.push(`冷卻: ${d}s`);break}case"active_vfx":{const n=s>=e.definition.maxLevel,o=this.skillManager.getAdvancedSkillBonusForActiveSkill(e.definition.id),h=1+s+o,r=u.DAMAGE_UNIT*h,c=Math.floor(r*(1+a)),d=((e.definition.cooldown||2500)*(1-i)/1e3).toFixed(1);n?(t.push("精準鎖定: 3 道超粗射線"),t.push("射程: 15 單位")):(t.push(`光束數: ${s+1} 道`),t.push("射程: 10 單位")),t.push(`傷害: ${c}${o>0?` (+${o}組合)`:""}`),t.push(`冷卻: ${d}s`);break}case"active_architect":{const o=Math.floor(this.maxHp*.3),h=[2,4,6,8,10,20],r=this.skillManager.getAdvancedSkillBonusForActiveSkill(e.definition.id),c=(h[s]||2)+r,l=u.DAMAGE_UNIT*c,p=((e.definition.cooldown||1e4)*(1-i)/1e3).toFixed(1);t.push(`護盾: ${o} (霸體)`),t.push(`反傷: ${l}${r>0?` (+${r}組合)`:""} + 擊退 1 單位`),t.push(`護盾消失回血: ${o}`),t.push(`冷卻: ${p}s`);break}}this.appendMaxExtraAbility(t,e)}appendMaxExtraAbility(t,e){const s=this.skillManager.getMaxExtraAbilityText(e.definition.id,this.currentLevel);s&&(t.push(""),t.push(s))}appendPassiveSkillInfo(t,e){switch(e.definition.id){case"passive_titanium_liver":{const s=this.skillManager.getTitaniumLiverHpBonus(),a=this.skillManager.getTitaniumLiverRegenInterval()/1e3;if(t.push(`HP 加成: +${Math.round(s*100)}%`),t.push(`最大 HP: ${this.maxHp}`),t.push(`回復: 每 ${a} 秒 +1% HP`),this.skillManager.hasTitaniumLiverRevive()){const i=this.reviveUsed?"(已使用)":"(待命)";t.push(`【不死】抵銷一次死亡 ${i}`)}break}case"passive_sync_rate":{const s=this.skillManager.getSyncRateSpeedBonus(),a=this.skillManager.getSyncRateCooldownReduction();t.push(`移速加成: +${Math.round(s*100)}%`),t.push(`冷卻減少: -${Math.round(a*100)}%`);break}case"passive_retina_module":{const s=this.skillManager.getRetinaModuleExpBonus(),a=this.skillManager.getRetinaModulePickupBonus();t.push(`經驗加成: +${Math.round(s*100)}%`),t.push(`拾取範圍: +${a} 單位`);break}case"passive_ai_enhancement":{const s=this.skillManager.getAiEnhancementDamageBonus(),a=this.skillManager.getAiEnhancementDefenseBonus();t.push(`攻擊加成: +${Math.round(s*100)}%`),t.push(`防禦加成: +${Math.round(a*100)}%`);break}}this.appendMaxExtraAbility(t,e)}updateSkillBarDisplay(){const t=this.skillManager.getPlayerActiveSkills(),e=this.skillManager.getPlayerPassiveSkills(),s=[...t,...e],a=this.skillGridCellSize,i=u.SKILL_GRID_GAP,o=8*(a+i)-i;for(let h=0;h<this.skillIconContainers.length;h++){const r=this.skillIconContainers[h],c=this.skillLevelTexts[h],l=s[h],d=r.list[1],p=this.skillIconSprites[h];if(l)if(d.setFillStyle(l.definition.color,.5),c.setText(ut.formatLevel(l.level,l.definition.maxLevel)),l.definition.iconPrefix){const g=l.definition.iconPrefix.startsWith("P")?`skill_icon_${l.definition.iconPrefix}`:`skill_icon_${l.definition.iconPrefix}${l.level.toString().padStart(2,"0")}`;if(this.textures.exists(g)){if(p)p.setTexture(g),p.setVisible(!0);else{const m=this.add.sprite(0,0,g);m.setOrigin(.5,.5);const S=(o-8)/Math.max(m.width,m.height);m.setScale(S),r.addAt(m,2),this.skillIconSprites[h]=m}d.setAlpha(0)}else p&&p.setVisible(!1),d.setAlpha(1)}else p&&p.setVisible(!1),d.setAlpha(1);else d.setFillStyle(3355443,0),d.setAlpha(1),c.setText(""),p&&p.setVisible(!1)}}createCharacterAnimations(){this.anims.create({key:"char_idle",frames:[{key:"char_idle_1"},{key:"char_idle_2"}],frameRate:2,repeat:-1}),this.anims.create({key:"char_run",frames:[{key:"char_run_1"},{key:"char_run_2"}],frameRate:8,repeat:-1}),this.anims.create({key:"char_attack",frames:[{key:"char_attack_1"},{key:"char_attack_2"}],frameRate:8,repeat:0}),this.anims.create({key:"char_hurt",frames:[{key:"char_hurt"}],frameRate:2,repeat:0})}updateCharacterSprite(){this.character.setPosition(this.characterX,this.characterY),this.character.setScale((this.facingRight?1:-1)*(this.characterSize/this.character.height),this.characterSize/this.character.height)}setCharacterState(t,e=!1){this.characterState!==t&&(this.isHurt&&!e&&t!=="hurt"||this.isAttacking&&!e&&t!=="hurt"||(this.characterState=t,this.character.play(`char_${t}`)))}updateCharacterFacing(t){t>this.characterX?this.facingRight=!0:t<this.characterX&&(this.facingRight=!1)}createModePanel(){this.modePanelContainer=this.add.container(0,0),this.modePanelContainer.setVisible(!1),this.uiContainer.add(this.modePanelContainer);const t=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0,.8);t.setInteractive(),this.modePanelContainer.add(t);const e=this.gameBounds.y+this.gameBounds.height*.12,s=this.add.text(this.gameBounds.x+this.gameBounds.width/2,e,"選擇難度",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(this.gameBounds.height*.07))}px`,color:"#ffffff",fontStyle:"bold"});s.setResolution(2),s.setOrigin(.5,.5),this.modePanelContainer.add(s);const a=e+this.gameBounds.height*.06,i=this.add.text(this.gameBounds.x+this.gameBounds.width/2,a,"挑戰更高難度獲得更多經驗",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.025))}px`,color:"#cccccc"});i.setResolution(2),i.setOrigin(.5,.5),this.modePanelContainer.add(i),this.createModeOptions();const n=this.gameBounds.y+this.gameBounds.height*.92,o=this.isMobile?"點兩次確認":"重複按同一鍵確認",h=this.add.text(this.gameBounds.x+this.gameBounds.width/2,n,o,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.022))}px`,color:"#888888"});h.setResolution(2),h.setOrigin(.5,.5),this.modePanelContainer.add(h)}createModeOptions(){this.modeCardBgs=[],this.modeCardContainers=[],this.modeCardImages=[];const t=this.gameBounds.width*.25,e=this.gameBounds.height*(this.isMobile?.55:.5),s=this.gameBounds.width*.05,a=u.GAME_MODES.length,i=t*a+s*(a-1),n=this.gameBounds.x+(this.gameBounds.width-i)/2+t/2,o=this.gameBounds.y+this.gameBounds.height*.55,h=["1","2","3"];for(let r=0;r<a;r++){const c=u.GAME_MODES[r],l=n+r*(t+s),d=this.add.container(l,o);this.modeCardContainers.push(d);const p=this.add.rectangle(0,0,t,e,2236962);if(p.setStrokeStyle(2,c.color),d.add(p),this.modeCardBgs.push(p),this.textures.exists(c.image)){const T=this.add.sprite(0,0,c.image),y=t/T.width,k=e/T.height,v=Math.max(y,k),I=t/v,w=e/v,A=(T.width-I)/2,P=(T.height-w)/2;T.setCrop(A,P,I,w),T.setScale(v),T.setAlpha(.6),T.setData("baseScale",v),T.setData("cropX",A),T.setData("cropY",P),T.setData("cropWidth",I),T.setData("cropHeight",w),d.add(T),this.modeCardImages.push(T)}else this.modeCardImages.push(null);const f=-e*.35,g=this.add.text(0,f,c.name,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(e*.15))}px`,color:"#"+c.color.toString(16).padStart(6,"0"),fontStyle:"bold"});g.setResolution(2),g.setOrigin(.5,.5),d.add(g);const m=e*.35,M=this.add.text(0,m,c.description,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(e*.055))}px`,color:"#ffffff",wordWrap:{width:t*.85},align:"center"});M.setResolution(2),M.setOrigin(.5,.5),d.add(M);const S=e*.5+e*.08,E=this.add.text(0,S,`[ ${h[r]} ]`,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(e*.06))}px`,color:"#ffff00",fontStyle:"bold"});E.setResolution(2),E.setOrigin(.5,.5),d.add(E),p.setInteractive({useHandCursor:!0}),p.on("pointerdown",()=>this.onModeCardClick(r)),p.on("pointerover",()=>this.onModeCardHover(r)),this.modePanelContainer.add(d)}this.updateModeCardStyle(0,!0)}updateModeCardStyle(t,e){const s=this.modeCardBgs[t],a=this.modeCardContainers[t],i=this.modeCardImages[t];if(!s||!a)return;const n=u.GAME_MODES[t];if(e){if(s.setFillStyle(3355443),s.setStrokeStyle(3,n.color),this.tweens.add({targets:a,scaleX:1.05,scaleY:1.05,duration:100}),i){i.setTint(16777215),i.setAlpha(.8);const o=i.getData("baseScale")||1,h=i.getData("cropX")||0,r=i.getData("cropY")||0,c=i.getData("cropWidth")||i.width,l=i.getData("cropHeight")||i.height,d=1.1,p=c/d,f=l/d,g=h+(c-p)/2,m=r+(l-f)/2;i.setCrop(g,m,p,f),this.tweens.add({targets:i,scaleX:o*d,scaleY:o*d,duration:100})}}else if(s.setFillStyle(2236962),s.setStrokeStyle(2,n.color),this.tweens.add({targets:a,scaleX:1,scaleY:1,duration:100}),i){i.setTint(6710886),i.setAlpha(.4);const o=i.getData("baseScale")||1,h=i.getData("cropX")||0,r=i.getData("cropY")||0,c=i.getData("cropWidth")||i.width,l=i.getData("cropHeight")||i.height;i.setCrop(h,r,c,l),this.tweens.add({targets:i,scaleX:o,scaleY:o,duration:100})}}onModeCardHover(t){this.isModeSelecting||this.selectedModeIndex!==t&&(this.updateModeCardStyle(this.selectedModeIndex,!1),this.selectedModeIndex=t,this.updateModeCardStyle(t,!0))}onModeCardClick(t){if(!this.isModeSelecting){if(this.selectedModeIndex===t){this.confirmModeSelection(t);return}this.updateModeCardStyle(this.selectedModeIndex,!1),this.selectedModeIndex=t,this.updateModeCardStyle(t,!0)}}confirmModeSelection(t){this.isModeSelecting||(this.isModeSelecting=!0,this.currentGameMode=u.GAME_MODES[t],this.hasModeSelected=!0,this.monsterManager.setDifficultyMultiplier(this.currentGameMode.multiplier),this.monsterManager.setSpeedMultiplier(this.currentGameMode.speedMultiplier),this.monsterManager.setHpMultiplier(this.currentGameMode.hpMultiplier),this.monsterManager.setDamageMultiplier(this.currentGameMode.damageMultiplier),this.monsterManager.setDebuffResistance(this.currentGameMode.debuffResistance),this.monsterManager.setWaveBaseCount(this.currentGameMode.waveCount),this.tweens.add({targets:this.modePanelContainer,alpha:0,duration:200,onComplete:()=>{this.modePanelContainer.setVisible(!1),this.isModeSelecting=!1,this.monsterManager.startSpawning(),this.pendingSkillPoints=1,this.tryShowSkillPanel()}}))}showModePanel(){this.isPaused=!0,this.isModeSelecting=!1,this.selectedModeIndex=0,this.modeCardBgs.forEach((t,e)=>{this.updateModeCardStyle(e,e===0)}),this.modePanelContainer.setVisible(!0),this.modePanelContainer.setAlpha(0),this.tweens.add({targets:this.modePanelContainer,alpha:1,duration:200})}handleModePanelInput(){!this.modePanelContainer||!this.modePanelContainer.visible||this.keyOne&&(G.Input.Keyboard.JustDown(this.keyOne)&&(this.selectedModeIndex===0?this.confirmModeSelection(0):(this.updateModeCardStyle(this.selectedModeIndex,!1),this.selectedModeIndex=0,this.updateModeCardStyle(0,!0))),G.Input.Keyboard.JustDown(this.keyTwo)&&(this.selectedModeIndex===1?this.confirmModeSelection(1):(this.updateModeCardStyle(this.selectedModeIndex,!1),this.selectedModeIndex=1,this.updateModeCardStyle(1,!0))),G.Input.Keyboard.JustDown(this.keyThree)&&(this.selectedModeIndex===2?this.confirmModeSelection(2):(this.updateModeCardStyle(this.selectedModeIndex,!1),this.selectedModeIndex=2,this.updateModeCardStyle(2,!0))))}createSkillPanel(){this.skillPanelContainer=this.add.container(0,0),this.skillPanelContainer.setVisible(!1),this.uiContainer.add(this.skillPanelContainer);const t=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0,.8);t.setInteractive(),this.skillPanelContainer.add(t);const e=this.gameBounds.y+this.gameBounds.height*.12,s=this.add.text(this.gameBounds.x+this.gameBounds.width/2,e,"選擇技能",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(this.gameBounds.height*.07))}px`,color:"#ffffff",fontStyle:"bold"});s.setResolution(2),s.setOrigin(.5,.5),this.skillPanelContainer.add(s);const a=e+this.gameBounds.height*.06,i=this.add.text(this.gameBounds.x+this.gameBounds.width/2,a,"提升你的數位能力",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.025))}px`,color:"#cccccc"});i.setResolution(2),i.setOrigin(.5,.5),this.skillPanelContainer.add(i),this.createSkillOptions();const n=this.gameBounds.y+this.gameBounds.height*.92,o=this.isMobile?"點兩次確認":"重複按同一鍵確認",h=this.add.text(this.gameBounds.x+this.gameBounds.width/2,n,o,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.022))}px`,color:"#888888"});h.setResolution(2),h.setOrigin(.5,.5),this.skillPanelContainer.add(h)}createSkillCutIn(){this.skillCutInContainer=this.add.container(0,0),this.skillCutInContainer.setVisible(!1),this.skillCutInContainer.setDepth(1e3),this.uiContainer.add(this.skillCutInContainer)}showSkillCutIn(t,e){this.skillCutInContainer.removeAll(!0);const s=this.gameBounds.height*.22,a=this.gameBounds.y+this.gameBounds.height*.25,i=this.gameBounds.width*.15,n=this.gameBounds.width-i*2,o=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,a,n,s,0,.75);this.skillCutInContainer.add(o);const h=this.add.graphics(),r=this.gameBounds.x,c=this.gameBounds.x+i,l=20;for(let w=0;w<l;w++){const A=w/l*.75,P=r+i/l*w,b=i/l+1;h.fillStyle(0,A),h.fillRect(P,a-s/2,b,s)}this.skillCutInContainer.add(h);const d=this.add.graphics(),p=this.gameBounds.x+this.gameBounds.width-i;for(let w=0;w<l;w++){const A=(1-w/l)*.75,P=p+i/l*w,b=i/l+1;d.fillStyle(0,A),d.fillRect(P,a-s/2,b,s)}this.skillCutInContainer.add(d);const f=3,g=this.add.graphics(),m=a-s/2-f/2;for(let w=0;w<l;w++){const A=w/l*.8,P=r+i/l*w,b=i/l+1;g.fillStyle(t.color,A),g.fillRect(P,m,b,f)}g.fillStyle(t.color,.8),g.fillRect(c,m,n,f);for(let w=0;w<l;w++){const A=(1-w/l)*.8,P=p+i/l*w,b=i/l+1;g.fillStyle(t.color,A),g.fillRect(P,m,b,f)}this.skillCutInContainer.add(g);const M=this.add.graphics(),S=a+s/2-f/2;for(let w=0;w<l;w++){const A=w/l*.8,P=r+i/l*w,b=i/l+1;M.fillStyle(t.color,A),M.fillRect(P,S,b,f)}M.fillStyle(t.color,.8),M.fillRect(c,S,n,f);for(let w=0;w<l;w++){const A=(1-w/l)*.8,P=p+i/l*w,b=i/l+1;M.fillStyle(t.color,A),M.fillRect(P,S,b,f)}this.skillCutInContainer.add(M);const E=t.maxLevel>0&&e>=t.maxLevel?"MAX":`Lv.${e}`,T=`${t.name} 提升到 ${E}`,y=this.add.text(this.gameBounds.x+this.gameBounds.width/2,a-s*.3,T,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(s*.26))}px`,color:"#ffffff",fontStyle:"bold"});y.setResolution(2),y.setOrigin(.5,.5),this.skillCutInContainer.add(y);let k="";if(t.levelUpQuotes&&t.levelUpQuotes[e]&&(k=t.levelUpQuotes[e]),k){const w=this.add.text(this.gameBounds.x+this.gameBounds.width/2,a+s*.05,k,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(s*.23))}px`,color:"#ffffff"});w.setResolution(2),w.setOrigin(.5,.5),this.skillCutInContainer.add(w)}let v=t.description;t.levelUpMessages&&t.levelUpMessages[e]&&(v=t.levelUpMessages[e]);const I=this.add.text(this.gameBounds.x+this.gameBounds.width/2,a+s*.25,v,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(s*.15))}px`,color:G.Display.Color.IntegerToColor(t.color).rgba});if(I.setResolution(2),I.setOrigin(.5,.5),this.skillCutInContainer.add(I),e>=t.maxLevel&&t.maxExtraAbility){const w=t.maxExtraAbility,A=w.isPercentage?(w.perLevel*100).toFixed(2):w.perLevel.toFixed(2);let P=`【${w.name}】${w.description.replace("{value}",`角色每級 +${A}${w.unit}`)}`;const b=this.add.text(this.gameBounds.x+this.gameBounds.width/2,a+s*.42,P,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(s*.13))}px`,color:"#ffcc00"});b.setResolution(2),b.setOrigin(.5,.5),this.skillCutInContainer.add(b)}this.skillCutInContainer.setX(-this.gameBounds.width),this.skillCutInContainer.setVisible(!0),this.skillCutInContainer.setAlpha(1),this.tweens.add({targets:this.skillCutInContainer,x:0,duration:250,ease:"Power2.easeOut",onComplete:()=>{this.time.delayedCall(2e3,()=>{this.tweens.add({targets:this.skillCutInContainer,x:this.gameBounds.width,duration:250,ease:"Power2.easeIn",onComplete:()=>{this.skillCutInContainer.setVisible(!1),this.skillCutInContainer.setX(0),this.isSkillSelecting=!1}})})}})}showTriggerCutIn(t,e,s){this.skillCutInContainer.removeAll(!0);const a=this.gameBounds.height*.22,i=this.gameBounds.y+this.gameBounds.height*.25,n=this.gameBounds.width*.15,o=this.gameBounds.width-n*2,h=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,i,o,a,0,.85);this.skillCutInContainer.add(h);const r=this.add.graphics(),c=this.gameBounds.x,l=20;for(let k=0;k<l;k++){const v=k/l*.85,I=c+n/l*k,w=n/l+1;r.fillStyle(0,v),r.fillRect(I,i-a/2,w,a)}this.skillCutInContainer.add(r);const d=this.add.graphics(),p=this.gameBounds.x+this.gameBounds.width-n;for(let k=0;k<l;k++){const v=(1-k/l)*.85,I=p+n/l*k,w=n/l+1;d.fillStyle(0,v),d.fillRect(I,i-a/2,w,a)}this.skillCutInContainer.add(d);const f=3,g=this.gameBounds.x+n,m=this.add.graphics(),M=i-a/2-f/2;for(let k=0;k<l;k++){const v=k/l*.8,I=c+n/l*k,w=n/l+1;m.fillStyle(t.color,v),m.fillRect(I,M,w,f)}m.fillStyle(t.color,.8),m.fillRect(g,M,o,f);for(let k=0;k<l;k++){const v=(1-k/l)*.8,I=p+n/l*k,w=n/l+1;m.fillStyle(t.color,v),m.fillRect(I,M,w,f)}this.skillCutInContainer.add(m);const S=this.add.graphics(),E=i+a/2-f/2;for(let k=0;k<l;k++){const v=k/l*.8,I=c+n/l*k,w=n/l+1;S.fillStyle(t.color,v),S.fillRect(I,E,w,f)}S.fillStyle(t.color,.8),S.fillRect(g,E,o,f);for(let k=0;k<l;k++){const v=(1-k/l)*.8,I=p+n/l*k,w=n/l+1;S.fillStyle(t.color,v),S.fillRect(I,E,w,f)}this.skillCutInContainer.add(S);const T=this.add.text(this.gameBounds.x+this.gameBounds.width/2,i-a*.25,e,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(a*.24))}px`,color:G.Display.Color.IntegerToColor(t.color).rgba,fontStyle:"bold"});T.setResolution(2),T.setOrigin(.5,.5),this.skillCutInContainer.add(T);const y=this.add.text(this.gameBounds.x+this.gameBounds.width/2,i+a*.15,s,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(a*.17))}px`,color:"#ffffff"});y.setResolution(2),y.setOrigin(.5,.5),this.skillCutInContainer.add(y),this.skillCutInContainer.setX(-this.gameBounds.width),this.skillCutInContainer.setVisible(!0),this.skillCutInContainer.setAlpha(1),this.tweens.add({targets:this.skillCutInContainer,x:0,duration:250,ease:"Power2.easeOut",onComplete:()=>{this.time.delayedCall(2e3,()=>{this.tweens.add({targets:this.skillCutInContainer,x:this.gameBounds.width,duration:250,ease:"Power2.easeIn",onComplete:()=>{this.skillCutInContainer.setVisible(!1),this.skillCutInContainer.setX(0)}})})}})}createSkillOptions(){this.skillOptions.forEach(l=>l.destroy()),this.skillOptions=[],this.skillCardBgs=[],this.mixedSkillTypes=[],this.mixedNormalIndices=[],this.mixedAdvancedIndices=[];const t=this.skillManager.getMixedSkillOptions();if(this.currentSkillChoices=t.normal,this.currentAdvancedSkillChoices=t.advanced,this.currentSkillChoices.length+this.currentAdvancedSkillChoices.length===0)return;if(this.currentSkillChoices.length===0&&this.currentAdvancedSkillChoices.length>0){this.isSelectingAdvancedSkill=!0,this.currentAdvancedSkillChoices.length>3&&(this.currentAdvancedSkillChoices=this.currentAdvancedSkillChoices.slice(0,3)),this.createAdvancedSkillOptions();return}if(this.currentAdvancedSkillChoices.length>0){this.createMixedSkillOptions();return}this.isSelectingAdvancedSkill=!1;const s=this.gameBounds.width*.25,a=this.gameBounds.height*(this.isMobile?.55:.5),i=this.gameBounds.width*.05,n=this.currentSkillChoices.length,o=s*n+i*(n-1),h=this.gameBounds.x+(this.gameBounds.width-o)/2+s/2,r=this.gameBounds.y+this.gameBounds.height*.55;let c;n===1?c=["2"]:n===2?c=["1","3"]:c=["1","2","3"];for(let l=0;l<this.currentSkillChoices.length;l++){const d=this.currentSkillChoices[l],p=this.skillManager.getSkillLevel(d.id),f=p<0,g=f?"-":p,m=f?0:p+1,M=h+l*(s+i),S=this.add.container(M,r),E=this.add.rectangle(0,0,s,a,2236962);E.setStrokeStyle(2,6710886),S.add(E);const T=this.add.text(0,-a*.42,d.type==="active"?"ACTIVE":"PASSIVE",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.045))}px`,color:d.type==="active"?"#ff6666":"#66ffff",fontStyle:"bold"});T.setResolution(2),T.setOrigin(.5,.5),S.add(T);const y=s*.5,k=-a*.18,v=this.add.rectangle(0,k,y,y,d.color,.3);if(v.setStrokeStyle(2,d.color),S.add(v),d.iconPrefix){const X=d.iconPrefix.startsWith("P")?`skill_icon_${d.iconPrefix}`:`skill_icon_${d.iconPrefix}${m.toString().padStart(2,"0")}`;if(this.textures.exists(X)){const L=this.add.sprite(0,k,X);L.setOrigin(.5,.5);const F=(y-8)/Math.max(L.width,L.height);L.setScale(F),S.add(L),v.setAlpha(0)}}const I=a*.06,w=this.add.text(0,I,d.name,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(a*.08))}px`,color:"#ffffff",fontStyle:"bold"});if(w.setResolution(2),w.setOrigin(.5,.5),S.add(w),d.subtitle){const O=this.isMobile?Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.045)):Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.055)),X=this.add.text(0,a*.12,d.subtitle,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${O}px`,color:"#999999"});X.setResolution(2),X.setOrigin(.5,.5),S.add(X)}let A;m>=d.maxLevel?A=`Lv.${g} → MAX`:f?A=`NEW → Lv.${m}`:A=`Lv.${g} → Lv.${m}`;const P=this.add.text(0,a*.2,A,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.05))}px`,color:m>=d.maxLevel?"#ffff00":"#88ff88",fontStyle:"bold"});P.setResolution(2),P.setOrigin(.5,.5),S.add(P);const b=a*.26,R=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.045)),D=s*(1-u.CARD_TEXT_PADDING*2),B=this.add.text(0,b,d.description,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${R}px`,color:"#dddddd",wordWrap:{width:D,useAdvancedWrap:!0},align:"center"});if(B.setResolution(2),B.setOrigin(.5,0),S.add(B),!this.isMobile){const O=a*.5+a*.08,X=this.add.text(0,O,`[ ${c[l]} ]`,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(a*.06))}px`,color:"#ffff00",fontStyle:"bold"});X.setResolution(2),X.setOrigin(.5,.5),S.add(X)}E.setInteractive({useHandCursor:!0});const _=l;E.on("pointerover",()=>{this.setSelectedSkill(_)}),E.on("pointerdown",()=>{this.isMobile?this.selectedSkillIndex===_?this.confirmSkillSelection():this.setSelectedSkill(_):(this.setSelectedSkill(_),this.confirmSkillSelection())}),this.skillPanelContainer.add(S),this.skillOptions.push(S),this.skillCardBgs.push(E)}this.selectedSkillIndex=0}tryShowSkillPanel(){this.skillPanelContainer&&this.skillPanelContainer.visible||this.pendingSkillPoints<=0||this.showSkillPanel()}showSkillPanel(){if(this.skillPanelContainer&&this.skillPanelContainer.visible)return;const t=this.skillManager.hasUpgradeableSkills(),e=this.skillManager.getUpgradeableAdvancedSkills().length>0;if(!t&&!e){this.pendingSkillPoints=0;return}if(this.createSkillOptions(),!(this.currentSkillChoices.length>0||this.mixedSkillTypes.length>0||this.isSelectingAdvancedSkill&&this.currentAdvancedSkillChoices.length>0)){this.pendingSkillPoints=0;return}this.isPaused=!0,this.isSkillSelecting=!1,this.isPointerDown=!1,this.skillPanelContainer.setVisible(!0),this.selectedSkillIndex=0,this.skillCardBgs.forEach((a,i)=>{i===0?(a.setFillStyle(3355443),a.setStrokeStyle(3,16777215)):(a.setFillStyle(2236962),a.setStrokeStyle(2,6710886))}),this.skillPanelContainer.setAlpha(0),this.tweens.add({targets:this.skillPanelContainer,alpha:1,duration:200}),this.skillOptions.forEach((a,i)=>{a.setScale(i===0?1.05:1),a.setY(this.gameBounds.y+this.gameBounds.height*.55+50),a.setAlpha(0),this.tweens.add({targets:a,y:this.gameBounds.y+this.gameBounds.height*.55,alpha:1,duration:300,delay:i*100,ease:"Back.easeOut"})})}hideSkillPanel(){this.pendingSkillPoints=Math.max(0,this.pendingSkillPoints-1),this.isSkillSelecting=!1,this.tweens.add({targets:this.skillPanelContainer,alpha:0,duration:200,onComplete:()=>{this.skillPanelContainer.setVisible(!1),this.pendingSkillPoints>0?this.time.delayedCall(100,()=>{this.tryShowSkillPanel()}):this.isPaused=!1}})}selectSkill(t,e){const s=this.currentSkillChoices[t];if(!this.skillManager.learnOrUpgradeSkill(e)){console.warn(`Failed to learn/upgrade skill: ${e}`),this.isSkillSelecting=!1,this.isPaused=!1;return}const i=this.skillManager.getPlayerSkill(e),n=(i==null?void 0:i.level)??0;this.updateSkillBarDisplay(),(i==null?void 0:i.definition.type)==="passive"&&(this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.drawHpBarFill(),this.updateHpText()),this.hideSkillPanel();const o=this.skillOptions[t];this.tweens.add({targets:o,scaleX:1.1,scaleY:1.1,duration:100,yoyo:!0,onComplete:()=>{this.showSkillCutIn(s,n)}})}selectAdvancedSkill(t,e){const s=this.currentAdvancedSkillChoices[t],a=this.skillManager.getEquippedAdvancedSkill(),i=(a==null?void 0:a.definition.id)===e,n=!a;if(!i&&!n&&this.clearAdvancedSkillEffects(),!this.skillManager.setEquippedAdvancedSkill(e)){console.warn(`Failed to equip advanced skill: ${e}`),this.isSkillSelecting=!1,this.isPaused=!1;return}this.skillManager.upgradeAdvancedSkill(e);const h=this.skillManager.getEquippedAdvancedSkill(),r=(h==null?void 0:h.level)??1;this.advancedSkillSlotVisible||this.showAdvancedSkillSlot(),this.updateAdvancedSkillDisplay(),h&&(n||!i)&&(this.advancedSkillCooldownTime=0,this.activateAdvancedSkill(h),this.advancedSkillCooldownTime=this.time.now),this.hideSkillPanel();const c=this.skillOptions[t];this.tweens.add({targets:c,scaleX:1.1,scaleY:1.1,duration:100,yoyo:!0,onComplete:()=>{this.showAdvancedSkillCutIn(s,r)}})}createAdvancedSkillOptions(){const t=this.gameBounds.width*.25,e=this.gameBounds.height*(this.isMobile?.55:.5),s=this.gameBounds.width*.05,a=this.currentAdvancedSkillChoices.length,i=t*a+s*(a-1),n=this.gameBounds.x+(this.gameBounds.width-i)/2+t/2,o=this.gameBounds.y+this.gameBounds.height*.55;let h;a===1?h=["2"]:a===2?h=["1","3"]:h=["1","2","3"];for(let r=0;r<this.currentAdvancedSkillChoices.length;r++){const c=this.currentAdvancedSkillChoices[r],l=this.skillManager.getAdvancedSkillLevel(c.id),d=l<0,p=d?"-":l,f=l+1,g=n+r*(t+s),m=this.add.container(g,o),M=this.add.rectangle(0,0,t,e,1710638);M.setStrokeStyle(3,16766720),m.add(M);const S=this.add.text(0,-e*.42,"ADVANCED",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(e*.045))}px`,color:"#ffd700",fontStyle:"bold"});S.setResolution(2),S.setOrigin(.5,.5),m.add(S);const E=t*.5,T=-e*.18,y=this.add.rectangle(0,T,E,E,c.color,.3);if(y.setStrokeStyle(2,c.color),m.add(y),c.iconPrefix){const _=/\d$/.test(c.iconPrefix)?`skill_icon_${c.iconPrefix}`:`skill_${c.iconPrefix}0${Math.min(f,c.maxLevel)}`;if(this.textures.exists(_)){const O=this.add.sprite(0,T,_);O.setOrigin(.5,.5);const L=(E-8)/Math.max(O.width,O.height);O.setScale(L),m.add(O),y.setAlpha(0)}}const k=e*.06,v=this.add.text(0,k,c.name,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(e*.08))}px`,color:"#ffd700",fontStyle:"bold"});if(v.setResolution(2),v.setOrigin(.5,.5),m.add(v),c.subtitle){const B=this.isMobile?Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(e*.045)):Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(e*.055)),_=this.add.text(0,e*.12,c.subtitle,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${B}px`,color:"#999999"});_.setResolution(2),_.setOrigin(.5,.5),m.add(_)}let I;const w=c.maxLevel>=0&&f>c.maxLevel;w?I=`Lv.${p} (MAX)`:d?I=`NEW → Lv.${f}`:I=`Lv.${p} → Lv.${f}`;const A=this.add.text(0,e*.2,I,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(e*.05))}px`,color:w?"#ffff00":"#88ff88",fontStyle:"bold"});A.setResolution(2),A.setOrigin(.5,.5),m.add(A);const P=e*.26,b=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(e*.045)),R=t*(1-u.CARD_TEXT_PADDING*2),D=this.add.text(0,P,c.description,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${b}px`,color:"#dddddd",wordWrap:{width:R,useAdvancedWrap:!0},align:"center"});if(D.setResolution(2),D.setOrigin(.5,0),m.add(D),!this.isMobile){const B=e*.5+e*.08,_=this.add.text(0,B,`[ ${h[r]} ]`,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(e*.07))}px`,color:"#ffff00",fontStyle:"bold"});_.setResolution(2),_.setOrigin(.5,.5),m.add(_)}M.setInteractive({useHandCursor:!0}),M.on("pointerover",()=>{const B=this.selectedSkillIndex;this.selectedSkillIndex=r,this.updateSkillCardStyle(B,!1),this.updateSkillCardStyle(r,!0)}),M.on("pointerdown",()=>{this.selectedSkillIndex=r,this.confirmSkillSelection()}),this.skillOptions.push(m),this.skillCardBgs.push(M),this.skillPanelContainer.add(m)}this.selectedSkillIndex=0,this.updateSkillCardStyle(0,!0)}createMixedSkillOptions(){this.mixedSkillTypes=[],this.mixedNormalIndices=[],this.mixedAdvancedIndices=[],this.isSelectingAdvancedSkill=!1;const t=[];for(let l=0;l<Math.min(3,this.currentSkillChoices.length);l++)t.push({type:"normal",index:l});const e=3-t.length;for(let l=0;l<Math.min(e,this.currentAdvancedSkillChoices.length);l++)t.push({type:"advanced",index:l});t.forEach(l=>{this.mixedSkillTypes.push(l.type),l.type==="normal"?(this.mixedNormalIndices.push(l.index),this.mixedAdvancedIndices.push(-1)):(this.mixedNormalIndices.push(-1),this.mixedAdvancedIndices.push(l.index))});const s=this.gameBounds.width*.25,a=this.gameBounds.height*(this.isMobile?.55:.5),i=this.gameBounds.width*.05,n=t.length,o=s*n+i*(n-1),h=this.gameBounds.x+(this.gameBounds.width-o)/2+s/2,r=this.gameBounds.y+this.gameBounds.height*.55;let c;n===1?c=["2"]:n===2?c=["1","3"]:c=["1","2","3"];for(let l=0;l<t.length;l++){const d=t[l],p=h+l*(s+i),f=this.add.container(p,r);if(d.type==="normal"){const g=this.currentSkillChoices[d.index],m=this.skillManager.getSkillLevel(g.id),M=m<0,S=M?"-":m,E=M?0:m+1,T=this.add.rectangle(0,0,s,a,2236962);T.setStrokeStyle(2,6710886),f.add(T);const y=this.add.text(0,-a*.42,g.type==="active"?"ACTIVE":"PASSIVE",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.045))}px`,color:g.type==="active"?"#ff6666":"#66ffff",fontStyle:"bold"});y.setResolution(2),y.setOrigin(.5,.5),f.add(y);const k=s*.5,v=-a*.18,I=this.add.rectangle(0,v,k,k,g.color,.3);if(I.setStrokeStyle(2,g.color),f.add(I),g.iconPrefix){const L=g.iconPrefix.startsWith("P")?`skill_icon_${g.iconPrefix}`:`skill_icon_${g.iconPrefix}${E.toString().padStart(2,"0")}`;if(this.textures.exists(L)){const H=this.add.sprite(0,v,L);H.setOrigin(.5,.5);const z=(k-8)/Math.max(H.width,H.height);H.setScale(z),f.add(H),I.setAlpha(0)}}const w=a*.06,A=this.add.text(0,w,g.name,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(a*.08))}px`,color:"#ffffff",fontStyle:"bold"});if(A.setResolution(2),A.setOrigin(.5,.5),f.add(A),g.subtitle){const X=this.isMobile?Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.045)):Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.055)),L=this.add.text(0,a*.12,g.subtitle,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${X}px`,color:"#999999"});L.setResolution(2),L.setOrigin(.5,.5),f.add(L)}let P;E>=g.maxLevel?P=`Lv.${S} → MAX`:M?P=`NEW → Lv.${E}`:P=`Lv.${S} → Lv.${E}`;const b=this.add.text(0,a*.2,P,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.05))}px`,color:E>=g.maxLevel?"#ffff00":"#88ff88",fontStyle:"bold"});b.setResolution(2),b.setOrigin(.5,.5),f.add(b);const R=a*.26,D=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.045)),B=s*(1-u.CARD_TEXT_PADDING*2),_=this.add.text(0,R,g.description,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${D}px`,color:"#dddddd",wordWrap:{width:B,useAdvancedWrap:!0},align:"center"});if(_.setResolution(2),_.setOrigin(.5,0),f.add(_),!this.isMobile){const X=a*.5+a*.08,L=this.add.text(0,X,`[ ${c[l]} ]`,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(a*.06))}px`,color:"#ffff00",fontStyle:"bold"});L.setResolution(2),L.setOrigin(.5,.5),f.add(L)}T.setInteractive({useHandCursor:!0});const O=l;T.on("pointerover",()=>{this.setSelectedSkill(O)}),T.on("pointerdown",()=>{this.isMobile?this.selectedSkillIndex===O?this.confirmMixedSkillSelection():this.setSelectedSkill(O):(this.setSelectedSkill(O),this.confirmMixedSkillSelection())}),this.skillCardBgs.push(T)}else{const g=this.currentAdvancedSkillChoices[d.index],m=this.skillManager.getAdvancedSkillLevel(g.id),M=m<0,S=M?"-":m,E=m+1,T=this.add.rectangle(0,0,s,a,1710638);T.setStrokeStyle(3,16766720),f.add(T);const y=this.add.text(0,-a*.42,"ADVANCED",{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.045))}px`,color:"#ffd700",fontStyle:"bold"});y.setResolution(2),y.setOrigin(.5,.5),f.add(y);const k=s*.5,v=-a*.18,I=this.add.rectangle(0,v,k,k,g.color,.3);if(I.setStrokeStyle(2,g.color),f.add(I),g.iconPrefix){const H=/\d$/.test(g.iconPrefix)?`skill_icon_${g.iconPrefix}`:`skill_${g.iconPrefix}0${Math.min(E,g.maxLevel<0?E:g.maxLevel)}`;if(this.textures.exists(H)){const F=this.add.sprite(0,v,H);F.setOrigin(.5,.5);const Y=(k-8)/Math.max(F.width,F.height);F.setScale(Y),f.add(F),I.setAlpha(0)}}const w=a*.06,A=this.add.text(0,w,g.name,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(a*.08))}px`,color:"#ffd700",fontStyle:"bold"});if(A.setResolution(2),A.setOrigin(.5,.5),f.add(A),g.subtitle){const L=this.isMobile?Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.045)):Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.055)),H=this.add.text(0,a*.12,g.subtitle,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${L}px`,color:"#999999"});H.setResolution(2),H.setOrigin(.5,.5),f.add(H)}let P;const b=g.maxLevel>=0&&E>g.maxLevel;b?P=`Lv.${S} (MAX)`:M?P=`NEW → Lv.${E}`:P=`Lv.${S} → Lv.${E}`;const R=this.add.text(0,a*.2,P,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.05))}px`,color:b?"#ffff00":"#88ff88",fontStyle:"bold"});R.setResolution(2),R.setOrigin(.5,.5),f.add(R);const D=a*.26,B=Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.045)),_=s*(1-u.CARD_TEXT_PADDING*2),O=this.add.text(0,D,g.description,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${B}px`,color:"#dddddd",wordWrap:{width:_,useAdvancedWrap:!0},align:"center"});if(O.setResolution(2),O.setOrigin(.5,0),f.add(O),!this.isMobile){const L=a*.5+a*.08,H=this.add.text(0,L,`[ ${c[l]} ]`,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_SMALL,Math.floor(a*.07))}px`,color:"#ffff00",fontStyle:"bold"});H.setResolution(2),H.setOrigin(.5,.5),f.add(H)}T.setInteractive({useHandCursor:!0});const X=l;T.on("pointerover",()=>{this.setSelectedSkill(X)}),T.on("pointerdown",()=>{this.isMobile?this.selectedSkillIndex===X?this.confirmMixedSkillSelection():this.setSelectedSkill(X):(this.setSelectedSkill(X),this.confirmMixedSkillSelection())}),this.skillCardBgs.push(T)}this.skillOptions.push(f),this.skillPanelContainer.add(f)}this.selectedSkillIndex=0,this.updateSkillCardStyle(0,!0)}confirmMixedSkillSelection(){if(this.isSkillSelecting)return;this.isSkillSelecting=!0;const t=this.selectedSkillIndex;if(t<0||t>=this.mixedSkillTypes.length)return;if(this.mixedSkillTypes[t]==="normal"){const s=this.mixedNormalIndices[t];if(s>=0&&s<this.currentSkillChoices.length){const a=this.currentSkillChoices[s];this.selectSkill(s,a.id)}}else{const s=this.mixedAdvancedIndices[t];if(s>=0&&s<this.currentAdvancedSkillChoices.length){const a=this.currentAdvancedSkillChoices[s],i=this.skillManager.getEquippedAdvancedSkill(),n=(i==null?void 0:i.definition.id)===a.id,o=!i;!n&&!o&&this.clearAdvancedSkillEffects(),this.skillManager.setEquippedAdvancedSkill(a.id),this.skillManager.upgradeAdvancedSkill(a.id);const h=this.skillManager.getAdvancedSkillLevel(a.id);this.showAdvancedSkillSlot(),this.updateAdvancedSkillDisplay();const r=this.skillManager.getEquippedAdvancedSkill();r&&(o||!n)&&(this.advancedSkillCooldownTime=0,this.activateAdvancedSkill(r),this.advancedSkillCooldownTime=this.time.now),this.hideSkillPanel(),this.showAdvancedSkillCutIn(a,h)}}}showAdvancedSkillCutIn(t,e){const s=this.generateAdvancedSkillMessage(t,e),a=this.generateAdvancedSkillQuote(t,e);this.showAdvancedSkillCutInDirect(t,e,s,a)}showAdvancedSkillCutInDirect(t,e,s,a){this.skillCutInContainer.removeAll(!0);const i=this.gameBounds.height*.22,n=this.gameBounds.y+this.gameBounds.height*.25,o=this.gameBounds.width*.15,h=this.gameBounds.width-o*2,r=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,n,h,i,0,.75);this.skillCutInContainer.add(r);const c=this.add.graphics(),l=this.gameBounds.x,d=this.gameBounds.x+o,p=20;for(let w=0;w<p;w++){const A=w/p*.75,P=l+o/p*w,b=o/p+1;c.fillStyle(0,A),c.fillRect(P,n-i/2,b,i)}this.skillCutInContainer.add(c);const f=this.add.graphics(),g=this.gameBounds.x+this.gameBounds.width-o;for(let w=0;w<p;w++){const A=(1-w/p)*.75,P=g+o/p*w,b=o/p+1;f.fillStyle(0,A),f.fillRect(P,n-i/2,b,i)}this.skillCutInContainer.add(f);const m=3,M=t.color,S=this.add.graphics(),E=n-i/2-m/2;for(let w=0;w<p;w++){const A=w/p*.8,P=l+o/p*w,b=o/p+1;S.fillStyle(M,A),S.fillRect(P,E,b,m)}S.fillStyle(M,.8),S.fillRect(d,E,h,m);for(let w=0;w<p;w++){const A=(1-w/p)*.8,P=g+o/p*w,b=o/p+1;S.fillStyle(M,A),S.fillRect(P,E,b,m)}this.skillCutInContainer.add(S);const T=this.add.graphics(),y=n+i/2-m/2;for(let w=0;w<p;w++){const A=w/p*.8,P=l+o/p*w,b=o/p+1;T.fillStyle(M,A),T.fillRect(P,y,b,m)}T.fillStyle(M,.8),T.fillRect(d,y,h,m);for(let w=0;w<p;w++){const A=(1-w/p)*.8,P=g+o/p*w,b=o/p+1;T.fillStyle(M,A),T.fillRect(P,y,b,m)}this.skillCutInContainer.add(T);const k=`${t.name} 提升到 Lv.${e}`,v=this.add.text(this.gameBounds.x+this.gameBounds.width/2,n-i*.3,k,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(i*.26))}px`,color:"#ffffff",fontStyle:"bold"});if(v.setResolution(2),v.setOrigin(.5,.5),this.skillCutInContainer.add(v),a){const w=this.add.text(this.gameBounds.x+this.gameBounds.width/2,n+i*.05,a,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_LARGE,Math.floor(i*.23))}px`,color:"#ffffff"});w.setResolution(2),w.setOrigin(.5,.5),this.skillCutInContainer.add(w)}const I=this.add.text(this.gameBounds.x+this.gameBounds.width/2,n+i*.25,s,{fontFamily:'"Noto Sans TC", sans-serif',fontSize:`${Math.max(u.MIN_FONT_SIZE_MEDIUM,Math.floor(i*.15))}px`,color:G.Display.Color.IntegerToColor(M).rgba});I.setResolution(2),I.setOrigin(.5,.5),this.skillCutInContainer.add(I),this.skillCutInContainer.setX(-this.gameBounds.width),this.skillCutInContainer.setVisible(!0),this.skillCutInContainer.setAlpha(1),this.tweens.add({targets:this.skillCutInContainer,x:0,duration:250,ease:"Power2.easeOut",onComplete:()=>{this.time.delayedCall(1500,()=>{this.tweens.add({targets:this.skillCutInContainer,x:this.gameBounds.width,duration:200,ease:"Power2.easeIn",onComplete:()=>{this.skillCutInContainer.setVisible(!1),this.isSkillSelecting=!1}})})}})}generateAdvancedSkillMessage(t,e){const s=this.currentLevel+e,a=u.DAMAGE_UNIT*s;switch(t.id){case"advanced_burning_celluloid":return`Lv.${e} - 傷害 ${s} 單位（${a}）`;case"advanced_tech_artist":return`Lv.${e} - 傷害 ${s} 單位（${a}）`;case"advanced_absolute_defense":return`Lv.${e} - 傷害 ${s} 單位（${a}）`;case"advanced_perfect_pixel":return`Lv.${e} - 傷害 ${s} 單位（${a}）`;case"advanced_vfx_burst":return`Lv.${e} - 傷害 ${s} 單位（${a}）`;case"advanced_phantom_iteration":{const i=Math.floor(e/5)+8;return`Lv.${e} - 持續 ${i} 秒`}case"advanced_zero_trust":return`Lv.${e} - 傷害 ${s} 單位（${a}）`;case"advanced_soul_slash":return`Lv.${e} - 傷害 ${s} 單位（${a}）`;default:return`Lv.${e}`}}generateAdvancedSkillQuote(t,e){return t.levelUpQuotes&&t.levelUpQuotes.length>0?t.levelUpQuotes[0]:t.subtitle||""}createSkillGrid(){const t=this.cameras.main.width,e=1920,s=20/this.gridScaleMultiplier,a=6/this.gridScaleMultiplier,i=Math.min(1,t/e);this.skillGridCellSize=Math.max(a,Math.floor(s*i));const n=u.SKILL_GRID_GAP;this.skillGridCols=Math.ceil((this.gameBounds.width+n)/(this.skillGridCellSize+n)),this.skillGridRows=Math.ceil((this.gameBounds.height+n)/(this.skillGridCellSize+n)),this.skillGridContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.skillGridContainer.setDepth(3);for(let o=0;o<this.skillGridRows;o++)for(let h=0;h<this.skillGridCols;h++){const r=h*(this.skillGridCellSize+n)+this.skillGridCellSize/2,c=o*(this.skillGridCellSize+n)+this.skillGridCellSize/2,l=this.add.rectangle(r,c,this.skillGridCellSize,this.skillGridCellSize,16777215,0);l.setVisible(!1),this.skillGridCells.push(l),this.skillGridContainer.add(l)}this.drawBorderFrame()}recreateSkillGrid(){this.skillGridCells.forEach(t=>t.destroy()),this.skillGridCells=[],this.skillGridContainer&&this.skillGridContainer.destroy(),this.createSkillGrid(),this.recreateSkillBar(),this.bringUIToTop()}bringUIToTop(){this.characterContainer&&this.uiContainer.bringToTop(this.characterContainer),this.hpBarContainer&&this.uiContainer.bringToTop(this.hpBarContainer),this.shieldText&&this.uiContainer.bringToTop(this.shieldText),this.expBarContainer&&this.uiContainer.bringToTop(this.expBarContainer),this.skillIconContainers.forEach(t=>{this.uiContainer.bringToTop(t)}),this.skillIconGridGraphics.forEach(t=>{this.uiContainer.bringToTop(t)}),this.skillInfoPanel&&this.uiContainer.bringToTop(this.skillInfoPanel),this.skillPanelContainer&&this.uiContainer.bringToTop(this.skillPanelContainer)}recreateSkillBar(){this.skillIcons.forEach(t=>t.destroy()),this.skillIcons=[],this.skillIconContainers.forEach(t=>t.destroy()),this.skillIconContainers=[],this.skillLevelTexts.forEach(t=>t.destroy()),this.skillLevelTexts=[],this.skillIconGridGraphics.forEach(t=>t.destroy()),this.skillIconGridGraphics=[],this.skillIconGridData=[],this.skillIconSprites=[],this.skillInfoPanel&&this.skillInfoPanel.destroy(),this.createSkillBar()}initSkillEffectPool(){for(let t=0;t<u.SKILL_EFFECT_POOL_SIZE;t++){const e=this.add.sprite(0,0,u.TEXTURE_CIRCLE);e.setVisible(!1),e.setActive(!1),e.setDepth(51),this.worldContainer.add(e),this.skillEffectPool.push(e)}}getSkillEffectSprite(){if(this.activeSkillEffects.length>=u.MAX_ACTIVE_SKILL_EFFECTS)return null;let t=this.skillEffectPool.pop();return t||(t=this.add.sprite(0,0,u.TEXTURE_CIRCLE),t.setDepth(51),this.worldContainer.add(t)),t.setVisible(!0),t.setActive(!0),this.activeSkillEffects.push(t),t}releaseSkillEffectSprite(t){t.setVisible(!1),t.setActive(!1),t.setScale(1),t.setRotation(0),t.setAlpha(1),t.setTint(16777215);const e=this.activeSkillEffects.indexOf(t);e>-1&&this.activeSkillEffects.splice(e,1),this.skillEffectPool.push(t)}initLineEffectPool(){for(let t=0;t<u.LINE_EFFECT_POOL_SIZE;t++){const e=this.add.sprite(0,0,u.TEXTURE_LINE);e.setVisible(!1),e.setActive(!1),e.setDepth(58),this.skillGridContainer.add(e),this.lineEffectPool.push(e)}}getLineEffectSprite(){if(this.activeLineEffects.length>=u.MAX_ACTIVE_LINE_EFFECTS)return null;let t=this.lineEffectPool.pop();return t||(t=this.add.sprite(0,0,u.TEXTURE_LINE),t.setDepth(58),this.skillGridContainer.add(t)),t.setVisible(!0),t.setActive(!0),this.activeLineEffects.push(t),t}releaseLineEffectSprite(t){t.setVisible(!1),t.setActive(!1),t.setScale(1),t.setRotation(0),t.setAlpha(1),t.setTint(16777215);const e=this.activeLineEffects.indexOf(t);e>-1&&this.activeLineEffects.splice(e,1),this.lineEffectPool.push(t)}initCircleLineEffectPool(){for(let t=0;t<u.CIRCLE_LINE_EFFECT_POOL_SIZE;t++){const e=this.add.sprite(0,0,u.TEXTURE_CIRCLE_LINE);e.setVisible(!1),e.setActive(!1),e.setDepth(55),this.skillGridContainer.add(e),this.circleLineEffectPool.push(e)}}getCircleLineEffectSprite(){let t=this.circleLineEffectPool.pop();return t||(t=this.add.sprite(0,0,u.TEXTURE_CIRCLE_LINE),t.setDepth(55),this.skillGridContainer.add(t)),t.setVisible(!0),t.setActive(!0),this.activeCircleLineEffects.push(t),t}releaseCircleLineEffectSprite(t){t.setVisible(!1),t.setActive(!1),t.setScale(1),t.setRotation(0),t.setAlpha(1),t.setTint(16777215);const e=this.activeCircleLineEffects.indexOf(t);e>-1&&this.activeCircleLineEffects.splice(e,1),this.circleLineEffectPool.push(t)}initExpCrystalPool(){const t=u.EXP_CRYSTAL_SIZE*this.gameBounds.height;for(let e=0;e<u.EXP_CRYSTAL_POOL_SIZE;e++){const s=this.add.graphics(),a=t/2;s.fillStyle(10040319,1),s.beginPath(),s.moveTo(a,0),s.lineTo(t,a),s.lineTo(a,t),s.lineTo(0,a),s.closePath(),s.fillPath(),s.fillStyle(13395711,.6),s.beginPath(),s.moveTo(a,t*.15),s.lineTo(t*.7,a),s.lineTo(a,t*.4),s.lineTo(t*.3,a*.7),s.closePath(),s.fillPath();const i=`exp_crystal_pool_${e}`;s.generateTexture(i,t,t),s.destroy();const n=this.add.sprite(0,0,i);n.setOrigin(.5,.5),n.setVisible(!1),n.setActive(!1),this.expCrystalContainer.add(n),this.expCrystalPool.push(n)}}getExpCrystalFromPool(){let t=this.expCrystalPool.pop();if(t)return t.setVisible(!0),t.setActive(!0),t;const e=this.gameBounds.height*u.EXP_CRYSTAL_SIZE;return t=this.add.sprite(0,0,"exp_crystal"),t.setDisplaySize(e,e),t.setVisible(!0),t.setActive(!0),this.expCrystalContainer.add(t),t}releaseExpCrystalToPool(t){t.setVisible(!1),t.setActive(!1),t.setScale(1),t.setAlpha(1),this.expCrystalPool.push(t)}spawnExpCrystal(t,e,s){const a=this.getExpCrystalFromPool();a.setPosition(t,e);const i=s+this.pendingMergeExp;this.pendingMergeExp=0,this.expCrystals.push({id:this.nextExpCrystalId++,x:t,y:e,exp:i,sprite:a,floatPhase:Math.random()*Math.PI*2,isBeingAttracted:!1})}mergeDistantExpCrystals(){if(this.expCrystals.length<=u.EXP_CRYSTAL_MERGE_THRESHOLD)return;const t=this.characterX+this.cameraOffsetX,e=this.characterY+this.cameraOffsetY;let s=-1,a=0;for(let i=0;i<this.expCrystals.length;i++){const n=this.expCrystals[i];if(n.isBeingAttracted)continue;const o=n.x-t,h=n.y-e,r=o*o+h*h;r>a&&(a=r,s=i)}if(s>=0){const i=this.expCrystals[s];this.pendingMergeExp+=i.exp,this.releaseExpCrystalToPool(i.sprite),this.expCrystals.splice(s,1)}}updateExpCrystals(t){if(this.mergeDistantExpCrystals(),this.expCrystals.length===0)return;const e=this.gameBounds.height*.1,s=this.skillManager.getRetinaModulePickupBonus(),a=(u.EXP_CRYSTAL_MAGNET_RANGE+s)*e,i=u.EXP_CRYSTAL_PICKUP_RANGE*e,n=u.EXP_CRYSTAL_ATTRACT_SPEED*e*(t/1e3),o=[];for(const h of this.expCrystals){const r=this.characterX-h.x,c=this.characterY-h.y,l=Math.sqrt(r*r+c*c);if(l<=a&&(h.isBeingAttracted=!0),h.isBeingAttracted)if(l>i){const d=r/l*n,p=c/l*n;h.x+=d,h.y+=p,h.sprite.setPosition(h.x,h.y);const f=.8+.2*Math.sin(this.time.now*.01);h.sprite.setScale(f)}else this.addExp(h.exp),this.playExpCrystalPickupEffect(h.x,h.y),o.push(h.id);else{h.floatPhase+=t*.003;const d=Math.sin(h.floatPhase)*5;h.sprite.setY(h.y+d)}}for(const h of o){const r=this.expCrystals.findIndex(c=>c.id===h);if(r!==-1){const c=this.expCrystals[r];this.releaseExpCrystalToPool(c.sprite),this.expCrystals.splice(r,1)}}}playExpCrystalPickupEffect(t,e){const s=this.getSkillEffectSprite();s&&(s.setTexture(u.TEXTURE_CIRCLE),s.setPosition(t,e),s.setScale(.15),s.setTint(10040319),s.setAlpha(1),s.setVisible(!0),this.tweens.add({targets:s,y:e-40,scaleX:.3,scaleY:.3,alpha:0,duration:350,ease:"Quad.easeOut",onComplete:()=>{this.releaseSkillEffectSprite(s)}}))}showHitSparkEffect(t,e,s,a,i=4){const n=this.worldToScreen(t,e),o=this.gameBounds.height/10,h=i,r=o*1.2,c=36,l=35*(Math.PI/180),d=s>>16&255,p=s>>8&255,f=s&255,g=[s,Math.min(255,d+30)<<16|Math.min(255,p+30)<<8|Math.min(255,f+30),Math.min(255,d+60)<<16|Math.min(255,p+60)<<8|Math.min(255,f+60),16777215,Math.min(255,d+40)<<16|Math.min(255,p+40)<<8|Math.min(255,f+40),s,Math.min(255,d+20)<<16|Math.min(255,p+20)<<8|Math.min(255,f+20),16777215];for(let m=0;m<h;m++){let M,S,E;const T=.6+Math.random()*.8,y=.7+Math.random()*.6,k=r*T,v=c*y;if(a!==void 0){const D=a+Math.PI,B=(m/(h-1)-.5)*2*l,_=(Math.random()-.5)*.5;M=D+B+_;const O=D+Math.PI/2,X=(m/(h-1)-.5)*o*.8,L=(Math.random()-.5)*o*.3,H=k*.5;S=n.x+Math.cos(O)*(X+L)+Math.cos(M)*H,E=n.y+Math.sin(O)*(X+L)+Math.sin(M)*H}else{M=Math.random()*Math.PI*2;const D=k*.5;S=n.x+Math.cos(M)*D+(Math.random()-.5)*o*.3,E=n.y+Math.sin(M)*D+(Math.random()-.5)*o*.3}const I=this.getLineEffectSprite();if(!I)continue;I.setPosition(S,E),I.setTint(g[m%g.length]),I.setRotation(M);const w=k/u.EFFECT_TEXTURE_SIZE,A=v/u.EFFECT_LINE_HEIGHT;I.setScale(w,A),I.setAlpha(1);const P=o*(1.2+Math.random()*1.3),b=S+Math.cos(M)*P,R=E+Math.sin(M)*P;this.tweens.add({targets:I,x:b,y:R,alpha:0,scaleX:w*.2,scaleY:A*.4,duration:280+Math.random()*140,ease:"Power2",onComplete:()=>{this.releaseLineEffectSprite(I)}})}}showExplosionSparkEffect(t,e,s,a=1.5){const i=this.gameBounds.height/10,n=8,o=i*1.5,h=32,r=i*a,c=s>>16&255,l=s>>8&255,d=s&255,p=[Math.max(0,c-40)<<16|Math.max(0,l-40)<<8|Math.max(0,d-40),Math.max(0,c-20)<<16|Math.max(0,l-20)<<8|Math.max(0,d-20),s,Math.min(255,c+30)<<16|Math.min(255,l+30)<<8|Math.min(255,d+30),Math.min(255,c+60)<<16|Math.min(255,l+60)<<8|Math.min(255,d+60),Math.min(255,c+90)<<16|Math.min(255,l+90)<<8|Math.min(255,d+90),16777215,Math.min(255,c+50)<<16|Math.min(255,l+50)<<8|Math.min(255,d+50)];for(let f=0;f<n;f++){const g=.6+Math.random()*.8,m=.7+Math.random()*.6,M=o*g,S=h*m,E=f/n*Math.PI*2+(Math.random()-.5)*.6,T=M*.5,y=t+Math.cos(E)*T,k=e+Math.sin(E)*T,v=this.getLineEffectSprite();if(!v)continue;v.setPosition(y,k),v.setTint(p[f%p.length]),v.setRotation(E);const I=M/u.EFFECT_TEXTURE_SIZE,w=S/u.EFFECT_LINE_HEIGHT;v.setScale(I,w),v.setAlpha(1);const A=r*(.9+Math.random()*.5),P=t+Math.cos(E)*A,b=e+Math.sin(E)*A;this.tweens.add({targets:v,x:P,y:b,alpha:0,scaleX:I*.3,duration:250+Math.random()*100,ease:"Power2",onComplete:()=>{this.releaseLineEffectSprite(v)}})}}getSectorTextureKey(t){const e=[30,40,50,60,70,80,90,100,110,120,130,140,150,160];let s=e[0],a=Math.abs(t-s);for(const i of e){const n=Math.abs(t-i);n<a&&(a=n,s=i)}return u.TEXTURE_SECTOR_PREFIX+s}flashSkillEffectSector(t,e,s,a,i,n){const o=this.getSkillEffectSprite();if(!o)return;const h=this.getSectorTextureKey(i*2);o.setTexture(h),o.setPosition(t,e),o.setRotation(a);const r=s*2/u.EFFECT_TEXTURE_SIZE;o.setScale(r),o.setTint(n),o.setAlpha(0),this.tweens.add({targets:o,alpha:{from:0,to:.75},scale:{from:r*.5,to:r},duration:150,ease:"Quad.easeOut",onComplete:()=>{this.time.delayedCall(150,()=>{this.tweens.add({targets:o,alpha:0,scale:r*1.1,duration:200,ease:"Quad.easeIn",onComplete:()=>{this.releaseSkillEffectSprite(o)}})})}})}flashSkillEffectCircle(t,e,s,a){const i=this.getSkillEffectSprite();if(!i)return;i.setTexture(u.TEXTURE_CIRCLE),i.setPosition(t,e);const n=s*2/u.EFFECT_TEXTURE_SIZE;i.setScale(n*.3),i.setTint(a),i.setAlpha(0),i.setRotation(0);const o=500,h=this.time.now,r=Math.PI*5,c=Math.PI*200,l=()=>{if(!i.active)return;const d=this.time.now-h,p=Math.min(d/o,1);let f;if(p<.8)f=p*o/1e3*r;else{const M=.8*o/1e3*r,E=(p-.8)/.2*.2*o/1e3*c;f=M+E}i.setRotation(f);let g,m;if(p<.8){const M=p/.8;g=n*.3+(n-n*.3)*M,m=.75}else{const M=(p-.8)/.2;g=n+n*.2*M,m=.75*(1-M)}i.setScale(g),i.setAlpha(m),p<1?this.time.delayedCall(16,l):this.releaseSkillEffectSprite(i)};l()}flashShieldEffect(t,e,s,a){const i=this.worldToScreen(t,e),n=this.gameBounds.height/10,o=this.getSkillEffectSprite();if(!o)return;o.setTexture(u.TEXTURE_SECTOR_360),o.setPosition(i.x,i.y+n*.3);const h=s*2.5/u.EFFECT_TEXTURE_SIZE,r=h*.3;o.setScale(h*.1,r*.1),o.setTint(a),o.setAlpha(0),o.setRotation(0),o.setDepth(199),this.tweens.add({targets:o,scaleX:{from:h*.1,to:h},scaleY:{from:r*.1,to:r},alpha:{from:.8,to:0},duration:500,ease:"Quad.easeOut",onComplete:()=>{this.releaseSkillEffectSprite(o)}});const c=8;for(let l=0;l<c;l++){const d=this.getLineEffectSprite();if(!d)continue;const p=l/c*Math.PI*2+(Math.random()-.5)*.5,f=n*(.3+Math.random()*.5),g=i.x+Math.cos(p)*f,m=i.y+n*(.1+Math.random()*.3),M=n*(.25+Math.random()*.2),S=20+Math.random()*16;d.setPosition(g,m),d.setRotation(-Math.PI/2+(Math.random()-.5)*.4),d.setScale(M/u.EFFECT_TEXTURE_SIZE,S/u.EFFECT_LINE_HEIGHT),d.setTint(a),d.setAlpha(.9),d.setDepth(200);const E=n*(2+Math.random()*1.5),T=M*2.5,y=500+Math.random()*300,k=l*40;this.tweens.add({targets:d,y:m-E,alpha:0,scaleX:T/u.EFFECT_TEXTURE_SIZE,scaleY:S*.4/u.EFFECT_LINE_HEIGHT,duration:y,delay:k,ease:"Quad.easeOut",onComplete:()=>{this.releaseLineEffectSprite(d)}})}}flashOctagonShieldExplosion(t,e,s,a){const i=this.worldToScreen(t,e),n=s*2/u.EFFECT_TEXTURE_SIZE,o=n*.05,h=this.add.sprite(i.x,i.y,u.TEXTURE_CIRCLE);this.skillGridContainer.add(h),h.setTint(16777215),h.setAlpha(1),h.setScale(.1),h.setDepth(252),this.tweens.add({targets:h,scaleX:n*.8,scaleY:n*.8,alpha:0,duration:300,ease:"Cubic.easeOut",onUpdate:()=>{const g=this.worldToScreen(t,e);h.setPosition(g.x,g.y)},onComplete:()=>h.destroy()});const r=[0,80,160],c=[a,16772744,16777215],l=[.9,.7,.5];r.forEach((g,m)=>{this.time.delayedCall(g,()=>{const M=this.add.sprite(i.x,i.y,u.TEXTURE_SHIELD);this.skillGridContainer.add(M),M.setTint(c[m]),M.setAlpha(l[m]),M.setScale(o*(1+m*.3)),M.setDepth(249-m),this.tweens.add({targets:M,scaleX:n*(1.2+m*.15),scaleY:n*(1.2+m*.15),rotation:Math.PI*(4-m),alpha:0,duration:600+m*100,ease:"Cubic.easeOut",onUpdate:()=>{const S=this.worldToScreen(t,e);M.setPosition(S.x,S.y)},onComplete:()=>M.destroy()})})});const d=this.add.sprite(i.x,i.y,u.TEXTURE_SHIELD);this.skillGridContainer.add(d),d.setTint(a),d.setAlpha(1),d.setScale(o),d.setDepth(250),d.setRotation(0);const p=this.add.sprite(i.x,i.y,u.TEXTURE_SHIELD);this.skillGridContainer.add(p),p.setTint(16777215),p.setAlpha(.9),p.setScale(o*.5),p.setDepth(251),p.setRotation(0),this.tweens.add({targets:d,scaleX:n,scaleY:n,rotation:Math.PI*6,alpha:0,duration:500,ease:"Cubic.easeOut",onUpdate:()=>{const g=this.worldToScreen(t,e);d.setPosition(g.x,g.y)},onComplete:()=>{d.destroy()}}),this.tweens.add({targets:p,scaleX:n*.6,scaleY:n*.6,rotation:-Math.PI*4,alpha:0,duration:600,ease:"Cubic.easeOut",onUpdate:()=>{const g=this.worldToScreen(t,e);p.setPosition(g.x,g.y)},onComplete:()=>{p.destroy()}});const f=8;for(let g=0;g<f;g++){const m=this.getSkillEffectSprite();if(!m)continue;m.setTexture(u.TEXTURE_CIRCLE);const M=Math.PI*2*g/f+Math.random()*.3,S=s*(.8+Math.random()*.4),E=this.worldToScreen(t,e);m.setPosition(E.x,E.y),m.setTint(g%2===0?a:16777215),m.setAlpha(1),m.setScale(.08+Math.random()*.04),m.setDepth(253);const T=t+Math.cos(M)*S,y=e+Math.sin(M)*S;this.tweens.add({targets:m,scaleX:.02,scaleY:.02,alpha:0,duration:400+Math.random()*200,ease:"Cubic.easeOut",onUpdate:k=>{const v=k.progress,I=t+(T-t)*v,w=e+(y-e)*v,A=this.worldToScreen(I,w);m.setPosition(A.x,A.y)},onComplete:()=>this.releaseSkillEffectSprite(m)})}}flashSkillEffectLine(t,e,s,a,i,n){const o=this.getSkillEffectSprite();if(!o)return;o.setTexture(u.TEXTURE_LINE);const h=s-t,r=a-e,c=Math.sqrt(h*h+r*r),l=(t+s)/2,d=(e+a)/2,p=Math.atan2(r,h);o.setPosition(l,d),o.setRotation(p);const f=c/u.EFFECT_TEXTURE_SIZE,g=i/u.EFFECT_LINE_HEIGHT;o.setScale(f,g),o.setTint(n),o.setAlpha(0),this.tweens.add({targets:o,alpha:{from:0,to:.85},scaleY:{from:g*.5,to:g},duration:80,ease:"Quad.easeOut",onComplete:()=>{this.time.delayedCall(300,()=>{this.tweens.add({targets:o,alpha:0,scaleY:g*.2,duration:400,ease:"Quad.easeIn",onComplete:()=>{this.releaseSkillEffectSprite(o)}})})}})}flashSkillEffectSectorMoving(t,e,s,a,i,n,o){const h=this.getSkillEffectSprite();if(!h)return;h.setTexture(u.TEXTURE_SOULWAVE);const r=s*2/u.EFFECT_TEXTURE_SIZE,c=r*.1;h.setScale(c),h.setRotation(a),h.setTint(n),h.setAlpha(.8),h.setPosition(t,e);const l=1e3,d=500,p=this.time.now,f=()=>{const g=this.time.now-p,m=Math.min(g/l,1);if(m>=1){this.releaseSkillEffectSprite(h);return}const M=Math.min(g/d,1),S=c+(r-c)*M;h.setScale(S);const E=o*m,T=t+Math.cos(a)*E,y=e+Math.sin(a)*E;h.setPosition(T,y);const k=.8*(1-m*.7);h.setAlpha(k),this.time.delayedCall(16,f)};f()}worldToScreen(t,e){return{x:t-this.cameraOffsetX,y:e-this.cameraOffsetY}}showSkillRangeCircle(t,e,s,a,i=.3){const n=this.worldToScreen(t,e),o=n.x,h=n.y,r=u.SKILL_GRID_GAP,c=this.skillGridCellSize+r,l=Math.max(0,Math.floor((o-s)/c)),d=Math.min(this.skillGridCols-1,Math.ceil((o+s)/c)),p=Math.max(0,Math.floor((h-s)/c)),f=Math.min(this.skillGridRows-1,Math.ceil((h+s)/c));for(let g=p;g<=f;g++)for(let m=l;m<=d;m++){const M=m*c+this.skillGridCellSize/2,S=g*c+this.skillGridCellSize/2,E=M-o,T=S-h;if(Math.sqrt(E*E+T*T)<=s){const k=g*this.skillGridCols+m;this.activateSkillGridCell(k,a,i)}}}showSkillRangeSector(t,e,s,a,i,n,o=.3){const h=this.worldToScreen(t,e),r=h.x,c=h.y,l=u.SKILL_GRID_GAP,d=this.skillGridCellSize+l,p=Math.max(0,Math.floor((r-s)/d)),f=Math.min(this.skillGridCols-1,Math.ceil((r+s)/d)),g=Math.max(0,Math.floor((c-s)/d)),m=Math.min(this.skillGridRows-1,Math.ceil((c+s)/d));for(let M=g;M<=m;M++)for(let S=p;S<=f;S++){const E=S*d+this.skillGridCellSize/2,T=M*d+this.skillGridCellSize/2,y=E-r,k=T-c,v=Math.sqrt(y*y+k*k);if(v<=s&&v>0){const I=Math.atan2(k,y);let w=Math.abs(I-a);if(w>Math.PI&&(w=2*Math.PI-w),w<=i){const A=M*this.skillGridCols+S;this.activateSkillGridCell(A,n,o)}}}}showSkillRangeLine(t,e,s,a,i,n,o=.3){const h=this.worldToScreen(t,e),r=this.worldToScreen(s,a),c=u.SKILL_GRID_GAP,l=this.skillGridCellSize+c,d=r.x-h.x,p=r.y-h.y,f=Math.sqrt(d*d+p*p);if(f===0)return;const g=d/f,m=p/f,M=-m,S=g,E=i/2,T=[{x:h.x+M*E,y:h.y+S*E},{x:h.x-M*E,y:h.y-S*E},{x:r.x+M*E,y:r.y+S*E},{x:r.x-M*E,y:r.y-S*E}],y=Math.min(...T.map(R=>R.x)),k=Math.max(...T.map(R=>R.x)),v=Math.min(...T.map(R=>R.y)),I=Math.max(...T.map(R=>R.y)),w=Math.max(0,Math.floor(y/l)),A=Math.min(this.skillGridCols-1,Math.ceil(k/l)),P=Math.max(0,Math.floor(v/l)),b=Math.min(this.skillGridRows-1,Math.ceil(I/l));for(let R=P;R<=b;R++)for(let D=w;D<=A;D++){const B=D*l+this.skillGridCellSize/2,_=R*l+this.skillGridCellSize/2,O=Math.max(0,Math.min(1,((B-h.x)*g+(_-h.y)*m)/f)),X=h.x+O*d,L=h.y+O*p;if(Math.sqrt((B-X)**2+(_-L)**2)<=E){const F=R*this.skillGridCols+D;this.activateSkillGridCell(F,n,o)}}}clearSkillGrid(){for(const t of this.activeSkillGridCells){if(this.vignetteEdgeCells.has(t)&&(this.isLowHp||this.currentShield>0))continue;const e=Math.floor(t/this.skillGridCols),s=t%this.skillGridCols;if(e===0||e===this.skillGridRows-1||s===0||s===this.skillGridCols-1||e>=1&&e<=3||e>=this.skillGridRows-3)continue;const a=this.skillGridCells[t];a&&a.setVisible(!1)}this.activeSkillGridCells.clear()}activateSkillGridCell(t,e,s){if(t<0||t>=this.skillGridCells.length)return;const a=this.skillGridCells[t];a&&(a.setFillStyle(e,s),a.setVisible(!0),this.activeSkillGridCells.add(t))}flashGridAt(t,e,s,a=1){const i=this.worldToScreen(t,e),n=u.SKILL_GRID_GAP,o=this.skillGridCellSize+n,h=Math.floor(i.x/o),r=Math.floor(i.y/o),c=600,l=200,d=this.time.now,p=[];for(let m=-a;m<=a;m++)for(let M=-a;M<=a;M++){const S=h+M,E=r+m;if(S<0||S>=this.skillGridCols||E<0||E>=this.skillGridRows)continue;const T=Math.sqrt(m*m+M*M);if(T<=a){const y=E*this.skillGridCols+S,k=this.skillGridCells[y];k&&p.push({cell:k,dist:T})}}if(p.length===0)return;const f=()=>{const m=this.time.now-d,M=Math.min(m/c,1);let S=0;m>l&&(S=(m-l)/(c-l));for(const{cell:E,dist:T}of p){const y=T/Math.max(a,1),v=(1-y*.4)*(1-S);if(v>.01)if(m<l){const w=(1-y)*.5;if(E.setFillStyle(s,v),E.setVisible(!0),T<a*.5){const A=s>>16&255,P=s>>8&255,b=s&255,R=Math.min(255,A+Math.floor((255-A)*w)),D=Math.min(255,P+Math.floor((255-P)*w)),B=Math.min(255,b+Math.floor((255-b)*w)),_=R<<16|D<<8|B;E.setFillStyle(_,v)}}else E.setFillStyle(s,v),E.setVisible(!0);else E.setVisible(!1)}if(M>=1)for(const{cell:E}of p)E.setVisible(!1),E.setAlpha(1)};f();const g=this.time.addEvent({delay:16,callback:f,callbackScope:this,repeat:Math.ceil(c/16)});this.time.delayedCall(c+50,()=>{g.remove();for(const{cell:m}of p)m.setVisible(!1),m.setAlpha(1)})}flashGridAtPositions(t,e,s=1){t.forEach(a=>{this.flashGridAt(a.x,a.y,e,s)})}flashDeathEffect(t,e){const s=this.worldToScreen(t,e),a=u.SKILL_GRID_GAP,i=this.skillGridCellSize+a,n=Math.floor(s.x/i),o=Math.floor(s.y/i),h=3,r=400,c=this.time.now,l=[];for(let S=0;S<h;S++){const E=Math.random()*Math.PI*2,T=2+Math.random()*2;l.push({col:n+Math.round(Math.cos(E)*T),row:o+Math.round(Math.sin(E)*T),radius:3+Math.floor(Math.random()*3)})}const d=new Map;for(const S of l){const E=S.radius;for(let T=-E;T<=E;T++)for(let y=-E;y<=E;y++){const k=Math.sqrt(T*T+y*y);if(k<=E){const v=S.col+y,I=S.row+T;if(v>=0&&v<this.skillGridCols&&I>=0&&I<this.skillGridRows){const w=`${v},${I}`,A=d.get(w);(!A||k<A.dist)&&d.set(w,{col:v,row:I,dist:k})}}}}const p=Array.from(d.values());if(p.length===0)return;const f=Math.max(...p.map(S=>S.dist)),g=[];for(const{col:S,row:E,dist:T}of p){const y=S*i+this.skillGridCellSize/2,k=E*i+this.skillGridCellSize/2,v=this.add.rectangle(y,k,this.skillGridCellSize,this.skillGridCellSize,16777215,0);v.setVisible(!1),this.skillGridContainer.add(v),g.push({rect:v,dist:T})}const m=()=>{const S=this.time.now-c,E=Math.min(S/r,1);for(const{rect:T,dist:y}of g){const k=y/(f+1),v=k+.5;let I=0;if(E>=k&&E<=v&&(E<k+.1?I=(E-k)/.1:I=1-(E-k-.1)/(v-k-.1),I=Math.max(0,Math.min(.8,I))),I>.01){const w=200+Math.floor(Math.random()*55),A=w<<16|w<<8|w;T.setFillStyle(A,I),T.setVisible(!0)}else T.setVisible(!1)}if(E>=1)for(const{rect:T}of g)T.destroy()};m();const M=this.time.addEvent({delay:16,callback:m,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{M.remove();for(const{rect:S}of g)S.active&&S.destroy()})}flashSkillAreaSector(t,e,s,a,i,n){const o=t,h=e,r=u.SKILL_GRID_GAP,c=this.skillGridCellSize+r,l=500,d=150,p=150,f=this.time.now,g=[],m=o-s,M=o+s,S=h-s,E=h+s;for(let v=S;v<=E;v+=c)for(let I=m;I<=M;I+=c){const w=Math.round(I/c)*c,A=Math.round(v/c)*c,P=w-o,b=A-h,R=Math.sqrt(P*P+b*b);if(R<=s&&R>0){const D=Math.atan2(b,P);let B=Math.abs(D-a);B>Math.PI&&(B=2*Math.PI-B),B<=i&&g.push({worldX:w,worldY:A,dist:R,angleDist:B})}}if(g.length===0)return;const T=[];for(const{worldX:v,worldY:I}of g){const w=this.add.rectangle(v,I,this.skillGridCellSize,this.skillGridCellSize,n,0);w.setVisible(!1),w.setDepth(50),this.worldContainer.add(w),T.push(w)}const y=()=>{const v=this.time.now-f,I=Math.min(v/l,1),w=Math.min(v/d,1),A=s*w;let P=0;v>d+p&&(P=(v-d-p)/(l-d-p));const b=s*P;let R=0;for(const{dist:D,angleDist:B}of g){const _=T[R++];if(_)if(D<=A&&D>=b){const O=D/s,X=B/i,F=Math.max(O,X),z=Math.max(0,Math.min(1,(F-.3)/.7)),Y=z*z*(3-2*z),W=.15+Y*.6;let Z=1;if(b>0){const N=s*.15;D<b+N&&(Z=(D-b)/N)}const et=W*Z;if(et>.01){const N=.5+Y*.5,U=n>>16&255,V=n>>8&255,q=n&255;let J=U,tt=V,Q=q;if(F>.85&&v<d+p){const at=(F-.85)/.15;J=Math.min(255,U+Math.floor((255-U)*at*.3)),tt=Math.min(255,V+Math.floor((255-V)*at*.3)),Q=Math.min(255,q+Math.floor((255-q)*at*.3))}else J=Math.floor(U*N),tt=Math.floor(V*N),Q=Math.floor(q*N);const nt=J<<16|tt<<8|Q;_.setFillStyle(nt,et),_.setVisible(!0)}else _.setVisible(!1)}else _.setVisible(!1)}if(I>=1)for(const D of T)D.destroy()};y();const k=this.time.addEvent({delay:16,callback:y,callbackScope:this,repeat:Math.ceil(l/16)});this.time.delayedCall(l+50,()=>{k.remove();for(const v of T)v.active&&v.destroy()})}flashSkillAreaCircle(t,e,s,a){const i=t,n=e,o=u.SKILL_GRID_GAP,h=this.skillGridCellSize+o,r=500,c=150,l=150,d=this.time.now,p=[],f=i-s,g=i+s,m=n-s,M=n+s;for(let y=m;y<=M;y+=h)for(let k=f;k<=g;k+=h){const v=Math.round(k/h)*h,I=Math.round(y/h)*h,w=v-i,A=I-n,P=Math.sqrt(w*w+A*A);P<=s&&p.push({worldX:v,worldY:I,dist:P})}if(p.length===0)return;const S=[];for(const{worldX:y,worldY:k}of p){const v=this.add.rectangle(y,k,this.skillGridCellSize,this.skillGridCellSize,a,0);v.setVisible(!1),v.setDepth(50),this.worldContainer.add(v),S.push(v)}const E=()=>{const y=this.time.now-d,k=Math.min(y/r,1),v=Math.min(y/c,1),I=s*v;let w=0;y>c+l&&(w=(y-c-l)/(r-c-l));const A=s*w;let P=0;for(const{dist:b}of p){const R=S[P++];if(R)if(b<=I&&b>=A){const D=b/s,B=Math.max(0,Math.min(1,(D-.3)/.7)),_=B*B*(3-2*B),O=.15+_*.6;let X=1;if(A>0){const H=s*.15;b<A+H&&(X=(b-A)/H)}const L=O*X;if(L>.01){const H=.5+_*.5,F=a>>16&255,z=a>>8&255,Y=a&255;let W=F,Z=z,et=Y;if(D>.85&&y<c+l){const U=(D-.85)/.15;W=Math.min(255,F+Math.floor((255-F)*U*.3)),Z=Math.min(255,z+Math.floor((255-z)*U*.3)),et=Math.min(255,Y+Math.floor((255-Y)*U*.3))}else W=Math.floor(F*H),Z=Math.floor(z*H),et=Math.floor(Y*H);const N=W<<16|Z<<8|et;R.setFillStyle(N,L),R.setVisible(!0)}else R.setVisible(!1)}else R.setVisible(!1)}if(k>=1)for(const b of S)b.destroy()};E();const T=this.time.addEvent({delay:16,callback:E,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{T.remove();for(const y of S)y.active&&y.destroy()})}flashSkillAreaLine(t,e,s,a,i,n){const o=t,h=e,r=s,c=a,l=u.SKILL_GRID_GAP,d=this.skillGridCellSize+l,p=r-o,f=c-h,g=Math.sqrt(p*p+f*f);if(g===0)return;const m=p/g,M=f/g,S=-M,E=m,T=i/2,y=800,k=80,v=300,I=y-k-v,w=this.time.now,A=[],P=[{x:o+S*T,y:h+E*T},{x:o-S*T,y:h-E*T},{x:r+S*T,y:c+E*T},{x:r-S*T,y:c-E*T}],b=Math.min(...P.map(L=>L.x)),R=Math.max(...P.map(L=>L.x)),D=Math.min(...P.map(L=>L.y)),B=Math.max(...P.map(L=>L.y));for(let L=D;L<=B;L+=d)for(let H=b;H<=R;H+=d){const F=Math.round(H/d)*d,z=Math.round(L/d)*d,Y=F-o,W=z-h,Z=Y*m+W*M;if(Z<0||Z>g)continue;const et=o+m*Z,N=h+M*Z,U=Math.sqrt((F-et)**2+(z-N)**2);U<=T&&A.push({worldX:F,worldY:z,distAlong:Z,distToLine:U})}if(A.length===0)return;const _=[];for(const{worldX:L,worldY:H}of A){const F=this.add.rectangle(L,H,this.skillGridCellSize,this.skillGridCellSize,n,0);F.setVisible(!1),F.setDepth(50),this.worldContainer.add(F),_.push(F)}const O=()=>{const L=this.time.now-w,H=Math.min(L/y,1),F=Math.min(L/k,1),z=g*F;let Y=0;L>k+v&&(Y=(L-k-v)/I);const W=g*Y,Z=1-Y;let et=0;for(const{distAlong:N,distToLine:U}of A){const V=_[et++];if(!V)continue;const q=T*Z;if(N<=z&&N>=W&&U<=q){const J=q>0?U/q:1,tt=1-J*J;let Q=.2+tt*.5;const nt=N/g,at=Math.min(1,nt/.15),ct=Math.min(1,(1-nt)/.15),St=Math.min(at,ct);Q*=St*St;let Mt=1;if(W>0){const ot=g*.1;N<W+ot&&(Mt=(N-W)/ot)}const Ct=Q*Mt;if(Ct>.01){const ot=.6+tt*.4,Tt=n>>16&255,yt=n>>8&255,kt=n&255;let vt,wt,It;if(J<.2&&L<k+v){const At=1-J/.2;vt=Math.min(255,Tt+Math.floor((255-Tt)*At*.3)),wt=Math.min(255,yt+Math.floor((255-yt)*At*.3)),It=Math.min(255,kt+Math.floor((255-kt)*At*.3))}else vt=Math.floor(Tt*ot),wt=Math.floor(yt*ot),It=Math.floor(kt*ot);const Ot=vt<<16|wt<<8|It;V.setFillStyle(Ot,Ct),V.setVisible(!0)}else V.setVisible(!1)}else V.setVisible(!1)}if(H>=1)for(const N of _)N.destroy()};O();const X=this.time.addEvent({delay:16,callback:O,callbackScope:this,repeat:Math.ceil(y/16)});this.time.delayedCall(y+50,()=>{X.remove();for(const L of _)L.active&&L.destroy()})}getCharacterX(){return this.characterX}getCharacterY(){return this.characterY}getCurrentLevel(){return this.currentLevel}getGameBounds(){return this.gameBounds}getMonsterManager(){return this.monsterManager}getSkillManager(){return this.skillManager}getShowGridSkillEffects(){return this.showGridSkillEffects}getCameraOffsetX(){return this.cameraOffsetX}getCameraOffsetY(){return this.cameraOffsetY}getCurrentShield(){return this.currentShield}getMaxShield(){return this.maxShield}setCurrentShield(t){this.currentShield=t}getFacingRight(){return this.facingRight}setFacingRight(t){this.facingRight=t,this.updateCharacterSprite()}setArchitectSkillLevel(t){this.architectSkillLevel=t}getCurrentSawBladePositions(){return this.currentSawBladePositions}getMaxHp(){return this.maxHp}setMaxShield(t){this.maxShield=t}setShieldReflectDamage(t){this.shieldReflectDamage=t}getCurrentHp(){return this.currentHp}setCurrentHp(t){this.currentHp=t}getTime(){return this.time}getCharacter(){return this.character}getZeroTrustActive(){return this.zeroTrustActive}setZeroTrustActive(t){this.zeroTrustActive=t}getZeroTrustPoints(){return this.zeroTrustPoints}clearZeroTrustPoints(){this.zeroTrustPoints=[]}clearZeroTrustTrackedMonsters(){this.zeroTrustTrackedMonsters.clear()}getZeroTrustSprite(){return this.zeroTrustSprite}clearZeroTrustSprite(){this.zeroTrustSprite=void 0}getPhantomCount(){return this.phantoms.length}getPhantomMaxCount(){return u.PHANTOM_MAX_COUNT}};x(u,"JOYSTICK_RADIUS",60),x(u,"JOYSTICK_KNOB_RADIUS",25),x(u,"MAP_SCALE_DEFAULT",10),x(u,"MAP_SCALE_IOS",3),x(u,"ACTIVE_SKILLS",4),x(u,"PASSIVE_SKILLS",3),x(u,"FLOOR_HEX_MAX",500),x(u,"FLOOR_HEX_GRID_SIZE",.025),x(u,"HEX_CHARS","0123456789ABCDEF"),x(u,"BINARY_CHARS","01"),x(u,"HEX_CHANCE",.3),x(u,"HEX_TINT_NORMAL",1727002),x(u,"HEX_TINT_HIGHLIGHT",16777215),x(u,"PARALLAX_BG_SCALE",4),x(u,"FLOOR_OBSTACLE_COUNT_MIN",15),x(u,"FLOOR_OBSTACLE_COUNT_MAX",20),x(u,"FLOOR_OBSTACLE_SIZE_MIN",5),x(u,"FLOOR_OBSTACLE_SIZE_MAX",8),x(u,"PHANTOM_COLOR",5579434),x(u,"PHANTOM_COLOR_LIGHT",7816396),x(u,"SCAN_INTERVAL",3e4),x(u,"SCAN_WIDTH",.15),x(u,"SCAN_SPEED",.3),x(u,"SCAN_BRIGHTNESS",1),x(u,"CIRCULAR_SCAN_INTERVAL",1e4),x(u,"CIRCULAR_SCAN_WIDTH",.1),x(u,"CIRCULAR_SCAN_SPEED",.8),x(u,"CIRCULAR_SCAN_MAX",1.5),x(u,"DAMAGE_SCAN_COLOR",16729156),x(u,"DAMAGE_SCAN_WIDTH",.08),x(u,"DAMAGE_SCAN_SPEED",1.2),x(u,"DAMAGE_SCAN_MAX",.6),x(u,"SHIELD_SCAN_COLOR",16763904),x(u,"SHIELD_SCAN_WIDTH",.1),x(u,"SHIELD_SCAN_EXPAND_SPEED",1),x(u,"SHIELD_SCAN_CONTRACT_SPEED",2.5),x(u,"SHIELD_SCAN_BURST_SPEED",3),x(u,"SHIELD_SCAN_EXPAND_MAX",.35),x(u,"SHIELD_SCAN_BURST_MAX",.8),x(u,"LEVELUP_SCAN_COLOR",4491519),x(u,"LEVELUP_SCAN_WIDTH",.1),x(u,"LEVELUP_SCAN_EXPAND_SPEED",1.2),x(u,"LEVELUP_SCAN_CONTRACT_SPEED",3),x(u,"LEVELUP_SCAN_BURST_SPEED",3.5),x(u,"LEVELUP_SCAN_EXPAND_MAX",.4),x(u,"LEVELUP_SCAN_BURST_MAX",1),x(u,"RADIUS_WAVE_INTERVAL",5e3),x(u,"RADIUS_WAVE_POINTS",5),x(u,"GAMEOVER_SCAN_COLOR",16729156),x(u,"GAMEOVER_SCAN_WIDTH",.12),x(u,"GAMEOVER_SCAN_EXPAND_SPEED",.8),x(u,"GAMEOVER_SCAN_CONTRACT_SPEED",2),x(u,"GAMEOVER_SCAN_BURST_SPEED",2.5),x(u,"GAMEOVER_SCAN_EXPAND_MAX",.5),x(u,"GAMEOVER_SCAN_BURST_MAX",1.2),x(u,"DOT_MATRIX_FONT",{G:[[0,0,1,1,1,1,0],[0,1,1,1,1,1,1],[1,1,0,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,0,1,1,1],[1,1,0,0,1,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,1],[0,0,1,1,1,1,0]],A:[[0,0,1,1,1,0,0],[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1]],M:[[1,1,0,0,0,1,1],[1,1,1,0,1,1,1],[1,1,1,1,1,1,1],[1,1,0,1,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1]],E:[[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,0,0,0,0,0],[1,1,0,0,0,0,0],[1,1,1,1,1,1,0],[1,1,1,1,1,1,0],[1,1,0,0,0,0,0],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1]],O:[[0,0,1,1,1,0,0],[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0],[0,0,1,1,1,0,0]],V:[[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,0,1,1,0],[0,1,1,0,1,1,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,1,0,0,0]],R:[[1,1,1,1,1,1,0],[1,1,1,1,1,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,1,1,1,1,0],[1,1,1,1,1,0,0],[1,1,0,1,1,0,0],[1,1,0,0,1,1,0],[1,1,0,0,0,1,1]]}),x(u,"CAMERA_DEAD_ZONE",.3),x(u,"GAME_MODES",[{id:"daily",name:"日常",multiplier:1,expMultiplier:1,speedMultiplier:.8,hpMultiplier:1,damageMultiplier:1,debuffResistance:0,waveCount:50,color:5025616,description:"標準難度，適合日常遊玩",image:"mode_daily"},{id:"nightmare",name:"噩夢",multiplier:2,expMultiplier:2,speedMultiplier:1.2,hpMultiplier:2,damageMultiplier:1.5,debuffResistance:.25,waveCount:75,color:10233776,description:`怪物更多更快，經驗翻倍
機率抵抗負面狀態`,image:"mode_nightmare"},{id:"inferno",name:"煉獄",multiplier:3,expMultiplier:3,speedMultiplier:1.5,hpMultiplier:2.5,damageMultiplier:2,debuffResistance:.5,waveCount:100,color:16007990,description:`極限挑戰，高風險高回報
更高機率抵抗負面狀態`,image:"mode_inferno"}]),x(u,"PHANTOM_MAX_COUNT",3),x(u,"HP_DAMAGE_DELAY",1e3),x(u,"HP_DAMAGE_LERP_SPEED",3),x(u,"MIN_FONT_SIZE_LARGE",16),x(u,"MIN_FONT_SIZE_MEDIUM",14),x(u,"MIN_FONT_SIZE_SMALL",12),x(u,"CARD_TEXT_PADDING",.12),x(u,"BASE_HP",200),x(u,"HP_PER_LEVEL",50),x(u,"BASE_EXP",100),x(u,"EXP_GROWTH_RATE",1.2),x(u,"DAMAGE_UNIT",10),x(u,"HURT_DURATION",200),x(u,"ATTACK_DURATION",150),x(u,"HEALING_ITEM_HEAL_PERCENT",.1),x(u,"HEALING_ITEM_DROP_COUNT_MIN",2),x(u,"HEALING_ITEM_DROP_COUNT_MAX",3),x(u,"HEALING_ITEM_SCATTER_RADIUS",.5),x(u,"HEALING_ITEM_SIZE",.05),x(u,"EXP_CRYSTAL_POOL_SIZE",300),x(u,"EXP_CRYSTAL_MERGE_THRESHOLD",200),x(u,"EXP_CRYSTAL_SIZE",.04),x(u,"EXP_CRYSTAL_MAGNET_RANGE",2),x(u,"EXP_CRYSTAL_ATTRACT_SPEED",8),x(u,"EXP_CRYSTAL_PICKUP_RANGE",2),x(u,"SKILL_GRID_GAP",1),x(u,"SKILL_EFFECT_POOL_SIZE",50),x(u,"MAX_ACTIVE_SKILL_EFFECTS",80),x(u,"LINE_EFFECT_POOL_SIZE",80),x(u,"MAX_ACTIVE_LINE_EFFECTS",120),x(u,"CIRCLE_LINE_EFFECT_POOL_SIZE",20),x(u,"TEXTURE_SECTOR_PREFIX","effect_sector_"),x(u,"TEXTURE_SECTOR_360","effect_sector_360"),x(u,"TEXTURE_CIRCLE","effect_circle"),x(u,"TEXTURE_CIRCLE_LINE","effect_circle_line"),x(u,"TEXTURE_LINE","effect_line"),x(u,"TEXTURE_SOULWAVE","effect_soulwave"),x(u,"TEXTURE_SHIELD","effect_shield"),x(u,"TEXTURE_SLASH","effect_slash"),x(u,"EFFECT_TEXTURE_SIZE",256),x(u,"EFFECT_LINE_HEIGHT",64);let bt=u;const zt=7,Wt={0:{width:5,pixels:[" ### ","#   #","#  ##","# # #","##  #","#   #"," ### "]},1:{width:3,pixels:[" # ","## "," # "," # "," # "," # ","###"]},2:{width:5,pixels:[" ### ","#   #","    #","  ## "," #   ","#    ","#####"]},3:{width:5,pixels:[" ### ","#   #","    #","  ## ","    #","#   #"," ### "]},4:{width:5,pixels:["#   #","#   #","#   #","#####","    #","    #","    #"]},5:{width:5,pixels:["#####","#    ","#    ","#### ","    #","#   #"," ### "]},6:{width:5,pixels:[" ### ","#    ","#    ","#### ","#   #","#   #"," ### "]},7:{width:5,pixels:["#####","    #","   # ","  #  ","  #  ","  #  ","  #  "]},8:{width:5,pixels:[" ### ","#   #","#   #"," ### ","#   #","#   #"," ### "]},9:{width:5,pixels:[" ### ","#   #","#   #"," ####","    #","    #"," ### "]},A:{width:5,pixels:[" ### ","#   #","#   #","#####","#   #","#   #","#   #"]},B:{width:5,pixels:["#### ","#   #","#   #","#### ","#   #","#   #","#### "]},C:{width:5,pixels:[" ### ","#   #","#    ","#    ","#    ","#   #"," ### "]},D:{width:5,pixels:["#### ","#   #","#   #","#   #","#   #","#   #","#### "]},E:{width:4,pixels:["####","#   ","#   ","### ","#   ","#   ","####"]},F:{width:4,pixels:["####","#   ","#   ","### ","#   ","#   ","#   "]},G:{width:5,pixels:[" ### ","#    ","#    ","# ###","#   #","#   #"," ### "]},H:{width:5,pixels:["#   #","#   #","#   #","#####","#   #","#   #","#   #"]},I:{width:3,pixels:["###"," # "," # "," # "," # "," # ","###"]},J:{width:4,pixels:["####","   #","   #","   #","   #","#  #"," ## "]},K:{width:5,pixels:["#   #","#  # ","# #  ","##   ","# #  ","#  # ","#   #"]},L:{width:4,pixels:["#   ","#   ","#   ","#   ","#   ","#   ","####"]},M:{width:5,pixels:["#   #","## ##","# # #","#   #","#   #","#   #","#   #"]},N:{width:5,pixels:["#   #","##  #","# # #","#  ##","#   #","#   #","#   #"]},O:{width:5,pixels:[" ### ","#   #","#   #","#   #","#   #","#   #"," ### "]},P:{width:4,pixels:["### ","#  #","#  #","### ","#   ","#   ","#   "]},Q:{width:5,pixels:[" ### ","#   #","#   #","#   #","# # #","#  # "," ## #"]},R:{width:4,pixels:["### ","#  #","#  #","### ","# # ","#  #","#  #"]},S:{width:4,pixels:[" ###","#   ","#   "," ## ","   #","   #","### "]},T:{width:5,pixels:["#####","  #  ","  #  ","  #  ","  #  ","  #  ","  #  "]},U:{width:5,pixels:["#   #","#   #","#   #","#   #","#   #","#   #"," ### "]},V:{width:5,pixels:["#   #","#   #","#   #","#   #"," # # "," # # ","  #  "]},W:{width:5,pixels:["#   #","#   #","#   #","#   #","# # #","## ##","#   #"]},X:{width:5,pixels:["#   #"," # # "," # # ","  #  "," # # "," # # ","#   #"]},Y:{width:5,pixels:["#   #","#   #"," # # ","  #  ","  #  ","  #  ","  #  "]},Z:{width:5,pixels:["#####","    #","   # ","  #  "," #   ","#    ","#####"]},"%":{width:5,pixels:["##  #","## # ","  #  "," #   "," # ##","#  ##","   ##"]}," ":{width:3,pixels:["   ","   ","   ","   ","   ","   ","   "]}},Vt={charHeight:zt,chars:Wt};class $t{constructor(){x(this,"font");this.font=Vt}textToPixels(C,t,e){const s=[],a=C.letterSpacing??1,i=C.color.replace("#",""),n=parseInt(i.substring(0,2),16),o=parseInt(i.substring(2,4),16),h=parseInt(i.substring(4,6),16),r=n<<16|o<<8|h;let c=0;const l=C.text.toUpperCase().split("");for(let M=0;M<l.length;M++){const S=this.font.chars[l[M]];S&&(c+=S.width,M<l.length-1&&(c+=a))}const d=Math.floor(t*C.position.x),p=Math.floor(e*C.position.y),f=d-Math.floor(c/2),g=p-Math.floor(this.font.charHeight/2);let m=f;for(const M of l){const S=this.font.chars[M];if(S){for(let E=0;E<S.pixels.length;E++){const T=S.pixels[E];for(let y=0;y<T.length;y++)if(T[y]==="#"){const k=m+y,v=g+E;k>=0&&k<t&&v>=0&&v<e&&s.push({gridX:k,gridY:v,color:r})}}m+=S.width+a}}return s}processConfig(C,t,e){const s=new Map;for(const a of C.texts){const i=this.textToPixels(a,t,e);s.set(a.id,i)}return s}}const Zt=[{id:"title1",text:"PRESS TO",letterSpacing:2,position:{x:.5,y:.44},color:"#ffffff"},{id:"title2",text:"START INTO THE VOID",letterSpacing:2,position:{x:.5,y:.56},color:"#ffffff"}],Kt={texts:Zt},lt=class lt extends G.Scene{constructor(){super("GridScene");x(this,"cells",[]);x(this,"cols",0);x(this,"rows",0);x(this,"cellWidth",10);x(this,"cellHeight",10);x(this,"gap",1);x(this,"isAnimating",!1);x(this,"isReady",!1);x(this,"textRenderer");x(this,"textPixels",new Map);x(this,"cursorGlowRadius",4);x(this,"glowPhase",0);x(this,"textBreathPhase",0);x(this,"isLoading",!0);x(this,"loadingCells",new Set);x(this,"backgroundImage");x(this,"cubeImage");x(this,"neroSImage");x(this,"glowImage");x(this,"cubeBaseScale",1);x(this,"cubeBaseY",0);x(this,"titleBgm");x(this,"pendingClickOrigin",null);x(this,"isPreloadingMain",!1);this.textRenderer=new $t}preload(){this.load.image("background","background.png"),this.load.image("cube","cube.png"),this.load.image("neros","NeroS.png"),this.load.image("glow","glow.png"),this.load.audio("bgm_title","audio/BGM00.mp3"),this.load.audio("se_ui_start","audio/SE_UI_Start.mp3"),this.load.on("progress",t=>{this.updateLoadingProgress(Math.floor(t*100))})}create(){this.cameras.main.setBackgroundColor("rgba(0,0,0,0)"),this.createBackground(),this.calculateGridSize(),this.createGrid(),this.showLoadingText(0),this.startEntryAnimation(),this.preloadGameAssets(),this.input.on("pointerdown",t=>{!this.isReady||this.isAnimating||this.isPreloadingMain||this.startMainScenePreload(t.x,t.y)}),this.input.on("pointermove",t=>{!this.isReady||this.isAnimating||this.updateCursorGlow(t.x,t.y)})}update(t,e){if(!this.isReady||this.isAnimating)return;this.glowPhase+=e*.002,this.textBreathPhase+=e*.004;const s=this.input.activePointer;s&&this.updateCursorGlow(s.x,s.y),this.updateTextBreath()}updateTextBreath(){const t=.5+.5*Math.sin(this.textBreathPhase),e=Math.floor(204+51*t),s=e<<16|e<<8|e,a=.5+.5*Math.sin(this.textBreathPhase*3),i=t>.6?a*.8:0,n=new Set;this.cells.forEach(o=>{o.isText&&n.add(`${o.x},${o.y}`)}),this.cells.forEach(o=>{if(o.isText)o.graphics.setFillStyle(s),o.graphics.setAlpha(.95);else{const h=`${o.x-1},${o.y-1}`;n.has(h)&&i>0&&(o.graphics.setFillStyle(8939263),o.graphics.setAlpha(i))}})}updateCursorGlow(t,e){const s=Math.floor(t/(this.cellWidth+this.gap)),a=Math.floor(e/(this.cellHeight+this.gap)),i=.3+.7*(.5+.5*Math.sin(this.glowPhase));this.cells.forEach(n=>{const o=n.x-s,h=n.y-a,r=Math.sqrt(o*o+h*h);if(r<=this.cursorGlowRadius){const l=(1-r/this.cursorGlowRadius)*i,d=n.originalColor>>16&255,p=n.originalColor>>8&255,f=n.originalColor&255,g=Math.min(255,Math.floor(d+(255-d)*l)),m=Math.min(255,Math.floor(p+(255-p)*l)),M=Math.min(255,Math.floor(f+(255-f)*l)),S=g<<16|m<<8|M;n.graphics.setFillStyle(S)}else n.graphics.setFillStyle(n.originalColor)})}createBackground(){const t=this.cameras.main.width,e=this.cameras.main.height,s=500,a=1e3,i=1e3;this.backgroundImage=this.add.image(t/2,e/2,"background");const n=t/this.backgroundImage.width,o=e/this.backgroundImage.height,h=Math.max(n,o);this.backgroundImage.setScale(h),this.backgroundImage.setDepth(-2),this.backgroundImage.setTint(0);const r=t*.7,c=e/2,l=e*2;this.glowImage=this.add.image(r,c,"glow"),this.glowImage.setDepth(-1.6);const d=l/this.glowImage.height;this.glowImage.setScale(.1),this.glowImage.setAlpha(0),this.tweens.add({targets:this.glowImage,scaleX:d,scaleY:d,alpha:1,duration:s,ease:"Sine.easeOut",onComplete:()=>{this.tweens.addCounter({from:0,to:128,duration:a,ease:"Sine.easeOut",onUpdate:M=>{const S=Math.floor(M.getValue()??0),E=S<<16|S<<8|S;this.backgroundImage.setTint(E)},onComplete:()=>{this.startCharacterEntrance(t,e,i,d)}})}});const p=e*1.5/this.textures.get("neros").getSourceImage().height,f=t+e*1.5*.5;this.neroSImage=this.add.image(f,e/2,"neros"),this.neroSImage.setOrigin(1,.5),this.neroSImage.setDepth(-1.5),this.neroSImage.setScale(p),this.neroSImage.setTint(12566463),this.neroSImage.setAlpha(0);const g=e*.7/this.textures.get("cube").getSourceImage().height,m=-e*.7*.5;this.cubeImage=this.add.image(m,e,"cube"),this.cubeImage.setOrigin(0,1),this.cubeImage.setDepth(-1),this.cubeImage.setScale(g),this.cubeImage.setAlpha(0),this.cubeBaseScale=g,this.cubeBaseY=e}startCharacterEntrance(t,e,s,a){const i=e*1.5/this.textures.get("neros").getSourceImage().height,n=t;this.tweens.add({targets:this.neroSImage,x:n,alpha:1,duration:s,ease:"Sine.easeOut",onComplete:()=>{this.tweens.add({targets:this.neroSImage,scaleX:i*1.015,scaleY:i*1.015,duration:2e3,ease:"Sine.easeInOut",yoyo:!0,repeat:-1})}});const o=e*.7/this.textures.get("cube").getSourceImage().height,h=t*.1;this.tweens.add({targets:this.cubeImage,x:h,alpha:1,duration:s,ease:"Sine.easeOut",onComplete:()=>{this.tweens.add({targets:this.cubeImage,scaleX:o*1.03,scaleY:o*1.03,duration:2e3,ease:"Sine.easeInOut",yoyo:!0,repeat:-1}),this.tweens.add({targets:this.cubeImage,y:e-e*.02,duration:2500,ease:"Sine.easeInOut",yoyo:!0,repeat:-1});const r=()=>{const c=a*(1+Math.random()*.15),l=.6+Math.random()*.4,d=30+Math.random()*120;this.tweens.add({targets:this.glowImage,scaleX:c,scaleY:c,alpha:l,duration:d,ease:"Sine.easeInOut",onComplete:r})};r()}})}showLoadingText(t){this.loadingCells.forEach(d=>{this.cells[d]&&(this.cells[d].originalColor=2236962,this.cells[d].isText=!1,this.cells[d].graphics.setFillStyle(2236962),this.cells[d].graphics.setAlpha(.2))}),this.loadingCells.clear();const e=`LOADING ${t}%`;this.textRenderer.textToPixels({id:"loading",text:e,letterSpacing:2,position:{x:.5,y:.45},color:"#ffffff"},this.cols,this.rows).forEach(d=>{const p=d.gridY*this.cols+d.gridX;this.cells[p]&&(this.cells[p].originalColor=d.color,this.cells[p].isText=!0,this.cells[p].graphics.setFillStyle(d.color),this.cells[p].graphics.setAlpha(.95),this.loadingCells.add(p))});const n=Math.floor(this.rows*.45)+Math.floor(7/2)+3,o=3,h=2,c=this.cols-2-h,l=Math.floor(t/100*c);for(let d=0;d<o;d++){const p=n+d;if(!(p>=this.rows))for(let f=0;f<l;f++){const g=h+f,m=p*this.cols+g;this.cells[m]&&(this.cells[m].originalColor=16777215,this.cells[m].isText=!0,this.cells[m].graphics.setFillStyle(16777215),this.cells[m].graphics.setAlpha(.95),this.loadingCells.add(m))}}}updateLoadingProgress(t){this.isLoading&&this.showLoadingText(t)}preloadGameAssets(){this.onLoadingComplete()}startMainScenePreload(t,e){this.pendingClickOrigin={x:t,y:e},this.isPreloadingMain=!0,this.isReady=!1,this.textPixels.forEach(n=>{n.forEach(o=>{const h=o.gridY*this.cols+o.gridX;this.cells[h]&&(this.cells[h].originalColor=2236962,this.cells[h].isText=!1,this.cells[h].graphics.setFillStyle(2236962),this.cells[h].graphics.setAlpha(.2))})}),this.textPixels.clear(),this.showLoadingText(0),this.load.off("progress"),this.load.on("progress",n=>{this.showLoadingText(Math.floor(n*100))}),this.load.on("complete",()=>{this.onMainScenePreloadComplete()}),this.load.image("char_idle_1","sprites/character/IDEL01.png"),this.load.image("char_idle_2","sprites/character/IDEL02.png"),this.load.image("char_run_1","sprites/character/RUN01.png"),this.load.image("char_run_2","sprites/character/RUN02.png"),this.load.image("char_attack_1","sprites/character/ATTACK01.png"),this.load.image("char_attack_2","sprites/character/ATTACK02.png"),this.load.image("char_hurt","sprites/character/HURT01.png"),this.load.audio("bgm_game_01","audio/BGM01.mp3"),this.load.audio("bgm_game_02","audio/BGM02.mp3"),this.load.audio("se_ui_click","audio/SE_UI_Click.mp3"),this.load.audio("se_ui_confirm","audio/SE_UI_Confirm.mp3"),this.load.audio("se_ui_popup","audio/SE_UI_Popup.mp3"),this.load.audio("se_ui_close","audio/SE_UI_Close.mp3"),this.load.audio("se_ui_start","audio/SE_UI_Start.mp3"),this.load.audio("se_hit_normal_1","audio/SE_Hit_Normal_01.mp3"),this.load.audio("se_hit_normal_2","audio/SE_Hit_Normal_02.mp3"),this.load.audio("se_hit_normal_3","audio/SE_Hit_Normal_03.mp3"),this.load.audio("se_hit_crit","audio/SE_Hit_Crit.mp3"),this.load.audio("se_hit_skill_1","audio/SE_Hit_Skill_01.mp3"),this.load.audio("se_hit_skill_2","audio/SE_Hit_Skill_02.mp3"),this.load.audio("se_hit_skill_3","audio/SE_Hit_Skill_03.mp3"),this.load.image("effect_circle","effects/circle.png"),this.load.image("effect_circle_line","effects/circle_line.png"),this.load.image("effect_line","effects/line.png"),this.load.image("effect_soulwave","effects/soulwave.png"),this.load.image("effect_shield","effects/shield.png"),this.load.image("effect_slash","effects/slash.png");const s=[30,40,50,60,70,80,90,100,110,120,130,140,150,160,360];for(const n of s)this.load.image(`effect_sector_${n}`,`effects/sector_${n}.png`);const a="0123456789ABCDEF";for(const n of a)this.load.image(`hex_${n}`,`effects/hex/${n}.png`);for(let n=0;n<=5;n++)this.load.image(`floor_water_${n}`,`floor/water_0${n}.png`);for(let n=1;n<=5;n++)this.load.image(`bg_city_${n}`,`city/bg_city_0${n}.png`);const i=["A","B","C","D"];for(const n of i)for(let o=0;o<=5;o++)this.load.image(`skill_icon_${n}${o.toString().padStart(2,"0")}`,`icons/skills/${n}${o.toString().padStart(2,"0")}.png`);for(let n=1;n<=4;n++)this.load.image(`skill_icon_P${n.toString().padStart(2,"0")}`,`icons/skills/P${n.toString().padStart(2,"0")}.png`);for(const n of["SA0","SA1","SB0","SB1","SC0","SC1","SD0","SD1"])this.load.image(`skill_icon_${n}`,`icons/skills/${n}.png`);this.load.image("mode_daily","images/mode_daily.png"),this.load.image("mode_nightmare","images/mode_nightmare.png"),this.load.image("mode_inferno","images/mode_inferno.png"),this.load.start()}onMainScenePreloadComplete(){this.isPreloadingMain=!1,this.cache.audio.exists("se_ui_start")&&this.sound.play("se_ui_start",{volume:.7}),this.time.delayedCall(500,()=>{this.tweens.addCounter({from:128,to:0,duration:1e3,ease:"Sine.easeIn",onUpdate:e=>{const s=Math.floor(e.getValue()??0),a=s<<16|s<<8|s;this.backgroundImage.setTint(a)}}),this.tweens.add({targets:this.neroSImage,alpha:0,duration:1e3,ease:"Sine.easeIn"}),this.tweens.add({targets:this.cubeImage,alpha:0,duration:1e3,ease:"Sine.easeIn"}),this.tweens.add({targets:this.glowImage,alpha:0,duration:1e3,ease:"Sine.easeIn"}),this.titleBgm&&this.titleBgm.isPlaying&&this.tweens.addCounter({from:.5,to:0,duration:1e3,ease:"Sine.easeIn",onUpdate:e=>{const s=e.getValue()??0;this.titleBgm.setVolume(s)},onComplete:()=>{this.titleBgm.stop()}}),this.time.delayedCall(1e3,()=>{if(this.pendingClickOrigin){const e=Math.floor(this.pendingClickOrigin.x/(this.cellWidth+this.gap)),s=Math.floor(this.pendingClickOrigin.y/(this.cellHeight+this.gap));this.startExitAnimation(e,s),this.pendingClickOrigin=null}})})}onLoadingComplete(){this.isLoading=!1,this.time.delayedCall(500,()=>{this.cells.forEach(t=>{t.originalColor=2236962,t.isText=!1,t.graphics.setFillStyle(2236962),t.graphics.setAlpha(.2)}),this.loadingCells.clear(),this.time.delayedCall(300,()=>{this.processTextConfig(),this.textPixels.forEach(t=>{t.forEach(e=>{const s=e.gridY*this.cols+e.gridX;this.cells[s]&&(this.cells[s].graphics.setFillStyle(e.color),this.cells[s].graphics.setAlpha(.95))})}),this.isAnimating||(this.isReady=!0),this.cache.audio.exists("bgm_title")&&(this.titleBgm=this.sound.add("bgm_title",{volume:.5,loop:!0}),this.titleBgm.play())})})}calculateGridSize(){const t=this.cameras.main.width,e=this.cameras.main.height,s=Math.min(1,t/lt.BASE_WIDTH),a=Math.max(lt.MIN_CELL_SIZE,Math.floor(lt.BASE_CELL_SIZE*s));this.gap=1,this.cellWidth=a,this.cellHeight=a,this.cols=Math.ceil((t+this.gap)/(a+this.gap)),this.rows=Math.ceil((e+this.gap)/(a+this.gap));const i=.05,n=t*(1-i*2),o=e*(1-i*2),h=16/9,r=n/o;let c,l;r>h?(l=o,c=o*h):(c=n,l=n/h);const d=(t-c)/2,p=(e-l)/2;this.registry.set("gameBounds",{x:d,y:p,width:c,height:l})}createGrid(){for(let t=0;t<this.rows;t++)for(let e=0;e<this.cols;e++){const s=e*(this.cellWidth+this.gap)+this.cellWidth/2,a=t*(this.cellHeight+this.gap)+this.cellHeight/2,i=this.add.rectangle(s,a,this.cellWidth,this.cellHeight,2236962);i.setAlpha(0),this.cells.push({x:e,y:t,graphics:i,delay:0,originalColor:2236962,isText:!1})}}processTextConfig(){this.textPixels=this.textRenderer.processConfig(Kt,this.cols,this.rows),this.textPixels.forEach(t=>{t.forEach(e=>{const s=e.gridY*this.cols+e.gridX;this.cells[s]&&(this.cells[s].originalColor=e.color,this.cells[s].isText=!0)})})}startEntryAnimation(){this.isAnimating=!0;const t=new Set;for(let g=0;g<this.cells.length;g++)t.add(g);const e=20,s=50,a=10,n=Math.floor(200/a),o=3e3;let h=0,r=!1;const c=(g,m)=>m*this.cols+g,l=g=>({x:g%this.cols,y:Math.floor(g/this.cols)}),d=g=>{const m=this.cells[g];m.graphics.setAlpha(1),m.graphics.setFillStyle(16777215),this.tweens.add({targets:m.graphics,fillColor:{from:16777215,to:m.originalColor},alpha:{from:1,to:.2},duration:80,ease:"Linear"})},p=g=>{const{x:m,y:M}=l(g),S=n,E=[];for(let k=0;k<=S;k++)E[k]=[];for(let k=-S;k<=S;k++)for(let v=-S;v<=S;v++){const I=m+v,w=M+k;if(I>=0&&I<this.cols&&w>=0&&w<this.rows){const A=Math.sqrt(v*v+k*k),P=Math.floor(A);if(P<=S){const b=c(I,w);E[P].push(b)}}}let T=0;const y=()=>{T>S||(E[T].forEach(k=>{t.has(k)&&(t.delete(k),d(k))}),T++,T<=S&&this.time.delayedCall(a,y))};y()},f=()=>{if(r)return;if(h>=o||t.size===0){this.finishEntry(t),r=!0;return}const g=Array.from(t),m=Math.min(e,g.length);for(let M=0;M<m&&g.length!==0;M++){const S=Math.floor(Math.random()*g.length),E=g[S];g.splice(S,1),t.has(E)&&p(E)}h+=s,t.size>0&&h<o?this.time.delayedCall(s,f):r||(this.finishEntry(t),r=!0)};f()}finishEntry(t){t.forEach(e=>{const s=this.cells[e];s.graphics.setAlpha(.2),s.graphics.setFillStyle(s.originalColor)}),this.time.delayedCall(100,()=>{this.isAnimating=!1,this.isLoading||(this.isReady=!0)})}startExitAnimation(t,e){this.isAnimating=!0;const s=this.cameras.main.width,a=this.cameras.main.height;this.scene.launch("MainScene"),this.scene.bringToTop("GridScene");const i=t*(this.cellWidth+this.gap)+this.cellWidth/2,n=e*(this.cellHeight+this.gap)+this.cellHeight/2;this.registry.events.emit("reveal-update",{x:i,y:n,radius:0}),this.cells.forEach(l=>{l.graphics.setFillStyle(0),l.graphics.setAlpha(1)}),this.backgroundImage.setVisible(!1),this.cubeImage.setVisible(!1),this.neroSImage.setVisible(!1),this.glowImage.setVisible(!1);const o=5;let h=0;this.cells.forEach(l=>{const d=l.x-t,p=l.y-e,f=Math.sqrt(d*d+p*p);l.delay=Math.floor(f*o),l.delay>h&&(h=l.delay)});const r=Math.sqrt(Math.max(i,s-i)**2+Math.max(n,a-n)**2)+50,c=h+150;this.tweens.addCounter({from:0,to:r,duration:c,ease:"Linear",onUpdate:l=>{const d=l.getValue()??0;this.registry.events.emit("reveal-update",{x:i,y:n,radius:d})}}),this.cells.forEach(l=>{this.time.delayedCall(l.delay,()=>{l.graphics.setFillStyle(16777215),l.graphics.setAlpha(1),this.tweens.addCounter({from:0,to:100,duration:200,ease:"Linear",onUpdate:d=>{const p=d.getValue()??0;let f,g;p<15?(f=16777215,g=1):p<30?(f=16776960,g=1):p<50?(f=16746496,g=1):p<70?(f=16720384,g=1-(p-50)/50):(f=6684672,g=1-(p-50)/50),l.graphics.setFillStyle(f),l.graphics.setAlpha(Math.max(0,g))},onComplete:()=>{l.graphics.setVisible(!1)}})})}),this.time.delayedCall(h+200,()=>{this.registry.events.emit("reveal-complete"),this.scene.stop("GridScene")})}};x(lt,"BASE_CELL_SIZE",10),x(lt,"MIN_CELL_SIZE",4),x(lt,"BASE_WIDTH",1920);let Rt=lt;window.playUIClick=Ft;window.playUIConfirm=Gt;window.playUIPopup=Nt;window.playUIClose=Yt;window.playSoundEffect=mt;const Bt=document.getElementById("version-info");if(Bt){const K="0.9.29a";Bt.textContent=`v${K}`}let it=null;function qt(){return window.innerWidth>window.innerHeight}function Dt(){return window.visualViewport?window.visualViewport.height:window.innerHeight}function Qt(){if(it)return;const K={type:G.AUTO,width:window.innerWidth,height:Dt(),parent:"app",backgroundColor:"#111111",antialias:!0,scale:{mode:G.Scale.RESIZE,autoCenter:G.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[Rt,bt]};it=new G.Game(K),it.events.once("ready",()=>{it&&it.sound&&(it.sound.volume=.5)})}function _t(){(window.innerWidth>900||qt())&&Qt()}let xt=null;function ht(){xt&&clearTimeout(xt),xt=window.setTimeout(()=>{if(it){const K=window.innerWidth,C=Dt();it.scale.resize(K,C);const t=it.canvas;t&&(t.style.width=`${K}px`,t.style.height=`${C}px`)}xt=null},50)}_t();window.addEventListener("resize",()=>{_t(),ht()});window.addEventListener("orientationchange",()=>{setTimeout(()=>{_t(),ht()},150)});window.visualViewport&&(window.visualViewport.addEventListener("resize",ht),window.visualViewport.addEventListener("scroll",ht));document.addEventListener("fullscreenchange",()=>{setTimeout(ht,100)});document.addEventListener("webkitfullscreenchange",()=>{setTimeout(ht,100)});window.matchMedia&&window.matchMedia("(display-mode: standalone)").addEventListener("change",()=>{setTimeout(ht,200)});window.addEventListener("focus",()=>{setTimeout(ht,100)});document.addEventListener("touchmove",K=>{K.target.closest(".popup-overlay")||K.preventDefault()},{passive:!1});document.addEventListener("dblclick",K=>{K.preventDefault()},{passive:!1});window.addEventListener("volumechange",K=>{it&&it.sound&&(it.sound.volume=K.detail.volume)});
