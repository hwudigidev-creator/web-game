<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="icons/icon-96x96.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- Google Fonts: Noto Sans TC -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="DIGI WAR" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="application-name" content="DIGI WAR" />
  <meta name="msapplication-TileColor" content="#111111" />
  <meta name="msapplication-tap-highlight" content="no" />

  <!-- PWA Manifest (ä½¿ç”¨ç›¸å°è·¯å¾‘æ”¯æ´ GitHub Pages å­ç›®éŒ„) -->
  <link rel="manifest" href="manifest.json" />

  <!-- Apple Touch Icons (ä½¿ç”¨ç›¸å°è·¯å¾‘) -->
  <link rel="apple-touch-icon" href="icons/icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="icons/icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="96x96" href="icons/icon-96x96.png" />
  <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128x128.png" />
  <link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144x144.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png" />
  <link rel="apple-touch-icon" sizes="384x384" href="icons/icon-384x384.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512x512.png" />

  <title>DIGI WAR</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    html, body {
      background-color: #111;
      overflow: hidden;
      /* ä½¿ç”¨ dvh æ’é™¤æ‰‹æ©Ÿç€è¦½å™¨ç¶²å€åˆ— */
      height: 100dvh;
      height: 100vh; /* fallback */
      width: 100vw;
      max-width: 100vw;
      max-height: 100dvh;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      position: fixed;
      top: 0;
      left: 0;
    }

    /* æ”¯æ´ dvh çš„ç€è¦½å™¨ */
    @supports (height: 100dvh) {
      body {
        height: 100dvh;
      }
    }

    #app {
      width: 100%;
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
      overflow: hidden;
    }

    /* ç¢ºä¿ canvas ä¸æœƒæº¢å‡º */
    #app canvas {
      display: block;
      max-width: 100vw !important;
      max-height: 100vh !important;
      max-height: 100dvh !important;
    }

    /* å³ä¸Šè§’æ§åˆ¶åˆ— - ç›´å¼æ’åˆ— */
    #controls {
      position: fixed;
      top: 10px;
      right: 10px;
      display: none; /* é è¨­éš±è—ï¼Œè½‰å ´å¾Œæ‰é¡¯ç¤º */
      flex-direction: column;
      gap: 8px;
      z-index: 1000;
    }

    #controls.visible {
      display: flex;
    }

    /* å·¦ä¸Šè§’æ§åˆ¶åˆ— - ç›´å¼æ’åˆ— */
    #left-controls {
      position: fixed;
      top: 10px;
      left: 10px;
      display: none; /* é è¨­éš±è—ï¼Œè½‰å ´å¾Œæ‰é¡¯ç¤º */
      flex-direction: column;
      gap: 8px;
      z-index: 1000;
    }

    #left-controls.visible {
      display: flex;
    }

    .ctrl-btn {
      width: clamp(32px, 5vw, 44px);
      height: clamp(32px, 5vw, 44px);
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: #fff;
      font-size: clamp(14px, 2.5vw, 20px);
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s ease;
      text-decoration: none;
      box-sizing: border-box;
      padding: 0;
      margin: 0;
      flex-shrink: 0;
    }

    .ctrl-btn:hover {
      background: rgba(0, 0, 0, 0.8);
      border-color: rgba(255, 255, 255, 0.6);
    }

    .ctrl-btn:active {
      transform: scale(0.95);
    }

    .ctrl-btn.muted {
      background: rgba(255, 68, 68, 0.6);
      border-color: rgba(255, 68, 68, 0.8);
    }

    #suicide-btn {
      background: rgba(80, 30, 30, 0.6);
      border-color: rgba(180, 80, 80, 0.5);
    }

    #suicide-btn:hover {
      background: rgba(120, 40, 40, 0.8);
      border-color: rgba(255, 100, 100, 0.8);
    }

    /* å½ˆå‡ºè¦–çª—æ¨£å¼ */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .popup-overlay.visible {
      display: flex;
      opacity: 1;
      pointer-events: auto;
    }

    /* é˜»æ­¢é»æ“Šç©¿é€åˆ°ä¸‹æ–¹éŠæˆ² */
    .popup-overlay.visible * {
      pointer-events: auto;
    }

    .popup-content {
      background: linear-gradient(135deg, rgba(30, 30, 50, 0.95), rgba(20, 20, 35, 0.98));
      border: 2px solid rgba(100, 100, 255, 0.4);
      border-radius: 16px;
      padding: 24px;
      padding-bottom: 32px;
      max-width: 90vw;
      max-height: 80vh;
      overflow: visible;
      position: relative;
      box-shadow: 0 0 30px rgba(100, 100, 255, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .popup-content h2 {
      color: #fff;
      margin: 0 0 16px 0;
      font-size: clamp(18px, 4vw, 24px);
      text-align: center;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .popup-content h2 i {
      color: #ffcc00;
    }

    .popup-body {
      color: rgba(255, 255, 255, 0.9);
      font-size: clamp(14px, 3vw, 16px);
      line-height: 1.6;
      text-align: left;
      width: 100%;
    }

    .popup-body .coming-soon {
      text-align: center;
      font-size: clamp(20px, 5vw, 28px);
      color: #ffcc00;
      margin: 20px 0 8px 0;
    }

    .popup-body .coming-soon-sub {
      text-align: center;
      color: rgba(255, 255, 255, 0.6);
      margin: 0 0 20px 0;
    }

    .help-section {
      margin-bottom: 16px;
    }

    .help-section h3 {
      color: #88aaff;
      margin: 0 0 8px 0;
      font-size: clamp(14px, 3vw, 18px);
      border-bottom: 1px solid rgba(136, 170, 255, 0.3);
      padding-bottom: 4px;
    }

    .help-section ul {
      margin: 0;
      padding-left: 20px;
    }

    .help-section li {
      margin: 4px 0;
    }

    .help-section b {
      color: #ffcc00;
    }

    .popup-close {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(255, 68, 68, 0.9);
      border: 3px solid rgba(255, 150, 150, 0.8);
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 0;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .popup-close:hover {
      background: rgba(255, 68, 68, 1);
      transform: scale(1.1);
    }

    .popup-close:active {
      transform: scale(0.95);
    }

    /* å½ˆçª—åº•éƒ¨æ‡¸æµ®æŒ‰éˆ• */
    .popup-footer {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translate(-50%, 50%);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    /* æ’è¡Œæ¦œå°ˆç”¨æ¨£å¼ - å›ºå®šè¢å¹• padding */
    .leaderboard-content {
      width: min(520px, calc(100vw - 40px));
      height: calc(100vh - 80px);
      max-height: calc(100vh - 80px);
      overflow: visible;
      box-sizing: border-box;
    }

    .lb-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      width: 100%;
      box-sizing: border-box;
      flex-shrink: 0;
    }

    .lb-tab {
      flex: 1;
      background: rgba(50, 50, 80, 0.6);
      border: 2px solid rgba(100, 100, 200, 0.3);
      border-radius: 8px;
      padding: 8px 4px;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      transition: all 0.2s ease;
    }

    .lb-tab i {
      font-size: clamp(16px, 4vw, 20px);
    }

    .lb-tab span {
      font-size: clamp(10px, 2.5vw, 12px);
      font-weight: bold;
    }

    .lb-tab small {
      font-size: clamp(8px, 2vw, 10px);
      opacity: 0.6;
    }

    .lb-tab:hover {
      background: rgba(70, 70, 120, 0.7);
      border-color: rgba(100, 100, 200, 0.5);
    }

    .lb-tab.active {
      background: rgba(100, 100, 200, 0.5);
      border-color: rgba(150, 150, 255, 0.7);
      color: #fff;
    }

    .lb-tab.active i {
      color: #ffcc00;
    }

    .lb-list {
      width: 100%;
      background: rgba(20, 20, 40, 0.8);
      border-radius: 8px;
      padding: 8px;
      flex: 1;
      min-height: 0;
      box-sizing: border-box;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .lb-header {
      display: flex;
      padding: 8px 12px;
      color: rgba(255, 255, 255, 0.5);
      font-size: clamp(10px, 2.5vw, 12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 4px;
      flex-shrink: 0;
    }

    .lb-rank {
      width: 36px;
      text-align: center;
    }

    .lb-name {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .lb-school {
      width: 130px;
      text-align: center;
      color: rgba(255, 255, 255, 0.6);
      font-size: clamp(10px, 2.5vw, 12px);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .lb-score {
      width: 70px;
      text-align: right;
    }

    .lb-entry {
      display: flex;
      padding: 8px 12px;
      color: rgba(255, 255, 255, 0.9);
      font-size: clamp(12px, 3vw, 14px);
      border-radius: 4px;
      transition: background 0.15s ease;
    }

    .lb-entry:nth-child(odd) {
      background: rgba(255, 255, 255, 0.03);
    }

    .lb-entry:hover {
      background: rgba(100, 100, 200, 0.2);
    }

    .lb-entry .lb-rank {
      font-weight: bold;
    }

    .lb-entry.rank-1 .lb-rank { color: #ffd700; }
    .lb-entry.rank-2 .lb-rank { color: #c0c0c0; }
    .lb-entry.rank-3 .lb-rank { color: #cd7f32; }

    .lb-empty {
      text-align: center;
      color: rgba(255, 255, 255, 0.4);
      padding: 40px 0;
      font-size: clamp(14px, 3vw, 16px);
    }

    .lb-loading {
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      padding: 60px 0;
      font-size: clamp(14px, 3vw, 16px);
    }

    .lb-loading i {
      margin-right: 8px;
      color: #ffcc00;
    }

    #lb-entries {
      flex: 1;
      overflow-y: auto;
    }

    #lb-entries:not(:empty) + .lb-empty {
      display: none;
    }

    /* è‡ªå®šç¾©æ²è»¸æ¨£å¼ - è—ç´«è‰²ä¸»é¡Œ */
    .lb-list::-webkit-scrollbar,
    #lb-entries::-webkit-scrollbar,
    .school-dropdown::-webkit-scrollbar,
    .popup-body::-webkit-scrollbar {
      width: 8px;
    }

    .lb-list::-webkit-scrollbar-track,
    #lb-entries::-webkit-scrollbar-track,
    .school-dropdown::-webkit-scrollbar-track,
    .popup-body::-webkit-scrollbar-track {
      background: rgba(20, 20, 40, 0.6);
      border-radius: 4px;
    }

    .lb-list::-webkit-scrollbar-thumb,
    #lb-entries::-webkit-scrollbar-thumb,
    .school-dropdown::-webkit-scrollbar-thumb,
    .popup-body::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(100, 100, 255, 0.6), rgba(150, 100, 200, 0.6));
      border-radius: 4px;
      border: 1px solid rgba(150, 150, 255, 0.3);
    }

    .lb-list::-webkit-scrollbar-thumb:hover,
    #lb-entries::-webkit-scrollbar-thumb:hover,
    .school-dropdown::-webkit-scrollbar-thumb:hover,
    .popup-body::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, rgba(120, 120, 255, 0.8), rgba(180, 120, 220, 0.8));
    }

    /* Firefox æ²è»¸æ¨£å¼ */
    .lb-list,
    #lb-entries,
    .school-dropdown,
    .popup-body {
      scrollbar-width: thin;
      scrollbar-color: rgba(100, 100, 255, 0.6) rgba(20, 20, 40, 0.6);
    }

    .lb-footer {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translate(-50%, 50%);
    }

    .lb-page-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(80, 80, 140, 0.95);
      border: 3px solid rgba(150, 150, 220, 0.8);
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      transition: all 0.2s ease;
    }

    .lb-page-btn:hover:not(:disabled) {
      background: rgba(100, 100, 150, 1);
      transform: scale(1.1);
    }

    .lb-page-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .lb-page-info {
      text-align: center;
      color: rgba(255, 255, 255, 0.5);
      font-size: clamp(10px, 2.5vw, 12px);
      margin-top: 8px;
      flex-shrink: 0;
    }

    /* æ­»äº¡çµç®—è¦–çª—æ¨£å¼ */
    .death-content {
      width: min(380px, 90vw);
    }

    .death-content h2 i {
      color: #ff4444;
    }

    .death-stats {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      width: 100%;
    }

    .death-stat {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px 8px;
      text-align: center;
    }

    .stat-label {
      display: block;
      font-size: clamp(10px, 2.5vw, 12px);
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 4px;
    }

    .stat-value {
      display: block;
      font-size: clamp(16px, 4vw, 20px);
      font-weight: bold;
      color: #ffcc00;
    }

    .death-form {
      width: 100%;
      margin-bottom: 16px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      font-size: clamp(12px, 3vw, 14px);
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 6px;
    }

    .form-group input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      font-size: clamp(14px, 3.5vw, 16px);
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(100, 100, 200, 0.3);
      border-radius: 8px;
      color: #fff;
      outline: none;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
    }

    .form-group input[type="text"]:focus {
      border-color: rgba(100, 100, 255, 0.7);
    }

    .form-group input[type="text"]::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    .school-select-wrapper {
      position: relative;
    }

    .school-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: rgba(30, 30, 50, 0.98);
      border: 2px solid rgba(100, 100, 200, 0.5);
      border-top: none;
      border-radius: 0 0 8px 8px;
      display: none;
      z-index: 100;
    }

    .school-dropdown.visible {
      display: block;
    }

    .school-option {
      padding: 10px 12px;
      font-size: clamp(12px, 3vw, 14px);
      color: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .school-option:hover {
      background: rgba(100, 100, 200, 0.3);
    }

    .school-option.selected {
      background: rgba(100, 100, 200, 0.5);
    }

    .death-actions {
      display: flex;
      gap: 12px;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translate(-50%, 50%);
    }

    .death-btn {
      padding: 12px 20px;
      font-size: clamp(14px, 3.5vw, 16px);
      font-weight: bold;
      border: 3px solid rgba(150, 150, 220, 0.8);
      border-radius: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      background: rgba(50, 50, 80, 0.6);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .death-btn:hover {
      background: rgba(70, 70, 110, 0.8);
      transform: translateY(-2px);
    }

    .death-btn.primary {
      background: rgba(100, 180, 100, 0.6);
      border-color: rgba(100, 200, 100, 0.6);
    }

    .death-btn.primary:hover {
      background: rgba(100, 200, 100, 0.8);
    }

    .death-btn.primary i {
      color: #ffcc00;
    }

    /* æ§åˆ¶å€å…±ç”¨æ¨£å¼ - ç›´å¼æ’åˆ— */
    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      width: clamp(32px, 5vw, 44px);
      box-sizing: border-box;
      padding: 6px 0;
      gap: 2px;
    }

    .control-btn {
      width: clamp(22px, 3.5vw, 30px);
      height: clamp(20px, 3vw, 26px);
      background: transparent;
      border: none;
      color: #fff;
      font-size: clamp(12px, 2vw, 16px);
      font-weight: bold;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.15s ease;
      border-radius: 4px;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .control-btn:active {
      transform: scale(0.9);
    }

    /* æ§åˆ¶å€æ•¸å€¼é¡¯ç¤º */
    .control-value {
      font-family: monospace;
      font-size: clamp(10px, 1.5vw, 14px);
      color: #fff;
      padding: 2px 0;
    }

    /* éŸ³é‡æ¢å®¹å™¨ */
    #volume-bars {
      display: flex;
      flex-direction: column-reverse;
      gap: 2px;
      padding: 2px 0;
    }

    .volume-bar {
      width: clamp(16px, 2.5vw, 22px);
      height: clamp(3px, 0.5vw, 5px);
      background: rgba(255, 255, 255, 0.25);
      border-radius: 2px;
      transition: background 0.1s ease;
    }

    .volume-bar.active {
      background: #fff;
    }

    .volume-bar.muted {
      background: rgba(255, 255, 255, 0.1);
    }

    /* å…¨è¢å¹•æ™‚æ”¹è®Šåœ–ç¤º */
    body.is-fullscreen #fullscreen-btn .expand-icon {
      display: none;
    }
    body.is-fullscreen #fullscreen-btn .compress-icon {
      display: block;
    }
    body:not(.is-fullscreen) #fullscreen-btn .expand-icon {
      display: block;
    }
    body:not(.is-fullscreen) #fullscreen-btn .compress-icon {
      display: none;
    }

    /* æ‰‹æ©Ÿç‰ˆéš±è—å…¨è¢å¹•æŒ‰éˆ• */
    @media screen and (max-width: 1024px) and (pointer: coarse) {
      #fullscreen-btn {
        display: none;
      }
    }

    /* å¼·åˆ¶æ©«å‘æç¤º */
    #rotate-notice {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #111;
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: #fff;
      font-family: Arial, sans-serif;
    }

    #rotate-notice .icon {
      font-size: clamp(48px, 15vw, 80px);
      margin-bottom: 20px;
      animation: rotate-phone 1.5s ease-in-out infinite;
    }

    #rotate-notice .text {
      font-size: clamp(14px, 4vw, 24px);
    }

    @keyframes rotate-phone {
      0%, 100% { transform: rotate(0deg); }
      50% { transform: rotate(-90deg); }
    }

    /* æ‰‹æ©Ÿç›´å‘æ™‚é¡¯ç¤ºæç¤º */
    @media screen and (max-width: 900px) and (orientation: portrait) {
      #rotate-notice {
        display: flex;
      }
      #app {
        display: none;
      }
      #controls {
        display: none;
      }
      #left-controls {
        display: none;
      }
      #version-info {
        display: none;
      }
    }

    /* æ‰‹æ©Ÿæ©«å‘ RWD - å›ºå®šé¢æ¿å¤§å° */
    @media screen and (max-height: 450px) {
      .popup-content {
        height: 85vh;
        max-height: 85vh;
        padding: 10px 14px;
        padding-bottom: 24px;
        box-sizing: border-box;
      }
      .popup-content h2 {
        margin: 0 0 6px 0;
        font-size: 14px;
        flex-shrink: 0;
      }
      .popup-close {
        width: 30px;
        height: 30px;
        font-size: 12px;
      }
      .lb-footer, .popup-footer, .death-actions {
        gap: 6px;
      }
      .lb-page-btn {
        width: 28px;
        height: 28px;
        font-size: 11px;
      }
      .death-btn {
        padding: 6px 12px;
        font-size: 11px;
        border-radius: 16px;
      }
      /* æ’è¡Œæ¦œ - å›ºå®šé«˜åº¦ */
      .leaderboard-content {
        width: min(420px, 96vw);
        height: 85vh;
      }
      .lb-tabs {
        margin-bottom: 6px;
        gap: 3px;
        flex-shrink: 0;
      }
      .lb-tab {
        padding: 4px 3px;
        font-size: 10px;
      }
      .lb-tab i {
        font-size: 12px;
      }
      .lb-tab span {
        font-size: 9px;
      }
      .lb-tab small {
        font-size: 8px;
      }
      .lb-list {
        flex: 1;
        min-height: 0;
        max-height: none;
        height: calc(85vh - 100px);
        overflow-y: auto;
        padding: 3px;
      }
      .lb-header {
        padding: 3px 6px;
        font-size: 9px;
      }
      .lb-entry {
        padding: 3px 6px;
        font-size: 10px;
      }
      .lb-school {
        width: 80px;
        font-size: 9px;
      }
      .lb-rank {
        width: 24px;
      }
      .lb-score {
        width: 65px;
      }
      .lb-empty, .lb-loading {
        padding: 15px 0;
        font-size: 11px;
      }
      .lb-page-info {
        font-size: 9px;
        margin-top: 4px;
      }
      /* èªªæ˜å½ˆçª— - å›ºå®šé«˜åº¦ */
      .popup-body {
        flex: 1;
        min-height: 0;
        font-size: 11px;
        line-height: 1.3;
        overflow-y: auto;
      }
      .help-section {
        margin-bottom: 6px;
      }
      .help-section h3 {
        font-size: 12px;
        margin-bottom: 3px;
      }
      .help-section ul {
        padding-left: 16px;
      }
      .help-section li {
        margin: 2px 0;
      }
      /* æ­»äº¡å½ˆçª— - å›ºå®šé«˜åº¦ */
      .death-content {
        height: 85vh;
        padding: 10px 14px;
        padding-bottom: 24px;
      }
      .death-stats {
        font-size: 11px;
        gap: 6px;
        margin-bottom: 6px;
        flex-shrink: 0;
      }
      .death-stat {
        padding: 6px 10px;
      }
      .leaderboard-submit {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
      }
      .leaderboard-submit h4 {
        font-size: 11px;
        margin-bottom: 4px;
      }
      .leaderboard-submit input {
        padding: 5px 8px;
        font-size: 11px;
      }
      .school-select-wrapper input {
        padding: 5px 8px;
        font-size: 11px;
      }
    }

    /* å³ä¸‹è§’ç‰ˆæœ¬è³‡è¨Š */
    #version-info {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-family: monospace;
      font-size: clamp(10px, 1.5vw, 14px);
      color: rgba(255, 255, 255, 0.3);
      z-index: 1000;
      pointer-events: none;
      user-select: none;
    }
  </style>
  <script type="module" crossorigin src="/web-game/assets/index-hvn4PrmS.js"></script>
  <link rel="modulepreload" crossorigin href="/web-game/assets/phaser-0RJB29YE.js">
</head>

<body>
  <div id="rotate-notice">
    <div class="icon">ğŸ“±</div>
    <div class="text">è«‹å°‡è£ç½®è½‰ç‚ºæ©«å‘</div>
  </div>

  <!-- å³ä¸‹è§’ç‰ˆæœ¬è³‡è¨Šï¼ˆç”± JS å‹•æ…‹è¨­å®šï¼‰ -->
  <div id="version-info"></div>

  <!-- å·¦ä¸Šè§’æ§åˆ¶åˆ—ï¼ˆé è¨­éš±è—ï¼Œè½‰å ´å¾Œé¡¯ç¤ºï¼‰ -->
  <div id="left-controls">
    <!-- å›é¦–é æŒ‰éˆ• -->
    <a href="https://hwudigidev-creator.github.io/www/" class="ctrl-btn" title="å›é¦–é "><i class="fa-solid fa-house"></i></a>
    <!-- è¯ç¹«æˆ‘å€‘æŒ‰éˆ• -->
    <a href="https://hwudigidev-creator.github.io/www/#/contact" class="ctrl-btn" title="è¯ç¹«æˆ‘å€‘"><i class="fa-solid fa-envelope"></i></a>
    <!-- åˆ†äº«æŒ‰éˆ• -->
    <button id="share-btn" class="ctrl-btn" title="åˆ†äº«"><i class="fa-solid fa-share-nodes"></i></button>
    <!-- æ’è¡Œæ¦œæŒ‰éˆ• -->
    <button id="leaderboard-btn" class="ctrl-btn" title="æ’è¡Œæ¦œ"><i class="fa-solid fa-ranking-star"></i></button>
    <!-- èªªæ˜æŒ‰éˆ• -->
    <button id="help-btn" class="ctrl-btn" title="èªªæ˜"><i class="fa-solid fa-question"></i></button>
  </div>

  <!-- æ’è¡Œæ¦œå½ˆå‡ºè¦–çª— -->
  <div id="leaderboard-popup" class="popup-overlay">
    <div class="popup-content leaderboard-content">
      <h2><i class="fa-solid fa-ranking-star"></i> æ’è¡Œæ¦œ</h2>
      <!-- é ç±¤ -->
      <div class="lb-tabs">
        <button class="lb-tab active" data-tab="time">
          <i class="fa-solid fa-hourglass-half"></i>
          <span>ä¸æœ½å‚³èªª</span>
          <small>æ”¯æ’æ™‚é–“</small>
        </button>
        <button class="lb-tab" data-tab="level">
          <i class="fa-solid fa-crown"></i>
          <span>å·”å³°éœ¸ä¸»</span>
          <small>æœ€é«˜ç­‰ç´š</small>
        </button>
        <button class="lb-tab" data-tab="damage">
          <i class="fa-solid fa-shield-halved"></i>
          <span>ç„¡å‚·ç¥è©±</span>
          <small>Lv.75+ é™å®š</small>
        </button>
      </div>
      <!-- æ’è¡Œåˆ—è¡¨ -->
      <div class="lb-list">
        <div class="lb-header">
          <span class="lb-rank">#</span>
          <span class="lb-name">ç©å®¶</span>
          <span class="lb-school">é™£ç‡Ÿ</span>
          <span class="lb-score">æˆç¸¾</span>
        </div>
        <div id="lb-entries">
          <!-- å‹•æ…‹ç”Ÿæˆæ’è¡Œé …ç›® -->
        </div>
        <p class="lb-empty">å°šç„¡ç´€éŒ„</p>
      </div>
      <!-- åº•éƒ¨æ§åˆ¶åˆ— -->
      <div class="lb-footer">
        <button class="lb-page-btn" id="lb-prev"><i class="fa-solid fa-chevron-up"></i></button>
        <button class="popup-close"><i class="fa-solid fa-xmark"></i></button>
        <button class="lb-page-btn" id="lb-next"><i class="fa-solid fa-chevron-down"></i></button>
      </div>
      <div class="lb-page-info">ç¬¬ <span id="lb-page-num">1</span> / <span id="lb-page-total">1</span> é </div>
    </div>
  </div>

  <!-- èªªæ˜å½ˆå‡ºè¦–çª— -->
  <div id="help-popup" class="popup-overlay">
    <div class="popup-content">
      <h2><i class="fa-solid fa-question-circle"></i> éŠæˆ²èªªæ˜</h2>
      <div class="popup-body">
        <div class="help-section">
          <h3>æ“ä½œæ–¹å¼</h3>
          <ul>
            <li><b>ç§»å‹•</b>ï¼šWASD æˆ– æ–¹å‘éµ / æ»‘é¼ æ‹–æ›³ãƒ»è§¸æ§è™›æ“¬æ–æ¡¿</li>
            <li><b>æŠ€èƒ½</b>ï¼šè‡ªå‹•æ–½æ”¾ï¼ˆå†·å»å®Œæˆå¾Œï¼‰</li>
          </ul>
        </div>
        <div class="help-section">
          <h3>éŠæˆ²ç›®æ¨™</h3>
          <ul>
            <li>æ¶ˆæ»…æ€ªç‰©ç²å–ç¶“é©—å€¼</li>
            <li>å‡ç´šè§£é–æ–°æŠ€èƒ½</li>
            <li>ç›¡å¯èƒ½å­˜æ´»æ›´ä¹…</li>
          </ul>
        </div>
        <div class="help-section">
          <h3>æç¤º</h3>
          <ul>
            <li>è­·ç›¾å¯ä»¥æŠµæ“‹å‚·å®³</li>
            <li>å‡ç´šæ™‚ HP æœƒå¢åŠ ä½†ä¸æœƒå›æ»¿</li>
            <li>æ³¨æ„é–ƒé¿æ€ªç‰©çš„æ”»æ“Š</li>
          </ul>
        </div>
      </div>
      <div class="popup-footer">
        <button class="popup-close"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>
  </div>

  <!-- æ­»äº¡çµç®—å½ˆå‡ºè¦–çª— -->
  <div id="death-popup" class="popup-overlay">
    <div class="popup-content death-content">
      <h2><i class="fa-solid fa-skull"></i> éŠæˆ²çµæŸ</h2>
      <div class="death-stats">
        <div class="death-stat">
          <span class="stat-label">å­˜æ´»æ™‚é–“</span>
          <span class="stat-value" id="death-time">00:00</span>
        </div>
        <div class="death-stat">
          <span class="stat-label">æœ€é«˜ç­‰ç´š</span>
          <span class="stat-value" id="death-level">Lv.1</span>
        </div>
        <div class="death-stat">
          <span class="stat-label">å—åˆ°å‚·å®³</span>
          <span class="stat-value" id="death-damage">0</span>
        </div>
      </div>
      <div class="death-form">
        <div class="form-group">
          <label for="death-nickname">æš±ç¨±</label>
          <input type="text" id="death-nickname" maxlength="12" placeholder="è¼¸å…¥æš±ç¨±..." value="AAA">
        </div>
        <div class="form-group">
          <label for="death-school">æ‰€å±¬é™£ç‡Ÿ</label>
          <div class="school-select-wrapper">
            <input type="text" id="death-school-input" placeholder="è¼¸å…¥æˆ–é¸æ“‡å­¸æ ¡..." autocomplete="off">
            <div id="school-dropdown" class="school-dropdown"></div>
          </div>
        </div>
      </div>
      <div class="death-actions">
        <button id="death-submit" class="death-btn primary">
          <i class="fa-solid fa-trophy"></i> ç™»éŒ„æ’è¡Œæ¦œ
        </button>
        <button id="death-skip" class="death-btn" style="display: none;">
          <i class="fa-solid fa-rotate-right"></i> è·³é
        </button>
      </div>
    </div>
  </div>

  <!-- å³ä¸Šè§’æ§åˆ¶åˆ—ï¼ˆé è¨­éš±è—ï¼Œè½‰å ´å¾Œé¡¯ç¤ºï¼‰ -->
  <div id="controls">
    <!-- é‡æ•´æŒ‰éˆ• -->
    <button id="reload-btn" class="ctrl-btn" title="é‡æ–°é–‹å§‹">â†»</button>
    <!-- ç¶²æ ¼å€ç‡æ§åˆ¶ï¼ˆæš«æ™‚éš±è—ï¼‰ -->
    <div id="grid-control" class="control-group" title="ç¶²æ ¼ç²¾ç´°åº¦" style="display: none;">
      <button id="grid-up" class="control-btn">+</button>
      <span id="grid-value" class="control-value">3X</span>
      <button id="grid-down" class="control-btn">âˆ’</button>
    </div>
    <!-- å…¨è¢å¹•æŒ‰éˆ• -->
    <button id="fullscreen-btn" class="ctrl-btn" title="å…¨è¢å¹•">
      <span class="expand-icon">â›¶</span>
      <span class="compress-icon">â›¶</span>
    </button>
    <!-- éŸ³é‡æ§åˆ¶ -->
    <div id="volume-control" class="control-group" title="éŸ³é‡">
      <button id="volume-up" class="control-btn">+</button>
      <div id="volume-bars"></div>
      <button id="volume-down" class="control-btn">âˆ’</button>
    </div>
    <!-- éœéŸ³æŒ‰éˆ• -->
    <button id="mute-btn" class="ctrl-btn" title="éœéŸ³">
      <i id="mute-icon" class="fa-solid fa-volume-high"></i>
    </button>
    <!-- è‡ªæ®ºæŒ‰éˆ•ï¼ˆå¿«é€Ÿç™»å…¥æ’è¡Œæ¦œï¼‰ -->
    <button id="suicide-btn" class="ctrl-btn" title="æ”¾æ£„æœ¬å±€">
      <i class="fa-solid fa-skull-crossbones"></i>
    </button>
  </div>

  <div id="app"></div>

  <script>
    // ===== éŸ³é‡æ§åˆ¶ =====
    const volumeBars = document.getElementById('volume-bars');
    const volumeUp = document.getElementById('volume-up');
    const volumeDown = document.getElementById('volume-down');

    const VOLUME_LEVELS = 10;
    let currentVolume = 5; // 0-10ï¼Œé è¨­ 50%

    // å»ºç«‹ 10 å€‹éŸ³é‡æ¢
    for (let i = 0; i < VOLUME_LEVELS; i++) {
      const bar = document.createElement('div');
      bar.className = 'volume-bar';
      bar.dataset.level = i;
      volumeBars.appendChild(bar);
    }

    function updateVolumeBars() {
      const bars = volumeBars.querySelectorAll('.volume-bar');
      bars.forEach((bar, index) => {
        bar.classList.remove('active', 'muted');
        if (index < currentVolume) {
          bar.classList.add('active');
        }
      });
      // ç™¼é€éŸ³é‡è®Šæ›´äº‹ä»¶çµ¦éŠæˆ²
      window.dispatchEvent(new CustomEvent('volumechange', { detail: { volume: currentVolume / VOLUME_LEVELS } }));
    }

    // é•·æŒ‰æŒçºŒè§¸ç™¼
    let volumeInterval = null;
    const INITIAL_DELAY = 300; // é¦–æ¬¡è§¸ç™¼å¾Œçš„å»¶é²
    const REPEAT_DELAY = 100;  // æŒçºŒè§¸ç™¼çš„é–“éš”

    function startVolumeUp() {
      if (currentVolume < VOLUME_LEVELS) {
        currentVolume++;
        updateVolumeBars();
      }
    }

    function startVolumeDown() {
      if (currentVolume > 0) {
        currentVolume--;
        updateVolumeBars();
      }
    }

    function startHold(action) {
      action(); // ç«‹å³è§¸ç™¼ä¸€æ¬¡
      let firstTrigger = true;
      volumeInterval = setInterval(() => {
        if (firstTrigger) {
          firstTrigger = false;
          clearInterval(volumeInterval);
          volumeInterval = setInterval(action, REPEAT_DELAY);
        }
        action();
      }, INITIAL_DELAY);
    }

    function stopHold() {
      if (volumeInterval) {
        clearInterval(volumeInterval);
        volumeInterval = null;
      }
    }

    // æ»‘é¼ äº‹ä»¶
    volumeUp.addEventListener('mousedown', () => startHold(startVolumeUp));
    volumeUp.addEventListener('mouseup', stopHold);
    volumeUp.addEventListener('mouseleave', stopHold);

    volumeDown.addEventListener('mousedown', () => startHold(startVolumeDown));
    volumeDown.addEventListener('mouseup', stopHold);
    volumeDown.addEventListener('mouseleave', stopHold);

    // è§¸æ§äº‹ä»¶
    volumeUp.addEventListener('touchstart', (e) => {
      e.preventDefault();
      startHold(startVolumeUp);
    });
    volumeUp.addEventListener('touchend', stopHold);
    volumeUp.addEventListener('touchcancel', stopHold);

    volumeDown.addEventListener('touchstart', (e) => {
      e.preventDefault();
      startHold(startVolumeDown);
    });
    volumeDown.addEventListener('touchend', stopHold);
    volumeDown.addEventListener('touchcancel', stopHold);

    // åˆå§‹åŒ–
    updateVolumeBars();

    // ===== éœéŸ³æŒ‰éˆ• =====
    const muteBtn = document.getElementById('mute-btn');
    const muteIcon = document.getElementById('mute-icon');
    let isMuted = false;
    let volumeBeforeMute = currentVolume;

    function toggleMute() {
      isMuted = !isMuted;
      if (isMuted) {
        volumeBeforeMute = currentVolume;
        currentVolume = 0;
        muteIcon.classList.remove('fa-volume-high');
        muteIcon.classList.add('fa-volume-xmark');
        muteBtn.classList.add('muted');
      } else {
        currentVolume = volumeBeforeMute > 0 ? volumeBeforeMute : 5;
        muteIcon.classList.remove('fa-volume-xmark');
        muteIcon.classList.add('fa-volume-high');
        muteBtn.classList.remove('muted');
      }
      updateVolumeBars();
    }

    muteBtn.addEventListener('click', toggleMute);

    // ===== è‡ªæ®ºæŒ‰éˆ•ï¼ˆå¿«é€ŸçµæŸä¸¦ç™»å…¥æ’è¡Œæ¦œï¼‰ =====
    const suicideBtn = document.getElementById('suicide-btn');
    suicideBtn.addEventListener('click', () => {
      if (confirm('ç¢ºå®šè¦æ”¾æ£„æœ¬å±€å—ï¼Ÿ')) {
        window.dispatchEvent(new CustomEvent('playerSuicide'));
      }
    });

    // ===== å½ˆå‡ºè¦–çª—åŠŸèƒ½ =====
    const leaderboardBtn = document.getElementById('leaderboard-btn');
    const helpBtn = document.getElementById('help-btn');
    const leaderboardPopup = document.getElementById('leaderboard-popup');
    const helpPopup = document.getElementById('help-popup');

    function openPopup(popup) {
      popup.style.display = 'flex';
      // å¼·åˆ¶é‡ç¹ªå¾Œå†æ·»åŠ  visible ä»¥å•Ÿå‹•å‹•ç•«
      requestAnimationFrame(() => {
        popup.classList.add('visible');
      });
      // é€šçŸ¥éŠæˆ²æš«åœ
      window.dispatchEvent(new CustomEvent('popupStateChange', { detail: { open: true } }));
    }

    function closePopup(popup) {
      popup.classList.remove('visible');
      setTimeout(() => {
        popup.style.display = 'none';
      }, 300);
      // é€šçŸ¥éŠæˆ²æ¢å¾©
      window.dispatchEvent(new CustomEvent('popupStateChange', { detail: { open: false } }));
    }

    // é–‹å•ŸæŒ‰éˆ•
    leaderboardBtn.addEventListener('click', () => openPopup(leaderboardPopup));
    helpBtn.addEventListener('click', () => openPopup(helpPopup));

    // é—œé–‰æŒ‰éˆ•
    document.querySelectorAll('.popup-close').forEach(btn => {
      btn.addEventListener('click', () => {
        const popup = btn.closest('.popup-overlay');
        if (popup) closePopup(popup);
      });
    });

    // é»æ“ŠèƒŒæ™¯é—œé–‰ï¼Œä¸¦é˜»æ­¢äº‹ä»¶ç©¿é€åˆ°éŠæˆ²
    document.querySelectorAll('.popup-overlay').forEach(popup => {
      popup.addEventListener('click', (e) => {
        e.stopPropagation();
        if (e.target === popup) closePopup(popup);
      });
      popup.addEventListener('pointerdown', (e) => e.stopPropagation());
      popup.addEventListener('pointerup', (e) => e.stopPropagation());
      popup.addEventListener('touchstart', (e) => e.stopPropagation());
      popup.addEventListener('touchend', (e) => e.stopPropagation());
    });

    // ===== æ’è¡Œæ¦œåŠŸèƒ½ =====
    const lbTabs = document.querySelectorAll('.lb-tab');
    const lbEntries = document.getElementById('lb-entries');
    const lbPrev = document.getElementById('lb-prev');
    const lbNext = document.getElementById('lb-next');
    const lbPageNum = document.getElementById('lb-page-num');
    const lbPageTotal = document.getElementById('lb-page-total');

    const MAX_ENTRIES = 100;
    let currentTab = 'time';
    let currentPage = 1;

    // å‹•æ…‹è¨ˆç®—æ¯é é¡¯ç¤ºæ•¸é‡
    function calculateEntriesPerPage() {
      const lbList = document.querySelector('.lb-list');
      if (!lbList) return 10;
      // å–å¾—åˆ—è¡¨å¯ç”¨é«˜åº¦ï¼ˆæ‰£é™¤ header ç´„ 30px å’Œ paddingï¼‰
      const availableHeight = lbList.clientHeight - 40;
      // æ¯å€‹ entry ç´„ 30px é«˜åº¦ï¼ˆå« paddingï¼‰
      const entryHeight = 30;
      const count = Math.floor(availableHeight / entryHeight);
      return Math.max(5, Math.min(20, count)); // æœ€å°‘5ç­†ï¼Œæœ€å¤š20ç­†
    }

    // Google Sheets API URL
    const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbyjqIgHpEa9G6qR53DjAV8mLA_794Pepoc9cUJWeZJRPIC7Iqj6fTsfy2vl-a95x6aMnQ/exec';

    // æ’è¡Œæ¦œè³‡æ–™å¿«å–
    let leaderboardData = {
      time: [],    // { name: 'Player', score: '12:34' }
      level: [],   // { name: 'Player', score: 'Lv.50' }
      damage: []   // { name: 'Player', score: '0', level: 75 }
    };
    let isLoadingLeaderboard = false;

    // å¾ Google Sheets è¼‰å…¥æ’è¡Œæ¦œ
    async function fetchLeaderboard() {
      if (!SHEET_API_URL) {
        console.warn('Google Sheets API URL not configured');
        return;
      }
      if (isLoadingLeaderboard) return;
      isLoadingLeaderboard = true;

      // é¡¯ç¤ºè®€å–ä¸­æç¤º
      const lbEntries = document.getElementById('lb-entries');
      if (lbEntries) {
        lbEntries.innerHTML = '<div class="lb-loading"><i class="fa-solid fa-spinner fa-spin"></i> è®€å–ä¸­...</div>';
      }

      try {
        const response = await fetch(`${SHEET_API_URL}?type=all`, {
          method: 'GET',
          redirect: 'follow'
        });
        const result = await response.json();
        if (result.success && result.data) {
          // è½‰æ›æ ¼å¼ï¼ˆåŒ…å«é™£ç‡Ÿï¼‰
          leaderboardData.time = (result.data.time || []).map(e => ({
            name: e.name,
            school: e.school || '',
            score: formatTime(e.score)
          }));
          leaderboardData.level = (result.data.level || []).map(e => {
            const lv = parseFloat(e.score) || 0;
            const lvInt = Math.floor(lv);
            const expPercent = Math.round((lv - lvInt) * 100);
            return {
              name: e.name,
              school: e.school || '',
              score: expPercent > 0 ? `Lv.${lvInt} (${expPercent}%)` : `Lv.${lvInt}`,
              rawScore: lv
            };
          });
          leaderboardData.damage = (result.data.damage || []).map(e => {
            const dmg = parseFloat(e.score) || 0;
            const lv = e.level || 1;
            const rate = dmg / (lv * lv);
            const ratePercent = (rate * 100).toFixed(2);
            return {
              name: e.name,
              school: e.school || '',
              score: `${dmg} (${ratePercent}%)`, // é¡¯ç¤ºæ ¼å¼: "ç¸½å‚· (æå‚·ç‡%)"
              damageRate: rate, // ç”¨æ–¼æ’åº
              rawDamage: dmg,
              level: lv
            };
          });
          // ä¾æå‚·ç‡æ’åºï¼ˆè¶Šä½è¶Šå¥½ï¼‰
          leaderboardData.damage.sort((a, b) => a.damageRate - b.damageRate);
        }
        renderLeaderboard();
      } catch (error) {
        console.error('Failed to fetch leaderboard:', error);
      } finally {
        isLoadingLeaderboard = false;
      }
    }

    // æ ¼å¼åŒ–æ™‚é–“ï¼ˆç§’æ•¸è½‰ mm:ssï¼‰
    function formatTime(seconds) {
      const sec = parseFloat(seconds) || 0;
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${String(s).padStart(2, '0')}`;
    }

    // è§£ææ™‚é–“ï¼ˆmm:ss è½‰ç§’æ•¸ï¼‰
    function parseTime(timeStr) {
      const [m, s] = timeStr.split(':').map(Number);
      return m * 60 + s;
    }

    // é©—è­‰ç¢¼ç”¢ç”Ÿï¼ˆé˜²ç«„æ”¹ï¼‰
    const GAME_SALT = 'DDT_2024_HWUDI';
    function generateChecksum(type, name, score, level, timestamp) {
      // ç›´æ¥ä½¿ç”¨å‚³å…¥çš„å€¼ï¼ˆå‘¼å«ç«¯éœ€ç¢ºä¿æ ¼å¼ä¸€è‡´ï¼‰
      const data = `${type}|${name}|${score}|${level}|${timestamp}|${GAME_SALT}`;
      let hash = 0;
      for (let i = 0; i < data.length; i++) {
        const char = data.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // è½‰ç‚º32ä½æ•´æ•¸
      }
      // è½‰ç‚º16é€²åˆ¶ä¸¦åŠ ä¸Šé•·åº¦æ ¡é©—
      const hex = Math.abs(hash).toString(16).padStart(8, '0');
      const lenCheck = (data.length % 256).toString(16).padStart(2, '0');
      return hex + lenCheck;
    }

    // æäº¤ç´€éŒ„åˆ° Google Sheets
    async function submitToSheet(type, name, score, school, level) {
      if (!SHEET_API_URL) {
        console.warn('Google Sheets API URL not configured');
        return null;
      }

      try {
        // çµ±ä¸€æ•¸å­—æ ¼å¼ï¼ˆç¢ºä¿ checksum å’Œ URL åƒæ•¸ä¸€è‡´ï¼‰
        const scoreStr = String(parseFloat(score) || 0);
        const levelStr = String(parseFloat(level) || 0);

        // ç”¢ç”Ÿæ™‚é–“æˆ³å’Œé©—è­‰ç¢¼
        const timestamp = Date.now();
        const checksum = generateChecksum(type, name, scoreStr, levelStr, timestamp);

        console.log('Submit debug:', { type, name, scoreStr, levelStr, timestamp, checksum });

        // ä½¿ç”¨ URL åƒæ•¸æ–¹å¼æäº¤ï¼ˆé¿å… CORS å•é¡Œï¼‰
        const params = new URLSearchParams({
          action: 'add',
          type,
          name,
          score: scoreStr,
          school: school || '',
          level: levelStr,
          ts: String(timestamp),
          cs: checksum
        });
        const response = await fetch(`${SHEET_API_URL}?${params.toString()}`, {
          method: 'GET',
          redirect: 'follow'
        });
        const result = await response.json();
        return result;
      } catch (error) {
        console.error('Failed to submit to sheet:', error);
        return null;
      }
    }

    function renderLeaderboard() {
      const entriesPerPage = calculateEntriesPerPage();
      const data = leaderboardData[currentTab].slice(0, MAX_ENTRIES);
      const totalPages = Math.max(1, Math.ceil(data.length / entriesPerPage));

      // ç¢ºä¿é ç¢¼æœ‰æ•ˆ
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      const start = (currentPage - 1) * entriesPerPage;
      const end = start + entriesPerPage;
      const pageData = data.slice(start, end);

      // æ¸…ç©ºä¸¦å¡«å…¥è³‡æ–™
      lbEntries.innerHTML = '';
      pageData.forEach((entry, index) => {
        const rank = start + index + 1;
        const div = document.createElement('div');
        div.className = 'lb-entry';
        if (rank <= 3) div.classList.add(`rank-${rank}`);
        const schoolDisplay = entry.school || '-';
        div.innerHTML = `
          <span class="lb-rank">${rank}</span>
          <span class="lb-name">${entry.name}</span>
          <span class="lb-school" title="${schoolDisplay}">${schoolDisplay}</span>
          <span class="lb-score">${entry.score}</span>
        `;
        lbEntries.appendChild(div);
      });

      // æ›´æ–°é ç¢¼
      lbPageNum.textContent = currentPage;
      lbPageTotal.textContent = totalPages;

      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      lbPrev.disabled = currentPage <= 1;
      lbNext.disabled = currentPage >= totalPages;
    }

    // é ç±¤åˆ‡æ›
    lbTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        lbTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        currentPage = 1;
        renderLeaderboard();
      });
    });

    // ç¿»é 
    lbPrev.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderLeaderboard();
      }
    });

    lbNext.addEventListener('click', () => {
      const entriesPerPage = calculateEntriesPerPage();
      const data = leaderboardData[currentTab].slice(0, MAX_ENTRIES);
      const totalPages = Math.ceil(data.length / entriesPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderLeaderboard();
      }
    });

    // è¦–çª—å¤§å°è®Šæ›´æ™‚é‡æ–°æ¸²æŸ“ï¼ˆèª¿æ•´æ¯é æ•¸é‡ï¼‰
    window.addEventListener('resize', () => {
      if (leaderboardPopup.classList.contains('visible')) {
        renderLeaderboard();
      }
    });

    // é–‹å•Ÿæ’è¡Œæ¦œæ™‚è¼‰å…¥ä¸¦æ¸²æŸ“
    leaderboardBtn.addEventListener('click', () => {
      currentPage = 1;
      fetchLeaderboard(); // å¾ Google Sheets è¼‰å…¥ï¼ˆå®Œæˆå¾Œæœƒè‡ªå‹• renderï¼‰
    });

    // æ­»äº¡ç‹€æ…‹è¿½è¹¤ï¼ˆç”¨æ–¼é»æ“ŠéŠæˆ²å€é‡æ–°æ‰“é–‹å½ˆçª—ï¼‰
    let isPlayerDead = false;
    let lastDeathData = null;

    // ç›£è¯éŠæˆ²çµæŸäº‹ä»¶ä»¥æ›´æ–°æ’è¡Œæ¦œ
    window.addEventListener('gameRecordUpdate', (e) => {
      const { type, name, school, score, level, rawScore } = e.detail;
      if (leaderboardData[type]) {
        // å‚·å®³æ¦œéœ€è¦è¨ˆç®—æå‚·ç‡ (damage / levelÂ²)
        if (type === 'damage') {
          const dmg = parseFloat(score) || 0;
          const lv = level || 1;
          const rate = dmg / (lv * lv);
          const ratePercent = (rate * 100).toFixed(2);
          leaderboardData[type].push({
            name,
            school: school || '',
            score: `${dmg} (${ratePercent}%)`, // é¡¯ç¤ºæ ¼å¼: "ç¸½å‚· (æå‚·ç‡%)"
            damageRate: rate,
            rawDamage: dmg,
            level: lv
          });
        } else if (type === 'level') {
          // ç­‰ç´šæ¦œéœ€è¦ rawScore ç”¨æ–¼æ’åº
          leaderboardData[type].push({ name, school: school || '', score, rawScore: rawScore || 0 });
        } else {
          leaderboardData[type].push({ name, school: school || '', score });
        }
        // æ’åºï¼ˆæ™‚é–“å’Œç­‰ç´šè¶Šå¤§è¶Šå¥½ï¼Œæå‚·ç‡è¶Šä½è¶Šå¥½ï¼‰
        if (type === 'damage') {
          leaderboardData[type].sort((a, b) => {
            return (a.damageRate || 0) - (b.damageRate || 0); // æå‚·ç‡ä½çš„æ’å‰é¢
          });
        } else if (type === 'level') {
          leaderboardData[type].sort((a, b) => {
            const lvA = a.rawScore || parseFloat(a.score.replace('Lv.', '')) || 0;
            const lvB = b.rawScore || parseFloat(b.score.replace('Lv.', '')) || 0;
            return lvB - lvA;
          });
        } else if (type === 'time') {
          leaderboardData[type].sort((a, b) => {
            const [mA, sA] = a.score.split(':').map(Number);
            const [mB, sB] = b.score.split(':').map(Number);
            return (mB * 60 + sB) - (mA * 60 + sA);
          });
        }
        // åªä¿ç•™å‰ 100 å
        leaderboardData[type] = leaderboardData[type].slice(0, MAX_ENTRIES);
      }
    });

    // åˆå§‹æ¸²æŸ“
    renderLeaderboard();

    // ===== æ­»äº¡çµç®—åŠŸèƒ½ =====
    const deathPopup = document.getElementById('death-popup');
    const deathNickname = document.getElementById('death-nickname');
    const deathSchoolInput = document.getElementById('death-school-input');
    const schoolDropdown = document.getElementById('school-dropdown');
    const deathSubmit = document.getElementById('death-submit');
    const deathSkip = document.getElementById('death-skip');
    const deathTime = document.getElementById('death-time');
    const deathLevel = document.getElementById('death-level');
    const deathDamage = document.getElementById('death-damage');

    let schoolList = [];
    let selectedSchool = '';

    // è¼‰å…¥å­¸æ ¡æ¸…å–®
    fetch('./src/data/hslist.json')
      .then(res => res.json())
      .then(data => {
        schoolList = data.filter(s => s.value !== '-1');
      })
      .catch(err => console.warn('ç„¡æ³•è¼‰å…¥å­¸æ ¡æ¸…å–®:', err));

    // å­¸æ ¡æœå°‹éæ¿¾
    function filterSchools(query) {
      if (!query) return schoolList.slice(0, 20);
      const q = query.toLowerCase();
      return schoolList.filter(s => s.label.toLowerCase().includes(q)).slice(0, 20);
    }

    function renderSchoolDropdown(schools) {
      schoolDropdown.innerHTML = '';
      schools.forEach(school => {
        const div = document.createElement('div');
        div.className = 'school-option';
        if (school.value === selectedSchool) div.classList.add('selected');
        div.textContent = school.label;
        div.addEventListener('click', () => {
          selectedSchool = school.value;
          deathSchoolInput.value = school.label;
          schoolDropdown.classList.remove('visible');
        });
        schoolDropdown.appendChild(div);
      });
    }

    deathSchoolInput.addEventListener('focus', () => {
      const filtered = filterSchools(deathSchoolInput.value);
      renderSchoolDropdown(filtered);
      schoolDropdown.classList.add('visible');
    });

    deathSchoolInput.addEventListener('input', () => {
      const filtered = filterSchools(deathSchoolInput.value);
      renderSchoolDropdown(filtered);
      schoolDropdown.classList.add('visible');
    });

    // é»æ“Šå¤–éƒ¨é—œé–‰ä¸‹æ‹‰é¸å–®
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.school-select-wrapper')) {
        schoolDropdown.classList.remove('visible');
      }
    });

    // é¡¯ç¤ºæ­»äº¡å½ˆå‡ºè¦–çª—
    function showDeathPopup(time, level, damage, isReopen = false) {
      // ä¿å­˜æ­»äº¡è³‡è¨Šä¾›é‡æ–°æ‰“é–‹ç”¨
      if (!isReopen) {
        lastDeathData = { time, level, damage };
        isPlayerDead = true;
      }

      deathTime.textContent = time;
      // é¡¯ç¤ºç­‰ç´šå«ç¶“é©—ç™¾åˆ†æ¯”ï¼Œä¾‹å¦‚ 75.30 é¡¯ç¤ºç‚º "Lv.75 (30%)"
      const lvInt = Math.floor(level);
      const expPercent = Math.round((level - lvInt) * 100);
      deathLevel.textContent = expPercent > 0 ? `Lv.${lvInt} (${expPercent}%)` : `Lv.${lvInt}`;
      deathLevel.dataset.rawLevel = level; // å­˜åŸå§‹å€¼ä¾›æäº¤ç”¨
      deathDamage.textContent = damage;
      // é‡æ–°æ‰“é–‹æ™‚ä¿ç•™å·²è¼¸å…¥çš„æš±ç¨±å’Œé™£ç‡Ÿ
      if (!isReopen) {
        deathNickname.value = '';
        deathSchoolInput.value = '';
        selectedSchool = '';
      }
      openPopup(deathPopup);
    }

    // æäº¤æ’è¡Œæ¦œ
    deathSubmit.addEventListener('click', async () => {
      const nickname = deathNickname.value.trim() || 'åŒ¿åç©å®¶';
      const school = selectedSchool || deathSchoolInput.value.trim() || 'ç„¡é™£ç‡Ÿ';
      const displayName = `${nickname}`;
      const level = parseFloat(deathLevel.dataset.rawLevel) || 0;

      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      deathSubmit.disabled = true;
      deathSubmit.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';

      // è§£æåˆ†æ•¸
      const timeScore = parseTime(deathTime.textContent); // è½‰ç‚ºç§’æ•¸
      const levelScore = level;
      const damageScore = parseFloat(deathDamage.textContent) || 0;

      // åŒæ™‚æäº¤åˆ° Google Sheets
      const promises = [
        submitToSheet('time', displayName, timeScore, school, level),
        submitToSheet('level', displayName, levelScore, school, level)
      ];
      // ç„¡å‚·ç¥è©±ï¼šéœ€é”åˆ° 75 ç´šæ‰èƒ½å…¥æ¦œ
      if (level >= 75) {
        promises.push(submitToSheet('damage', displayName, damageScore, school, level));
      }

      const results = await Promise.all(promises);
      console.log('Submit results:', results);

      // æª¢æŸ¥æ˜¯å¦æœ‰å¤±æ•—
      const failed = results.filter(r => r && !r.success);
      if (failed.length > 0) {
        console.error('Some submissions failed:', failed);
        alert('ä¸Šå‚³å¤±æ•—: ' + (failed[0]?.error || 'æœªçŸ¥éŒ¯èª¤'));
        deathSubmit.disabled = false;
        deathSubmit.innerHTML = '<i class="fa-solid fa-trophy"></i> ç™»éŒ„æ’è¡Œæ¦œ';
        return;
      }

      // ä¹Ÿæ›´æ–°æœ¬åœ°å¿«å–ï¼ˆä¾›å³æ™‚é¡¯ç¤ºï¼‰
      window.dispatchEvent(new CustomEvent('gameRecordUpdate', {
        detail: { type: 'time', name: displayName, school, score: deathTime.textContent }
      }));
      // ç­‰ç´šæ¦œéœ€è¦ rawScore ç”¨æ–¼æ’åº
      const lvInt = Math.floor(level);
      const expPct = Math.round((level - lvInt) * 100);
      const levelDisplay = expPct > 0 ? `Lv.${lvInt} (${expPct}%)` : `Lv.${lvInt}`;
      window.dispatchEvent(new CustomEvent('gameRecordUpdate', {
        detail: { type: 'level', name: displayName, school, score: levelDisplay, rawScore: level }
      }));
      if (level >= 75) {
        window.dispatchEvent(new CustomEvent('gameRecordUpdate', {
          detail: { type: 'damage', name: displayName, school, score: deathDamage.textContent, level: level }
        }));
      }

      // é‡ç½®æ­»äº¡ç‹€æ…‹
      isPlayerDead = false;
      lastDeathData = null;
      closePopup(deathPopup);
      // é‡æ–°é–‹å§‹éŠæˆ²ï¼ˆä¸å›æ¨™é¡Œç•«é¢ï¼‰
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('gameRestart'));
      }, 500);
    });

    // è·³é
    deathSkip.addEventListener('click', () => {
      // é‡ç½®æ­»äº¡ç‹€æ…‹
      isPlayerDead = false;
      lastDeathData = null;
      closePopup(deathPopup);
      // é‡æ–°é–‹å§‹éŠæˆ²ï¼ˆä¸å›æ¨™é¡Œç•«é¢ï¼‰
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('gameRestart'));
      }, 500);
    });

    // ç›£è¯éŠæˆ²æ­»äº¡äº‹ä»¶
    window.addEventListener('playerDeath', (e) => {
      const { survivalTime, level, totalDamage } = e.detail;
      showDeathPopup(survivalTime, level, totalDamage);
    });

    // é»æ“ŠéŠæˆ²å€åŸŸé‡æ–°æ‰“é–‹æ­»äº¡å½ˆçª—
    document.getElementById('app').addEventListener('click', () => {
      if (isPlayerDead && lastDeathData && deathPopup.style.display !== 'flex') {
        showDeathPopup(lastDeathData.time, lastDeathData.level, lastDeathData.damage, true);
      }
    });

    // ===== å…¨è¢å¹•åŠŸèƒ½ =====
    const fullscreenBtn = document.getElementById('fullscreen-btn');

    function isFullscreen() {
      return !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
    }

    function updateFullscreenState() {
      if (isFullscreen()) {
        document.body.classList.add('is-fullscreen');
      } else {
        document.body.classList.remove('is-fullscreen');
      }
    }

    function toggleFullscreen() {
      if (!isFullscreen()) {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
          elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) {
          elem.webkitRequestFullscreen();
        } else if (elem.mozRequestFullScreen) {
          elem.mozRequestFullScreen();
        } else if (elem.msRequestFullscreen) {
          elem.msRequestFullscreen();
        }
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
          document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    }

    fullscreenBtn.addEventListener('click', toggleFullscreen);

    document.addEventListener('fullscreenchange', updateFullscreenState);
    document.addEventListener('webkitfullscreenchange', updateFullscreenState);
    document.addEventListener('mozfullscreenchange', updateFullscreenState);
    document.addEventListener('MSFullscreenChange', updateFullscreenState);

    // ===== é‡æ•´æŒ‰éˆ• =====
    const reloadBtn = document.getElementById('reload-btn');
    reloadBtn.addEventListener('click', () => {
      location.reload();
    });

    // ===== åˆ†äº«æŒ‰éˆ• =====
    const shareBtn = document.getElementById('share-btn');
    shareBtn.addEventListener('click', async () => {
      const shareData = {
        title: 'DIGI WAR',
        text: 'ä¾†ç© DIGI WAR å§ï¼',
        url: window.location.href
      };

      if (navigator.share) {
        try {
          await navigator.share(shareData);
        } catch (err) {
          // ç”¨æˆ¶å–æ¶ˆåˆ†äº«æˆ–ç™¼ç”ŸéŒ¯èª¤
          console.log('Share cancelled or failed:', err);
        }
      } else {
        // ä¸æ”¯æ´ Web Share APIï¼Œè¤‡è£½é€£çµåˆ°å‰ªè²¼ç°¿
        try {
          await navigator.clipboard.writeText(window.location.href);
          alert('é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        } catch (err) {
          // å‰ªè²¼ç°¿ä¹Ÿä¸æ”¯æ´ï¼Œé¡¯ç¤ºé€£çµ
          prompt('è«‹è¤‡è£½æ­¤é€£çµï¼š', window.location.href);
        }
      }
    });

    // ===== ç¶²æ ¼å€ç‡æ§åˆ¶ =====
    const gridUp = document.getElementById('grid-up');
    const gridDown = document.getElementById('grid-down');
    const gridValue = document.getElementById('grid-value');
    // åˆ¤æ–·æ˜¯å¦ç‚ºæ‰‹æ©Ÿï¼ˆè§¸æ§è£ç½®ä¸”è¢å¹•è¼ƒå°ï¼‰
    const isMobileDevice = ('ontouchstart' in window) && window.innerWidth < 1024;
    let gridScale = isMobileDevice ? 2 : 3; // æ‰‹æ©Ÿé è¨­ 2Xï¼Œé›»è…¦é è¨­ 3X
    gridValue.textContent = `${gridScale}X`;

    function updateGridDisplay() {
      gridValue.textContent = `${gridScale}X`;
      window.dispatchEvent(new CustomEvent('gridscalechange', { detail: { scale: gridScale } }));
    }

    gridUp.addEventListener('click', () => {
      if (gridScale < 3) {
        gridScale++;
        updateGridDisplay();
      }
    });

    gridDown.addEventListener('click', () => {
      if (gridScale > 1) {
        gridScale--;
        updateGridDisplay();
      }
    });

    // ===== è¨»å†Š Service Worker =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // ä½¿ç”¨ç›¸å°è·¯å¾‘ï¼Œæ”¯æ´ GitHub Pages å­ç›®éŒ„éƒ¨ç½²
        const swPath = new URL('sw.js', window.location.href).href;
        navigator.serviceWorker.register(swPath)
          .then((registration) => {
            console.log('[PWA] Service Worker registered:', registration.scope);
          })
          .catch((error) => {
            console.log('[PWA] Service Worker registration failed:', error);
          });
      });
    }
  </script>

</body>

</html>